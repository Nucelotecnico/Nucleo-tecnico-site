<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>N√∫cleo-T√©cnico - √çndices</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="indices.css">

</head>

<body>

  <div style="display: flex; align-items: center; justify-content: center; gap: 24px;">
    <h1 id="titulo"
      style="font-family:'Roboto Slab', 'Georgia', serif; font-size:2.8em; color:#184d27; letter-spacing:2px; font-weight:900; padding:10px 12px; margin:0;">
      PORTAL N√öCLEO T√âCNICO
    </h1>
  </div>
  <br>
  <br>

  <div class="menu-container">
    <button id="btn-home" class="menu-btn" onclick="location.href='index.html'">Home</button>
    <button id="btn-checklist" class="menu-btn" onclick="location.href='checklist.html'">Checklist</button>
    <button id="btn-indices" class="menu-btn" onclick="location.href='indices.html'">√çndices</button>
    <button id="btn-fluxos" class="menu-btn" onclick="location.href='fluxos.html'">Fluxos</button>
    <button id="btn-calendario" class="menu-btn" onclick="location.href='calendario.html'">Calend√°rio</button>
    <button id="btn-links" class="menu-btn" onclick="location.href='links.html'">Links</button>
    <button id="btn-modulos" class="menu-btn" onclick="location.href='modulos.html'">M√≥dulos
      <br>Homologados</button>
    <button id="btn-ferramentas" class="menu-btn" onclick="location.href='ferramentas.html'">Ferramentas</button>
    <button id="btn-controlens" class="menu-btn" onclick="location.href='controlens.html'">Controle<br>An√°lises</button>
    <button id="btn-engenharia" class="menu-btn" onclick="location.href='engenharia.html'">Engenharia</button>
    <button id="btn-configuracoes" class="menu-btn" onclick="location.href='configuracoes.html'">Configura√ß√µes</button>
    <button class="menu-btn" onclick="logout()"
      style="background: linear-gradient(145deg, #d32f2f, #f44336);">Sair</button>

  </div>

  <script src="auth.js"></script>
  <script src="menu.js"></script>

  <h2 style="text-align: center; color: #2e7d32; margin: 24px 0; font-weight: 600; font-size: 2.2em;">GERENCIADOR DE
    √çNDICES</h2>

  <div style="max-width: 1400px; width: 100%; margin: 0 auto; padding: 20px;">

    <!-- Se√ß√£o de Upload -->
    <div id="secaoUpload"
      style="display: none; background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <h2 style="color: #2e7d32; margin-bottom: 16px;">üì§ Upload de Arquivo Excel</h2>
      <div style="display: flex; gap: 12px; align-items: center;">
        <input type="file" id="fileInput" accept=".xlsx, .xls"
          style="padding: 10px; border: 2px solid #e8f5e9; border-radius: 8px; flex: 1;">
        <button onclick="processarExcel()"
          style="background: linear-gradient(145deg, #2e7d32, #43a047); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
          Importar Dados
        </button>
        <button onclick="limparTabela()"
          style="background: linear-gradient(145deg, #d32f2f, #f44336); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
          Limpar Tabela
        </button>
      </div>
      <p style="color: #666; font-size: 0.9em; margin-top: 8px;">
        ‚ÑπÔ∏è O arquivo Excel deve conter as colunas: Nota, √Årea operacional, Cidade, C√≥digo medidas, Descri√ß√£o, Texto
        medidas, Status usu√°rio, In√≠cio planejado, Fim planejado, Conclu√≠do por, Conclu√≠da em, Modificado por
      </p>
    </div>

    <!-- Bot√µes do Gr√°fico de Quantidade notas ABER e ANDM por tipo -->
    <div style="display: flex; gap: 12px; margin-bottom: 16px; justify-content: center;">
      <button id="btnMedidas0034" onclick="exibirMedidas0034()" style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s ease; white-space: nowrap;">
        MEDIDAS 0034
      </button>
      <button id="btnNotasAndamento" onclick="exibirNotasAndamento()" style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s ease; white-space: nowrap;">
        NOTAS EM ANDAMENTO
      </button>
      <button id="btnNotasConcluidas" onclick="exibirNotasConcluidas()" style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s ease; white-space: nowrap;">
        NOTAS CONCLU√çDAS
      </button>
      <button id="btnPrazosAnalise" onclick="exibirPrazosAnalise()" style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s ease; white-space: nowrap;">
        PRAZOS DE AN√ÅLISE
      </button>
      <button id="btnProdutividade" onclick="exibirProdutividade()" style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s ease; white-space: nowrap;">
        PRODUTIVIDADE
      </button>
      <button id="btnExibirTabelaNotas" onclick="exibirTabelaNotas()" style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s ease; white-space: nowrap;">
        EXIBIR TABELA DE NOTAS
      </button>
    </div>

    <!-- Gr√°fico de Todos os Tipos de Descri√ß√£o -->
    <div style="max-width: 1400px; width: 100%; margin: 0 auto;">
    <div id="graficoOutrosTipos"
      style="display: none; background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <h2 style="color: #2e7d32; margin-bottom: 16px;">üìã Quantidade notas ABER e ANDM por tipo</h2>
      <div style="max-width: 1000px; margin: 0 auto;">
        <canvas id="chartOutrosTipos"></canvas>
      </div>
      <div id="infoOutrosTipos"
        style="margin-top: 16px; padding: 12px; background: #e3f2fd; border-radius: 8px; color: #1976d2;">
        <strong>Total de notas:</strong> <span id="totalOutrosTipos">0</span> |
        <strong>Tipos √∫nicos:</strong> <span id="tiposUnicos">0</span>
      </div>
    </div>
    </div>



    <!-- Gr√°fico de Texto Medidas -->
    <div style="max-width: 1400px; width: 100%; margin: 0 auto;">
    <div id="graficoTextoMedidas"
      style="display: none; background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <h2 style="color: #2e7d32; margin-bottom: 16px;">üìù Quantidade de Notas por Texto de Medidas</h2>
      <div style="max-width: 1200px; margin: 0 auto;">
        <canvas id="chartTextoMedidas"></canvas>
      </div>
      <div id="infoTextoMedidas"
        style="margin-top: 16px; padding: 12px; background: #f0f4f8; border-radius: 8px; color: #1976d2;">
        <strong>Total de notas:</strong> <span id="totalTextoMedidas">0</span> |
        <strong>Categorias √∫nicas:</strong> <span id="categoriasUnicasTextoMedidas">0</span>
      </div>
    </div>
    </div>

    <!-- Gr√°fico Medidas 0034 -->
    <div style="max-width: 1400px; width: 100%; margin: 0 auto;">
    <div id="graficoMedidas0034"
      style="display: none; background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #2e7d32; margin: 0;">üìä Quantidade de Notas ABER e ANDM - C√≥digo 0034</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: flex-end;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <label for="filtroMesMedidas0034" style="font-size: 14px; color: #666; font-weight: 500;">Filtrar por m√™s:</label>
            <select id="filtroMesMedidas0034" onchange="filtrarGraficoMedidas0034PorMes()"
              style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; background: #fff; cursor: pointer;">
              <option value="todos">Todos os meses</option>
            </select>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleDescricoesMedidas0034" onclick="toggleDropdownDescricoesMedidas0034()"
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por descri√ß√£o</span>
            </button>
            <div id="containerCheckboxesDescricoesMedidas0034"
              style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
        </div>
      </div>
      <div style="max-width: 1200px; margin: 0 auto;">
        <canvas id="chartMedidas0034"></canvas>
      </div>
      <div id="infoMedidas0034"
        style="margin-top: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px; color: #333;">
        <strong>Total de notas:</strong> <span id="totalMedidas0034">0</span> |
        <strong style="color: #2e7d32;">ANDM:</strong> <span id="totalANDMMedidas0034" style="color: #2e7d32;">0</span> |
        <strong style="color: #66bb6a;">ABER:</strong> <span id="totalABERMedidas0034" style="color: #66bb6a;">0</span>
      </div>
    </div>
    </div>

    <!-- Gr√°fico Prazo M√©dio Medidas 0034 -->
    <div style="max-width: 1400px; width: 100%; margin: 0 auto;">
    <div id="graficoPrazoMedio0034"
      style="display: none; background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #2e7d32; margin: 0;">üìà Prazo M√©dio Mensal - C√≥digo 0034</h2>
        <div style="display: flex; gap: 12px; align-items: flex-start;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <label for="filtroAnoPrazo0034" style="font-size: 14px; color: #666; font-weight: 500;">Filtrar por ano:</label>
            <select id="filtroAnoPrazo0034" onchange="aplicarFiltroAnoPrazo0034()"
              style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; background: #fff; cursor: pointer; min-width: 120px;">
              <option value="todos">Todos</option>
            </select>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleDescricoesPrazo0034" onclick="toggleDropdownDescricoesPrazo0034()"
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por descri√ß√£o</span>
            </button>
            <div id="containerCheckboxesDescricoesPrazo0034"
              style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
        </div>
      </div>
      <div style="max-width: 1200px; margin: 0 auto;">
        <canvas id="chartPrazoMedio0034"></canvas>
      </div>
      <div id="infoPrazoMedio0034"
        style="margin-top: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px; color: #333;">
        <strong>Total de notas analisadas:</strong> <span id="totalNotasAnalisadas0034">0</span> |
        <strong>Prazo m√©dio geral:</strong> <span id="prazoMedioGeral0034">0</span> dias
      </div>
    </div>
    </div>

    <!-- Gr√°fico de An√°lise Geral -->
    <div style="max-width: 1400px; width: 100%; margin: 0 auto;">
    <div id="graficoFimPlanejado"
      style="display: none; background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div
        style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #2e7d32; margin: 0;">üìä Quantidade de Notas ABER E ANDM Carga e GD</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: flex-end;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <label for="filtroMesFimPlanejado" style="font-size: 14px; color: #666; font-weight: 500;">Filtrar por
              m√™s:</label>
            <select id="filtroMesFimPlanejado" onchange="filtrarGraficoFimPlanejadoPorMes()"
              style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; background: #fff; cursor: pointer;">
              <option value="todos">Todos os meses</option>
            </select>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleDescricoes" onclick="toggleDropdownDescricoes()"
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por descri√ß√£o</span>
            </button>
            <div id="containerCheckboxesDescricoes"
              style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleCodigoMedidas" onclick="toggleDropdownCodigoMedidas()"
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por C√≥digo Medidas</span>
            </button>
            <div id="containerCheckboxesCodigoMedidas"
              style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleStatusFimPlanejado" onclick="toggleDropdownStatusFimPlanejado()"
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por Status</span>
            </button>
            <div id="containerCheckboxesStatusFimPlanejado"
              style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
        </div>
      </div>
      <div style="max-width: 1000px; margin: 0 auto;">
        <canvas id="chartFimPlanejado"></canvas>
      </div>
      <div id="infoGeralNotas"
        style="margin-top: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px; color: #333;">
        <strong>Total de notas:</strong> <span id="totalGeralNotas">0</span> |
        <strong style="color: #2e7d32;">ANDM:</strong> <span id="totalANDM" style="color: #2e7d32;">0</span> |
        <strong style="color: #66bb6a;">ABER:</strong> <span id="totalABER" style="color: #66bb6a;">0</span>
      </div>
    </div>
    </div>

    <!-- Modal para exibir notas detalhadas -->
    <div id="modalNotas"
      style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow: auto;">
      <div
        style="background: white; margin: 50px auto; max-width: 90%; max-height: 85vh; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div
          style="background: #2e7d32; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0;" id="modalTitulo">Notas Detalhadas</h3>
          <button onclick="fecharModalNotas()"
            style="background: transparent; border: none; color: white; font-size: 28px; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
        </div>
        <div style="padding: 20px 20px 40px 20px; max-height: calc(85vh - 80px); overflow-y: auto;">
          <div id="modalConteudo"></div>
        </div>
      </div>
    </div>

    <!-- Gr√°fico Quantidade de notas ABER e ANDM - Carga -->
    <div style="max-width: 1400px; width: 100%; margin: 0 auto;">
    <div id="graficoSemGeracoes"
      style="display: none; background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div
        style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #2e7d32; margin: 0;">üîç Quantidade de notas ABER e ANDM - Carga</h2>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <button id="botaoToggleCodigoMedidasSemGeracoes" onclick="toggleDropdownCodigoMedidasSemGeracoes()"
            style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
            <span>‚ñº</span>
            <span>Filtrar por C√≥digo Medidas</span>
          </button>
          <div id="containerCheckboxesCodigoMedidasSemGeracoes"
            style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
            <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
          </div>
        </div>
      </div>
      <div style="max-width: 1000px; margin: 0 auto;">
        <canvas id="chartSemGeracoes"></canvas>
      </div>
      <div id="infoSemGeracoes"
        style="margin-top: 16px; padding: 12px; background: #f3e5f5; border-radius: 8px; color: #7b1fa2;">
        <strong>Total de notas:</strong> <span id="totalSemGeracoes">0</span>
      </div>
    </div>
    </div>

    <!-- Gr√°fico Quantidade de notas ABER e ANDM - GD -->
    <div style="max-width: 1400px; width: 100%; margin: 0 auto;">
    <div id="graficoMiniGeracao"
      style="display: none; background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div
        style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #2e7d32; margin: 0;">‚ö° Quantidade de notas ABER e ANDM - GD</h2>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <button id="botaoToggleCodigoMedidasMiniGeracao" onclick="toggleDropdownCodigoMedidasMiniGeracao()"
            style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
            <span>‚ñº</span>
            <span>Filtrar por C√≥digo Medidas</span>
          </button>
          <div id="containerCheckboxesCodigoMedidasMiniGeracao"
            style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
            <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
          </div>
        </div>
      </div>
      <div style="max-width: 1000px; margin: 0 auto;">
        <canvas id="chartMiniGeracao"></canvas>
      </div>
      <div id="infoMiniGeracao"
        style="margin-top: 16px; padding: 12px; background: #f1f8f4; border-radius: 8px; color: #2e7d32;">
        <strong>Total de notas:</strong> <span id="totalMiniGeracao">0</span>
      </div>
    </div>
    </div>

    <!-- Gr√°fico de Notas Conclu√≠das por M√™s -->
    <div id="graficoNotasConcluidasPorMes"
      style="display: none; background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;">
        <h2 style="color: #2e7d32; margin: 0;">üìÖ Notas Conclu√≠das por M√™s</h2>
        <div style="display: flex; align-items: center; gap: 10px;">
          <label for="filtroAnoNotasConcluidasPorMes" style="font-size: 14px; color: #666; font-weight: 500;">Filtrar por ano:</label>
          <select id="filtroAnoNotasConcluidasPorMes" onchange="aplicarFiltroAnoNotasConcluidasPorMes()"
            style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; background: #fff; cursor: pointer; min-width: 120px;">
            <option value="todos">Todos</option>
          </select>
        </div>
      </div>
      <div style="max-width: 1000px; margin: 0 auto;">
        <canvas id="chartNotasConcluidasPorMes"></canvas>
      </div>
      <div id="infoNotasConcluidasPorMes"
        style="margin-top: 16px; padding: 12px; background: #e8f5e9; border-radius: 8px; color: #2e7d32;">
        <strong>Total de notas analisadas:</strong> <span id="totalNotasConcluidasPorMes">0</span>
      </div>
    </div>

    <!-- Gr√°fico de Notas Conclu√≠das (CONC CTEC e CONC RTEC) -->

    <div id="graficoConcluidas"
      style="display: none; background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div
        style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #2e7d32; margin: 0;">‚úÖ Notas Conclu√≠das por Data de Conclus√£o</h2>
        <div style="display: flex; flex-wrap: wrap; align-items: flex-start; gap: 12px; justify-content: flex-end;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <label for="filtroMesConcluidas" style="font-size: 14px; color: #666; font-weight: 500;">Filtrar por
              m√™s:</label>
            <select id="filtroMesConcluidas" onchange="filtrarGraficoConcluidasPorMes()"
              style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; background: #fff; cursor: pointer;">
              <option value="todos">Todos os meses</option>
            </select>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleCodigoMedidasConcluidas" onclick="toggleDropdownCodigoMedidasConcluidas()"
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por C√≥digo Medidas</span>
            </button>
            <div id="containerCheckboxesCodigoMedidasConcluidas"
              style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
        </div>
      </div>
      <div style="max-width: 1000px; margin: 0 auto;">
        <canvas id="chartConcluidas"></canvas>
      </div>
      <div id="infoConcluidas"
        style="margin-top: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px; color: #333;">
        <strong>Total de notas conclu√≠das:</strong> <span id="totalConcluidas">0</span> |
        <strong style="color: #388e3c;">CONC CTEC:</strong> <span id="totalCONC_CTEC" style="color: #388e3c;">0</span> |
        <strong style="color: #81c784;">CONC RTEC:</strong> <span id="totalCONC_RTEC" style="color: #81c784;">0</span> |
        <strong style="color: #388e3c;">% Aprova√ß√£o CONC CTEC:</strong> <span id="percentualAprovacao"
          style="color: #388e3c; font-weight: bold;">0%</span>
      </div>
    </div>

      <!-- Gr√°fico de Conclu√≠das por Tipo de Solicita√ß√£o (Mini/Micro vs Demais) -->
      <div id="graficoConcluidasPorTipoSolicitacao"
        style="display: none; background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;">
          <h2 style="color: #2e7d32; margin: 0;">üìä Conclu√≠das por Tipo - Mini/Micro Gera√ß√£o</h2>
          <div style="display: flex; align-items: center; gap: 16px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 14px; color: #666; cursor: pointer;">
              <input type="checkbox" id="ocultarBarrasMini" onchange="toggleBarrasMini()" style="cursor: pointer;">
              <span>Ocultar barras</span>
            </label>
            <label for="filtroAnoConcluidasPorTipoSolicitacao" style="font-size: 14px; color: #666; font-weight: 500;">Filtrar por ano:</label>
            <select id="filtroAnoConcluidasPorTipoSolicitacao" onchange="aplicarFiltroAnoConcluidasPorTipoSolicitacao()"
              style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; background: #fff; cursor: pointer; min-width: 120px;">
              <option value="todos">Todos</option>
            </select>
          </div>
        </div>
        <div style="max-width: 1000px; margin: 0 auto; height: 400px;">
          <canvas id="chartConcluidasPorTipoSolicitacao"></canvas>
        </div>
        <div id="infoConcluidasPorTipoSolicitacao"
          style="margin-top: 16px; padding: 12px; background: #eef7f0; border-radius: 8px; color: #2e7d32;">
          <strong>Total de notas analisadas:</strong> <span id="totalNotasConcluidasPorTipoMini">0</span> | <strong></strong>Crit√©rio:</strong> Mini/Micro Gera√ß√£o (CONC CTEC e CONC RTEC)
        </div>
      </div>

      <!-- Gr√°fico de Conclu√≠das por Tipo Demais -->
      <div id="graficoConcluidasPorTipoDemais"
        style="display: none; background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;">
          <h2 style="color: #2e7d32; margin: 0;">üìä Conclu√≠das por Tipo - Carga</h2>
          <div style="display: flex; align-items: center; gap: 16px;">
            <label style="display: flex; align-items: center; gap: 6px; font-size: 14px; color: #666; cursor: pointer;">
              <input type="checkbox" id="ocultarBarrasDemais" onchange="toggleBarrasDemais()" style="cursor: pointer;">
              <span>Ocultar barras</span>
            </label>
            <label for="filtroAnoConcluidasPorTipoDemais" style="font-size: 14px; color: #666; font-weight: 500;">Filtrar por ano:</label>
            <select id="filtroAnoConcluidasPorTipoDemais" onchange="aplicarFiltroAnoConcluidasPorTipoDemais()"
              style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; background: #fff; cursor: pointer; min-width: 120px;">
              <option value="todos">Todos</option>
            </select>
          </div>
        </div>
        <div style="max-width: 1000px; margin: 0 auto; height: 400px;">
          <canvas id="chartConcluidasPorTipoDemais"></canvas>
        </div>
        <div id="infoConcluidasPorTipoDemais"
          style="margin-top: 16px; padding: 12px; background: #eef7f0; border-radius: 8px; color: #2e7d32;">
          <strong>Total de notas analisadas:</strong> <span id="totalNotasConcluidasPorTipoDemais">0</span> | <strong></strong>Crit√©rio:</strong> Demais Tipos de Solicita√ß√£o (CONC CTEC e CONC RTEC)
        </div>
      </div>

    <!-- Gr√°fico de Prazo M√©dio Mensal -->
    <div id="graficoPrazoMedioGeral"
      style="display: none; background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div
        style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #2e7d32; margin: 0;">üìÖ Prazo M√©dio Mensal Geral(GD e Carga)</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: flex-end; align-items: flex-start;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <label for="filtroAnoPrazoMedio" style="font-size: 14px; color: #666; font-weight: 500;">Filtrar por ano:</label>
            <select id="filtroAnoPrazoMedio" onchange="aplicarFiltroAnoPrazoMedio()"
              style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; background: #fff; cursor: pointer; min-width: 120px;">
              <option value="todos">Todos</option>
            </select>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleDescricoesPrazo" onclick="toggleDropdownDescricoesPrazo()"
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por descri√ß√£o</span>
            </button>
            <div id="containerCheckboxesDescricoesPrazo"
              style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleCodigoMedidasPrazo" onclick="toggleDropdownCodigoMedidasPrazo()"
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por C√≥digo Medidas</span>
            </button>
            <div id="containerCheckboxesCodigoMedidasPrazo"
              style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
        </div>
      </div>
      <div style="max-width: 1000px; margin: 0 auto;">
        <canvas id="chartPrazoMedio"></canvas>
      </div>
      <div id="infoPrazoMedio"
        style="margin-top: 16px; padding: 12px; background: #fff3e0; border-radius: 8px; color: #e65100;">
        <strong>Total de notas analisadas:</strong> <span id="totalNotasAnalisadas">0</span> |
        <strong>Prazo m√©dio geral:</strong> <span id="prazoMedioGeral">0</span> dias
      </div>
    </div>

    <!-- Gr√°fico de Prazo M√©dio Mensal - Todos exceto Mini/Micro Gera√ß√£o -->
    <div id="graficoPrazoMedioCarga"
      style="display: none; background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div
        style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #2e7d32; margin: 0;">üìÖ Prazo M√©dio Mensal - Carga</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: flex-end; align-items: flex-start;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <label for="filtroAnoPrazoMedioExceto" style="font-size: 14px; color: #666; font-weight: 500;">Filtrar por ano:</label>
            <select id="filtroAnoPrazoMedioExceto" onchange="aplicarFiltroAnoPrazoMedioExceto()"
              style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; background: #fff; cursor: pointer; min-width: 120px;">
              <option value="todos">Todos</option>
            </select>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleDescricoesPrazoExceto" onclick="toggleDropdownDescricoesPrazoExceto()"
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por descri√ß√£o</span>
            </button>
            <div id="containerCheckboxesDescricoesPrazoExceto"
              style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleCodigoMedidasPrazoExceto" onclick="toggleDropdownCodigoMedidasPrazoExceto()"
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por C√≥digo Medidas</span>
            </button>
            <div id="containerCheckboxesCodigoMedidasPrazoExceto"
              style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
        </div>
      </div>
      <div style="max-width: 1000px; margin: 0 auto;">
        <canvas id="chartPrazoMedioExceto"></canvas>
      </div>
      <div id="infoPrazoMedioExceto"
        style="margin-top: 16px; padding: 12px; background: #fff3e0; border-radius: 8px; color: #e65100;">
        <strong>Total de notas analisadas:</strong> <span id="totalNotasAnalisadasExceto">0</span> |
        <strong>Prazo m√©dio geral:</strong> <span id="prazoMedioGeralExceto">0</span> dias
      </div>
    </div>

    <!-- Gr√°fico de Prazo M√©dio Mensal - Somente Mini/Micro Gera√ß√£o -->
    <div id="graficoPrazoMedioGD"
      style="display: none; background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div
        style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #2e7d32; margin: 0;">üìÖ Prazo M√©dio Mensal - GD</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: flex-end; align-items: flex-start;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <label for="filtroAnoPrazoMedioMiniMicro" style="font-size: 14px; color: #666; font-weight: 500;">Filtrar por ano:</label>
            <select id="filtroAnoPrazoMedioMiniMicro" onchange="aplicarFiltroAnoPrazoMedioMiniMicro()"
              style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; background: #fff; cursor: pointer; min-width: 120px;">
              <option value="todos">Todos</option>
            </select>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleDescricoesPrazoMiniMicro" onclick="toggleDropdownDescricoesPrazoMiniMicro()"
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por descri√ß√£o</span>
            </button>
            <div id="containerCheckboxesDescricoesPrazoMiniMicro"
              style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleCodigoMedidasPrazoMiniMicro" onclick="toggleDropdownCodigoMedidasPrazoMiniMicro()"
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por C√≥digo Medidas</span>
            </button>
            <div id="containerCheckboxesCodigoMedidasPrazoMiniMicro"
              style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
        </div>
      </div>
      <div style="max-width: 1000px; margin: 0 auto;">
        <canvas id="chartPrazoMedioMiniMicro"></canvas>
      </div>
      <div id="infoPrazoMedioMiniMicro"
        style="margin-top: 16px; padding: 12px; background: #fff3e0; border-radius: 8px; color: #e65100;">
        <strong>Total de notas analisadas:</strong> <span id="totalNotasAnalisadasMiniMicro">0</span> |
        <strong>Prazo m√©dio geral:</strong> <span id="prazoMedioGeralMiniMicro">0</span> dias
      </div>
    </div>





    <!-- Gr√°fico: Notas Conclu√≠das por Usu√°rio -->
    <div id="graficoNotasPorUsuario"
      style="display: none; background: #fff; border-radius: 10px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 24px;">
      <div
        style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #d32f2f; margin: 0;">üë• Notas Conclu√≠das por Usu√°rio</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: flex-end;">
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <label for="filtroMesNotasPorUsuario" style="font-size: 14px; color: #666; font-weight: 500;">Filtrar por
              m√™s (Conclu√≠da em):</label>
            <select id="filtroMesNotasPorUsuario" onchange="aplicarFiltroMesNotasPorUsuario()"
              style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; min-width: 180px;">
              <option value="todos">Todos os meses</option>
            </select>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleDescricoesNotasPorUsuario" onclick="toggleDropdownDescricoesNotasPorUsuario()"
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por descri√ß√£o</span>
            </button>
            <div id="containerCheckboxesDescricoesNotasPorUsuario"
              style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleCodigoMedidasNotasPorUsuario" onclick="toggleDropdownCodigoMedidasNotasPorUsuario()"
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por C√≥digo Medidas</span>
            </button>
            <div id="containerCheckboxesCodigoMedidasNotasPorUsuario"
              style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
        </div>
      </div>
      <div style="max-width: 1000px; margin: 0 auto;">
        <canvas id="chartNotasPorUsuario"></canvas>
      </div>
      <div id="infoNotasPorUsuario"
        style="margin-top: 16px; padding: 12px; background: #ffebee; border-radius: 8px; color: #c62828;">
        <strong>Total de notas conclu√≠das:</strong> <span id="totalNotasPorUsuario">0</span>
      </div>
    </div>

    <!-- Gr√°fico: Percentual de Aprova√ß√£o/Reprova√ß√£o por Usu√°rio -->
    <div id="graficoAprovacaoReprovacaoPorUsuario"
      style="display: none; background: #fff; border-radius: 10px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 24px;">
      <div
        style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #2e7d32; margin: 0;">üìä Percentual de Aprova√ß√£o e Reprova√ß√£o por Usu√°rio</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: flex-end;">
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <label for="filtroMesAprovacaoReprovacao" style="font-size: 14px; color: #666; font-weight: 500;">Filtrar por
              m√™s (Conclu√≠da em):</label>
            <select id="filtroMesAprovacaoReprovacao" onchange="aplicarFiltroMesAprovacaoReprovacao()"
              style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; min-width: 180px;">
              <option value="todos">Todos os meses</option>
            </select>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleDescricoesAprovacaoReprovacao" onclick="toggleDropdownDescricoesAprovacaoReprovacao()"
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por descri√ß√£o</span>
            </button>
            <div id="containerCheckboxesDescricoesAprovacaoReprovacao"
              style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleCodigoMedidasAprovacaoReprovacao" onclick="toggleDropdownCodigoMedidasAprovacaoReprovacao()"
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por C√≥digo Medidas</span>
            </button>
            <div id="containerCheckboxesCodigoMedidasAprovacaoReprovacao"
              style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
        </div>
      </div>
      <div style="max-width: 1400px; margin: 0 auto;">
        <canvas id="chartAprovacaoReprovacaoPorUsuario"></canvas>
      </div>
      <div id="infoAprovacaoReprovacaoPorUsuario"
        style="margin-top: 16px; padding: 12px; background: #e8f5e9; border-radius: 8px; color: #2e7d32;">
        <strong>Total de notas conclu√≠das:</strong> <span id="totalNotasAprovacaoReprovacao">0</span>
      </div>
    </div>

    <!-- Gr√°fico: Notas Conclu√≠das por Dia por Usu√°rio -->
    <div id="graficoNotasConcluidasPorDiaUsuario"
      style="display: none; background: #fff; border-radius: 10px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 24px;">
      <div
        style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #1976d2; margin: 0;">üìÖ Notas Conclu√≠das por Dia por Usu√°rio</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: flex-end;">
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <label for="filtroMesNotasConcluidasPorDiaUsuario" style="font-size: 14px; color: #666; font-weight: 500;">Filtrar por
              m√™s (Conclu√≠da em):</label>
            <select id="filtroMesNotasConcluidasPorDiaUsuario" onchange="aplicarFiltroMesNotasConcluidasPorDiaUsuario()"
              style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; min-width: 180px;">
              <option value="todos">Todos os meses</option>
            </select>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleUsuariosNotasConcluidasPorDia" onclick="toggleDropdownUsuariosNotasConcluidasPorDia()"
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por Usu√°rio</span>
            </button>
            <div id="containerCheckboxesUsuariosNotasConcluidasPorDia"
              style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px; max-height: 300px; overflow-y: auto;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
        </div>
      </div>
      <div style="max-width: 1400px; margin: 0 auto;">
        <canvas id="chartNotasConcluidasPorDiaUsuario"></canvas>
      </div>
      <div id="infoNotasConcluidasPorDiaUsuario"
        style="margin-top: 16px; padding: 12px; background: #e3f2fd; border-radius: 8px; color: #1565c0;">
        <strong>Total de notas conclu√≠das:</strong> <span id="totalNotasConcluidasPorDiaUsuario">0</span>
      </div>
    </div>

    <!-- Tabela de Dados -->
    <div id="secaoDadosCadastrados"
      style="display: none; background: #fff; border-radius: 10px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow-x: auto;">
      <h2 style="color: #2e7d32; margin-bottom: 16px;">üìä Dados Cadastrados</h2>
      <div id="tabelaContainer" style="overflow-x: auto;">
        <table id="tabelaIndices" style="width: 100%; border-collapse: collapse; min-width: 1200px;">
          <thead>
            <tr style="background: #f5f5f5;">
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">Nota</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">√Årea
                Operacional</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">Cidade
              </th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">C√≥digo
                Medidas</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">Descri√ß√£o
              </th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">Texto
                Medidas</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">Status
                Usu√°rio</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">In√≠cio
                Planejado</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">Fim
                Planejado</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">Conclu√≠do
                Por</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">Conclu√≠da
                Em</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">
                Modificado Por</th>
              <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd; white-space: nowrap;">A√ß√µes
              </th>
            </tr>
          </thead>
          <tbody id="tabelaBody">
            <tr>
              <td colspan="13" style="text-align: center; padding: 20px; color: #999;">
                Nenhum dado cadastrado. Fa√ßa upload de um arquivo Excel para come√ßar.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>



  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="auth.js"></script>
  <script>
    // Configura√ß√£o do Supabase
    const SUPABASE_URL = 'https://nelzhukmxrgdoarsxcek.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lbHpodWtteHJnZG9hcnN4Y2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMDIxNzUsImV4cCI6MjA3MTU3ODE3NX0.KHvfJHVimKwiraEzbyZWyLnTO5P5VEvM86GlyE7y09k';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Registrar o plugin ChartDataLabels assim que os scripts carregarem
    if (typeof Chart !== 'undefined' && typeof ChartDataLabels !== 'undefined') {
      Chart.register(ChartDataLabels);
    }

    // Controlar acesso √† se√ß√£o de upload para usu√°rio comum
    document.addEventListener('DOMContentLoaded', function () {
      const categoria = sessionStorage.getItem('userCategoria');
      const secaoUpload = document.getElementById('secaoUpload');
      const secaoDadosCadastrados = document.getElementById('secaoDadosCadastrados');
      const btnProdutividade = document.getElementById('btnProdutividade');

      if (categoria === 'usuario') {
        if (secaoUpload) {
          secaoUpload.style.display = 'none';
        }
        if (btnProdutividade) {
          btnProdutividade.style.display = 'none';
        }
      } else {
        if (secaoUpload) {
          secaoUpload.style.display = 'block';
        }
        if (btnProdutividade) {
          btnProdutividade.style.display = 'inline-block';
        }
      }
      
      // Sempre manter a tabela oculta na inicializa√ß√£o
      if (secaoDadosCadastrados) {
        secaoDadosCadastrados.style.display = 'none';
      }
    });

    window.processarExcel = async function () {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];

      if (!file) {
        alert('Por favor, selecione um arquivo Excel.');
        return;
      }

      const reader = new FileReader();
      reader.onload = async function (e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];

          // Ler como array de arrays (ignora cabe√ßalhos problem√°ticos)
          const arrayData = XLSX.utils.sheet_to_json(firstSheet, {
            header: 1, // Retorna array de arrays
            defval: '' // Define valor padr√£o para c√©lulas vazias
          });

          console.log('Total de linhas no Excel:', arrayData.length);
          console.log('Primeira linha (cabe√ßalho):', arrayData[0]);
          console.log('Segunda linha (dados):', arrayData[1]);
          console.log('Terceira linha (dados):', arrayData[2]);

          // Remover linha de cabe√ßalho
          const dadosLinhas = arrayData.slice(1).filter(row =>
            row && row.length > 0 && row.some(cell => cell !== '' && cell !== null && cell !== undefined)
          );

          console.log('Total de linhas com dados:', dadosLinhas.length);

          if (dadosLinhas.length === 0) {
            alert('O arquivo Excel est√° vazio ou n√£o possui dados v√°lidos.');
            return;
          }

          // Mapear os dados usando √≠ndices de array
          const dadosFormatados = dadosLinhas.map((row, index) => {
            console.log(`Linha ${index + 1}:`, row);
            return {
              nota: String(row[0] || ''),
              area_operacional: String(row[1] || ''),
              cidade: String(row[2] || ''),
              codigo_medidas: String(row[3] || ''),
              descricao: String(row[4] || ''),
              texto_medidas: String(row[5] || ''),
              status_usuario: String(row[6] || ''),
              inicio_planejado: String(row[7] || ''),
              fim_planejado: String(row[8] || ''),
              concluido_por: String(row[9] || ''),
              concluida_em: String(row[10] || ''),
              modificado_por: String(row[11] || '')
            };
          });

          console.log('Dados formatados:', dadosFormatados);
          console.log('Total de registros formatados:', dadosFormatados.length);

          // Inserir no banco de dados
          const { data: insertData, error } = await supabaseClient
            .from('indices')
            .insert(dadosFormatados);

          if (error) {
            console.error('Erro ao inserir dados:', error);
            alert('Erro ao importar dados: ' + error.message);
          } else {
            alert(`${dadosFormatados.length} registros importados com sucesso!`);
            fileInput.value = '';
            carregarDados();
          }
        } catch (error) {
          console.error('Erro ao processar arquivo:', error);
          alert('Erro ao processar arquivo: ' + error.message);
        }
      };

      reader.readAsArrayBuffer(file);
    };

    // Fun√ß√µes para o modal de notas
    window.abrirModalNotas = function (notas, data, status) {
      const modal = document.getElementById('modalNotas');
      const titulo = document.getElementById('modalTitulo');
      const conteudo = document.getElementById('modalConteudo');

      titulo.textContent = `${status} - ${data} (${notas.length} notas)`;

      if (notas.length === 0) {
        conteudo.innerHTML = '<p style="text-align: center; color: #666;">Nenhuma nota encontrada.</p>';
      } else {
        let html = '<table style="width: 100%; border-collapse: collapse;">';
        html += '<thead><tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Nota</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Regional</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Cidade</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">C√≥digo Medidas</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Texto Medidas</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Descri√ß√£o</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Status Usu√°rio</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Conclu√≠do Por</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Conclu√≠da Em</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Respons√°vel</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">A√ß√µes</th>';
        html += '</tr></thead><tbody>';

        notas.forEach((nota, index) => {
          const bgColor = index % 2 === 0 ? '#fff' : '#f9f9f9';
          html += `<tr style="background: ${bgColor}; border-bottom: 1px solid #eee;">`;
          html += `<td style="padding: 10px;">${nota.nota || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.regional || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.cidade || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.codigo_medidas || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.texto_medidas || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.descricao || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.status_usuario || ''}</td>`;
          html += `<td style="padding: 10px;"><input type="text" id="modal_concluido_${nota.id}" value="${nota.concluido_por || ''}" style="padding:6px; width:160px; border:1px solid #ccc; border-radius:4px;" /></td>`;
          html += `<td style="padding: 10px;"><input type="text" id="modal_concluida_em_${nota.id}" value="${nota.concluida_em || ''}" style="padding:6px; width:160px; border:1px solid #ccc; border-radius:4px;" /></td>`;
          html += `<td style="padding: 10px;">${nota.responsavel || ''}</td>`;
          html += `<td style="padding: 10px;">`;
          html += `<select id="status_${index}" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">`;
          html += `<option value="${nota.status_usuario || ''}" selected>${nota.status_usuario || 'Selecione'}</option>`;
          html += `<option value="ANDM">ANDM</option>`;
          html += `<option value="ABER">ABER</option>`;
          html += `<option value="CONC CTEC">CONC CTEC</option>`;
          html += `<option value="CONC RTEC">CONC RTEC</option>`;
          html += `<option value="CANC">CANC</option>`;
          html += `</select>`;
          html += `<button onclick="atualizarStatusNota('${nota.id}', ${index})" style="padding: 6px 12px; margin-top: 4px; background: #2e7d32; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%;">Salvar</button>`;
          html += `</td>`;
          html += '</tr>';
        });

        html += '</tbody></table>';
        conteudo.innerHTML = html;
      }

      modal.style.display = 'block';
    };

    window.atualizarStatusNota = async function (notaId, rowIndex) {
      const selectElement = document.getElementById(`status_${rowIndex}`);
      const novoStatus = selectElement.value;

      if (!novoStatus || novoStatus === 'Selecione') {
        alert('Por favor, selecione um status v√°lido');
        return;
      }

      // Tamb√©m tenta ler o campo 'Conclu√≠do Por' e 'Conclu√≠da Em' do modal (se presente)
      const inputConcluido = document.getElementById(`modal_concluido_${notaId}`);
      const inputConcluida = document.getElementById(`modal_concluida_em_${notaId}`);
      const concluidoValor = inputConcluido ? inputConcluido.value : null;
      const concluidaValor = inputConcluida ? inputConcluida.value : null;

      try {
        const updatePayload = { status_usuario: novoStatus };
        if (concluidoValor !== null) updatePayload.concluido_por = concluidoValor;
        if (concluidaValor !== null) updatePayload.concluida_em = concluidaValor;

        const { error } = await supabaseClient
          .from('indices')
          .update(updatePayload)
          .eq('id', notaId);

        if (error) {
          console.error('Erro ao atualizar status/conclu√≠do:', error);
          alert('Erro ao atualizar: ' + error.message);
        } else {
          // Atualiza dados locais (sem recarregar tudo) para que o modal permane√ßa aberto
          if (typeof dadosGlobais !== 'undefined' && Array.isArray(dadosGlobais)) {
            for (let i = 0; i < dadosGlobais.length; i++) {
              if (String(dadosGlobais[i].id) === String(notaId)) {
                dadosGlobais[i].status_usuario = novoStatus;
                if (concluidoValor !== null) dadosGlobais[i].concluido_por = concluidoValor;
                if (concluidaValor !== null) dadosGlobais[i].concluida_em = concluidaValor;
                break;
              }
            }
          }
          if (typeof dadosGlobaisCompletos !== 'undefined' && Array.isArray(dadosGlobaisCompletos)) {
            for (let i = 0; i < dadosGlobaisCompletos.length; i++) {
              if (String(dadosGlobaisCompletos[i].id) === String(notaId)) {
                dadosGlobaisCompletos[i].status_usuario = novoStatus;
                if (concluidoValor !== null) dadosGlobaisCompletos[i].concluido_por = concluidoValor;
                if (concluidaValor !== null) dadosGlobaisCompletos[i].concluida_em = concluidaValor;
                break;
              }
            }
          }

          // Atualiza gr√°ficos que dependem desses arrays (mantendo modal aberto)
          try {
            if (typeof gerarGrafico === 'function' && typeof dadosGlobaisCompletos !== 'undefined') gerarGrafico(dadosGlobaisCompletos);
            if (typeof gerarGraficoNotasPorUsuario === 'function' && typeof dadosGlobais !== 'undefined') await gerarGraficoNotasPorUsuario(dadosGlobais);
            // Atualizar gr√°fico de notas conclu√≠das quando pertinente
            if (typeof gerarGraficoConcluidas === 'function') {
              const mesSel = document.getElementById('filtroMesConcluidas')?.value || null;
              gerarGraficoConcluidas(typeof dadosGlobaisCompletos !== 'undefined' ? dadosGlobaisCompletos : dadosGlobais, mesSel);
            }
          } catch (e) {
            console.warn('Erro ao atualizar gr√°ficos localmente:', e);
          }

          alert('Altera√ß√µes salvas com sucesso! (modal permanece aberto)');
        }
      } catch (error) {
        console.error('Erro ao atualizar status/conclu√≠do:', error);
        alert('Erro ao atualizar: ' + error.message);
      }
    };

    window.atualizarConcluidoPor = async function (id) {
      // Atualiza somente a partir do input do modal
      const input = document.getElementById(`modal_concluido_${id}`);
      if (!input) {
        alert('Campo Conclu√≠do Por no modal n√£o encontrado. Abra o modal para editar.');
        return;
      }

      const novoValor = input.value;

      try {
        const { error } = await supabaseClient
          .from('indices')
          .update({ concluido_por: novoValor })
          .eq('id', id);

        if (error) {
          console.error('Erro ao atualizar Conclu√≠do Por:', error);
          alert('Erro ao atualizar: ' + error.message);
        } else {
          alert('Conclu√≠do Por atualizado com sucesso!');
          carregarDados();
        }
      } catch (error) {
        console.error('Erro ao atualizar Conclu√≠do Por:', error);
        alert('Erro ao atualizar: ' + error.message);
      }
    };

    window.fecharModalNotas = function () {
      document.getElementById('modalNotas').style.display = 'none';
    };

    // Fun√ß√£o para ativar o bot√£o clicado
    window.ativarBotao = function(botaoId) {
      // Lista de todos os bot√µes
      const botoes = ['btnMedidas0034', 'btnNotasAndamento', 'btnNotasConcluidas', 'btnPrazosAnalise', 'btnProdutividade', 'btnExibirTabelaNotas'];
      
      // Resetar todos os bot√µes para a cor verde
      botoes.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.style.background = '#2e7d32';
        }
      });
      
      // Ativar o bot√£o clicado com a cor laranja (mesma do hover do cabe√ßalho)
      const botaoAtivo = document.getElementById(botaoId);
      if (botaoAtivo) {
        botaoAtivo.style.background = 'linear-gradient(145deg, #ff9f68, #ffb088)';
      }
    };

    // Fun√ß√£o para exibir gr√°ficos de "Medidas 0034"
    window.exibirMedidas0034 = function () {
      ativarBotao('btnMedidas0034');
      // Mostrar apenas os gr√°ficos de Medidas 0034
      document.getElementById('graficoMedidas0034').style.display = 'block';
      document.getElementById('graficoPrazoMedio0034').style.display = 'block';
      // Ocultar todos os outros gr√°ficos
      document.getElementById('graficoOutrosTipos').style.display = 'none';
      document.getElementById('graficoFimPlanejado').style.display = 'none';
      document.getElementById('graficoSemGeracoes').style.display = 'none';
      document.getElementById('graficoMiniGeracao').style.display = 'none';
      document.getElementById('graficoTextoMedidas').style.display = 'none';
      document.getElementById('graficoConcluidas').style.display = 'none';
      document.getElementById('graficoPrazoMedioGeral').style.display = 'none';
      document.getElementById('graficoPrazoMedioCarga').style.display = 'none';
      document.getElementById('graficoPrazoMedioGD').style.display = 'none';
      document.getElementById('graficoNotasPorUsuario').style.display = 'none';
      document.getElementById('graficoAprovacaoReprovacaoPorUsuario').style.display = 'none';
      document.getElementById('graficoNotasConcluidasPorDiaUsuario').style.display = 'none';
      document.getElementById('graficoNotasConcluidasPorMes').style.display = 'none';
      document.getElementById('graficoConcluidasPorTipoSolicitacao').style.display = 'none';
      document.getElementById('graficoConcluidasPorTipoDemais').style.display = 'none';
      document.getElementById('secaoDadosCadastrados').style.display = 'none';
      
      // Gerar os gr√°ficos se houver dados
      const dados = typeof dadosGlobaisCompletos !== 'undefined' && dadosGlobaisCompletos.length > 0 
        ? dadosGlobaisCompletos 
        : dadosGlobais;
      
      if (dados && dados.length > 0) {
        gerarGraficoMedidas0034(dados);
        popularFiltroDescricoesPrazo0034(dados);
        popularFiltroAnoPrazo0034(dados);
        gerarGraficoPrazoMedio0034(dados);
      }
    };

    // Fun√ß√£o para exibir gr√°ficos de "Notas em Andamento"
    window.exibirNotasAndamento = function () {
      ativarBotao('btnNotasAndamento');
      // Mostrar os gr√°ficos
      document.getElementById('graficoOutrosTipos').style.display = 'block';
      document.getElementById('graficoFimPlanejado').style.display = 'block';
      document.getElementById('graficoSemGeracoes').style.display = 'block';
      document.getElementById('graficoMiniGeracao').style.display = 'block';
      document.getElementById('graficoTextoMedidas').style.display = 'block';
      // Ocultar outros gr√°ficos
      document.getElementById('graficoMedidas0034').style.display = 'none';
      document.getElementById('graficoPrazoMedio0034').style.display = 'none';
      document.getElementById('graficoConcluidas').style.display = 'none';
      document.getElementById('graficoPrazoMedioGeral').style.display = 'none';
      document.getElementById('graficoPrazoMedioCarga').style.display = 'none';
      document.getElementById('graficoPrazoMedioGD').style.display = 'none';
      document.getElementById('graficoNotasPorUsuario').style.display = 'none';
      document.getElementById('graficoAprovacaoReprovacaoPorUsuario').style.display = 'none';
      document.getElementById('graficoNotasConcluidasPorDiaUsuario').style.display = 'none';
      document.getElementById('graficoNotasConcluidasPorMes').style.display = 'none';
      document.getElementById('graficoConcluidasPorTipoSolicitacao').style.display = 'none';
      document.getElementById('graficoConcluidasPorTipoDemais').style.display = 'none';
      document.getElementById('secaoDadosCadastrados').style.display = 'none';
    };

    // Fun√ß√£o para exibir gr√°ficos de "Notas Conclu√≠das"
    window.exibirNotasConcluidas = function () {
      ativarBotao('btnNotasConcluidas');
      // Mostrar apenas o gr√°fico de notas conclu√≠das
      document.getElementById('graficoConcluidas').style.display = 'block';
      document.getElementById('graficoNotasConcluidasPorMes').style.display = 'block';
      document.getElementById('graficoConcluidasPorTipoSolicitacao').style.display = 'block';
      document.getElementById('graficoConcluidasPorTipoDemais').style.display = 'block';
      // Ocultar outros gr√°ficos
      document.getElementById('graficoMedidas0034').style.display = 'none';
      document.getElementById('graficoPrazoMedio0034').style.display = 'none';
      document.getElementById('graficoOutrosTipos').style.display = 'none';
      document.getElementById('graficoFimPlanejado').style.display = 'none';
      document.getElementById('graficoSemGeracoes').style.display = 'none';
      document.getElementById('graficoMiniGeracao').style.display = 'none';
      document.getElementById('graficoTextoMedidas').style.display = 'none';
      document.getElementById('graficoPrazoMedioGeral').style.display = 'none';
      document.getElementById('graficoPrazoMedioCarga').style.display = 'none';
      document.getElementById('graficoPrazoMedioGD').style.display = 'none';
      document.getElementById('graficoNotasPorUsuario').style.display = 'none';
      document.getElementById('graficoAprovacaoReprovacaoPorUsuario').style.display = 'none';
      document.getElementById('graficoNotasConcluidasPorDiaUsuario').style.display = 'none';
      document.getElementById('secaoDadosCadastrados').style.display = 'none';
      
      // Popular os meses e gerar o gr√°fico com a sele√ß√£o autom√°tica - usando apenas c√≥digos 0040-0045
      const dadosTodos = typeof dadosGlobaisCompletos !== 'undefined' ? dadosGlobaisCompletos : dadosGlobais;
      const dados = filtrarDadosCodigosPadrao(dadosTodos);
      if (typeof popularFiltroMeses === 'function') {
        popularFiltroMeses(dados);
      }
    };

    // Fun√ß√£o para exibir gr√°ficos de "Prazos de An√°lise"
    window.exibirPrazosAnalise = function () {
      ativarBotao('btnPrazosAnalise');
      // Mostrar os 3 gr√°ficos de prazo
      document.getElementById('graficoPrazoMedioGeral').style.display = 'block';
      document.getElementById('graficoPrazoMedioCarga').style.display = 'block';
      document.getElementById('graficoPrazoMedioGD').style.display = 'block';
      // Ocultar outros gr√°ficos
      document.getElementById('graficoMedidas0034').style.display = 'none';
      document.getElementById('graficoPrazoMedio0034').style.display = 'none';
      document.getElementById('graficoOutrosTipos').style.display = 'none';
      document.getElementById('graficoFimPlanejado').style.display = 'none';
      document.getElementById('graficoSemGeracoes').style.display = 'none';
      document.getElementById('graficoMiniGeracao').style.display = 'none';
      document.getElementById('graficoTextoMedidas').style.display = 'none';
      document.getElementById('graficoConcluidas').style.display = 'none';
      document.getElementById('graficoNotasPorUsuario').style.display = 'none';
      document.getElementById('graficoAprovacaoReprovacaoPorUsuario').style.display = 'none';
      document.getElementById('graficoNotasConcluidasPorDiaUsuario').style.display = 'none';
      document.getElementById('graficoNotasConcluidasPorMes').style.display = 'none';
      document.getElementById('graficoConcluidasPorTipoSolicitacao').style.display = 'none';
      document.getElementById('graficoConcluidasPorTipoDemais').style.display = 'none';
      document.getElementById('secaoDadosCadastrados').style.display = 'none';

      // Popular os filtros de ano e gerar os gr√°ficos
      const dados = typeof dadosGlobaisCompletos !== 'undefined' && dadosGlobaisCompletos.length > 0 
        ? dadosGlobaisCompletos 
        : dadosGlobais;
      
      if (dados && dados.length > 0) {
        popularFiltroAnoPrazoMedio(dados);
        gerarGraficoPrazoMedio(dados);
        
        popularFiltroAnoPrazoMedioExceto(dados);
        gerarGraficoPrazoMedioExceto(dados);
        
        popularFiltroAnoPrazoMedioMiniMicro(dados);
        gerarGraficoPrazoMedioMiniMicro(dados);
      }
    };

    // Fun√ß√£o para exibir gr√°ficos de "Produtividade"
    window.exibirProdutividade = function () {
      ativarBotao('btnProdutividade');
      // Mostrar os gr√°ficos de produtividade
      document.getElementById('graficoNotasPorUsuario').style.display = 'block';
      document.getElementById('graficoAprovacaoReprovacaoPorUsuario').style.display = 'block';
      document.getElementById('graficoNotasConcluidasPorDiaUsuario').style.display = 'block';
      // Ocultar outros gr√°ficos
      document.getElementById('graficoMedidas0034').style.display = 'none';
      document.getElementById('graficoPrazoMedio0034').style.display = 'none';
      document.getElementById('graficoNotasConcluidasPorMes').style.display = 'none';
      document.getElementById('graficoConcluidasPorTipoSolicitacao').style.display = 'none';
      document.getElementById('graficoConcluidasPorTipoDemais').style.display = 'none';
      document.getElementById('graficoFimPlanejado').style.display = 'none';
      document.getElementById('graficoSemGeracoes').style.display = 'none';
      document.getElementById('graficoMiniGeracao').style.display = 'none';
      document.getElementById('graficoTextoMedidas').style.display = 'none';
      document.getElementById('graficoConcluidas').style.display = 'none';
      document.getElementById('graficoPrazoMedioGeral').style.display = 'none';
      document.getElementById('graficoPrazoMedioCarga').style.display = 'none';
      document.getElementById('graficoPrazoMedioGD').style.display = 'none';
      document.getElementById('graficoConcluidasPorTipoDemais').style.display = 'none';
      document.getElementById('secaoDadosCadastrados').style.display = 'none';
    };

    // Fun√ß√£o para exibir tabela de notas
    window.exibirTabelaNotas = function () {
      ativarBotao('btnExibirTabelaNotas');
      // Ocultar todos os gr√°ficos
      document.getElementById('graficoMedidas0034').style.display = 'none';
      document.getElementById('graficoPrazoMedio0034').style.display = 'none';
      document.getElementById('graficoNotasPorUsuario').style.display = 'none';
      document.getElementById('graficoAprovacaoReprovacaoPorUsuario').style.display = 'none';
      document.getElementById('graficoNotasConcluidasPorDiaUsuario').style.display = 'none';
      document.getElementById('graficoNotasConcluidasPorMes').style.display = 'none';
      document.getElementById('graficoConcluidasPorTipoSolicitacao').style.display = 'none';
      document.getElementById('graficoConcluidasPorTipoDemais').style.display = 'none';
      document.getElementById('graficoFimPlanejado').style.display = 'none';
      document.getElementById('graficoSemGeracoes').style.display = 'none';
      document.getElementById('graficoMiniGeracao').style.display = 'none';
      document.getElementById('graficoTextoMedidas').style.display = 'none';
      document.getElementById('graficoConcluidas').style.display = 'none';
      document.getElementById('graficoPrazoMedioGeral').style.display = 'none';
      document.getElementById('graficoPrazoMedioCarga').style.display = 'none';
      document.getElementById('graficoPrazoMedioGD').style.display = 'none';
      
      // Exibir a se√ß√£o de Dados Cadastrados
      document.getElementById('secaoDadosCadastrados').style.display = 'block';
    };

    // Fun√ß√£o para abrir modal com notas SEM possibilidade de edi√ß√£o
    window.abrirModalNotasSemEdicao = function (notas, titulo) {
      const modal = document.getElementById('modalNotas');
      const tituloEl = document.getElementById('modalTitulo');
      const conteudo = document.getElementById('modalConteudo');

      tituloEl.textContent = `${titulo} (${notas.length} notas)`;

      if (notas.length === 0) {
        conteudo.innerHTML = '<p style="text-align: center; color: #666;">Nenhuma nota encontrada.</p>';
      } else {
        let html = '<table style="width: 100%; border-collapse: collapse;">';
        html += '<thead><tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Nota</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Regional</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Cidade</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">C√≥digo Medidas</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Texto Medidas</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Descri√ß√£o</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Status Usu√°rio</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Conclu√≠do Por</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Conclu√≠da Em</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Respons√°vel</th>';
        html += '</tr></thead><tbody>';

        notas.forEach((nota, index) => {
          const bgColor = index % 2 === 0 ? '#fff' : '#f9f9f9';
          html += `<tr style="background: ${bgColor}; border-bottom: 1px solid #eee;">`;
          html += `<td style="padding: 10px;">${nota.nota || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.regional || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.cidade || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.codigo_medidas || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.texto_medidas || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.descricao || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.status_usuario || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.concluido_por || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.concluida_em || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.responsavel || ''}</td>`;
          html += '</tr>';
        });

        html += '</tbody></table>';
        conteudo.innerHTML = html;
      }

      modal.style.display = 'block';
    };

    // Fechar modal ao clicar fora dele
    window.onclick = function (event) {
      const modal = document.getElementById('modalNotas');
      if (event.target === modal) {
        fecharModalNotas();
      }
    };

    window.carregarDados = async function () {
      try {
        // Buscar todos os registros usando pagina√ß√£o (Supabase tem limite de 1000 por padr√£o)
        let todosOsDados = [];
        let inicio = 0;
        const tamanhoPagina = 1000;
        let temMaisDados = true;

        console.log('Iniciando carregamento de dados com pagina√ß√£o...');

        while (temMaisDados) {
          const { data, error } = await supabaseClient
            .from('indices')
            .select('*')
            .order('fim_planejado', { ascending: true })
            .range(inicio, inicio + tamanhoPagina - 1);

          if (error) {
            console.error('Erro ao carregar dados:', error);
            return;
          }

          if (data && data.length > 0) {
            todosOsDados = todosOsDados.concat(data);
            console.log(`P√°gina carregada: ${inicio} a ${inicio + data.length}, Total acumulado: ${todosOsDados.length}`);
            inicio += tamanhoPagina;
            temMaisDados = data.length === tamanhoPagina;
          } else {
            temMaisDados = false;
          }
        }

        console.log('Total de registros carregados:', todosOsDados.length);

        // Armazenar dados globalmente
        dadosGlobais = todosOsDados;
        dadosGlobaisCompletos = todosOsDados;

        const dadosCodigosPadrao = filtrarDadosCodigosPadrao(todosOsDados);

        exibirDados(todosOsDados);

        // Popular filtro de descri√ß√µes e de meses ANTES de gerar o gr√°fico
        popularFiltroDescricoes(dadosCodigosPadrao);
        popularFiltroDescricoesMedidas0034(todosOsDados);
        popularFiltroMesesFimPlanejado(dadosCodigosPadrao);
        popularFiltroMeses(dadosCodigosPadrao);
        popularFiltroCodigoMedidas(dadosCodigosPadrao);
        popularFiltroCodigoMedidasConcluidas(dadosCodigosPadrao);
        popularFiltroStatusFimPlanejado(dadosCodigosPadrao);

        // Gerar gr√°fico DEPOIS de popular os filtros
        gerarGrafico(dadosCodigosPadrao);

        popularFiltroAnoPrazoMedio(dadosCodigosPadrao);
        gerarGraficoPrazoMedio(dadosCodigosPadrao);
        popularFiltroDescricoesPrazo(dadosCodigosPadrao);
        popularFiltroCodigoMedidasPrazo(dadosCodigosPadrao);

        popularFiltroAnoPrazoMedioExceto(dadosCodigosPadrao);
        gerarGraficoPrazoMedioExceto(dadosCodigosPadrao);
        popularFiltroDescricoesPrazoExceto(dadosCodigosPadrao);
        popularFiltroCodigoMedidasPrazoExceto(dadosCodigosPadrao);

        popularFiltroAnoPrazoMedioMiniMicro(dadosCodigosPadrao);
        gerarGraficoPrazoMedioMiniMicro(dadosCodigosPadrao);
        popularFiltroDescricoesPrazoMiniMicro(dadosCodigosPadrao);
        popularFiltroCodigoMedidasPrazoMiniMicro(dadosCodigosPadrao);

        gerarGraficoMiniGeracao(dadosCodigosPadrao);
        popularFiltroCodigoMedidasMiniGeracao(dadosCodigosPadrao);

        gerarGraficoOutrosTipos(dadosCodigosPadrao);
        popularFiltroCodigoMedidasSemGeracoes(dadosCodigosPadrao);

        gerarGraficoTextoMedidas(dadosCodigosPadrao);

        gerarGraficoMedidas0034(todosOsDados);

        gerarGraficoSemGeracoes(dadosCodigosPadrao);

        popularFiltroDescricoesNotasPorUsuario(dadosCodigosPadrao);
        popularFiltroMesesNotasPorUsuario(dadosCodigosPadrao);
        popularFiltroCodigoMedidasNotasPorUsuario(dadosCodigosPadrao);
        await gerarGraficoNotasPorUsuario(dadosCodigosPadrao);

        popularFiltroDescricoesAprovacaoReprovacao(dadosCodigosPadrao);
        popularFiltroMesesAprovacaoReprovacao(dadosCodigosPadrao);
        popularFiltroCodigoMedidasAprovacaoReprovacao(dadosCodigosPadrao);
        await gerarGraficoAprovacaoReprovacaoPorUsuario(dadosCodigosPadrao);

        popularFiltroMesesNotasConcluidasPorDiaUsuario(dadosCodigosPadrao);
        popularFiltroUsuariosNotasConcluidasPorDia(dadosCodigosPadrao);
        await gerarGraficoNotasConcluidasPorDiaUsuario(dadosCodigosPadrao);

        popularFiltroAnoNotasConcluidasPorMes(todosOsDados);
        gerarGraficoNotasConcluidasPorMes(dadosCodigosPadrao);

        popularFiltroAnoConcluidasPorTipoSolicitacao(dadosCodigosPadrao);
        gerarGraficoConcluidasPorTipoSolicitacao(dadosCodigosPadrao);

        popularFiltroAnoConcluidasPorTipoDemais(dadosCodigosPadrao);
        gerarGraficoConcluidasPorTipoDemais(dadosCodigosPadrao);
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
      }
    };

    function filtrarDadosCodigosPadrao(dados) {
      const codigosPermitidos = new Set(['0040', '0041', '0042', '0045']);
      return (dados || []).filter(item => {
        const codigoMedidas = (item.codigo_medidas || '').trim();
        return codigosPermitidos.has(codigoMedidas);
      });
    }

    window.exibirDados = function (dados) {
      const tbody = document.getElementById('tabelaBody');

      if (!dados || dados.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="13" style="text-align: center; padding: 20px; color: #999;">
              Nenhum dado cadastrado. Fa√ßa upload de um arquivo Excel para come√ßar.
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = dados.map(item => `
        <tr id="row_${item.id}" style="border-bottom: 1px solid #eee;">
          <td style="padding: 12px;">${item.nota || ''}</td>
          <td style="padding: 12px;">${item.area_operacional || ''}</td>
          <td style="padding: 12px;">${item.cidade || ''}</td>
          <td style="padding: 12px;">${item.codigo_medidas || ''}</td>
          <td style="padding: 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${item.descricao || ''}">${item.descricao || ''}</td>
          <td style="padding: 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${item.texto_medidas || ''}">${item.texto_medidas || ''}</td>
          <td id="status_cell_${item.id}" style="padding: 12px;">${item.status_usuario || ''}</td>
          <td style="padding: 12px;">${item.inicio_planejado || ''}</td>
          <td style="padding: 12px;">${item.fim_planejado || ''}</td>
          <td id="concluido_cell_${item.id}" style="padding: 12px;">${item.concluido_por || ''}</td>
          <td style="padding: 12px;">${item.concluida_em || ''}</td>
          <td style="padding: 12px;">${item.modificado_por || ''}</td>
          <td style="padding: 12px; text-align: center;">
            <button onclick="excluirRegistro(${item.id})" 
              style="background: #dc3545; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
              üóëÔ∏è Excluir
            </button>
          </td>
        </tr>
      `).join('');
    };

    window.excluirRegistro = async function (id) {
      if (!confirm('Tem certeza que deseja excluir este registro?')) return;

      const { error } = await supabaseClient
        .from('indices')
        .delete()
        .eq('id', id);

      if (error) {
        alert('Erro ao excluir: ' + error.message);
      } else {
        alert('Registro exclu√≠do com sucesso!');
        carregarDados();
      }
    };

    window.limparTabela = async function () {
      if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° excluir TODOS os dados da tabela. Deseja continuar?')) return;

      if (!confirm('Tem certeza ABSOLUTA? Esta a√ß√£o n√£o pode ser desfeita!')) return;

      const { error } = await supabaseClient
        .from('indices')
        .delete()
        .neq('id', 0);

      if (error) {
        alert('Erro ao limpar tabela: ' + error.message);
      } else {
        alert('Tabela limpa com sucesso!');
        carregarDados();
      }
    };

    window.aplicarFiltros = async function () {
      const filtroNota = document.getElementById('filtroNota').value.toLowerCase();
      const filtroCidade = document.getElementById('filtroCidade').value.toLowerCase();
      const filtroStatus = document.getElementById('filtroStatus').value.toLowerCase();

      const buildQuery = () => {
        let query = supabaseClient.from('indices').select('*');

        if (filtroNota) {
          query = query.ilike('nota', `%${filtroNota}%`);
        }
        if (filtroCidade) {
          query = query.ilike('cidade', `%${filtroCidade}%`);
        }
        if (filtroStatus) {
          query = query.ilike('status_usuario', `%${filtroStatus}%`);
        }

        return query;
      };

      // Buscar todos os dados filtrados com pagina√ß√£o
      let dadosFiltrados = [];
      let inicio = 0;
      const tamanhoPagina = 1000;
      let temMaisDados = true;
      let ultimoErro = null;

      while (temMaisDados) {
        const { data: pagina, error } = await buildQuery()
          .order('fim_planejado', { ascending: true })
          .range(inicio, inicio + tamanhoPagina - 1);

        if (error) {
          ultimoErro = error;
          break;
        }

        if (pagina && pagina.length > 0) {
          dadosFiltrados = dadosFiltrados.concat(pagina);
          inicio += tamanhoPagina;
          temMaisDados = pagina.length === tamanhoPagina;
        } else {
          temMaisDados = false;
        }
      }

      if (ultimoErro) {
        alert('Erro ao aplicar filtros: ' + ultimoErro.message);
      } else {
        // Armazenar dados globalmente
        dadosGlobais = dadosFiltrados;

        console.log('Dados carregados, total:', dadosFiltrados.length);
        console.log('Primeira descri√ß√£o:', dadosFiltrados[0]?.descricao);

        exibirDados(dadosFiltrados);

        // Buscar dados completos com pagina√ß√£o
        let todosOsDadosCompletos = [];
        let inicio = 0;
        const tamanhoPagina = 1000;
        let temMaisDados = true;

        while (temMaisDados) {
          const { data: dataCompleta, error: errorCompleta } = await supabaseClient
            .from('indices')
            .select('*')
            .order('fim_planejado', { ascending: true })
            .range(inicio, inicio + tamanhoPagina - 1);

          if (errorCompleta) {
            console.error('Erro ao carregar dados completos:', errorCompleta);
            break;
          }

          if (dataCompleta && dataCompleta.length > 0) {
            todosOsDadosCompletos = todosOsDadosCompletos.concat(dataCompleta);
            inicio += tamanhoPagina;
            temMaisDados = dataCompleta.length === tamanhoPagina;
          } else {
            temMaisDados = false;
          }
        }

        dadosGlobaisCompletos = todosOsDadosCompletos.length > 0 ? todosOsDadosCompletos : dadosFiltrados;

        gerarGrafico(dadosGlobaisCompletos);

        // Popular filtro de descri√ß√µes e de meses
        console.log('Chamando popularFiltroDescricoes...');
        popularFiltroDescricoes(dadosGlobaisCompletos);
        console.log('Chamando popularFiltroMeses...');
        popularFiltroMesesFimPlanejado(dadosFiltrados);
        popularFiltroMeses(dadosFiltrados);
        popularFiltroCodigoMedidas(dadosGlobaisCompletos);
        popularFiltroStatusFimPlanejado(dadosGlobaisCompletos);

        gerarGraficoPrazoMedio(dadosFiltrados);
        popularFiltroDescricoesPrazo(dadosFiltrados);
        popularFiltroCodigoMedidasPrazo(dadosFiltrados);

        gerarGraficoPrazoMedioExceto(dadosFiltrados);
        popularFiltroDescricoesPrazoExceto(dadosFiltrados);
        popularFiltroCodigoMedidasPrazoExceto(dadosFiltrados);

        gerarGraficoPrazoMedioMiniMicro(dadosFiltrados);
        popularFiltroDescricoesPrazoMiniMicro(dadosFiltrados);
        popularFiltroCodigoMedidasPrazoMiniMicro(dadosFiltrados);

        gerarGraficoMiniGeracao(dadosFiltrados);
        popularFiltroCodigoMedidasMiniGeracao(dadosFiltrados);

        gerarGraficoOutrosTipos(dadosFiltrados);
        popularFiltroCodigoMedidasSemGeracoes(dadosFiltrados);

        gerarGraficoSemGeracoes(dadosFiltrados);

        popularFiltroDescricoesNotasPorUsuario(dadosFiltrados);
        popularFiltroMesesNotasPorUsuario(dadosFiltrados);
        popularFiltroCodigoMedidasNotasPorUsuario(dadosFiltrados);
        await gerarGraficoNotasPorUsuario(dadosFiltrados);
      }
    };

    window.limparFiltros = function () {
      document.getElementById('filtroNota').value = '';
      document.getElementById('filtroCidade').value = '';
      document.getElementById('filtroStatus').value = '';
      carregarDados();
    };

    // Fun√ß√£o para toggle dropdown de descri√ß√µes
    window.toggleDropdownDescricoes = function () {
      const container = document.getElementById('containerCheckboxesDescricoes');
      const botao = document.getElementById('botaoToggleDescricoes');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de descri√ß√µes - Medidas 0034
    window.toggleDropdownDescricoesMedidas0034 = function () {
      const container = document.getElementById('containerCheckboxesDescricoesMedidas0034');
      const botao = document.getElementById('botaoToggleDescricoesMedidas0034');

      if (!container || !botao) {
        return;
      }

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de descri√ß√µes do Prazo 0034
    window.toggleDropdownDescricoesPrazo0034 = function () {
      const container = document.getElementById('containerCheckboxesDescricoesPrazo0034');
      const botao = document.getElementById('botaoToggleDescricoesPrazo0034');

      if (!container || !botao) {
        return;
      }

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de descri√ß√µes do Prazo M√©dio
    window.toggleDropdownDescricoesPrazo = function () {
      const container = document.getElementById('containerCheckboxesDescricoesPrazo');
      const botao = document.getElementById('botaoToggleDescricoesPrazo');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de descri√ß√µes do Prazo M√©dio - Exceto Mini/Micro
    window.toggleDropdownDescricoesPrazoExceto = function () {
      const container = document.getElementById('containerCheckboxesDescricoesPrazoExceto');
      const botao = document.getElementById('botaoToggleDescricoesPrazoExceto');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de descri√ß√µes do Prazo M√©dio - Mini/Micro
    window.toggleDropdownDescricoesPrazoMiniMicro = function () {
      const container = document.getElementById('containerCheckboxesDescricoesPrazoMiniMicro');
      const botao = document.getElementById('botaoToggleDescricoesPrazoMiniMicro');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de descri√ß√µes do gr√°fico de Notas por Usu√°rio
    window.toggleDropdownDescricoesNotasPorUsuario = function () {
      const container = document.getElementById('containerCheckboxesDescricoesNotasPorUsuario');
      const botao = document.getElementById('botaoToggleDescricoesNotasPorUsuario');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de C√≥digo Medidas do gr√°fico de Notas por Usu√°rio
    window.toggleDropdownCodigoMedidasNotasPorUsuario = function () {
      const container = document.getElementById('containerCheckboxesCodigoMedidasNotasPorUsuario');
      const botao = document.getElementById('botaoToggleCodigoMedidasNotasPorUsuario');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de C√≥digo Medidas do gr√°fico de Fim Planejado
    window.toggleDropdownCodigoMedidas = function () {
      const container = document.getElementById('containerCheckboxesCodigoMedidas');
      const botao = document.getElementById('botaoToggleCodigoMedidas');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de Status do gr√°fico de Fim Planejado
    window.toggleDropdownStatusFimPlanejado = function () {
      const container = document.getElementById('containerCheckboxesStatusFimPlanejado');
      const botao = document.getElementById('botaoToggleStatusFimPlanejado');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de C√≥digo Medidas do gr√°fico de Conclu√≠das
    window.toggleDropdownCodigoMedidasConcluidas = function () {
      const container = document.getElementById('containerCheckboxesCodigoMedidasConcluidas');
      const botao = document.getElementById('botaoToggleCodigoMedidasConcluidas');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de C√≥digo Medidas do Prazo M√©dio (CONC)
    window.toggleDropdownCodigoMedidasPrazo = function () {
      const container = document.getElementById('containerCheckboxesCodigoMedidasPrazo');
      const botao = document.getElementById('botaoToggleCodigoMedidasPrazo');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de C√≥digo Medidas do Prazo M√©dio - Exceto Mini/Micro
    window.toggleDropdownCodigoMedidasPrazoExceto = function () {
      const container = document.getElementById('containerCheckboxesCodigoMedidasPrazoExceto');
      const botao = document.getElementById('botaoToggleCodigoMedidasPrazoExceto');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de C√≥digo Medidas do Prazo M√©dio - Mini/Micro
    window.toggleDropdownCodigoMedidasPrazoMiniMicro = function () {
      const container = document.getElementById('containerCheckboxesCodigoMedidasPrazoMiniMicro');
      const botao = document.getElementById('botaoToggleCodigoMedidasPrazoMiniMicro');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de C√≥digo Medidas do gr√°fico Mini Gera√ß√£o
    window.toggleDropdownCodigoMedidasMiniGeracao = function () {
      const container = document.getElementById('containerCheckboxesCodigoMedidasMiniGeracao');
      const botao = document.getElementById('botaoToggleCodigoMedidasMiniGeracao');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de C√≥digo Medidas do gr√°fico Sem Mini/Micro Gera√ß√£o
    window.toggleDropdownCodigoMedidasSemGeracoes = function () {
      const container = document.getElementById('containerCheckboxesCodigoMedidasSemGeracoes');
      const botao = document.getElementById('botaoToggleCodigoMedidasSemGeracoes');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para popular o filtro de descri√ß√µes do gr√°fico de Fim Planejado com checkboxes
    window.popularFiltroDescricoes = function (dados) {
      console.log('=== INICIANDO popularFiltroDescricoes ===');
      console.log('Total de dados recebidos:', dados?.length || 0);

      if (!dados || dados.length === 0) {
        console.warn('Sem dados para popular filtro de descri√ß√µes');
        return;
      }

      const descricoes = new Set();

      dados.forEach((item, idx) => {
        const descricao = item.descricao || item.Descri√ß√£o || '';
        if (descricao) {
          descricoes.add(descricao);
        }
      });

      console.log('Descri√ß√µes encontradas:', Array.from(descricoes));
      console.log('Total de descri√ß√µes √∫nicas:', descricoes.size);

      const container = document.getElementById('containerCheckboxesDescricoes');
      console.log('Container encontrado?', !!container);

      if (!container) {
        console.error('‚ùå Container "containerCheckboxesDescricoes" n√£o encontrado!');
        return;
      }

      container.innerHTML = ''; // Limpar conte√∫do anterior

      // Adicionar checkboxes para cada descri√ß√£o
      const descricoesArray = Array.from(descricoes).sort();

      descricoesArray.forEach((desc, index) => {
        const checkboxId = 'checkbox_desc_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = desc;
        checkbox.checked = true; // Come√ßar marcado por padr√£o
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function () {
          console.log('Checkbox alterado:', desc, 'Marcado:', this.checked);
          aplicarFiltroDescricaoFimPlanejado();
        };

        const span = document.createElement('span');
        span.textContent = desc;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });

      console.log('‚úÖ Checkboxes criados com sucesso! Total:', descricoesArray.length);
    };

    // Fun√ß√£o para popular o filtro de descri√ß√µes do gr√°fico Medidas 0034
    window.popularFiltroDescricoesMedidas0034 = function (dados) {
      if (!dados || dados.length === 0) {
        return;
      }

      const descricoes = new Set();

      dados.forEach(item => {
        const descricao = (item.descricao || '').trim();
        const codigoMedidas = (item.codigo_medidas || '').trim();
        const eh0034 = descricao.includes('0034') || codigoMedidas === '0034';
        if (eh0034 && descricao) {
          descricoes.add(descricao);
        }
      });

      const container = document.getElementById('containerCheckboxesDescricoesMedidas0034');
      if (!container) {
        return;
      }

      container.innerHTML = '';

      const descricoesArray = Array.from(descricoes).sort();
      const descricaoInicial = 'Analisar Carga Acessante Mini Gera√ß√£o';
      const existeDescricaoInicial = descricoesArray.includes(descricaoInicial);

      descricoesArray.forEach((desc, index) => {
        const checkboxId = 'checkbox_desc_0034_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = desc;
        checkbox.checked = existeDescricaoInicial ? desc === descricaoInicial : true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function () {
          filtrarGraficoMedidas0034PorMes();
        };

        const span = document.createElement('span');
        span.textContent = desc;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    // Fun√ß√£o para popular filtro de descri√ß√£o do Prazo 0034
    window.popularFiltroDescricoesPrazo0034 = function (dados) {
      if (!dados || dados.length === 0) {
        return;
      }

      const descricoes = new Set();

      dados.forEach(item => {
        const descricao = (item.descricao || '').trim();
        const codigoMedidas = (item.codigo_medidas || '').trim();
        const eh0034 = descricao.includes('0034') || codigoMedidas === '0034';
        const status = item.status_usuario || '';
        const statusOk = (status === 'CONC CTEC' || status === 'CONC RTEC');
        if (eh0034 && statusOk && descricao) {
          descricoes.add(descricao);
        }
      });

      const container = document.getElementById('containerCheckboxesDescricoesPrazo0034');
      if (!container) {
        return;
      }

      container.innerHTML = '';

      const descricoesArray = Array.from(descricoes).sort();
      const descricaoInicial = 'Analisar Carga Acessante Mini Gera√ß√£o';
      const existeDescricaoInicial = descricoesArray.includes(descricaoInicial);

      descricoesArray.forEach((desc, index) => {
        const checkboxId = 'checkbox_desc_prazo0034_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = desc;
        checkbox.checked = existeDescricaoInicial ? desc === descricaoInicial : true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function () {
          gerarGraficoPrazoMedio0034(dadosGlobaisCompletos || dadosGlobais);
        };

        const span = document.createElement('span');
        span.textContent = desc;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    // Fun√ß√£o para aplicar filtro de descri√ß√£o com checkboxes
    window.aplicarFiltroDescricaoFimPlanejado = function () {
      gerarGrafico(dadosGlobais);
    };

    // Fun√ß√£o para popular filtro de C√≥digo Medidas - Fim Planejado
    window.popularFiltroCodigoMedidas = function (dados) {
      // Buscar todos os c√≥digos de medidas existentes no banco
      const codigos = new Set();

      dados.forEach(item => {
        const codigo = (item.codigo_medidas || '').trim();
        if (codigo) {
          codigos.add(codigo);
        }
      });

      const container = document.getElementById('containerCheckboxesCodigoMedidas');
      if (!container) {
        console.error('‚ùå Container "containerCheckboxesCodigoMedidas" n√£o encontrado!');
        return;
      }

      container.innerHTML = '';
      const codigosArray = Array.from(codigos).sort();

      codigosArray.forEach((codigo, index) => {
        const checkboxId = 'checkbox_codigo_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = codigo;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function () {
          aplicarFiltroCodigoMedidasFimPlanejado();
        };

        const span = document.createElement('span');
        span.textContent = codigo;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    // Fun√ß√£o para popular filtro de Status - Fim Planejado
    window.popularFiltroStatusFimPlanejado = function (dados) {
      const statusSet = new Set();
      dados.forEach(item => {
        const status = (item.status_usuario || item.status || item.Status || item.status_atual || '').trim().toUpperCase();
        let statusBase = status;
        if (statusBase.includes('ABER')) {
          statusBase = 'ABER';
        } else if (statusBase.includes('ANDM')) {
          statusBase = 'ANDM';
        }
        if (statusBase) {
          statusSet.add(statusBase);
        }
      });

      const container = document.getElementById('containerCheckboxesStatusFimPlanejado');
      if (!container) {
        console.error('‚ùå Container "containerCheckboxesStatusFimPlanejado" n√£o encontrado!');
        return;
      }

      container.innerHTML = '';
      const statusArray = Array.from(statusSet).sort();

      statusArray.forEach((status, index) => {
        const checkboxId = 'checkbox_status_fim_planejado_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = status;
        checkbox.checked = status === 'ABER' || status === 'ANDM';
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function () {
          aplicarFiltroStatusFimPlanejado();
        };

        const span = document.createElement('span');
        span.textContent = status;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroStatusFimPlanejado = function () {
      const dadosBase = (dadosGlobaisCompletos && dadosGlobaisCompletos.length > 0) ? dadosGlobaisCompletos : dadosGlobais;
      gerarGrafico(dadosBase);
    };

    window.aplicarFiltroCodigoMedidasFimPlanejado = function () {
      gerarGrafico(dadosGlobais);
    };

    // Fun√ß√£o para popular o filtro de descri√ß√µes do Prazo M√©dio com checkboxes
    window.popularFiltroDescricoesPrazo = function (dados) {
      console.log('=== INICIANDO popularFiltroDescricoesPrazo ===');

      const descricoes = new Set();

      dados.forEach(item => {
        const descricao = item.descricao || '';
        if (descricao) {
          descricoes.add(descricao);
        }
      });

      const container = document.getElementById('containerCheckboxesDescricoesPrazo');
      if (!container) {
        console.error('‚ùå Container "containerCheckboxesDescricoesPrazo" n√£o encontrado!');
        return;
      }

      container.innerHTML = ''; // Limpar conte√∫do anterior

      const descricoesArray = Array.from(descricoes).sort();

      descricoesArray.forEach((desc, index) => {
        const checkboxId = 'checkbox_prazo_desc_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = desc;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function () {
          aplicarFiltroDescricaoPrazo();
        };

        const span = document.createElement('span');
        span.textContent = desc;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });

      console.log('‚úÖ Checkboxes do Prazo M√©dio criados com sucesso!');
    };

    // Fun√ß√£o para aplicar filtro de descri√ß√£o ao Prazo M√©dio
    window.aplicarFiltroDescricaoPrazo = function () {
      gerarGraficoPrazoMedio(dadosGlobais);
    };

    // Fun√ß√£o para popular filtro de C√≥digo Medidas - Prazo M√©dio (CONC)
    window.popularFiltroCodigoMedidasPrazo = function (dados) {
      const codigos = new Set();
      dados.forEach(item => {
        const status = item.status_usuario || '';
        const codigo = item.codigo_medidas || '';
        if ((status === 'CONC CTEC' || status === 'CONC RTEC') && codigo && item.inicio_planejado && item.concluida_em) {
          codigos.add(codigo);
        }
      });

      const container = document.getElementById('containerCheckboxesCodigoMedidasPrazo');
      if (!container) return;

      container.innerHTML = '';
      const codigosArray = Array.from(codigos).sort();

      codigosArray.forEach((codigo, index) => {
        const checkboxId = 'checkbox_codigo_prazo_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = codigo;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function () {
          aplicarFiltroCodigoMedidasPrazo();
        };

        const span = document.createElement('span');
        span.textContent = codigo;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroCodigoMedidasPrazo = function () {
      gerarGraficoPrazoMedio(dadosGlobais);
    };

    // Fun√ß√£o para popular filtro de ano do gr√°fico Prazo M√©dio Geral
    window.popularFiltroAnoPrazoMedio = function (dados) {
      const anosSet = new Set();

      dados.forEach(item => {
        const status = item.status_usuario || '';
        const concluidaEm = item.concluida_em || '';
        const codigoMedidas = (item.codigo_medidas || '').trim();
        
        const codigosPermitidos = ['0040', '0041', '0042', '0045'];
        if (!codigosPermitidos.includes(codigoMedidas)) return;
        
        if (status !== 'CONC CTEC' && status !== 'CONC RTEC') return;
        if (!concluidaEm) return;
        
        const partes = concluidaEm.split('.');
        if (partes.length >= 3) {
          anosSet.add(partes[2]);
        }
      });

      const anosArray = Array.from(anosSet).sort((a, b) => parseInt(b, 10) - parseInt(a, 10));
      const selectAno = document.getElementById('filtroAnoPrazoMedio');
      if (!selectAno) return;

      selectAno.innerHTML = '<option value="todos">Todos</option>';

      anosArray.forEach(ano => {
        const option = document.createElement('option');
        option.value = ano;
        option.textContent = ano;
        selectAno.appendChild(option);
      });

      const anoAtual = String(new Date().getFullYear());
      if (anosArray.includes(anoAtual)) {
        selectAno.value = anoAtual;
      }
    };

    window.aplicarFiltroAnoPrazoMedio = function () {
      gerarGraficoPrazoMedio(dadosGlobais);
    };

    // Fun√ß√£o para popular filtro de ano do gr√°fico Prazo M√©dio Carga
    window.popularFiltroAnoPrazoMedioExceto = function (dados) {
      const anosSet = new Set();

      dados.forEach(item => {
        const status = item.status_usuario || '';
        const concluidaEm = item.concluida_em || '';
        const codigoMedidas = (item.codigo_medidas || '').trim();
        
        const codigosPermitidos = ['0040', '0041', '0042', '0045'];
        if (!codigosPermitidos.includes(codigoMedidas)) return;
        
        if (status !== 'CONC CTEC' && status !== 'CONC RTEC') return;
        if (!concluidaEm) return;
        
        const partes = concluidaEm.split('.');
        if (partes.length >= 3) {
          anosSet.add(partes[2]);
        }
      });

      const anosArray = Array.from(anosSet).sort((a, b) => parseInt(b, 10) - parseInt(a, 10));
      const selectAno = document.getElementById('filtroAnoPrazoMedioExceto');
      if (!selectAno) return;

      selectAno.innerHTML = '<option value="todos">Todos</option>';

      anosArray.forEach(ano => {
        const option = document.createElement('option');
        option.value = ano;
        option.textContent = ano;
        selectAno.appendChild(option);
      });

      const anoAtual = String(new Date().getFullYear());
      if (anosArray.includes(anoAtual)) {
        selectAno.value = anoAtual;
      }
    };

    window.aplicarFiltroAnoPrazoMedioExceto = function () {
      gerarGraficoPrazoMedioExceto(dadosGlobais);
    };

    // Fun√ß√£o para popular filtro de ano do gr√°fico Prazo M√©dio GD (Mini/Micro)
    window.popularFiltroAnoPrazoMedioMiniMicro = function (dados) {
      const anosSet = new Set();

      dados.forEach(item => {
        const status = item.status_usuario || '';
        const concluidaEm = item.concluida_em || '';
        const codigoMedidas = (item.codigo_medidas || '').trim();
        
        const codigosPermitidos = ['0040', '0041', '0042', '0045'];
        if (!codigosPermitidos.includes(codigoMedidas)) return;
        
        if (status !== 'CONC CTEC' && status !== 'CONC RTEC') return;
        if (!concluidaEm) return;
        
        const partes = concluidaEm.split('.');
        if (partes.length >= 3) {
          anosSet.add(partes[2]);
        }
      });

      const anosArray = Array.from(anosSet).sort((a, b) => parseInt(b, 10) - parseInt(a, 10));
      const selectAno = document.getElementById('filtroAnoPrazoMedioMiniMicro');
      if (!selectAno) return;

      selectAno.innerHTML = '<option value="todos">Todos</option>';

      anosArray.forEach(ano => {
        const option = document.createElement('option');
        option.value = ano;
        option.textContent = ano;
        selectAno.appendChild(option);
      });

      const anoAtual = String(new Date().getFullYear());
      if (anosArray.includes(anoAtual)) {
        selectAno.value = anoAtual;
      }
    };

    window.aplicarFiltroAnoPrazoMedioMiniMicro = function () {
      gerarGraficoPrazoMedioMiniMicro(dadosGlobais);
    };

    // Fun√ß√£o para popular filtro de C√≥digo Medidas - Conclu√≠das
    window.popularFiltroCodigoMedidasConcluidas = function (dados) {
      const codigos = new Set();
      dados.forEach(item => {
        const status = item.status_usuario || '';
        const codigo = item.codigo_medidas || '';
        if ((status === 'CONC CTEC' || status === 'CONC RTEC') && codigo) {
          codigos.add(codigo);
        }
      });

      const container = document.getElementById('containerCheckboxesCodigoMedidasConcluidas');
      if (!container) {
        console.error('‚ùå Container "containerCheckboxesCodigoMedidasConcluidas" n√£o encontrado!');
        return;
      }

      container.innerHTML = '';
      const codigosArray = Array.from(codigos).sort();

      codigosArray.forEach((codigo, index) => {
        const checkboxId = 'checkbox_codigo_concluidas_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = codigo;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function () {
          aplicarFiltroCodigoMedidasConcluidas();
        };

        const span = document.createElement('span');
        span.textContent = codigo;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroCodigoMedidasConcluidas = function () {
      const mesSelecionado = document.getElementById('filtroMesConcluidas')?.value || 'todos';
      gerarGraficoConcluidas(dadosGlobais, mesSelecionado);
    };

    // Fun√ß√£o para popular filtro de descri√ß√µes - Prazo M√©dio Exceto Mini/Micro
    window.popularFiltroDescricoesPrazoExceto = function (dados) {
      const descricoes = new Set();
      dados.forEach(item => {
        const descricao = item.descricao || '';
        if (descricao && !descricao.toLowerCase().includes('mini gera√ß√£o') && !descricao.toLowerCase().includes('micro gera√ß√£o')) {
          descricoes.add(descricao);
        }
      });

      const container = document.getElementById('containerCheckboxesDescricoesPrazoExceto');
      container.innerHTML = '';
      const descricoesArray = Array.from(descricoes).sort();

      descricoesArray.forEach((desc, index) => {
        const checkboxId = 'checkbox_prazo_exceto_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = desc;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = aplicarFiltroDescricaoPrazoExceto;

        const span = document.createElement('span');
        span.textContent = desc;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroDescricaoPrazoExceto = function () {
      gerarGraficoPrazoMedioExceto(dadosGlobais);
    };

    // Fun√ß√£o para popular filtro de descri√ß√µes - Prazo M√©dio Mini/Micro Gera√ß√£o
    window.popularFiltroDescricoesPrazoMiniMicro = function (dados) {
      const descricoes = new Set();
      dados.forEach(item => {
        const descricao = item.descricao || '';
        if (descricao && (descricao.toLowerCase().includes('mini gera√ß√£o') || descricao.toLowerCase().includes('micro gera√ß√£o'))) {
          descricoes.add(descricao);
        }
      });

      const container = document.getElementById('containerCheckboxesDescricoesPrazoMiniMicro');
      container.innerHTML = '';
      const descricoesArray = Array.from(descricoes).sort();

      descricoesArray.forEach((desc, index) => {
        const checkboxId = 'checkbox_prazo_minimicro_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = desc;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = aplicarFiltroDescricaoPrazoMiniMicro;

        const span = document.createElement('span');
        span.textContent = desc;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroDescricaoPrazoMiniMicro = function () {
      gerarGraficoPrazoMedioMiniMicro(dadosGlobais);
    };

    // Fun√ß√£o para popular o filtro de descri√ß√µes do gr√°fico de Notas por Usu√°rio
    window.popularFiltroDescricoesNotasPorUsuario = function (dados) {
      const descricoes = new Set();
      dados.forEach(item => {
        const descricao = item.descricao || '';
        if (descricao) {
          descricoes.add(descricao);
        }
      });

      const container = document.getElementById('containerCheckboxesDescricoesNotasPorUsuario');
      if (!container) {
        console.error('‚ùå Container "containerCheckboxesDescricoesNotasPorUsuario" n√£o encontrado!');
        return;
      }

      container.innerHTML = '';
      const descricoesArray = Array.from(descricoes).sort();

      descricoesArray.forEach((desc, index) => {
        const checkboxId = 'checkbox_notas_usuario_desc_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = desc;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function () {
          aplicarFiltroDescricaoNotasPorUsuario();
        };

        const span = document.createElement('span');
        span.textContent = desc;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroDescricaoNotasPorUsuario = async function () {
      await gerarGraficoNotasPorUsuario(dadosGlobais);
    };

    // Fun√ß√£o para popular o filtro de meses do gr√°fico de Notas por Usu√°rio (Conclu√≠da em)
    window.popularFiltroMesesNotasPorUsuario = function (dados) {
      const mesesSet = new Set();

      dados.forEach(item => {
        const concluidaEm = item.concluida_em || '';
        const status = item.status_usuario || '';
        if ((status === 'CONC CTEC' || status === 'CONC RTEC') && concluidaEm) {
          const partes = concluidaEm.split('.');
          if (partes.length >= 3) {
            const mesAno = partes[1] + '.' + partes[2];
            mesesSet.add(mesAno);
          }
        }
      });

      const mesesArray = Array.from(mesesSet).sort((a, b) => {
        const [mesA, anoA] = a.split('.');
        const [mesB, anoB] = b.split('.');
        const dataA = new Date(parseInt(anoA), parseInt(mesA) - 1);
        const dataB = new Date(parseInt(anoB), parseInt(mesB) - 1);
        return dataA - dataB;
      });

      const selectMes = document.getElementById('filtroMesNotasPorUsuario');
      if (!selectMes) return;
      selectMes.innerHTML = '<option value="todos">Todos os meses</option>';

      mesesArray.forEach(mesAno => {
        const [mes, ano] = mesAno.split('.');
        const nomeMes = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][parseInt(mes) - 1];
        const option = document.createElement('option');
        option.value = mesAno;
        option.textContent = `${nomeMes}/${ano}`;
        selectMes.appendChild(option);
      });

      // Selecionar m√™s atual ou anterior se houver dados
      const dataAtual = new Date();
      const mesAtual = String(dataAtual.getMonth() + 1).padStart(2, '0');
      const anoAtual = dataAtual.getFullYear();
      const mesAnoAtual = `${mesAtual}.${anoAtual}`;

      if (mesesArray.includes(mesAnoAtual)) {
        selectMes.value = mesAnoAtual;
      } else {
        // Se o m√™s atual n√£o tem dados, tenta o m√™s anterior
        const dataAnterior = new Date(anoAtual, parseInt(mesAtual) - 2, 1);
        const mesAnterior = String(dataAnterior.getMonth() + 1).padStart(2, '0');
        const anoAnterior = dataAnterior.getFullYear();
        const mesAnoAnterior = `${mesAnterior}.${anoAnterior}`;
        
        if (mesesArray.includes(mesAnoAnterior)) {
          selectMes.value = mesAnoAnterior;
        } else if (mesesArray.length > 0) {
          // Se tamb√©m n√£o houver m√™s anterior, usa o √∫ltimo m√™s dispon√≠vel
          selectMes.value = mesesArray[mesesArray.length - 1];
        }
      }
      
      // Gerar o gr√°fico com o m√™s selecionado
      if (typeof gerarGraficoNotasPorUsuario === 'function') {
        gerarGraficoNotasPorUsuario(dados);
      }
    };

    window.aplicarFiltroMesNotasPorUsuario = async function () {
      await gerarGraficoNotasPorUsuario(dadosGlobais);
    };

    // Fun√ß√£o para popular o filtro de C√≥digo Medidas do gr√°fico de Notas por Usu√°rio
    window.popularFiltroCodigoMedidasNotasPorUsuario = function (dados) {
      const codigos = new Set();
      dados.forEach(item => {
        const codigo = item.codigo_medidas || '';
        if (codigo) {
          codigos.add(codigo);
        }
      });

      const container = document.getElementById('containerCheckboxesCodigoMedidasNotasPorUsuario');
      if (!container) {
        console.error('‚ùå Container "containerCheckboxesCodigoMedidasNotasPorUsuario" n√£o encontrado!');
        return;
      }

      container.innerHTML = '';
      const codigosArray = Array.from(codigos).sort();

      codigosArray.forEach((codigo, index) => {
        const checkboxId = 'checkbox_notas_usuario_codigo_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = codigo;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function () {
          aplicarFiltroCodigoMedidasNotasPorUsuario();
        };

        const span = document.createElement('span');
        span.textContent = codigo;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroCodigoMedidasNotasPorUsuario = async function () {
      await gerarGraficoNotasPorUsuario(dadosGlobais);
    };

    // Fun√ß√£o para popular o filtro de ano do gr√°fico de Notas Conclu√≠das por M√™s
    window.popularFiltroAnoNotasConcluidasPorMes = function (dados) {
      const anosSet = new Set();

      dados.forEach(item => {
        const status = item.status_usuario || '';
        const textoMedidas = (item.texto_medidas || '').toUpperCase();
        const concluidaEm = item.concluida_em || '';

        const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') ||
          textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
          textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));

        const eNotaConcluida = status === 'CONC CTEC' || status === 'CONC RTEC';
        const statusValido = status !== 'ANDM' && status !== 'ABER' && status !== 'CANC';

        if (eNotaConcluida && statusValido && temAnexo && concluidaEm) {
          const partes = concluidaEm.split('.');
          if (partes.length >= 3) {
            anosSet.add(partes[2]);
          }
        }
      });

      const anosArray = Array.from(anosSet).sort((a, b) => parseInt(b, 10) - parseInt(a, 10));
      const selectAno = document.getElementById('filtroAnoNotasConcluidasPorMes');
      if (!selectAno) return;

      selectAno.innerHTML = '<option value="todos">Todos</option>';

      anosArray.forEach(ano => {
        const option = document.createElement('option');
        option.value = ano;
        option.textContent = ano;
        selectAno.appendChild(option);
      });

      const anoAtual = String(new Date().getFullYear());
      if (anosArray.includes(anoAtual)) {
        selectAno.value = anoAtual;
      }
    };

    window.aplicarFiltroAnoNotasConcluidasPorMes = function () {
      gerarGraficoNotasConcluidasPorMes(dadosGlobais);
    };

    // Fun√ß√£o para popular o filtro de ano do gr√°fico Conclu√≠das por Tipo de Solicita√ß√£o
    window.popularFiltroAnoConcluidasPorTipoSolicitacao = function (dados) {
      const anosSet = new Set();

      dados.forEach(item => {
        const status = item.status_usuario || '';
        const concluidaEm = item.concluida_em || '';
        if (status !== 'CONC CTEC' && status !== 'CONC RTEC') return;
        if (!concluidaEm) return;
        const partes = concluidaEm.split('.');
        if (partes.length >= 3) {
          anosSet.add(partes[2]);
        }
      });

      const anosArray = Array.from(anosSet).sort((a, b) => parseInt(b, 10) - parseInt(a, 10));
      const selectAno = document.getElementById('filtroAnoConcluidasPorTipoSolicitacao');
      if (!selectAno) return;

      selectAno.innerHTML = '<option value="todos">Todos</option>';

      anosArray.forEach(ano => {
        const option = document.createElement('option');
        option.value = ano;
        option.textContent = ano;
        selectAno.appendChild(option);
      });

      const anoAtual = String(new Date().getFullYear());
      if (anosArray.includes(anoAtual)) {
        selectAno.value = anoAtual;
      }
    };

    window.aplicarFiltroAnoConcluidasPorTipoSolicitacao = function () {
      gerarGraficoConcluidasPorTipoSolicitacao(dadosGlobais);
    };

    // Fun√ß√£o para popular o filtro de ano do gr√°fico Prazo M√©dio 0034
    window.popularFiltroAnoPrazo0034 = function (dados) {
      const anosSet = new Set();

      dados.forEach(item => {
        const descricao = (item.descricao || '').trim();
        const codigoMedidas = (item.codigo_medidas || '').trim();
        const eh0034 = descricao.includes('0034') || codigoMedidas === '0034';
        const status = item.status_usuario || '';
        const concluidaEm = item.concluida_em || '';
        
        if (!eh0034) return;
        if (status !== 'CONC CTEC' && status !== 'CONC RTEC') return;
        if (!concluidaEm) return;
        
        const partes = concluidaEm.split('.');
        if (partes.length >= 3) {
          anosSet.add(partes[2]);
        }
      });

      const anosArray = Array.from(anosSet).sort((a, b) => parseInt(b, 10) - parseInt(a, 10));
      const selectAno = document.getElementById('filtroAnoPrazo0034');
      if (!selectAno) return;

      selectAno.innerHTML = '<option value="todos">Todos</option>';

      anosArray.forEach(ano => {
        const option = document.createElement('option');
        option.value = ano;
        option.textContent = ano;
        selectAno.appendChild(option);
      });

      const anoAtual = String(new Date().getFullYear());
      if (anosArray.includes(anoAtual)) {
        selectAno.value = anoAtual;
      }
    };

    window.aplicarFiltroAnoPrazo0034 = function () {
      const dados = typeof dadosGlobaisCompletos !== 'undefined' && dadosGlobaisCompletos.length > 0 
        ? dadosGlobaisCompletos 
        : dadosGlobais;
      gerarGraficoPrazoMedio0034(dados);
    };

    // Fun√ß√µes de filtro para gr√°fico Conclu√≠das por Tipo Demais
    window.popularFiltroAnoConcluidasPorTipoDemais = function (dados) {
      // Coletar anos √∫nicos das notas conclusivas (CONC CTEC e CONC RTEC)
      const anos = new Set();
      dados.forEach(item => {
        const status = item.status_usuario || '';
        if ((status === 'CONC CTEC' || status === 'CONC RTEC')) {
          const concluidaEm = item.concluida_em || '';
          if (concluidaEm) {
            const partes = concluidaEm.split('.');
            if (partes.length >= 3) {
              anos.add(partes[2]);
            }
          }
        }
      });

      const anosArray = Array.from(anos).sort((a, b) => b - a);
      const selectAno = document.getElementById('filtroAnoConcluidasPorTipoDemais');
      if (!selectAno) return;

      selectAno.innerHTML = '<option value="todos">Todos</option>';
      anosArray.forEach(ano => {
        const option = document.createElement('option');
        option.value = ano;
        option.textContent = ano;
        selectAno.appendChild(option);
      });

      const anoAtual = String(new Date().getFullYear());
      if (anosArray.includes(anoAtual)) {
        selectAno.value = anoAtual;
      }
    };

    window.aplicarFiltroAnoConcluidasPorTipoDemais = function () {
      gerarGraficoConcluidasPorTipoDemais(dadosGlobais);
    };

    // Fun√ß√£o para popular filtro de C√≥digo Medidas - Prazo M√©dio Exceto Mini/Micro
    window.popularFiltroCodigoMedidasPrazoExceto = function (dados) {
      const codigos = new Set();
      dados.forEach(item => {
        const status = item.status_usuario || '';
        const codigo = item.codigo_medidas || '';
        const descricao = (item.descricao || '').toLowerCase();
        if ((status === 'CONC CTEC' || status === 'CONC RTEC') && codigo && item.inicio_planejado && item.concluida_em &&
          !descricao.includes('mini gera√ß√£o') && !descricao.includes('micro gera√ß√£o')) {
          codigos.add(codigo);
        }
      });

      const container = document.getElementById('containerCheckboxesCodigoMedidasPrazoExceto');
      if (!container) return;

      container.innerHTML = '';
      const codigosArray = Array.from(codigos).sort();

      codigosArray.forEach((codigo, index) => {
        const checkboxId = 'checkbox_codigo_prazo_exceto_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = codigo;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function () {
          aplicarFiltroCodigoMedidasPrazoExceto();
        };

        const span = document.createElement('span');
        span.textContent = codigo;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroCodigoMedidasPrazoExceto = function () {
      gerarGraficoPrazoMedioExceto(dadosGlobais);
    };

    // Fun√ß√£o para popular filtro de C√≥digo Medidas - Prazo M√©dio Mini/Micro
    window.popularFiltroCodigoMedidasPrazoMiniMicro = function (dados) {
      const codigos = new Set();
      dados.forEach(item => {
        const status = item.status_usuario || '';
        const codigo = item.codigo_medidas || '';
        const descricao = (item.descricao || '').toLowerCase();
        if ((status === 'CONC CTEC' || status === 'CONC RTEC') && codigo && item.inicio_planejado && item.concluida_em &&
          (descricao.includes('mini gera√ß√£o') || descricao.includes('micro gera√ß√£o'))) {
          codigos.add(codigo);
        }
      });

      const container = document.getElementById('containerCheckboxesCodigoMedidasPrazoMiniMicro');
      if (!container) return;

      container.innerHTML = '';
      const codigosArray = Array.from(codigos).sort();

      codigosArray.forEach((codigo, index) => {
        const checkboxId = 'checkbox_codigo_prazo_minimicro_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = codigo;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function () {
          aplicarFiltroCodigoMedidasPrazoMiniMicro();
        };

        const span = document.createElement('span');
        span.textContent = codigo;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroCodigoMedidasPrazoMiniMicro = function () {
      gerarGraficoPrazoMedioMiniMicro(dadosGlobais);
    };

    // Fun√ß√£o para popular filtro de C√≥digo Medidas - Mini Gera√ß√£o
    window.popularFiltroCodigoMedidasMiniGeracao = function (dados) {
      const codigos = new Set();
      dados.forEach(item => {
        const codigo = item.codigo_medidas || '';
        const descricao = (item.descricao || '').toLowerCase();
        if (codigo && descricao.includes('analisar carga acessante mini gera√ß√£o')) {
          codigos.add(codigo);
        }
      });

      const container = document.getElementById('containerCheckboxesCodigoMedidasMiniGeracao');
      if (!container) return;

      container.innerHTML = '';
      const codigosArray = Array.from(codigos).sort();

      codigosArray.forEach((codigo, index) => {
        const checkboxId = 'checkbox_codigo_minigeracao_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = codigo;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function () {
          aplicarFiltroCodigoMedidasMiniGeracao();
        };

        const span = document.createElement('span');
        span.textContent = codigo;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroCodigoMedidasMiniGeracao = function () {
      gerarGraficoMiniGeracao(dadosGlobais);
    };

    // Fun√ß√£o para popular filtro de C√≥digo Medidas - Sem Gera√ß√µes
    window.popularFiltroCodigoMedidasSemGeracoes = function (dados) {
      const codigos = new Set();
      dados.forEach(item => {
        const codigo = item.codigo_medidas || '';
        const descricao = (item.descricao || '').toLowerCase();
        if (codigo && !descricao.includes('mini gera√ß√£o') && !descricao.includes('micro gera√ß√£o')) {
          codigos.add(codigo);
        }
      });

      const container = document.getElementById('containerCheckboxesCodigoMedidasSemGeracoes');
      if (!container) return;

      container.innerHTML = '';
      const codigosArray = Array.from(codigos).sort();

      codigosArray.forEach((codigo, index) => {
        const checkboxId = 'checkbox_codigo_semgeracoes_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = codigo;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function () {
          aplicarFiltroCodigoMedidasSemGeracoes();
        };

        const span = document.createElement('span');
        span.textContent = codigo;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroCodigoMedidasSemGeracoes = function () {
      gerarGraficoOutrosTipos(dadosGlobais);
      gerarGraficoTextoMedidas(dadosGlobais);
      gerarGraficoSemGeracoes(dadosGlobais);
    };

    // Vari√°vel global para armazenar dados
    let dadosGlobais = [];
    let dadosGlobaisCompletos = [];

    // Fun√ß√£o para popular o filtro de meses
    window.popularFiltroMeses = function (dados) {
      const mesesSet = new Set();

      dados.forEach(item => {
        const concluidaEm = item.concluida_em || '';
        const status = item.status_usuario || '';

        if ((status === 'CONC CTEC' || status === 'CONC RTEC') && concluidaEm) {
          const partes = concluidaEm.split('.');
          if (partes.length >= 3) {
            const mesAno = partes[1] + '.' + partes[2]; // MM.YYYY
            mesesSet.add(mesAno);
          }
        }
      });

      const mesesArray = Array.from(mesesSet).sort((a, b) => {
        const [mesA, anoA] = a.split('.');
        const [mesB, anoB] = b.split('.');
        const dataA = new Date(parseInt(anoA), parseInt(mesA) - 1);
        const dataB = new Date(parseInt(anoB), parseInt(mesB) - 1);
        return dataA - dataB;
      });

      const selectMes = document.getElementById('filtroMesConcluidas');
      // Manter a op√ß√£o "Todos os meses"
      selectMes.innerHTML = '<option value="todos">Todos os meses</option>';

      // Adicionar op√ß√µes de meses
      mesesArray.forEach(mesAno => {
        const [mes, ano] = mesAno.split('.');
        const nomeMes = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][parseInt(mes) - 1];
        const option = document.createElement('option');
        option.value = mesAno;
        option.textContent = `${nomeMes}/${ano}`;
        selectMes.appendChild(option);
      });

      // Selecionar m√™s atual por padr√£o
      const dataAtual = new Date();
      const mesAtual = String(dataAtual.getMonth() + 1).padStart(2, '0');
      const anoAtual = dataAtual.getFullYear();
      const mesAnoAtual = `${mesAtual}.${anoAtual}`;

      if (mesesArray.includes(mesAnoAtual)) {
        selectMes.value = mesAnoAtual;
        gerarGraficoConcluidas(dados, mesAnoAtual);
      } else {
        // Se o m√™s atual n√£o tem dados, tenta o m√™s anterior
        const dataAnterior = new Date(anoAtual, parseInt(mesAtual) - 2, 1); // -2 porque meses s√£o 0-indexed
        const mesAnterior = String(dataAnterior.getMonth() + 1).padStart(2, '0');
        const anoAnterior = dataAnterior.getFullYear();
        const mesAnoAnterior = `${mesAnterior}.${anoAnterior}`;
        
        if (mesesArray.includes(mesAnoAnterior)) {
          selectMes.value = mesAnoAnterior;
          gerarGraficoConcluidas(dados, mesAnoAnterior);
        } else {
          // Se tamb√©m n√£o houver m√™s anterior, usa o √∫ltimo m√™s dispon√≠vel
          if (mesesArray.length > 0) {
            const ultimoMes = mesesArray[mesesArray.length - 1];
            selectMes.value = ultimoMes;
            gerarGraficoConcluidas(dados, ultimoMes);
          } else {
            gerarGraficoConcluidas(dados, 'todos');
          }
        }
      }
    };

    // Fun√ß√£o para popular o filtro de meses do gr√°fico ABER/ANDM (fim_planejado)
    window.popularFiltroMesesFimPlanejado = function (dados) {
      const mesesSet = new Set();

      dados.forEach(item => {
        const fimPlanejado = item.fim_planejado || '';
        if (fimPlanejado) {
          const partes = fimPlanejado.split('.');
          if (partes.length >= 3) {
            const mesAno = partes[1] + '.' + partes[2]; // MM.YYYY
            mesesSet.add(mesAno);
          }
        }
      });

      const mesesArray = Array.from(mesesSet).sort((a, b) => {
        const [mesA, anoA] = a.split('.');
        const [mesB, anoB] = b.split('.');
        const dataA = new Date(parseInt(anoA), parseInt(mesA) - 1);
        const dataB = new Date(parseInt(anoB), parseInt(mesB) - 1);
        return dataA - dataB;
      });

      const selectMes = document.getElementById('filtroMesFimPlanejado');
      if (!selectMes) {
        return;
      }

      const valorAtual = selectMes.value || 'todos';
      selectMes.innerHTML = '<option value="todos">Todos os meses</option>';

      mesesArray.forEach(mesAno => {
        const [mes, ano] = mesAno.split('.');
        const nomeMes = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][parseInt(mes) - 1];
        const option = document.createElement('option');
        option.value = mesAno;
        option.textContent = `${nomeMes}/${ano}`;
        selectMes.appendChild(option);
      });

      if (mesesArray.includes(valorAtual)) {
        selectMes.value = valorAtual;
      }
    };

    window.filtrarGraficoFimPlanejadoPorMes = function () {
      const mesSelecionado = document.getElementById('filtroMesFimPlanejado')?.value || 'todos';
      const dadosBase = (dadosGlobaisCompletos && dadosGlobaisCompletos.length > 0) ? dadosGlobaisCompletos : dadosGlobais;
      gerarGrafico(dadosBase, mesSelecionado);
    };

    // Fun√ß√£o para filtrar gr√°fico Medidas 0034 por m√™s
    window.filtrarGraficoMedidas0034PorMes = function () {
      const mesSelecionado = document.getElementById('filtroMesMedidas0034')?.value || 'todos';
      const dadosBase = (dadosGlobaisCompletos && dadosGlobaisCompletos.length > 0) ? dadosGlobaisCompletos : dadosGlobais;
      gerarGraficoMedidas0034(dadosBase, mesSelecionado);
    };

    // Fun√ß√£o para filtrar gr√°fico de conclu√≠das por m√™s
    window.filtrarGraficoConcluidasPorMes = function () {
      const mesSelecionado = document.getElementById('filtroMesConcluidas').value;
      gerarGraficoConcluidas(dadosGlobais, mesSelecionado);
    };

    // Vari√°vel global para os gr√°ficos
    let chartInstance = null;
    let chartConcluidasInstance = null;
    let chartPrazoMedioInstance = null;
    let chartPrazoMedioExcetoInstance = null;
    let chartPrazoMedioMiniMicroInstance = null;
    let chartMiniGeracaoInstance = null;
    let chartOutrosTiposInstance = null;
    let chartSemGeracoesInstance = null;
    let chartTextoMedidasInstance = null;

    let chartNotasPorUsuarioInstance = null;
    let chartAprovacaoReprovacaoPorUsuarioInstance = null;
    let chartNotasConcluidasPorDiaUsuarioInstance = null;
    let chartNotasConcluidasPorMesInstance = null;
    let chartConcluidasPorTipoSolicitacaoInstance = null;
    let chartMedidas0034Instance = null;
    let chartPrazoMedio0034Instance = null;

    // Fun√ß√£o para toggle barras no gr√°fico Mini/Micro
    window.toggleBarrasMini = function () {
      if (!chartConcluidasPorTipoSolicitacaoInstance) return;
      
      const checkbox = document.getElementById('ocultarBarrasMini');
      const ocultarBarras = checkbox.checked;
      
      // Ocultar ou mostrar os datasets das barras (√≠ndices 0 e 1)
      chartConcluidasPorTipoSolicitacaoInstance.data.datasets[0].hidden = ocultarBarras;
      chartConcluidasPorTipoSolicitacaoInstance.data.datasets[1].hidden = ocultarBarras;
      
      // A linha (√≠ndice 2) permanece sempre vis√≠vel
      chartConcluidasPorTipoSolicitacaoInstance.update();
    };
    let chartConcluidasPorTipoDemaisInstance = null;

    // Fun√ß√£o para toggle barras no gr√°fico Demais
    window.toggleBarrasDemais = function () {
      if (!chartConcluidasPorTipoDemaisInstance) return;
      
      const checkbox = document.getElementById('ocultarBarrasDemais');
      const ocultarBarras = checkbox.checked;
      
      // Ocultar ou mostrar os datasets das barras (√≠ndices 0 e 1)
      chartConcluidasPorTipoDemaisInstance.data.datasets[0].hidden = ocultarBarras;
      chartConcluidasPorTipoDemaisInstance.data.datasets[1].hidden = ocultarBarras;
      
      // A linha (√≠ndice 2) permanece sempre vis√≠vel
      chartConcluidasPorTipoDemaisInstance.update();
    };
    // Fun√ß√£o para gerar gr√°fico de barras
    window.gerarGrafico = function (dados, mesFiltro = null) {
      if (!dados || dados.length === 0) {
        return;
      }

      const mesSelecionado = mesFiltro ?? (document.getElementById('filtroMesFimPlanejado')?.value || 'todos');

      const normalizarStatusBase = function (status) {
        const statusNormalizado = (status || '').trim().toUpperCase();
        if (statusNormalizado.includes('ABER')) return 'ABER';
        if (statusNormalizado.includes('ANDM')) return 'ANDM';
        return statusNormalizado;
      };

      // Obter descri√ß√µes selecionadas nos checkboxes
      const checkboxes = document.querySelectorAll('#containerCheckboxesDescricoes input[type="checkbox"]');
      const descricoesChecadas = new Set();
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          descricoesChecadas.add((checkbox.value || '').trim());
        }
      });
      const todasDescricoesMarcadas = checkboxes.length > 0 && Array.from(checkboxes).every(checkbox => checkbox.checked);

      // Obter c√≥digos medidas selecionados nos checkboxes
      const checkboxesCodigo = document.querySelectorAll('#containerCheckboxesCodigoMedidas input[type="checkbox"]');
      const codigosChecados = new Set();
      checkboxesCodigo.forEach(checkbox => {
        if (checkbox.checked) {
          codigosChecados.add((checkbox.value || '').trim());
        }
      });
      const todosCodigosMarcados = checkboxesCodigo.length > 0 && Array.from(checkboxesCodigo).every(checkbox => checkbox.checked);

      // Obter status selecionados nos checkboxes
      const checkboxesStatus = document.querySelectorAll('#containerCheckboxesStatusFimPlanejado input[type="checkbox"]');
      const statusChecados = new Set();
      checkboxesStatus.forEach(checkbox => {
        if (checkbox.checked) {
          statusChecados.add((checkbox.value || '').trim().toUpperCase());
        }
      });
      const todosStatusMarcados = checkboxesStatus.length > 0 && Array.from(checkboxesStatus).every(checkbox => checkbox.checked);
      const nenhumStatusMarcado = checkboxesStatus.length > 0 && Array.from(checkboxesStatus).every(checkbox => !checkbox.checked);

      // Debug: verificar quantos registros de cada status existem
      const contagemStatus = {};
      dados.forEach(item => {
        const status = (item.status_usuario || item.status || item.Status || item.status_atual || '').trim().toUpperCase();
        const statusBase = normalizarStatusBase(status);
        contagemStatus[statusBase] = (contagemStatus[statusBase] || 0) + 1;
      });
      console.log('Contagem por status no total de dados:', contagemStatus);
      console.log('Status ABER marcado?', statusChecados.has('ABER'));
      console.log('Status ANDM marcado?', statusChecados.has('ANDM'));
      console.log('Nenhum status marcado?', nenhumStatusMarcado);
      console.log('Todos status marcados?', todosStatusMarcados);

      // Filtrar por status selecionado e aplicar filtros de descri√ß√£o/c√≥digo
      let rejeitadosPorStatus = 0;
      let rejeitadosPorDescricao = 0;
      let rejeitadosPorCodigo = 0;

      const dadosFiltrados = dados.filter(item => {
        const status = (item.status_usuario || item.status || item.Status || item.status_atual || '').trim().toUpperCase();
        const statusBase = normalizarStatusBase(status);
        const descricao = (item.descricao || '').trim();
        const codigoMedidas = (item.codigo_medidas || '').trim();
        const fimPlanejado = (item.fim_planejado || '').trim();

        let mesOk = true;
        if (mesSelecionado && mesSelecionado !== 'todos') {
          const partes = fimPlanejado.split('.');
          if (partes.length >= 3) {
            const mesAno = partes[1] + '.' + partes[2];
            mesOk = mesAno === mesSelecionado;
          } else {
            mesOk = false;
          }
        }

        const statusOk = nenhumStatusMarcado
          ? (statusBase === 'ABER' || statusBase === 'ANDM')
          : (todosStatusMarcados || statusChecados.size === 0)
            ? !!statusBase
            : statusChecados.has(statusBase);
        const descricaoOk = todasDescricoesMarcadas || descricoesChecadas.size === 0 || descricoesChecadas.has(descricao);
        const codigoOk = todosCodigosMarcados || codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);

        if (!statusOk) rejeitadosPorStatus++;
        if (!descricaoOk) rejeitadosPorDescricao++;
        if (!codigoOk) rejeitadosPorCodigo++;

        return statusOk && descricaoOk && codigoOk && mesOk;
      });

      console.log('===== AN√ÅLISE DE FILTROS =====');
      console.log('Total de dados recebidos:', dados.length);
      console.log('Total de dados filtrados:', dadosFiltrados.length);
      console.log('Rejeitados por Status:', rejeitadosPorStatus);
      console.log('Rejeitados por Descri√ß√£o:', rejeitadosPorDescricao);
      console.log('Rejeitados por C√≥digo Medidas:', rejeitadosPorCodigo);
      console.log('Descri√ß√µes marcadas:', descricoesChecadas.size, 'Todas marcadas?', todasDescricoesMarcadas);
      console.log('C√≥digos marcados:', codigosChecados.size, 'Todos marcados?', todosCodigosMarcados);
      console.log('Primeiras 5 datas fim_planejado:', dadosFiltrados.slice(0, 5).map(d => d.fim_planejado));
      console.log('√öltimas 5 datas fim_planejado:', dadosFiltrados.slice(-5).map(d => d.fim_planejado));

      // Agrupar dados por fim_planejado e status
      const agrupamentoPorData = {};
      const totaisPorStatus = {};
      const statusPresentes = new Set();

      dadosFiltrados.forEach(item => {
        const fimPlanejado = item.fim_planejado || 'Sem data';
        const status = (item.status_usuario || item.status || item.Status || item.status_atual || '').trim().toUpperCase();
        const statusBase = normalizarStatusBase(status);
        if (!statusBase) {
          return;
        }
        statusPresentes.add(statusBase);

        if (!agrupamentoPorData[fimPlanejado]) {
          agrupamentoPorData[fimPlanejado] = {};
        }

        if (!agrupamentoPorData[fimPlanejado][statusBase]) {
          agrupamentoPorData[fimPlanejado][statusBase] = 0;
        }
        agrupamentoPorData[fimPlanejado][statusBase]++;

        if (!totaisPorStatus[statusBase]) {
          totaisPorStatus[statusBase] = 0;
        }
        totaisPorStatus[statusBase]++;
      });

      // Atualizar contadores na interface
      document.getElementById('totalGeralNotas').textContent = dadosFiltrados.length;
      document.getElementById('totalANDM').textContent = totaisPorStatus.ANDM || 0;
      document.getElementById('totalABER').textContent = totaisPorStatus.ABER || 0;

      // Converter para arrays e ordenar por data
      const labels = Object.keys(agrupamentoPorData).sort((a, b) => {
        if (a === 'Sem data') return 1;
        if (b === 'Sem data') return -1;
        return new Date(a.split('.').reverse().join('-')) - new Date(b.split('.').reverse().join('-'));
      });

      console.log('Total de labels (datas √∫nicas):', labels.length);
      console.log('Todas as labels:', labels);

      // Preparar dados para cada status selecionado
      const statusOrdenados = Array.from(statusPresentes).sort();
      const palette = [
        { bg: 'rgba(46, 125, 50, 0.7)', border: 'rgba(46, 125, 50, 1)' },
        { bg: 'rgba(102, 187, 106, 0.7)', border: 'rgba(102, 187, 106, 1)' },
        { bg: 'rgba(25, 118, 210, 0.7)', border: 'rgba(25, 118, 210, 1)' },
        { bg: 'rgba(255, 167, 38, 0.7)', border: 'rgba(255, 167, 38, 1)' },
        { bg: 'rgba(171, 71, 188, 0.7)', border: 'rgba(171, 71, 188, 1)' },
        { bg: 'rgba(239, 83, 80, 0.7)', border: 'rgba(239, 83, 80, 1)' }
      ];

      const datasets = statusOrdenados.map((status, index) => {
        const colors = palette[index % palette.length];
        return {
          label: status,
          data: labels.map(label => (agrupamentoPorData[label] && agrupamentoPorData[label][status]) ? agrupamentoPorData[label][status] : 0),
          backgroundColor: colors.bg,
          borderColor: colors.border,
          borderWidth: 2,
          borderRadius: 8,
          hoverBackgroundColor: colors.bg,
          hoverBorderColor: colors.border,
          datalabels: {
            color: '#2e7d32',
            anchor: 'end',
            align: 'top',
            offset: 4,
            font: {
              weight: 'bold',
              size: 11,
              family: 'Roboto'
            },
            formatter: function (value) {
              return value > 0 ? value : '';
            }
          }
        };
      });

      // Destruir gr√°fico anterior se existir
      if (chartInstance) {
        chartInstance.destroy();
      }

      // Criar novo gr√°fico com m√∫ltiplos datasets
      const ctx = document.getElementById('chartFimPlanejado').getContext('2d');
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          onClick: (event, activeElements) => {
            if (activeElements.length > 0) {
              const datasetIndex = activeElements[0].datasetIndex;
              const index = activeElements[0].index;
              const dataLabel = labels[index];
              const statusLabel = statusOrdenados[datasetIndex];

              // Filtrar notas correspondentes √† barra clicada
              const notasFiltradas = dadosFiltrados.filter(item => {
                const fimPlanejado = item.fim_planejado || 'Sem data';
                const status = (item.status_usuario || item.status || item.Status || item.status_atual || '').trim().toUpperCase();
                const statusBase = normalizarStatusBase(status);
                return fimPlanejado === dataLabel && statusBase === statusLabel;
              });

              abrirModalNotas(notasFiltradas, dataLabel, statusLabel);
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(46, 125, 50, 0.9)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function (context) {
                  return context.dataset.label + ': ' + context.parsed.y;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: 'Roboto'
                },
                color: '#666',
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'Fim Planejado',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Quantidade',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Fun√ß√£o para gerar gr√°fico de Medidas 0034
    window.gerarGraficoMedidas0034 = function (dados, mesFiltro = null) {
      if (!dados || dados.length === 0) {
        console.log('Medidas 0034: Nenhum dado recebido');
        return;
      }

      console.log('===== MEDIDAS 0034 - IN√çCIO =====');
      console.log('Total de dados recebidos:', dados.length);
      console.log('Filtro de m√™s:', mesFiltro);

      // Verificar quantos registros t√™m 0034 na descri√ß√£o ou no c√≥digo
      const com0034Descricao = dados.filter(item => (item.descricao || '').trim().includes('0034'));
      const com0034Codigo = dados.filter(item => (item.codigo_medidas || '').trim() === '0034');
      console.log('Registros com 0034 na descri√ß√£o:', com0034Descricao.length);
      console.log('Registros com codigo_medidas = 0034:', com0034Codigo.length);
      
      // Verificar status dos registros com 0034
      const statusCount = {};
      com0034Descricao.concat(com0034Codigo).forEach(item => {
        const status = (item.status_usuario || item.status || item.Status || item.status_atual || '').trim().toUpperCase();
        statusCount[status] = (statusCount[status] || 0) + 1;
      });
      console.log('Status dos registros com 0034:', statusCount);

      // Obter descri√ß√µes selecionadas nos checkboxes
      const checkboxesDescricao = document.querySelectorAll('#containerCheckboxesDescricoesMedidas0034 input[type="checkbox"]');
      const descricoesChecadas = new Set();
      checkboxesDescricao.forEach(checkbox => {
        if (checkbox.checked) {
          descricoesChecadas.add((checkbox.value || '').trim());
        }
      });
      const todasDescricoesMarcadas = checkboxesDescricao.length > 0 && Array.from(checkboxesDescricao).every(checkbox => checkbox.checked);

      // Filtrar apenas notas com descri√ß√£o contendo '0034' OU codigo_medidas = '0034', status ABER/ANDM e descri√ß√£o selecionada
      const dadosFiltrados = dados.filter(item => {
        const descricao = (item.descricao || '').trim();
        const codigoMedidas = (item.codigo_medidas || '').trim();
        const status = (item.status_usuario || item.status || item.Status || item.status_atual || '').trim().toUpperCase();
        const fimPlanejado = (item.fim_planejado || '').trim();
        
        // Normalizar status para ABER/ANDM
        const statusBase = typeof normalizarStatusBase === 'function'
          ? normalizarStatusBase(status)
          : (status.includes('ABER') ? 'ABER' : (status.includes('ANDM') ? 'ANDM' : ''));
        
        // Filtrar apenas descri√ß√£o contendo 0034 OU c√≥digo 0034 e status ABER ou ANDM
        const eh0034 = descricao.includes('0034') || codigoMedidas === '0034';
        const descricaoOk = todasDescricoesMarcadas || descricoesChecadas.size === 0 || descricoesChecadas.has(descricao);
        if (!eh0034 || !statusBase || !descricaoOk) {
          return false;
        }

        // Aplicar filtro de m√™s se fornecido
        if (mesFiltro && mesFiltro !== 'todos') {
          const partes = fimPlanejado.split('.');
          if (partes.length >= 3) {
            const mesAno = partes[1] + '.' + partes[2];
            return mesAno === mesFiltro;
          } else {
            return false;
          }
        }

        return true;
      });

      console.log('Total de dados filtrados (0034 + ABER/ANDM):', dadosFiltrados.length);
      console.log('Primeiros 3 registros filtrados:', dadosFiltrados.slice(0, 3).map(d => ({
        nota: d.nota,
        descricao: d.descricao,
        status: d.status_usuario || d.status,
        fim_planejado: d.fim_planejado
      })));


      // Agrupar dados por fim_planejado e status
      const agrupamentoPorData = {};
      const totaisPorStatus = {
        'ABER': 0,
        'ANDM': 0
      };

      dadosFiltrados.forEach(item => {
        const fimPlanejado = item.fim_planejado || 'Sem data';
        const status = (item.status_usuario || item.status || item.Status || item.status_atual || '').trim().toUpperCase();
        
        const statusBase = typeof normalizarStatusBase === 'function'
          ? normalizarStatusBase(status)
          : (status.includes('ABER') ? 'ABER' : (status.includes('ANDM') ? 'ANDM' : ''));

        if (!agrupamentoPorData[fimPlanejado]) {
          agrupamentoPorData[fimPlanejado] = {
            'ABER': 0,
            'ANDM': 0
          };
        }

        agrupamentoPorData[fimPlanejado][statusBase]++;
        totaisPorStatus[statusBase]++;
      });

      // Atualizar contadores na interface
      document.getElementById('totalMedidas0034').textContent = dadosFiltrados.length;
      document.getElementById('totalANDMMedidas0034').textContent = totaisPorStatus['ANDM'];
      document.getElementById('totalABERMedidas0034').textContent = totaisPorStatus['ABER'];

      console.log('Totais por status - ANDM:', totaisPorStatus['ANDM'], 'ABER:', totaisPorStatus['ABER']);
      console.log('Datas √∫nicas encontradas:', Object.keys(agrupamentoPorData).length);
      console.log('Agrupamento por data:', agrupamentoPorData);

      // Converter para arrays e ordenar por data
      const labels = Object.keys(agrupamentoPorData).sort((a, b) => {
        if (a === 'Sem data') return 1;
        if (b === 'Sem data') return -1;
        return new Date(a.split('.').reverse().join('-')) - new Date(b.split('.').reverse().join('-'));
      });

      console.log('Labels ordenadas (datas):', labels);
      console.log('Total de labels:', labels.length);

      // Preparar datasets para ABER e ANDM
      const datasets = [
        {
          label: 'ANDM',
          data: labels.map(label => agrupamentoPorData[label]['ANDM']),
          backgroundColor: 'rgba(46, 125, 50, 0.7)',
          borderColor: 'rgba(46, 125, 50, 1)',
          borderWidth: 2,
          borderRadius: 8,
          datalabels: {
            color: '#2e7d32',
            anchor: 'end',
            align: 'top',
            offset: 4,
            font: {
              weight: 'bold',
              size: 11,
              family: 'Roboto'
            },
            formatter: function (value) {
              return value > 0 ? value : '';
            }
          }
        },
        {
          label: 'ABER',
          data: labels.map(label => agrupamentoPorData[label]['ABER']),
          backgroundColor: 'rgba(102, 187, 106, 0.7)',
          borderColor: 'rgba(102, 187, 106, 1)',
          borderWidth: 2,
          borderRadius: 8,
          datalabels: {
            color: '#66bb6a',
            anchor: 'end',
            align: 'top',
            offset: 4,
            font: {
              weight: 'bold',
              size: 11,
              family: 'Roboto'
            },
            formatter: function (value) {
              return value > 0 ? value : '';
            }
          }
        }
      ];

      // Destruir gr√°fico anterior se existir
      if (chartMedidas0034Instance) {
        chartMedidas0034Instance.destroy();
      }

      console.log('Criando gr√°fico com', labels.length, 'labels');
      console.log('Dataset ANDM:', datasets[0].data);
      console.log('Dataset ABER:', datasets[1].data);

      // Criar novo gr√°fico
      const ctx = document.getElementById('chartMedidas0034').getContext('2d');
      chartMedidas0034Instance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          onClick: (event, activeElements) => {
            if (activeElements.length > 0) {
              const datasetIndex = activeElements[0].datasetIndex;
              const index = activeElements[0].index;
              const dataLabel = labels[index];
              const statusLabel = datasetIndex === 0 ? 'ANDM' : 'ABER';

              // Filtrar notas correspondentes √† barra clicada
              const notasFiltradas = dadosFiltrados.filter(item => {
                const fimPlanejado = item.fim_planejado || 'Sem data';
                const status = (item.status_usuario || item.status || item.Status || item.status_atual || '').trim().toUpperCase();
                const statusBase = status.includes('ABER') ? 'ABER' : (status.includes('ANDM') ? 'ANDM' : '');
                return fimPlanejado === dataLabel && statusBase === statusLabel;
              });

              abrirModalNotas(notasFiltradas, dataLabel, statusLabel);
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(46, 125, 50, 0.9)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function (context) {
                  return context.dataset.label + ': ' + context.parsed.y;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: 'Roboto'
                },
                color: '#666',
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'Fim Planejado',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Quantidade de Notas',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });

      // Popular o filtro de meses
      if (!mesFiltro) {
        popularFiltroMesesMedidas0034(dados);
      }
    };

    // Fun√ß√£o para popular filtro de meses do gr√°fico Medidas 0034
    function popularFiltroMesesMedidas0034(dados) {
      const selectMes = document.getElementById('filtroMesMedidas0034');
      if (!selectMes) return;

      // Filtrar apenas dados com descri√ß√£o contendo 0034 ou c√≥digo 0034
      const dadosFiltrados = dados.filter(item => {
        const descricao = (item.descricao || '').trim();
        const codigoMedidas = (item.codigo_medidas || '').trim();
        return descricao.includes('0034') || codigoMedidas === '0034';
      });

      // Obter todos os meses √∫nicos
      const mesesSet = new Set();
      dadosFiltrados.forEach(item => {
        const fimPlanejado = (item.fim_planejado || '').trim();
        if (fimPlanejado && fimPlanejado !== 'Sem data') {
          const partes = fimPlanejado.split('.');
          if (partes.length >= 3) {
            const mesAno = partes[1] + '.' + partes[2];
            mesesSet.add(mesAno);
          }
        }
      });

      // Ordenar meses
      const mesesOrdenados = Array.from(mesesSet).sort((a, b) => {
        const [mesA, anoA] = a.split('.');
        const [mesB, anoB] = b.split('.');
        return new Date(anoA, mesA - 1) - new Date(anoB, mesB - 1);
      });

      // Limpar e repopular select
      selectMes.innerHTML = '<option value="todos">Todos os meses</option>';
      mesesOrdenados.forEach(mesAno => {
        const [mes, ano] = mesAno.split('.');
        const option = document.createElement('option');
        option.value = mesAno;
        option.textContent = `${mes}/${ano}`;
        selectMes.appendChild(option);
      });
      
      console.log('Filtro de meses Medidas 0034 populado com', mesesOrdenados.length, 'meses');
    }

    // Fun√ß√£o para gerar gr√°fico de Prazo M√©dio Medidas 0034
    window.gerarGraficoPrazoMedio0034 = function (dados) {
      if (!dados || dados.length === 0) {
        return;
      }

      // Obter ano selecionado no filtro
      const selectAno = document.getElementById('filtroAnoPrazo0034');
      const anoSelecionado = selectAno ? selectAno.value : 'todos';

      // Obter descri√ß√µes selecionadas nos checkboxes
      const checkboxes = document.querySelectorAll('#containerCheckboxesDescricoesPrazo0034 input[type="checkbox"]');
      const descricoesChecadas = new Set();
      let todasDescricoesMarcadas = true;
      
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          descricoesChecadas.add(checkbox.value);
        } else {
          todasDescricoesMarcadas = false;
        }
      });

      // Filtrar apenas notas conclu√≠das (CONC CTEC ou CONC RTEC) com c√≥digo 0034
      const notasConcluidas = dados.filter(item => {
        const status = item.status_usuario || '';
        const descricao = (item.descricao || '').trim();
        const codigoMedidas = (item.codigo_medidas || '').trim();
        const textoMedidas = (item.texto_medidas || '').toUpperCase();
        const concluidaEm = (item.concluida_em || '').trim();

        // Verificar se √© c√≥digo 0034
        const eh0034 = descricao.includes('0034') || codigoMedidas === '0034';

        // Aplicar filtro de descri√ß√£o
        const descricaoOk = todasDescricoesMarcadas || descricoesChecadas.size === 0 || descricoesChecadas.has(descricao);

        // Aplicar filtro de ano
        let anoOk = true;
        if (anoSelecionado !== 'todos' && concluidaEm) {
          const partes = concluidaEm.split('.');
          if (partes.length >= 3) {
            anoOk = partes[2] === anoSelecionado;
          }
        }

        // Verificar se o texto de medidas cont√©m "SEM ANEXO" ou varia√ß√µes
        const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') ||
          textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
          textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));

        const statusOk = (status === 'CONC CTEC' || status === 'CONC RTEC') &&
          item.inicio_planejado &&
          item.concluida_em;
        
        return eh0034 && descricaoOk && anoOk && statusOk && temAnexo;
      });

      if (notasConcluidas.length === 0) {
        document.getElementById('totalNotasAnalisadas0034').textContent = '0';
        document.getElementById('prazoMedioGeral0034').textContent = '0';
        if (chartPrazoMedio0034Instance) {
          chartPrazoMedio0034Instance.destroy();
          chartPrazoMedio0034Instance = null;
        }
        return;
      }

      // Fun√ß√£o para converter data DD.MM.YYYY para objeto Date
      function parseData(dataStr) {
        if (!dataStr) return null;
        const partes = dataStr.split('.');
        if (partes.length !== 3) return null;
        return new Date(partes[2], partes[1] - 1, partes[0]);
      }

      // Calcular diferen√ßas e agrupar por m√™s/ano
      const prazosPorMes = {};
      let somaTotalDias = 0;
      let totalNotasValidas = 0;

      notasConcluidas.forEach(item => {
        const inicioPlanejado = parseData(item.inicio_planejado);
        const concluida = parseData(item.concluida_em);

        if (inicioPlanejado && concluida) {
          const diferencaDias = Math.round((concluida - inicioPlanejado) / (1000 * 60 * 60 * 24));
          const mesAno = `${String(concluida.getMonth() + 1).padStart(2, '0')}.${concluida.getFullYear()}`;

          if (!prazosPorMes[mesAno]) {
            prazosPorMes[mesAno] = { soma: 0, count: 0 };
          }

          prazosPorMes[mesAno].soma += diferencaDias;
          prazosPorMes[mesAno].count++;
          somaTotalDias += diferencaDias;
          totalNotasValidas++;
        }
      });

      // Calcular m√©dia por m√™s e ordenar
      const mesesOrdenados = Object.keys(prazosPorMes).sort((a, b) => {
        const [mesA, anoA] = a.split('.');
        const [mesB, anoB] = b.split('.');
        return new Date(anoA, mesA - 1) - new Date(anoB, mesB - 1);
      });

      const labels = mesesOrdenados.map(mesAno => {
        const [mes, ano] = mesAno.split('.');
        return `${mes}/${ano}`;
      });

      const prazosMedios = mesesOrdenados.map(mesAno => {
        const prazo = prazosPorMes[mesAno];
        return Math.round(prazo.soma / prazo.count);
      });

      // Atualizar informa√ß√µes
      const prazoMedioGeral = totalNotasValidas > 0 ? Math.round(somaTotalDias / totalNotasValidas) : 0;
      document.getElementById('totalNotasAnalisadas0034').textContent = totalNotasValidas;
      document.getElementById('prazoMedioGeral0034').textContent = prazoMedioGeral;

      // Destruir gr√°fico anterior se existir
      if (chartPrazoMedio0034Instance) {
        chartPrazoMedio0034Instance.destroy();
      }

      // Criar novo gr√°fico
      const ctx = document.getElementById('chartPrazoMedio0034').getContext('2d');
      chartPrazoMedio0034Instance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Prazo M√©dio (dias)',
            data: prazosMedios,
            borderColor: 'rgba(46, 125, 50, 1)',
            backgroundColor: 'rgba(46, 125, 50, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.3,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: 'rgba(46, 125, 50, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333',
                padding: 15,
                usePointStyle: true
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              titleFont: {
                size: 14,
                family: 'Roboto',
                weight: 'bold'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                label: function (context) {
                  return `Prazo m√©dio: ${context.parsed.y} dias`;
                }
              }
            },
            datalabels: {
              anchor: 'end',
              align: 'top',
              formatter: (value) => `${value}d`,
              color: '#2e7d32',
              font: {
                size: 11,
                family: 'Roboto',
                weight: 'bold'
              },
              offset: 4
            }
          },
          scales: {
            x: {
              ticks: {
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666',
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'M√™s/Ano',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 5,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666',
                callback: function (value) {
                  return value + ' dias';
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Prazo M√©dio (dias)',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Fun√ß√£o para gerar gr√°fico de Notas Conclu√≠das (CONC CTEC e CONC RTEC)
    window.gerarGraficoConcluidas = function (dados, mesFiltro = null) {
      if (!dados || dados.length === 0) {
        return;
      }

      // Obter c√≥digos medidas selecionados nos checkboxes
      const checkboxesCodigo = document.querySelectorAll('#containerCheckboxesCodigoMedidasConcluidas input[type="checkbox"]');
      const codigosChecados = new Set();
      checkboxesCodigo.forEach(checkbox => {
        if (checkbox.checked) {
          codigosChecados.add(checkbox.value);
        }
      });

      // Filtrar dados por m√™s se especificado
      let dadosFiltrados = dados;
      if (mesFiltro && mesFiltro !== 'todos') {
        dadosFiltrados = dados.filter(item => {
          const concluidaEm = item.concluida_em || '';
          if (!concluidaEm) return false;
          // Extrair m√™s/ano no formato MM.YYYY
          const partes = concluidaEm.split('.');
          if (partes.length >= 2) {
            const mesAno = partes[1] + '.' + partes[2]; // MM.YYYY
            return mesAno === mesFiltro;
          }
          return false;
        });
      }

      // Agrupar dados por concluida_em e status_usuario
      const agrupamentoPorData = {};
      let totalCONC_CTEC = 0;
      let totalCONC_RTEC = 0;

      dadosFiltrados.forEach(item => {
        const concluidaEm = item.concluida_em || 'Sem data';
        const status = item.status_usuario || '';
        const codigoMedidas = item.codigo_medidas || '';
        const textoMedidas = (item.texto_medidas || '').toUpperCase();
        
        // Verificar se tem anexo
        const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') ||
          textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
          textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));
        
        const codigoOk = codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);

        if ((status === 'CONC CTEC' || status === 'CONC RTEC') && codigoOk && temAnexo) {
          if (!agrupamentoPorData[concluidaEm]) {
            agrupamentoPorData[concluidaEm] = { CONC_CTEC: 0, CONC_RTEC: 0 };
          }

          if (status === 'CONC CTEC') {
            agrupamentoPorData[concluidaEm].CONC_CTEC++;
            totalCONC_CTEC++;
          } else if (status === 'CONC RTEC') {
            agrupamentoPorData[concluidaEm].CONC_RTEC++;
            totalCONC_RTEC++;
          }
        }
      });

      // Atualizar contadores na interface
      const totalConcluidas = totalCONC_CTEC + totalCONC_RTEC;
      const percentualAprovacao = totalConcluidas > 0 ? ((totalCONC_CTEC / totalConcluidas) * 100).toFixed(1) : 0;

      document.getElementById('totalConcluidas').textContent = totalConcluidas;
      document.getElementById('totalCONC_CTEC').textContent = totalCONC_CTEC;
      document.getElementById('totalCONC_RTEC').textContent = totalCONC_RTEC;
      document.getElementById('percentualAprovacao').textContent = percentualAprovacao + '%';

      if (totalConcluidas === 0) {
        // Limpar gr√°fico se n√£o houver dados
        if (chartConcluidasInstance) {
          chartConcluidasInstance.destroy();
          chartConcluidasInstance = null;
        }
        return;
      }

      // Converter para arrays e ordenar por data
      const labels = Object.keys(agrupamentoPorData).sort((a, b) => {
        if (a === 'Sem data') return 1;
        if (b === 'Sem data') return -1;
        return new Date(a.split('.').reverse().join('-')) - new Date(b.split('.').reverse().join('-'));
      });

      // Preparar dados para cada status
      const valoresCONC_CTEC = labels.map(label => agrupamentoPorData[label].CONC_CTEC);
      const valoresCONC_RTEC = labels.map(label => agrupamentoPorData[label].CONC_RTEC);

      // Destruir gr√°fico anterior se existir
      if (chartConcluidasInstance) {
        chartConcluidasInstance.destroy();
      }

      // Criar novo gr√°fico com m√∫ltiplos datasets
      const ctx = document.getElementById('chartConcluidas').getContext('2d');
      chartConcluidasInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'CONC CTEC',
              data: valoresCONC_CTEC,
              backgroundColor: 'rgba(56, 142, 60, 0.7)',
              borderColor: 'rgba(56, 142, 60, 1)',
              borderWidth: 2,
              borderRadius: 8,
              hoverBackgroundColor: 'rgba(67, 160, 71, 0.8)',
              hoverBorderColor: 'rgba(67, 160, 71, 1)',
              datalabels: {
                color: '#fff',
                font: {
                  weight: 'bold',
                  size: 12
                },
                formatter: function (value) {
                  return value > 0 ? value : '';
                }
              }
            },
            {
              label: 'CONC RTEC',
              data: valoresCONC_RTEC,
              backgroundColor: 'rgba(129, 199, 132, 0.7)',
              borderColor: 'rgba(129, 199, 132, 1)',
              borderWidth: 2,
              borderRadius: 8,
              hoverBackgroundColor: 'rgba(165, 214, 167, 0.8)',
              hoverBorderColor: 'rgba(165, 214, 167, 1)',
              datalabels: {
                color: '#fff',
                font: {
                  weight: 'bold',
                  size: 12
                },
                formatter: function (value) {
                  return value > 0 ? value : '';
                }
              }
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          onClick: (event, activeElements) => {
            if (activeElements.length > 0) {
              const datasetIndex = activeElements[0].datasetIndex;
              const index = activeElements[0].index;
              const dataLabel = labels[index];
              const statusLabel = datasetIndex === 0 ? 'CONC CTEC' : 'CONC RTEC';

              // Filtrar notas correspondentes √† barra clicada
              const notasFiltradas = dadosFiltrados.filter(item => {
                const concluidaEm = item.concluida_em || 'Sem data';
                const status = item.status_usuario || '';
                const codigoMedidas = item.codigo_medidas || '';
                const codigoOk = codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);
                return concluidaEm === dataLabel && status === statusLabel && codigoOk;
              });

              abrirModalNotas(notasFiltradas, dataLabel, statusLabel);
            }
          },
          plugins: {
            datalabels: {
              display: true,
              align: 'center',
              anchor: 'center'
            },
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(46, 125, 50, 0.9)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function (context) {
                  return context.dataset.label + ': ' + context.parsed.y;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: 'Roboto'
                },
                color: '#666',
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'Data de Conclus√£o',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Quantidade',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Fun√ß√£o para gerar gr√°fico de Prazo M√©dio Mensal
    window.gerarGraficoPrazoMedio = function (dados) {
      if (!dados || dados.length === 0) {
        return;
      }

      // Obter ano selecionado no dropdown
      const filtroAnoPrazoMedioElement = document.getElementById('filtroAnoPrazoMedio');
      const anoSelecionado = filtroAnoPrazoMedioElement ? filtroAnoPrazoMedioElement.value : 'todos';

      // Obter descri√ß√µes selecionadas nos checkboxes
      const checkboxes = document.querySelectorAll('#containerCheckboxesDescricoesPrazo input[type="checkbox"]');
      const descricoesChecadas = new Set();
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          descricoesChecadas.add(checkbox.value);
        }
      });

      // Obter c√≥digos medidas selecionados nos checkboxes
      const checkboxesCodigo = document.querySelectorAll('#containerCheckboxesCodigoMedidasPrazo input[type="checkbox"]');
      const codigosChecados = new Set();
      checkboxesCodigo.forEach(checkbox => {
        if (checkbox.checked) {
          codigosChecados.add(checkbox.value);
        }
      });

      // Filtrar apenas notas conclu√≠das (CONC CTEC ou CONC RTEC) com datas v√°lidas e descri√ß√£o selecionada
      const notasConcluidas = dados.filter(item => {
        const status = item.status_usuario || '';
        const descricao = item.descricao || '';
        const codigoMedidas = (item.codigo_medidas || '').trim();
        const textoMedidas = (item.texto_medidas || '').toUpperCase();
        const concluidaEm = (item.concluida_em || '').trim();

        // Verificar c√≥digos permitidos (0040, 0041, 0042, 0045)
        const codigosPermitidos = ['0040', '0041', '0042', '0045'];
        if (!codigosPermitidos.includes(codigoMedidas)) return false;

        // Aplicar filtro de ano
        let anoOk = true;
        if (anoSelecionado !== 'todos' && concluidaEm) {
          const partes = concluidaEm.split('.');
          if (partes.length >= 3) {
            anoOk = partes[2] === anoSelecionado;
          }
        }

        // Verificar se o texto de medidas cont√©m "SEM ANEXO" ou varia√ß√µes
        const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') ||
          textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
          textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));

        const statusOk = (status === 'CONC CTEC' || status === 'CONC RTEC') &&
          item.inicio_planejado &&
          item.concluida_em;
        const descricaoOk = descricoesChecadas.size === 0 || descricoesChecadas.has(descricao);
        const codigoOk = codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);
        return statusOk && descricaoOk && codigoOk && anoOk && temAnexo;
      });

      if (notasConcluidas.length === 0) {
        document.getElementById('totalNotasAnalisadas').textContent = '0';
        document.getElementById('prazoMedioGeral').textContent = '0';
        if (chartPrazoMedioInstance) {
          chartPrazoMedioInstance.destroy();
          chartPrazoMedioInstance = null;
        }
        return;
      }

      // Fun√ß√£o para converter data DD.MM.YYYY para objeto Date
      function parseData(dataStr) {
        if (!dataStr) return null;
        const partes = dataStr.split('.');
        if (partes.length !== 3) return null;
        // Date(ano, m√™s-1, dia)
        return new Date(partes[2], partes[1] - 1, partes[0]);
      }

      // Calcular diferen√ßas e agrupar por m√™s/ano
      const prazosPorMes = {};
      let somaTotalDias = 0;
      let totalNotasValidas = 0;

      notasConcluidas.forEach(item => {
        const inicioPlanejado = parseData(item.inicio_planejado);
        const concluida = parseData(item.concluida_em);

        if (inicioPlanejado && concluida) {
          // Calcular diferen√ßa em dias (data de conclus√£o - in√≠cio planejado)
          const diferencaDias = Math.round((concluida - inicioPlanejado) / (1000 * 60 * 60 * 24));

          // Agrupar por m√™s/ano (baseado na data de conclus√£o)
          const mesAno = `${String(concluida.getMonth() + 1).padStart(2, '0')}.${concluida.getFullYear()}`;

          if (!prazosPorMes[mesAno]) {
            prazosPorMes[mesAno] = { soma: 0, count: 0 };
          }

          prazosPorMes[mesAno].soma += diferencaDias;
          prazosPorMes[mesAno].count++;

          somaTotalDias += diferencaDias;
          totalNotasValidas++;
        }
      });

      // Calcular m√©dias mensais
      const mesesOrdenados = Object.keys(prazosPorMes).sort((a, b) => {
        const [mesA, anoA] = a.split('.').map(Number);
        const [mesB, anoB] = b.split('.').map(Number);
        return (anoA * 12 + mesA) - (anoB * 12 + mesB);
      });

      const labels = mesesOrdenados;
      const medias = mesesOrdenados.map(mes => {
        const media = prazosPorMes[mes].soma / prazosPorMes[mes].count;
        return Math.round(media * 10) / 10; // Arredondar para 1 casa decimal
      });

      // Atualizar contadores
      const prazoMedioGeral = totalNotasValidas > 0 ? Math.round((somaTotalDias / totalNotasValidas) * 10) / 10 : 0;
      document.getElementById('totalNotasAnalisadas').textContent = totalNotasValidas;
      document.getElementById('prazoMedioGeral').textContent = prazoMedioGeral;

      // Destruir gr√°fico anterior se existir
      if (chartPrazoMedioInstance) {
        chartPrazoMedioInstance.destroy();
      }

      // Criar novo gr√°fico
      const ctx = document.getElementById('chartPrazoMedio').getContext('2d');
      chartPrazoMedioInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Prazo M√©dio (dias)',
            data: medias,
            backgroundColor: 'rgba(255, 152, 0, 0.2)',
            borderColor: 'rgba(255, 152, 0, 1)',
            borderWidth: 3,
            pointBackgroundColor: 'rgba(255, 152, 0, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8,
            tension: 0.3,
            fill: false,
            datalabels: {
              display: true,
              align: 'top',
              anchor: 'end',
              offset: 6,
              formatter: (value) => {
                return value.toFixed(1) + ' dias';
              },
              font: {
                size: 11,
                family: 'Roboto',
                weight: 'bold'
              },
              color: '#ff9800',
              backgroundColor: 'rgba(255,255,255,0.9)',
              borderRadius: 4,
              padding: 4
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(255, 152, 0, 0.9)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function (context) {
                  return 'Prazo m√©dio: ' + context.parsed.y + ' dias';
                },
                afterLabel: function (context) {
                  const mes = labels[context.dataIndex];
                  const info = prazosPorMes[mes];
                  return 'Notas: ' + info.count;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'M√™s/Ano',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666',
                callback: function (value) {
                  return value + ' dias';
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Prazo M√©dio (dias)',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Gr√°fico Prazo M√©dio (Exceto Mini/Micro Gera√ß√£o)
    window.gerarGraficoPrazoMedioExceto = function (dados) {
      if (!dados || dados.length === 0) {
        return;
      }

      // Obter ano selecionado no filtro
      const selectAno = document.getElementById('filtroAnoPrazoMedioExceto');
      const anoSelecionado = selectAno ? selectAno.value : 'todos';

      // Obter descri√ß√µes selecionadas nos checkboxes
      const checkboxes = document.querySelectorAll('#containerCheckboxesDescricoesPrazoExceto input[type="checkbox"]');
      const descricoesChecadas = new Set();
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          descricoesChecadas.add(checkbox.value);
        }
      });

      // Obter c√≥digos medidas selecionados nos checkboxes
      const checkboxesCodigo = document.querySelectorAll('#containerCheckboxesCodigoMedidasPrazoExceto input[type="checkbox"]');
      const codigosChecados = new Set();
      checkboxesCodigo.forEach(checkbox => {
        if (checkbox.checked) {
          codigosChecados.add(checkbox.value);
        }
      });

      // Filtrar apenas notas conclu√≠das (CONC CTEC ou CONC RTEC) que N√ÉO sejam mini/micro gera√ß√£o
      const notasConcluidas = dados.filter(item => {
        const status = item.status_usuario || '';
        const descricao = item.descricao || '';
        const codigoMedidas = (item.codigo_medidas || '').trim();
        const textoMedidas = (item.texto_medidas || '').toUpperCase();
        const concluidaEm = (item.concluida_em || '').trim();

        // Verificar c√≥digos permitidos (0040, 0041, 0042, 0045)
        const codigosPermitidos = ['0040', '0041', '0042', '0045'];
        if (!codigosPermitidos.includes(codigoMedidas)) return false;

        // Aplicar filtro de ano
        let anoOk = true;
        if (anoSelecionado !== 'todos' && concluidaEm) {
          const partes = concluidaEm.split('.');
          if (partes.length >= 3) {
            anoOk = partes[2] === anoSelecionado;
          }
        }

        // Verificar se o texto de medidas cont√©m "SEM ANEXO" ou varia√ß√µes
        const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') ||
          textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
          textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));

        const statusOk = (status === 'CONC CTEC' || status === 'CONC RTEC') &&
          item.inicio_planejado &&
          item.concluida_em;
        // Excluir mini e micro gera√ß√£o
        const naoEMiniMicro = !descricao.toLowerCase().includes('mini gera√ß√£o') &&
          !descricao.toLowerCase().includes('micro gera√ß√£o');
        const descricaoOk = descricoesChecadas.size === 0 || descricoesChecadas.has(descricao);
        const codigoOk = codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);
        return statusOk && naoEMiniMicro && descricaoOk && codigoOk && anoOk && temAnexo;
      });

      if (notasConcluidas.length === 0) {
        document.getElementById('totalNotasAnalisadasExceto').textContent = '0';
        document.getElementById('prazoMedioGeralExceto').textContent = '0';
        if (chartPrazoMedioExcetoInstance) {
          chartPrazoMedioExcetoInstance.destroy();
          chartPrazoMedioExcetoInstance = null;
        }
        return;
      }

      // Fun√ß√£o para converter data DD.MM.YYYY para objeto Date
      function parseData(dataStr) {
        if (!dataStr) return null;
        const partes = dataStr.split('.');
        if (partes.length !== 3) return null;
        return new Date(partes[2], partes[1] - 1, partes[0]);
      }

      // Calcular diferen√ßas e agrupar por m√™s/ano
      const prazosPorMes = {};
      let somaTotalDias = 0;
      let totalNotasValidas = 0;

      notasConcluidas.forEach(item => {
        const inicioPlanejado = parseData(item.inicio_planejado);
        const concluida = parseData(item.concluida_em);

        if (inicioPlanejado && concluida) {
          const diferencaDias = Math.round((concluida - inicioPlanejado) / (1000 * 60 * 60 * 24));
          const mesAno = `${String(concluida.getMonth() + 1).padStart(2, '0')}.${concluida.getFullYear()}`;

          if (!prazosPorMes[mesAno]) {
            prazosPorMes[mesAno] = { soma: 0, count: 0 };
          }

          prazosPorMes[mesAno].soma += diferencaDias;
          prazosPorMes[mesAno].count++;

          somaTotalDias += diferencaDias;
          totalNotasValidas++;
        }
      });

      const mesesOrdenados = Object.keys(prazosPorMes).sort((a, b) => {
        const [mesA, anoA] = a.split('.').map(Number);
        const [mesB, anoB] = b.split('.').map(Number);
        return (anoA * 12 + mesA) - (anoB * 12 + mesB);
      });

      const labels = mesesOrdenados;
      const medias = mesesOrdenados.map(mes => {
        const media = prazosPorMes[mes].soma / prazosPorMes[mes].count;
        return Math.round(media * 10) / 10;
      });

      const prazoMedioGeral = totalNotasValidas > 0 ? Math.round((somaTotalDias / totalNotasValidas) * 10) / 10 : 0;
      document.getElementById('totalNotasAnalisadasExceto').textContent = totalNotasValidas;
      document.getElementById('prazoMedioGeralExceto').textContent = prazoMedioGeral;

      if (chartPrazoMedioExcetoInstance) {
        chartPrazoMedioExcetoInstance.destroy();
      }

      const ctx = document.getElementById('chartPrazoMedioExceto').getContext('2d');
      chartPrazoMedioExcetoInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Prazo M√©dio (dias)',
            data: medias,
            backgroundColor: 'rgba(76, 175, 80, 0.2)',
            borderColor: 'rgba(76, 175, 80, 1)',
            borderWidth: 3,
            pointBackgroundColor: 'rgba(76, 175, 80, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8,
            tension: 0.3,
            fill: false,
            datalabels: {
              display: true,
              align: 'top',
              anchor: 'end',
              offset: 6,
              formatter: (value) => {
                return value.toFixed(1) + ' dias';
              },
              font: {
                size: 11,
                family: 'Roboto',
                weight: 'bold'
              },
              color: '#4caf50',
              backgroundColor: 'rgba(255,255,255,0.9)',
              borderRadius: 4,
              padding: 4
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(76, 175, 80, 0.9)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function (context) {
                  return 'Prazo m√©dio: ' + context.parsed.y + ' dias';
                },
                afterLabel: function (context) {
                  const mes = labels[context.dataIndex];
                  const info = prazosPorMes[mes];
                  return 'Notas: ' + info.count;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'M√™s/Ano',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666',
                callback: function (value) {
                  return value + ' dias';
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Prazo M√©dio (dias)',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Gr√°fico Prazo M√©dio (Somente Mini/Micro Gera√ß√£o)
    window.gerarGraficoPrazoMedioMiniMicro = function (dados) {
      if (!dados || dados.length === 0) {
        return;
      }

      // Obter ano selecionado no filtro
      const selectAno = document.getElementById('filtroAnoPrazoMedioMiniMicro');
      const anoSelecionado = selectAno ? selectAno.value : 'todos';

      // Obter descri√ß√µes selecionadas nos checkboxes
      const checkboxes = document.querySelectorAll('#containerCheckboxesDescricoesPrazoMiniMicro input[type="checkbox"]');
      const descricoesChecadas = new Set();
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          descricoesChecadas.add(checkbox.value);
        }
      });

      // Obter c√≥digos medidas selecionados nos checkboxes
      const checkboxesCodigo = document.querySelectorAll('#containerCheckboxesCodigoMedidasPrazoMiniMicro input[type="checkbox"]');
      const codigosChecados = new Set();
      checkboxesCodigo.forEach(checkbox => {
        if (checkbox.checked) {
          codigosChecados.add(checkbox.value);
        }
      });

      // Filtrar apenas notas conclu√≠das (CONC CTEC ou CONC RTEC) que SEJAM mini/micro gera√ß√£o
      const notasConcluidas = dados.filter(item => {
        const status = item.status_usuario || '';
        const descricao = item.descricao || '';
        const codigoMedidas = (item.codigo_medidas || '').trim();
        const textoMedidas = (item.texto_medidas || '').toUpperCase();
        const concluidaEm = (item.concluida_em || '').trim();

        // Verificar c√≥digos permitidos (0040, 0041, 0042, 0045)
        const codigosPermitidos = ['0040', '0041', '0042', '0045'];
        if (!codigosPermitidos.includes(codigoMedidas)) return false;

        // Aplicar filtro de ano
        let anoOk = true;
        if (anoSelecionado !== 'todos' && concluidaEm) {
          const partes = concluidaEm.split('.');
          if (partes.length >= 3) {
            anoOk = partes[2] === anoSelecionado;
          }
        }

        // Verificar se o texto de medidas cont√©m "SEM ANEXO" ou varia√ß√µes
        const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') ||
          textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
          textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));

        const statusOk = (status === 'CONC CTEC' || status === 'CONC RTEC') &&
          item.inicio_planejado &&
          item.concluida_em;
        // Incluir apenas mini e micro gera√ß√£o
        const ehMiniMicro = descricao.toLowerCase().includes('mini gera√ß√£o') ||
          descricao.toLowerCase().includes('micro gera√ß√£o');
        const descricaoOk = descricoesChecadas.size === 0 || descricoesChecadas.has(descricao);
        const codigoOk = codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);
        return statusOk && ehMiniMicro && descricaoOk && codigoOk && anoOk && temAnexo;
      });

      if (notasConcluidas.length === 0) {
        document.getElementById('totalNotasAnalisadasMiniMicro').textContent = '0';
        document.getElementById('prazoMedioGeralMiniMicro').textContent = '0';
        if (chartPrazoMedioMiniMicroInstance) {
          chartPrazoMedioMiniMicroInstance.destroy();
          chartPrazoMedioMiniMicroInstance = null;
        }
        return;
      }

      // Fun√ß√£o para converter data DD.MM.YYYY para objeto Date
      function parseData(dataStr) {
        if (!dataStr) return null;
        const partes = dataStr.split('.');
        if (partes.length !== 3) return null;
        return new Date(partes[2], partes[1] - 1, partes[0]);
      }

      // Calcular diferen√ßas e agrupar por m√™s/ano
      const prazosPorMes = {};
      let somaTotalDias = 0;
      let totalNotasValidas = 0;

      notasConcluidas.forEach(item => {
        const inicioPlanejado = parseData(item.inicio_planejado);
        const concluida = parseData(item.concluida_em);

        if (inicioPlanejado && concluida) {
          const diferencaDias = Math.round((concluida - inicioPlanejado) / (1000 * 60 * 60 * 24));
          const mesAno = `${String(concluida.getMonth() + 1).padStart(2, '0')}.${concluida.getFullYear()}`;

          if (!prazosPorMes[mesAno]) {
            prazosPorMes[mesAno] = { soma: 0, count: 0 };
          }

          prazosPorMes[mesAno].soma += diferencaDias;
          prazosPorMes[mesAno].count++;

          somaTotalDias += diferencaDias;
          totalNotasValidas++;
        }
      });

      const mesesOrdenados = Object.keys(prazosPorMes).sort((a, b) => {
        const [mesA, anoA] = a.split('.').map(Number);
        const [mesB, anoB] = b.split('.').map(Number);
        return (anoA * 12 + mesA) - (anoB * 12 + mesB);
      });

      const labels = mesesOrdenados;
      const medias = mesesOrdenados.map(mes => {
        const media = prazosPorMes[mes].soma / prazosPorMes[mes].count;
        return Math.round(media * 10) / 10;
      });

      const prazoMedioGeral = totalNotasValidas > 0 ? Math.round((somaTotalDias / totalNotasValidas) * 10) / 10 : 0;
      document.getElementById('totalNotasAnalisadasMiniMicro').textContent = totalNotasValidas;
      document.getElementById('prazoMedioGeralMiniMicro').textContent = prazoMedioGeral;

      if (chartPrazoMedioMiniMicroInstance) {
        chartPrazoMedioMiniMicroInstance.destroy();
      }

      const ctx = document.getElementById('chartPrazoMedioMiniMicro').getContext('2d');
      chartPrazoMedioMiniMicroInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Prazo M√©dio (dias)',
            data: medias,
            backgroundColor: 'rgba(33, 150, 243, 0.2)',
            borderColor: 'rgba(33, 150, 243, 1)',
            borderWidth: 3,
            pointBackgroundColor: 'rgba(33, 150, 243, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8,
            tension: 0.3,
            fill: false,
            datalabels: {
              display: true,
              align: 'top',
              anchor: 'end',
              offset: 6,
              formatter: (value) => {
                return value.toFixed(1) + ' dias';
              },
              font: {
                size: 11,
                family: 'Roboto',
                weight: 'bold'
              },
              color: '#2196f3',
              backgroundColor: 'rgba(255,255,255,0.9)',
              borderRadius: 4,
              padding: 4
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(33, 150, 243, 0.9)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function (context) {
                  return 'Prazo m√©dio: ' + context.parsed.y + ' dias';
                },
                afterLabel: function (context) {
                  const mes = labels[context.dataIndex];
                  const info = prazosPorMes[mes];
                  return 'Notas: ' + info.count;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'M√™s/Ano',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666',
                callback: function (value) {
                  return value + ' dias';
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Prazo M√©dio (dias)',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Fun√ß√£o para gerar gr√°fico filtrado de Mini Gera√ß√£o
    window.gerarGraficoMiniGeracao = function (dados) {
      if (!dados || dados.length === 0) {
        document.getElementById('totalMiniGeracao').textContent = '0';
        return;
      }

      // Obter c√≥digos medidas selecionados nos checkboxes
      const checkboxesCodigo = document.querySelectorAll('#containerCheckboxesCodigoMedidasMiniGeracao input[type="checkbox"]');
      const codigosChecados = new Set();
      checkboxesCodigo.forEach(checkbox => {
        if (checkbox.checked) {
          codigosChecados.add(checkbox.value);
        }
      });

      // Filtrar apenas registros de Mini/Micro Gera√ß√£o e status ABER ou ANDM
      const dadosFiltrados = dados.filter(item => {
        const descricao = (item.descricao || '').toLowerCase();
        const temDescricao = descricao.includes('mini gera√ß√£o') || descricao.includes('micro gera√ß√£o');
        const statusRaw = (item.status_usuario || item.status || item.Status || item.status_atual || '').trim().toUpperCase();
        const statusBase = typeof normalizarStatusBase === 'function'
          ? normalizarStatusBase(statusRaw)
          : (statusRaw.includes('ABER') ? 'ABER' : (statusRaw.includes('ANDM') ? 'ANDM' : ''));
        const temStatus = statusBase === 'ABER' || statusBase === 'ANDM';
        const codigoMedidas = (item.codigo_medidas || '').trim();
        const codigoOk = codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);
        return temDescricao && temStatus && codigoOk;
      });

      console.log('Total de registros Mini Gera√ß√£o:', dadosFiltrados.length);
      document.getElementById('totalMiniGeracao').textContent = dadosFiltrados.length;

      if (dadosFiltrados.length === 0) {
        // Limpar gr√°fico se n√£o houver dados
        if (chartMiniGeracaoInstance) {
          chartMiniGeracaoInstance.destroy();
          chartMiniGeracaoInstance = null;
        }
        return;
      }

      // Agrupar dados por fim_planejado e contar
      const agrupamento = {};
      dadosFiltrados.forEach(item => {
        const fimPlanejado = item.fim_planejado || 'Sem data';
        if (agrupamento[fimPlanejado]) {
          agrupamento[fimPlanejado]++;
        } else {
          agrupamento[fimPlanejado] = 1;
        }
      });

      // Converter para arrays e ordenar por data
      const labels = Object.keys(agrupamento).sort((a, b) => {
        if (a === 'Sem data') return 1;
        if (b === 'Sem data') return -1;
        return new Date(a.split('.').reverse().join('-')) - new Date(b.split('.').reverse().join('-'));
      });
      const valores = labels.map(label => agrupamento[label]);

      // Destruir gr√°fico anterior se existir
      if (chartMiniGeracaoInstance) {
        chartMiniGeracaoInstance.destroy();
      }

      // Criar novo gr√°fico
      const ctx = document.getElementById('chartMiniGeracao').getContext('2d');
      chartMiniGeracaoInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade de Notas - Mini Gera√ß√£o',
            data: valores,
            backgroundColor: 'rgba(255, 152, 0, 0.7)',
            borderColor: 'rgba(255, 152, 0, 1)',
            borderWidth: 2,
            borderRadius: 8,
            hoverBackgroundColor: 'rgba(255, 167, 38, 0.8)',
            hoverBorderColor: 'rgba(255, 167, 38, 1)',
            datalabels: {
              display: true,
              anchor: 'end',
              align: 'top',
              offset: 4,
              font: {
                size: 11,
                family: 'Roboto',
                weight: 'bold'
              },
              color: '#ff9800'
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          onClick: (event, activeElements) => {
            if (activeElements.length > 0) {
              const index = activeElements[0].index;
              const dataLabel = labels[index];
              const statusLabel = 'GD';

              // Filtrar notas correspondentes √† barra clicada
              const notasFiltradas = dadosFiltrados.filter(item => {
                const fimPlanejado = item.fim_planejado || 'Sem data';
                return fimPlanejado === dataLabel;
              });

              abrirModalNotas(notasFiltradas, dataLabel, statusLabel);
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(255, 152, 0, 0.9)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function (context) {
                  return 'Notas: ' + context.parsed.y;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Quantidade',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: 'Roboto'
                },
                color: '#666',
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'Fim Planejado',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Fun√ß√£o para gerar gr√°fico com todos os tipos de descri√ß√£o (incluindo Mini Gera√ß√£o)
    window.gerarGraficoOutrosTipos = function (dados) {
      // Obter c√≥digos medidas selecionados nos checkboxes
      const checkboxesCodigo = document.querySelectorAll('#containerCheckboxesCodigoMedidasSemGeracoes input[type="checkbox"]');
      const codigosChecados = new Set();
      checkboxesCodigo.forEach(checkbox => {
        if (checkbox.checked) {
          codigosChecados.add(checkbox.value);
        }
      });

      // Filtrar apenas status ANDM e ABER
      const dadosFiltrados = dados.filter(item => {
        const status = item.status_usuario || '';
        const codigoMedidas = item.codigo_medidas || '';
        const codigoOk = codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);
        return (status === 'ANDM' || status === 'ABER') && codigoOk;
      });

      // Atualizar contador total
      document.getElementById('totalOutrosTipos').textContent = dadosFiltrados.length;

      if (dadosFiltrados.length === 0) {
        // Limpar gr√°fico se n√£o houver dados
        if (chartOutrosTiposInstance) {
          chartOutrosTiposInstance.destroy();
          chartOutrosTiposInstance = null;
        }
        document.getElementById('tiposUnicos').textContent = '0';
        return;
      }

      // Agrupar dados por descri√ß√£o e contar
      const agrupamento = {};
      dadosFiltrados.forEach(item => {
        const descricao = item.descricao || 'Sem descri√ß√£o';
        if (agrupamento[descricao]) {
          agrupamento[descricao]++;
        } else {
          agrupamento[descricao] = 1;
        }
      });

      // Atualizar contador de tipos √∫nicos
      document.getElementById('tiposUnicos').textContent = Object.keys(agrupamento).length;

      // Converter para arrays e ordenar por quantidade (decrescente)
      const ordenado = Object.entries(agrupamento).sort((a, b) => b[1] - a[1]);
      const labels = ordenado.map(item => item[0]);
      const valores = ordenado.map(item => item[1]);

      // Destruir gr√°fico anterior se existir
      if (chartOutrosTiposInstance) {
        chartOutrosTiposInstance.destroy();
      }

      // Criar novo gr√°fico
      const ctx = document.getElementById('chartOutrosTipos').getContext('2d');
      chartOutrosTiposInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade de Notas - Todos os Tipos',
            data: valores,
            backgroundColor: 'rgba(25, 118, 210, 0.7)',
            borderColor: 'rgba(25, 118, 210, 1)',
            borderWidth: 2,
            borderRadius: 8,
            hoverBackgroundColor: 'rgba(66, 165, 245, 0.8)',
            hoverBorderColor: 'rgba(66, 165, 245, 1)',
            datalabels: {
              display: true,
              anchor: 'end',
              align: 'top',
              offset: 4,
              font: {
                size: 11,
                family: 'Roboto',
                weight: 'bold'
              },
              color: '#1976d2'
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          onClick: (event, activeElements) => {
            if (activeElements.length > 0) {
              const index = activeElements[0].index;
              const descricaoLabel = labels[index];

              // Filtrar notas correspondentes √† barra clicada
              const notasFiltradas = dadosFiltrados.filter(item => {
                const descricao = item.descricao || 'Sem descri√ß√£o';
                return descricao === descricaoLabel;
              });

              abrirModalNotasSemEdicao(notasFiltradas, descricaoLabel);
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(25, 118, 210, 0.9)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function (context) {
                  return 'Notas: ' + context.parsed.y;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Quantidade',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: 'Roboto'
                },
                color: '#666',
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'Tipo de Descri√ß√£o',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Fun√ß√£o para calcular similaridade entre strings
    function calcularSimilaridade(str1, str2) {
      const s1 = str1.toLowerCase().trim();
      const s2 = str2.toLowerCase().trim();
      
      // Se uma string est√° contida na outra
      if (s1.includes(s2) || s2.includes(s1)) {
        return 0.9;
      }
      
      // Calcular dist√¢ncia de Levenshtein simplificada
      const longer = s1.length > s2.length ? s1 : s2;
      const shorter = s1.length > s2.length ? s2 : s1;
      
      if (longer.length === 0) return 1.0;
      
      const editDistance = getEditDistance(shorter, longer);
      return (longer.length - editDistance) / longer.length;
    }

    // Fun√ß√£o auxiliar para calcular dist√¢ncia de Levenshtein
    function getEditDistance(s1, s2) {
      const costs = [];
      for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
          if (i === 0) {
            costs[j] = j;
          } else if (j > 0) {
            let newValue = costs[j - 1];
            if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
              newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
            }
            costs[j - 1] = lastValue;
            lastValue = newValue;
          }
        }
        if (i > 0) costs[s2.length] = lastValue;
      }
      return costs[s2.length];
    }

    // Fun√ß√£o para agrupar textos parecidos (com limiar de similaridade)
    function agruparTextosParecidos(textos, limiarSimilaridade = 0.75) {
      const grupos = [];
      const processados = new Set();
      
      textos.forEach((texto1, idx1) => {
        if (processados.has(idx1)) return;
        
        const grupo = {
          principal: texto1,
          similares: [texto1],
          indices: [idx1]
        };
        
        processados.add(idx1);
        
        textos.forEach((texto2, idx2) => {
          if (idx1 === idx2 || processados.has(idx2)) return;
          
          const similaridade = calcularSimilaridade(texto1, texto2);
          if (similaridade >= limiarSimilaridade) {
            grupo.similares.push(texto2);
            grupo.indices.push(idx2);
            processados.add(idx2);
          }
        });
        
        grupos.push(grupo);
      });
      
      return grupos;
    }

    // Fun√ß√£o para gerar gr√°fico de Texto Medidas
    window.gerarGraficoTextoMedidas = function (dados) {
      // Obter c√≥digos medidas selecionados nos checkboxes (mesmo filtro do gr√°fico OutrosTipos)
      const checkboxesCodigo = document.querySelectorAll('#containerCheckboxesCodigoMedidasSemGeracoes input[type="checkbox"]');
      const codigosChecados = new Set();
      checkboxesCodigo.forEach(checkbox => {
        if (checkbox.checked) {
          codigosChecados.add(checkbox.value);
        }
      });

      // Filtrar apenas status ANDM e ABER e c√≥digos selecionados (incluindo vazios)
      const dadosFiltrados = dados.filter(item => {
        const status = item.status_usuario || '';
        const codigoMedidas = item.codigo_medidas || '';
        const codigoOk = codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);
        return (status === 'ANDM' || status === 'ABER') && codigoOk;
      });

      // Atualizar contador total
      document.getElementById('totalTextoMedidas').textContent = dadosFiltrados.length;

      if (dadosFiltrados.length === 0) {
        if (chartTextoMedidasInstance) {
          chartTextoMedidasInstance.destroy();
          chartTextoMedidasInstance = null;
        }
        document.getElementById('categoriasUnicasTextoMedidas').textContent = '0';
        return;
      }

      // Contar ocorr√™ncias de cada texto (mantendo cada um √∫nico)
      const contagem = {};
      dadosFiltrados.forEach(item => {
        const textoMedidas = (item.texto_medidas || '').trim();
        const texto = textoMedidas.length > 0 ? textoMedidas : '‚¨ú Sem Texto de Medidas';
        contagem[texto] = (contagem[texto] || 0) + 1;
      });

      // Ordenar por quantidade (decrescente)
      const ordenado = Object.entries(contagem).sort((a, b) => b[1] - a[1]);
      const labels = ordenado.map(item => item[0].length > 50 ? item[0].substring(0, 50) + '...' : item[0]);
      const valores = ordenado.map(item => item[1]);

      // Total de categorias √∫nicas
      document.getElementById('categoriasUnicasTextoMedidas').textContent = Object.keys(contagem).length;

      // Destruir gr√°fico anterior se existir
      if (chartTextoMedidasInstance) {
        chartTextoMedidasInstance.destroy();
      }

      // Criar novo gr√°fico
      const ctx = document.getElementById('chartTextoMedidas').getContext('2d');
      chartTextoMedidasInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade de Notas - Texto Medidas',
            data: valores,
            backgroundColor: 'rgba(102, 187, 106, 0.7)',
            borderColor: 'rgba(102, 187, 106, 1)',
            borderWidth: 2,
            borderRadius: 8,
            hoverBackgroundColor: 'rgba(129, 199, 132, 0.9)',
            hoverBorderColor: 'rgba(129, 199, 132, 1)',
            datalabels: {
              display: true,
              anchor: 'end',
              align: 'top',
              offset: 4,
              font: {
                size: 11,
                family: 'Roboto',
                weight: 'bold'
              },
              color: '#2e7d32'
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          onClick: (event, activeElements) => {
            if (activeElements.length > 0) {
              const index = activeElements[0].index;
              const textoLabel = labels[index];

              // Filtrar notas correspondentes √† barra clicada
              let notasFiltradas = [];
              
              if (textoLabel === '‚¨ú Sem Texto de Medidas') {
                // Filtrar notas com texto_medidas vazio
                notasFiltradas = dadosFiltrados.filter(item => {
                  const textoMedidas = (item.texto_medidas || '').trim();
                  return textoMedidas.length === 0;
                });
              } else {
                // Buscar o texto original se foi truncado
                let textoOriginal = textoLabel;
                if (textoLabel.endsWith('...')) {
                  textoOriginal = textoLabel.substring(0, textoLabel.length - 3);
                  // Filtrar notas que come√ßam com o texto truncado
                  notasFiltradas = dadosFiltrados.filter(item => {
                    const textoMedidas = (item.texto_medidas || '').trim();
                    return textoMedidas.startsWith(textoOriginal);
                  });
                } else {
                  // Filtrar notas que correspondem exatamente ao texto
                  notasFiltradas = dadosFiltrados.filter(item => {
                    const textoMedidas = (item.texto_medidas || '').trim();
                    return textoMedidas === textoLabel;
                  });
                }
              }

              abrirModalNotasSemEdicao(notasFiltradas, textoLabel);
            }
          },
          plugins: {
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(102, 187, 106, 0.9)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function (context) {
                  return 'Notas: ' + context.parsed.y;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Quantidade',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: 'Roboto'
                },
                color: '#666',
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'Texto de Medidas',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Fun√ß√£o para gerar gr√°fico sem Mini e Micro Gera√ß√£o - Por Fim Planejado
    window.gerarGraficoSemGeracoes = function (dados) {
      // Filtrar dados excluindo mini e micro gera√ß√£o e considerando apenas ANDM e ABER
      const dadosFiltrados = dados.filter(item => {
        const descricao = (item.descricao || '').toLowerCase();
        const statusRaw = (item.status_usuario || item.status || item.Status || item.status_atual || '').trim().toUpperCase();
        const statusBase = typeof normalizarStatusBase === 'function'
          ? normalizarStatusBase(statusRaw)
          : (statusRaw.includes('ABER') ? 'ABER' : (statusRaw.includes('ANDM') ? 'ANDM' : ''));
        return !descricao.includes('mini gera√ß√£o') &&
          !descricao.includes('micro gera√ß√£o') &&
          (statusBase === 'ANDM' || statusBase === 'ABER');
      });

      // Atualizar contador total
      document.getElementById('totalSemGeracoes').textContent = dadosFiltrados.length;

      if (dadosFiltrados.length === 0) {
        // Limpar gr√°fico se n√£o houver dados
        if (chartSemGeracoesInstance) {
          chartSemGeracoesInstance.destroy();
          chartSemGeracoesInstance = null;
        }
        return;
      }

      // Agrupar dados por fim_planejado e contar
      const agrupamento = {};
      dadosFiltrados.forEach(item => {
        const fimPlanejado = item.fim_planejado || 'Sem data';
        if (agrupamento[fimPlanejado]) {
          agrupamento[fimPlanejado]++;
        } else {
          agrupamento[fimPlanejado] = 1;
        }
      });

      // Converter para arrays e ordenar por data
      const labels = Object.keys(agrupamento).sort((a, b) => {
        if (a === 'Sem data') return 1;
        if (b === 'Sem data') return -1;
        return new Date(a.split('.').reverse().join('-')) - new Date(b.split('.').reverse().join('-'));
      });
      const valores = labels.map(label => agrupamento[label]);

      // Destruir gr√°fico anterior se existir
      if (chartSemGeracoesInstance) {
        chartSemGeracoesInstance.destroy();
      }

      // Criar novo gr√°fico
      const ctx = document.getElementById('chartSemGeracoes').getContext('2d');
      chartSemGeracoesInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade de Notas - Sem Mini/Micro Gera√ß√£o',
            data: valores,
            backgroundColor: 'rgba(46, 125, 50, 0.7)',
            borderColor: 'rgba(46, 125, 50, 1)',
            borderWidth: 2,
            borderRadius: 8,
            hoverBackgroundColor: 'rgba(56, 142, 60, 0.9)',
            hoverBorderColor: 'rgba(56, 142, 60, 1)',
            datalabels: {
              display: true,
              anchor: 'end',
              align: 'top',
              offset: 4,
              font: {
                size: 11,
                family: 'Roboto',
                weight: 'bold'
              },
              color: '#2e7d32'
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          onClick: (event, activeElements) => {
            if (activeElements.length > 0) {
              const index = activeElements[0].index;
              const dataLabel = labels[index];
              const statusLabel = 'CARGA';

              // Filtrar notas correspondentes √† barra clicada
              const notasFiltradas = dadosFiltrados.filter(item => {
                const fimPlanejado = item.fim_planejado || 'Sem data';
                return fimPlanejado === dataLabel;
              });

              abrirModalNotas(notasFiltradas, dataLabel, statusLabel);
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(46, 125, 50, 0.9)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function (context) {
                  return 'Notas: ' + context.parsed.y;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Quantidade',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: 'Roboto'
                },
                color: '#666',
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'Fim Planejado',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Gr√°fico de Notas Conclu√≠das por Usu√°rio
    window.gerarGraficoNotasPorUsuario = async function (dados) {
      if (!dados || dados.length === 0) {
        document.getElementById('totalNotasPorUsuario').textContent = '0';
        if (chartNotasPorUsuarioInstance) {
          chartNotasPorUsuarioInstance.destroy();
          chartNotasPorUsuarioInstance = null;
        }
        return;
      }

      // Obter descri√ß√µes selecionadas nos checkboxes
      const checkboxes = document.querySelectorAll('#containerCheckboxesDescricoesNotasPorUsuario input[type="checkbox"]');
      const descricoesChecadas = new Set();
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          descricoesChecadas.add(checkbox.value);
        }
      });

      // Obter m√™s selecionado (Conclu√≠da em)
      const selectMes = document.getElementById('filtroMesNotasPorUsuario');
      const mesSelecionado = selectMes ? selectMes.value : 'todos';

      // Obter c√≥digos de medidas selecionados
      const checkboxesCodigo = document.querySelectorAll('#containerCheckboxesCodigoMedidasNotasPorUsuario input[type="checkbox"]');
      const codigosChecados = new Set();
      checkboxesCodigo.forEach(checkbox => {
        if (checkbox.checked) {
          codigosChecados.add(checkbox.value);
        }
      });

      // Filtrar apenas notas conclu√≠das (status CONC CTEC ou CONC RTEC) com usu√°rio preenchido e com anexo
      const notasConcluidas = dados.filter(item => {
        const status = item.status_usuario || '';
        const usuario = (item.concluido_por || '').trim();
        const descricao = item.descricao || '';
        const codigoMedidas = item.codigo_medidas || '';
        const concluidaEm = item.concluida_em || '';
        const textoMedidas = (item.texto_medidas || '').toUpperCase();

        // Verificar se tem anexo
        const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') ||
          textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
          textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));

        const descricaoOk = descricoesChecadas.size === 0 || descricoesChecadas.has(descricao);
        const codigoOk = codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);

        let mesOk = true;
        if (mesSelecionado !== 'todos') {
          const partes = concluidaEm.split('.');
          if (partes.length >= 3) {
            const mesAno = partes[1] + '.' + partes[2];
            mesOk = mesAno === mesSelecionado;
          } else {
            mesOk = false;
          }
        }

        return (status === 'CONC CTEC' || status === 'CONC RTEC') && usuario !== '' && descricaoOk && codigoOk && mesOk && temAnexo;
      });

      if (notasConcluidas.length === 0) {
        document.getElementById('totalNotasPorUsuario').textContent = '0';
        if (chartNotasPorUsuarioInstance) {
          chartNotasPorUsuarioInstance.destroy();
          chartNotasPorUsuarioInstance = null;
        }
        return;
      }

      // Atualizar total
      document.getElementById('totalNotasPorUsuario').textContent = notasConcluidas.length;

      // Agrupar por usu√°rio (concluido_por) - mant√©m a matr√≠cula como chave
      const agrupamentoUsuario = {};
      const usuariosUnicos = new Set();
      
      notasConcluidas.forEach(item => {
        const usuario = (item.concluido_por || 'Desconhecido').trim();
        usuariosUnicos.add(usuario);
        if (agrupamentoUsuario[usuario]) {
          agrupamentoUsuario[usuario]++;
        } else {
          agrupamentoUsuario[usuario] = 1;
        }
      });

      // Buscar dados de usu√°rios da tabela user_login_nt
      let mapaNomesUsuarios = {};
      try {
        // Criar um array com os valores √∫nicos para fazer o filtro
        const usuariosArray = Array.from(usuariosUnicos);
        
        if (usuariosArray.length > 0) {
          // Fazer consulta para todas as matr√≠culas de uma vez
          const { data: usuariosData, error } = await supabaseClient
            .from('user_login_nt')
            .select('matricula, nome_usuario');

          if (!error && usuariosData) {
            // Criar mapa de matr√≠cula (lowercase) -> nome do usu√°rio
            usuariosData.forEach(user => {
              if (user.matricula && user.nome_usuario) {
                // Converter matr√≠cula para lowercase para compara√ß√£o case-insensitive
                mapaNomesUsuarios[user.matricula.toLowerCase()] = user.nome_usuario;
              }
            });
          }
        }
      } catch (err) {
        console.error('Erro ao buscar dados de usu√°rios:', err);
      }

      // Converter para arrays, ordenar por quantidade (decrescente) e substituir nomes
      const labels = Object.keys(agrupamentoUsuario).sort((a, b) => {
        return agrupamentoUsuario[b] - agrupamentoUsuario[a];
      }).map(matricula => {
        // Se encontrou nome do usu√°rio, exibe "Nome (Matricula)", sen√£o apenas "(Matricula)"
        // Buscar usando lowercase para case-insensitive
        const nomeUsuario = mapaNomesUsuarios[matricula.toLowerCase()];
        if (nomeUsuario) {
          return `${nomeUsuario} (${matricula})`;
        } else {
          return `(${matricula})`;
        }
      });

      const valores = Object.keys(agrupamentoUsuario).sort((a, b) => {
        return agrupamentoUsuario[b] - agrupamentoUsuario[a];
      }).map(label => agrupamentoUsuario[label]);

      // Cores em tons de verde para melhor visualiza√ß√£o
      const cores = [
        'rgba(46, 125, 50, 0.7)',   // Verde escuro
        'rgba(56, 142, 60, 0.7)',   // Verde m√©dio-escuro
        'rgba(67, 160, 71, 0.7)',   // Verde m√©dio
        'rgba(76, 175, 80, 0.7)',   // Verde padr√£o
        'rgba(102, 187, 106, 0.7)', // Verde claro
        'rgba(129, 199, 132, 0.7)', // Verde muito claro
        'rgba(27, 94, 32, 0.7)',    // Verde escuro intenso
        'rgba(46, 125, 50, 0.7)',   // Verde escuro (repetido)
        'rgba(56, 142, 60, 0.7)',   // Verde m√©dio-escuro (repetido)
        'rgba(76, 175, 80, 0.7)'    // Verde padr√£o (repetido)
      ];

      const backgroundColors = labels.map((_, index) => cores[index % cores.length]);
      const borderColors = backgroundColors.map(color => color.replace('0.7', '1'));

      // Destruir gr√°fico anterior se existir
      if (chartNotasPorUsuarioInstance) {
        chartNotasPorUsuarioInstance.destroy();
      }

      // Criar novo gr√°fico
      const ctx = document.getElementById('chartNotasPorUsuario').getContext('2d');
      chartNotasPorUsuarioInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade de Notas Conclu√≠das',
            data: valores,
            backgroundColor: backgroundColors,
            borderColor: borderColors,
            borderWidth: 2,
            borderRadius: 8,
            hoverBackgroundColor: borderColors,
            barPercentage: 0.8,
            categoryPercentage: 0.9
          }]
        },
        options: {
          indexAxis: 'y', // Gr√°fico horizontal
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.0,
          onClick: (event, activeElements) => {
            if (activeElements.length > 0) {
              const index = activeElements[0].index;
              const usuarioLabel = labels[index];
              
              // Extrair matr√≠cula do label (est√° no formato "Nome (Matricula)" ou "(Matricula)")
              const matriculaMatch = usuarioLabel.match(/\(([^)]+)\)$/);
              const matricula = matriculaMatch ? matriculaMatch[1] : usuarioLabel;

              // Filtrar notas correspondentes ao usu√°rio clicado (usando a matr√≠cula)
              // Compara√ß√£o case-insensitive
              const notasFiltradas = notasConcluidas.filter(item => {
                const usuario = (item.concluido_por || '').trim();
                return usuario.toLowerCase() === matricula.toLowerCase();
              });

              abrirModalNotasSemEdicao(notasFiltradas, `Notas de ${usuarioLabel}`);
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.7)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function (context) {
                  return 'Notas: ' + context.parsed.x;
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Quantidade de Notas',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            y: {
              ticks: {
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'Usu√°rio',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Fun√ß√£o para gerar gr√°fico de Notas Conclu√≠das por M√™s

        // Fun√ß√µes de filtro para o gr√°fico de Aprova√ß√£o/Reprova√ß√£o por Usu√°rio
        window.popularFiltroDescricoesAprovacaoReprovacao = function (dados) {
          const descricoes = new Set();
          dados.forEach(item => {
            const status = item.status_usuario || '';
            const descricao = item.descricao || '';
            const textoMedidas = (item.texto_medidas || '').toUpperCase();
            const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') ||
              textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
              textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));
            if ((status === 'CONC CTEC' || status === 'CONC RTEC') && descricao && temAnexo) {
              descricoes.add(descricao);
            }
          });
          const container = document.getElementById('containerCheckboxesDescricoesAprovacaoReprovacao');
          container.innerHTML = '';
          Array.from(descricoes).sort().forEach(descricao => {
            const label = document.createElement('label');
            label.style.display = 'flex';
            label.style.alignItems = 'center';
            label.style.gap = '6px';
            label.style.cursor = 'pointer';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = descricao;
            checkbox.checked = true;
            checkbox.onchange = () => gerarGraficoAprovacaoReprovacaoPorUsuario(dadosGlobais);
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(descricao));
            container.appendChild(label);
          });
        };

        window.toggleDropdownDescricoesAprovacaoReprovacao = function () {
          const container = document.getElementById('containerCheckboxesDescricoesAprovacaoReprovacao');
          container.style.display = container.style.display === 'none' ? 'flex' : 'none';
        };

        window.popularFiltroMesesAprovacaoReprovacao = function (dados) {
          const meses = new Set();
          dados.forEach(item => {
            const status = item.status_usuario || '';
            const concluidaEm = item.concluida_em || '';
            const textoMedidas = (item.texto_medidas || '').toUpperCase();
            const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') ||
              textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
              textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));
            if ((status === 'CONC CTEC' || status === 'CONC RTEC') && concluidaEm && temAnexo) {
              const partes = concluidaEm.split('.');
              if (partes.length >= 3) {
                const mesAno = partes[1] + '.' + partes[2];
                meses.add(mesAno);
              }
            }
          });
          const select = document.getElementById('filtroMesAprovacaoReprovacao');
          select.innerHTML = '<option value="todos">Todos os meses</option>';
          const mesesArray = Array.from(meses).sort((a, b) => {
            const [mesA, anoA] = a.split('.');
            const [mesB, anoB] = b.split('.');
            return anoA !== anoB ? anoB - anoA : mesB - mesA;
          });

          mesesArray.forEach(mesAno => {
            const option = document.createElement('option');
            option.value = mesAno;
            option.textContent = mesAno;
            select.appendChild(option);
          });

          // Selecionar m√™s atual ou anterior se houver dados
          const dataAtual = new Date();
          const mesAtual = String(dataAtual.getMonth() + 1).padStart(2, '0');
          const anoAtual = dataAtual.getFullYear();
          const mesAnoAtual = `${mesAtual}.${anoAtual}`;

          if (mesesArray.includes(mesAnoAtual)) {
            select.value = mesAnoAtual;
          } else {
            const dataAnterior = new Date(anoAtual, parseInt(mesAtual) - 2, 1);
            const mesAnterior = String(dataAnterior.getMonth() + 1).padStart(2, '0');
            const anoAnterior = dataAnterior.getFullYear();
            const mesAnoAnterior = `${mesAnterior}.${anoAnterior}`;

            if (mesesArray.includes(mesAnoAnterior)) {
              select.value = mesAnoAnterior;
            } else if (mesesArray.length > 0) {
              select.value = mesesArray[mesesArray.length - 1];
            }
          }
        };

        window.aplicarFiltroMesAprovacaoReprovacao = function () {
          gerarGraficoAprovacaoReprovacaoPorUsuario(dadosGlobais);
        };

        window.popularFiltroCodigoMedidasAprovacaoReprovacao = function (dados) {
          const codigos = new Set();
          dados.forEach(item => {
            const status = item.status_usuario || '';
            const codigoMedidas = item.codigo_medidas || '';
            const textoMedidas = (item.texto_medidas || '').toUpperCase();
            const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') ||
              textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
              textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));
            if ((status === 'CONC CTEC' || status === 'CONC RTEC') && codigoMedidas && temAnexo) {
              codigos.add(codigoMedidas);
            }
          });
          const container = document.getElementById('containerCheckboxesCodigoMedidasAprovacaoReprovacao');
          container.innerHTML = '';
          Array.from(codigos).sort().forEach(codigo => {
            const label = document.createElement('label');
            label.style.display = 'flex';
            label.style.alignItems = 'center';
            label.style.gap = '6px';
            label.style.cursor = 'pointer';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = codigo;
            checkbox.checked = true;
            checkbox.onchange = () => gerarGraficoAprovacaoReprovacaoPorUsuario(dadosGlobais);
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(codigo));
            container.appendChild(label);
          });
        };

        window.toggleDropdownCodigoMedidasAprovacaoReprovacao = function () {
          const container = document.getElementById('containerCheckboxesCodigoMedidasAprovacaoReprovacao');
          container.style.display = container.style.display === 'none' ? 'flex' : 'none';
        };

        // Gr√°fico de Percentual de Aprova√ß√£o/Reprova√ß√£o por Usu√°rio
        window.gerarGraficoAprovacaoReprovacaoPorUsuario = async function (dados) {
          if (!dados || dados.length === 0) {
            document.getElementById('totalNotasAprovacaoReprovacao').textContent = '0';
            if (chartAprovacaoReprovacaoPorUsuarioInstance) {
              chartAprovacaoReprovacaoPorUsuarioInstance.destroy();
              chartAprovacaoReprovacaoPorUsuarioInstance = null;
            }
            return;
          }

          // Obter descri√ß√µes selecionadas nos checkboxes
          const checkboxes = document.querySelectorAll('#containerCheckboxesDescricoesAprovacaoReprovacao input[type="checkbox"]');
          const descricoesChecadas = new Set();
          checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
              descricoesChecadas.add(checkbox.value);
            }
          });

          // Obter m√™s selecionado (Conclu√≠da em)
          const selectMes = document.getElementById('filtroMesAprovacaoReprovacao');
          const mesSelecionado = selectMes ? selectMes.value : 'todos';

          // Obter c√≥digos de medidas selecionados
          const checkboxesCodigo = document.querySelectorAll('#containerCheckboxesCodigoMedidasAprovacaoReprovacao input[type="checkbox"]');
          const codigosChecados = new Set();
          checkboxesCodigo.forEach(checkbox => {
            if (checkbox.checked) {
              codigosChecados.add(checkbox.value);
            }
          });

          // Filtrar apenas notas conclu√≠das (status CONC CTEC ou CONC RTEC) com usu√°rio preenchido e com anexo
          const notasConcluidas = dados.filter(item => {
            const status = item.status_usuario || '';
            const usuario = (item.concluido_por || '').trim();
            const descricao = item.descricao || '';
            const codigoMedidas = item.codigo_medidas || '';
            const concluidaEm = item.concluida_em || '';
            const textoMedidas = (item.texto_medidas || '').toUpperCase();

            // Verificar se tem anexo
            const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') ||
              textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
              textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));

            const descricaoOk = descricoesChecadas.size === 0 || descricoesChecadas.has(descricao);
            const codigoOk = codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);

            let mesOk = true;
            if (mesSelecionado !== 'todos') {
              const partes = concluidaEm.split('.');
              if (partes.length >= 3) {
                const mesAno = partes[1] + '.' + partes[2];
                mesOk = mesAno === mesSelecionado;
              } else {
                mesOk = false;
              }
            }

            return (status === 'CONC CTEC' || status === 'CONC RTEC') && usuario !== '' && descricaoOk && codigoOk && mesOk && temAnexo;
          });

          if (notasConcluidas.length === 0) {
            document.getElementById('totalNotasAprovacaoReprovacao').textContent = '0';
            if (chartAprovacaoReprovacaoPorUsuarioInstance) {
              chartAprovacaoReprovacaoPorUsuarioInstance.destroy();
              chartAprovacaoReprovacaoPorUsuarioInstance = null;
            }
            return;
          }

          // Atualizar total
          document.getElementById('totalNotasAprovacaoReprovacao').textContent = notasConcluidas.length;

          // Agrupar por usu√°rio (concluido_por) e contar aprova√ß√µes/reprova√ß√µes
          const agrupamentoUsuario = {};
          const usuariosUnicos = new Set();
      
          notasConcluidas.forEach(item => {
            const usuario = (item.concluido_por || 'Desconhecido').trim();
            const status = item.status_usuario || '';
            usuariosUnicos.add(usuario);
        
            if (!agrupamentoUsuario[usuario]) {
              agrupamentoUsuario[usuario] = { aprovadas: 0, reprovadas: 0 };
            }
        
            if (status === 'CONC CTEC') {
              agrupamentoUsuario[usuario].aprovadas++;
            } else if (status === 'CONC RTEC') {
              agrupamentoUsuario[usuario].reprovadas++;
            }
          });

          // Buscar dados de usu√°rios da tabela user_login_nt
          let mapaNomesUsuarios = {};
          try {
            const usuariosArray = Array.from(usuariosUnicos);
        
            if (usuariosArray.length > 0) {
              const { data: usuariosData, error } = await supabaseClient
                .from('user_login_nt')
                .select('matricula, nome_usuario');

              if (!error && usuariosData) {
                usuariosData.forEach(user => {
                  if (user.matricula && user.nome_usuario) {
                    mapaNomesUsuarios[user.matricula.toLowerCase()] = user.nome_usuario;
                  }
                });
              }
            }
          } catch (err) {
            console.error('Erro ao buscar dados de usu√°rios:', err);
          }

          // Ordenar usu√°rios por total de notas (decrescente)
          const usuariosOrdenados = Object.keys(agrupamentoUsuario).sort((a, b) => {
            const totalA = agrupamentoUsuario[a].aprovadas + agrupamentoUsuario[a].reprovadas;
            const totalB = agrupamentoUsuario[b].aprovadas + agrupamentoUsuario[b].reprovadas;
            return totalB - totalA;
          });

          // Criar labels com nomes dos usu√°rios
          const labels = usuariosOrdenados.map(matricula => {
            const nomeUsuario = mapaNomesUsuarios[matricula.toLowerCase()];
            if (nomeUsuario) {
              return `${nomeUsuario} (${matricula})`;
            } else {
              return `(${matricula})`;
            }
          });

          // Calcular percentuais
          const percentuaisAprovacao = usuariosOrdenados.map(usuario => {
            const total = agrupamentoUsuario[usuario].aprovadas + agrupamentoUsuario[usuario].reprovadas;
            return total > 0 ? (agrupamentoUsuario[usuario].aprovadas / total * 100).toFixed(1) : 0;
          });

          const percentuaisReprovacao = usuariosOrdenados.map(usuario => {
            const total = agrupamentoUsuario[usuario].aprovadas + agrupamentoUsuario[usuario].reprovadas;
            return total > 0 ? (agrupamentoUsuario[usuario].reprovadas / total * 100).toFixed(1) : 0;
          });

          // Valores absolutos para tooltip
          const valoresAprovacao = usuariosOrdenados.map(usuario => agrupamentoUsuario[usuario].aprovadas);
          const valoresReprovacao = usuariosOrdenados.map(usuario => agrupamentoUsuario[usuario].reprovadas);

          // Criar gr√°fico
          const ctx = document.getElementById('chartAprovacaoReprovacaoPorUsuario').getContext('2d');
      
          if (chartAprovacaoReprovacaoPorUsuarioInstance) {
            chartAprovacaoReprovacaoPorUsuarioInstance.destroy();
          }

          chartAprovacaoReprovacaoPorUsuarioInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [
                {
                  label: '% Aprova√ß√£o (CONC CTEC)',
                  data: percentuaisAprovacao,
                  backgroundColor: 'rgba(46, 125, 50, 0.7)',
                  borderColor: 'rgba(46, 125, 50, 1)',
                  borderWidth: 2,
                  valoresAbsolutos: valoresAprovacao
                },
                {
                  label: '% Reprova√ß√£o (CONC RTEC)',
                  data: percentuaisReprovacao,
                  backgroundColor: 'rgba(211, 47, 47, 0.7)',
                  borderColor: 'rgba(211, 47, 47, 1)',
                  borderWidth: 2,
                  valoresAbsolutos: valoresReprovacao
                }
              ]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: true,
              aspectRatio: 1.5,
              layout: {
                padding: {
                  right: 60
                }
              },
              onClick: (event, elements) => {
                if (elements.length > 0) {
                  const index = elements[0].index;
                  const usuarioLabel = labels[index];
                  const datasetIndex = elements[0].datasetIndex;
              
                  // Extrair matr√≠cula do label
                  const matriculaMatch = usuarioLabel.match(/\(([^)]+)\)$/);
                  const matricula = matriculaMatch ? matriculaMatch[1] : usuarioLabel;

                  // Filtrar notas correspondentes ao usu√°rio e status clicado
                  const statusFiltro = datasetIndex === 0 ? 'CONC CTEC' : 'CONC RTEC';
                  const notasFiltradas = notasConcluidas.filter(item => {
                    const usuario = (item.concluido_por || '').trim();
                    const status = item.status_usuario || '';
                    return usuario.toLowerCase() === matricula.toLowerCase() && status === statusFiltro;
                  });

                  const tipoTexto = datasetIndex === 0 ? 'Aprovadas' : 'Reprovadas';
                  abrirModalNotasSemEdicao(notasFiltradas, `Notas ${tipoTexto} de ${usuarioLabel}`);
                }
              },
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                  labels: {
                    font: {
                      size: 13,
                      family: 'Roboto'
                    },
                    color: '#333',
                    padding: 15
                  }
                },
                title: {
                  display: false
                },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  titleFont: {
                    size: 14,
                    family: 'Roboto'
                  },
                  bodyFont: {
                    size: 13,
                    family: 'Roboto'
                  },
                  padding: 12,
                  callbacks: {
                    label: function (context) {
                      const valoresAbsolutos = context.dataset.valoresAbsolutos || [];
                      const valorAbsoluto = valoresAbsolutos[context.dataIndex] || 0;
                      const percentual = context.parsed.x;
                      return `${context.dataset.label}: ${valorAbsoluto} notas (${percentual}%)`;
                    }
                  }
                },
                datalabels: {
                  display: true,
                  anchor: 'end',
                  align: 'right',
                  offset: 8,
                  clip: false,
                  clamp: false,
                  formatter: (value) => {
                    return value + '%';
                  },
                  font: {
                    size: 11,
                    family: 'Roboto',
                    weight: 'bold'
                  },
                  color: '#333'
                }
              },
              scales: {
                x: {
                  stacked: false,
                  beginAtZero: true,
                  max: 100,
                  ticks: {
                    callback: function(value) {
                      return value + '%';
                    },
                    font: {
                      size: 12,
                      family: 'Roboto'
                    },
                    color: '#666'
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                  },
                  title: {
                    display: true,
                    text: 'Percentual (%)',
                    font: {
                      size: 13,
                      family: 'Roboto',
                      weight: 'bold'
                    },
                    color: '#333'
                  }
                },
                y: {
                  stacked: false,
                  ticks: {
                    font: {
                      size: 11,
                      family: 'Roboto'
                    },
                    color: '#666'
                  },
                  grid: {
                    display: false
                  },
                  title: {
                    display: true,
                    text: 'Usu√°rio',
                    font: {
                      size: 13,
                      family: 'Roboto',
                      weight: 'bold'
                    },
                    color: '#333'
                  }
                }
              }
            }
          });
        };

        // Filtro de m√™s do gr√°fico de notas conclu√≠das por dia por usu√°rio
        window.popularFiltroMesesNotasConcluidasPorDiaUsuario = function (dados) {
          const meses = new Set();
          dados.forEach(item => {
            const status = item.status_usuario || '';
            const concluidaEm = item.concluida_em || '';
            const usuario = (item.concluido_por || '').trim();
            const textoMedidas = (item.texto_medidas || '').toUpperCase();
            const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') ||
              textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
              textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));

            if ((status === 'CONC CTEC' || status === 'CONC RTEC') && concluidaEm && usuario && temAnexo) {
              const partes = concluidaEm.split('.');
              if (partes.length >= 3) {
                const mesAno = partes[1] + '.' + partes[2];
                meses.add(mesAno);
              }
            }
          });

          const select = document.getElementById('filtroMesNotasConcluidasPorDiaUsuario');
          select.innerHTML = '<option value="todos">Todos os meses</option>';
          const mesesArray = Array.from(meses).sort((a, b) => {
            const [mesA, anoA] = a.split('.');
            const [mesB, anoB] = b.split('.');
            return anoA !== anoB ? anoB - anoA : mesB - mesA;
          });

          mesesArray.forEach(mesAno => {
            const option = document.createElement('option');
            option.value = mesAno;
            option.textContent = mesAno;
            select.appendChild(option);
          });

          // Selecionar m√™s atual ou anterior se houver dados
          const dataAtual = new Date();
          const mesAtual = String(dataAtual.getMonth() + 1).padStart(2, '0');
          const anoAtual = dataAtual.getFullYear();
          const mesAnoAtual = `${mesAtual}.${anoAtual}`;

          if (mesesArray.includes(mesAnoAtual)) {
            select.value = mesAnoAtual;
          } else {
            const dataAnterior = new Date(anoAtual, parseInt(mesAtual) - 2, 1);
            const mesAnterior = String(dataAnterior.getMonth() + 1).padStart(2, '0');
            const anoAnterior = dataAnterior.getFullYear();
            const mesAnoAnterior = `${mesAnterior}.${anoAnterior}`;

            if (mesesArray.includes(mesAnoAnterior)) {
              select.value = mesAnoAnterior;
            } else if (mesesArray.length > 0) {
              select.value = mesesArray[mesesArray.length - 1];
            }
          }
        };

        window.aplicarFiltroMesNotasConcluidasPorDiaUsuario = function () {
          gerarGraficoNotasConcluidasPorDiaUsuario(dadosGlobais);
        };

    window.popularFiltroUsuariosNotasConcluidasPorDia = async function (dados) {
      const usuarios = new Set();
      dados.forEach(item => {
        const status = item.status_usuario || '';
        const usuario = (item.concluido_por || '').trim();
        const concluidaEm = item.concluida_em || '';
        const textoMedidas = (item.texto_medidas || '').toUpperCase();
        const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') ||
          textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
          textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));

        if ((status === 'CONC CTEC' || status === 'CONC RTEC') && usuario && concluidaEm && temAnexo) {
          usuarios.add(usuario);
        }
      });

      const container = document.getElementById('containerCheckboxesUsuariosNotasConcluidasPorDia');
      container.innerHTML = '';

      // Buscar nomes dos usu√°rios da tabela user_login_nt
      let mapaNomesUsuarios = {};
      try {
        const usuariosArray = Array.from(usuarios);
        if (usuariosArray.length > 0) {
          const { data: usuariosData, error } = await supabaseClient
            .from('user_login_nt')
            .select('matricula, nome_usuario');

          if (!error && usuariosData) {
            usuariosData.forEach(user => {
              if (user.matricula && user.nome_usuario) {
                mapaNomesUsuarios[user.matricula.toLowerCase()] = user.nome_usuario;
              }
            });
          }
        }
      } catch (err) {
        console.error('Erro ao buscar dados de usu√°rios:', err);
      }

      const usuariosArray = Array.from(usuarios);
      usuariosArray.sort();

      usuariosArray.forEach((usuario, index) => {
        const checkboxId = 'checkbox_usuario_dia_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '6px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '4px 0';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = usuario;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.onchange = () => gerarGraficoNotasConcluidasPorDiaUsuario(dadosGlobais);

        label.appendChild(checkbox);
        
        // Exibir nome do usu√°rio se dispon√≠vel, sen√£o exibir matr√≠cula
        const nomeUsuario = mapaNomesUsuarios[usuario.toLowerCase()];
        const textDisplay = nomeUsuario ? `${nomeUsuario} (${usuario})` : usuario;
        label.appendChild(document.createTextNode(textDisplay));
        container.appendChild(label);
      });
    };

    window.toggleDropdownUsuariosNotasConcluidasPorDia = function () {
      const container = document.getElementById('containerCheckboxesUsuariosNotasConcluidasPorDia');
      container.style.display = container.style.display === 'none' ? 'flex' : 'none';
    };

    // Gr√°fico de notas conclu√≠das por dia por usu√°rio
    window.gerarGraficoNotasConcluidasPorDiaUsuario = async function (dados) {
      if (!dados || dados.length === 0) {
        document.getElementById('totalNotasConcluidasPorDiaUsuario').textContent = '0';
        if (chartNotasConcluidasPorDiaUsuarioInstance) {
          chartNotasConcluidasPorDiaUsuarioInstance.destroy();
          chartNotasConcluidasPorDiaUsuarioInstance = null;
        }
        return;
      }

      const selectMes = document.getElementById('filtroMesNotasConcluidasPorDiaUsuario');
      const mesSelecionado = selectMes ? selectMes.value : 'todos';

      // Obter usu√°rios selecionados nos checkboxes
      const checkboxes = document.querySelectorAll('#containerCheckboxesUsuariosNotasConcluidasPorDia input[type="checkbox"]');
      const usuariosChecados = new Set();
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          usuariosChecados.add(checkbox.value);
        }
      });

      const notasConcluidas = dados.filter(item => {
        const status = item.status_usuario || '';
        const usuario = (item.concluido_por || '').trim();
        const concluidaEm = item.concluida_em || '';
        const textoMedidas = (item.texto_medidas || '').toUpperCase();

        const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') ||
          textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
          textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));

        const usuarioOk = usuariosChecados.size === 0 || usuariosChecados.has(usuario);

        let mesOk = true;
        if (mesSelecionado !== 'todos') {
          const partes = concluidaEm.split('.');
          if (partes.length >= 3) {
            const mesAno = partes[1] + '.' + partes[2];
            mesOk = mesAno === mesSelecionado;
          } else {
            mesOk = false;
          }
        }

        return (status === 'CONC CTEC' || status === 'CONC RTEC') && usuario !== '' && concluidaEm && mesOk && temAnexo && usuarioOk;
      });

      if (notasConcluidas.length === 0) {
        document.getElementById('totalNotasConcluidasPorDiaUsuario').textContent = '0';
        if (chartNotasConcluidasPorDiaUsuarioInstance) {
          chartNotasConcluidasPorDiaUsuarioInstance.destroy();
          chartNotasConcluidasPorDiaUsuarioInstance = null;
        }
        return;
      }

      document.getElementById('totalNotasConcluidasPorDiaUsuario').textContent = notasConcluidas.length;

          const agrupamentoUsuario = {};
          const usuariosUnicos = new Set();
          const datasUnicas = new Set();

          notasConcluidas.forEach(item => {
            const usuario = (item.concluido_por || 'Desconhecido').trim();
            const concluidaEm = item.concluida_em || '';
            const partes = concluidaEm.split('.');
            if (partes.length < 3) return;

            const dataLabel = concluidaEm;
            datasUnicas.add(dataLabel);
            usuariosUnicos.add(usuario);

            if (!agrupamentoUsuario[usuario]) {
              agrupamentoUsuario[usuario] = {};
            }
            agrupamentoUsuario[usuario][dataLabel] = (agrupamentoUsuario[usuario][dataLabel] || 0) + 1;
          });

          const labels = Array.from(datasUnicas).sort((a, b) => {
            return new Date(a.split('.').reverse().join('-')) - new Date(b.split('.').reverse().join('-'));
          });

          // Buscar nomes dos usu√°rios
          let mapaNomesUsuarios = {};
          try {
            const usuariosArray = Array.from(usuariosUnicos);
            if (usuariosArray.length > 0) {
              const { data: usuariosData, error } = await supabaseClient
                .from('user_login_nt')
                .select('matricula, nome_usuario');

              if (!error && usuariosData) {
                usuariosData.forEach(user => {
                  if (user.matricula && user.nome_usuario) {
                    mapaNomesUsuarios[user.matricula.toLowerCase()] = user.nome_usuario;
                  }
                });
              }
            }
          } catch (err) {
            console.error('Erro ao buscar dados de usu√°rios:', err);
          }

          const usuariosOrdenados = Array.from(usuariosUnicos).sort((a, b) => {
            const totalA = labels.reduce((sum, data) => sum + (agrupamentoUsuario[a]?.[data] || 0), 0);
            const totalB = labels.reduce((sum, data) => sum + (agrupamentoUsuario[b]?.[data] || 0), 0);
            return totalB - totalA;
          });

          const cores = [
            'rgba(144, 202, 249, 0.8)',  // Azul claro
            'rgba(165, 214, 167, 0.8)',  // Verde claro
            'rgba(255, 183, 77, 0.8)',   // Laranja claro
            'rgba(239, 154, 154, 0.8)',  // Vermelho claro
            'rgba(206, 167, 230, 0.8)',  // Roxo claro
            'rgba(129, 212, 221, 0.8)',  // Ciano claro
            'rgba(255, 213, 141, 0.8)',  // √Çmbar claro
            'rgba(179, 229, 252, 0.8)',  // Azul p√°lido
            'rgba(197, 225, 165, 0.8)',  // Verde p√°lido
            'rgba(255, 204, 188, 0.8)'   // Rosa claro
          ];

          const datasets = usuariosOrdenados.map((usuario, index) => {
            const nomeUsuario = mapaNomesUsuarios[usuario.toLowerCase()];
            const label = nomeUsuario ? `${nomeUsuario} (${usuario})` : `(${usuario})`;
            const cor = cores[index % cores.length];
            return {
              label,
              data: labels.map(dataLabel => agrupamentoUsuario[usuario]?.[dataLabel] || 0),
              backgroundColor: cor,
              borderColor: cor.replace('0.8', '1'),
              borderWidth: 1
            };
          });

          const ctx = document.getElementById('chartNotasConcluidasPorDiaUsuario').getContext('2d');
          if (chartNotasConcluidasPorDiaUsuarioInstance) {
            chartNotasConcluidasPorDiaUsuarioInstance.destroy();
          }

          chartNotasConcluidasPorDiaUsuarioInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              aspectRatio: 2.5,
              plugins: {
                datalabels: {
                  display: true,
                  anchor: 'end',
                  align: 'top',
                  offset: 4,
                  formatter: (value) => {
                    return value > 0 ? value : '';
                  },
                  font: {
                    size: 11,
                    family: 'Roboto',
                    weight: 'bold'
                  },
                  color: '#333'
                },
                legend: {
                  display: true,
                  position: 'bottom',
                  labels: {
                    font: {
                      size: 12,
                      family: 'Roboto'
                    },
                    color: '#333'
                  }
                },
                title: {
                  display: false
                },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  titleFont: {
                    size: 14,
                    family: 'Roboto'
                  },
                  bodyFont: {
                    size: 13,
                    family: 'Roboto'
                  },
                  padding: 12,
                  callbacks: {
                    label: function (context) {
                      return `${context.dataset.label}: ${context.parsed.y} notas`;
                    }
                  }
                }
              },
              scales: {
                x: {
                  ticks: {
                    font: {
                      size: 11,
                      family: 'Roboto'
                    },
                    color: '#666'
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                  },
                  title: {
                    display: true,
                    text: 'Data (dd.mm.aaaa)',
                    font: {
                      size: 13,
                      family: 'Roboto',
                      weight: 'bold'
                    },
                    color: '#333'
                  }
                },
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1,
                    font: {
                      size: 12,
                      family: 'Roboto'
                    },
                    color: '#666'
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                  },
                  title: {
                    display: true,
                    text: 'Quantidade de Notas',
                    font: {
                      size: 13,
                      family: 'Roboto',
                      weight: 'bold'
                    },
                    color: '#333'
                  }
                }
              }
            }
          });
        };

        // Fun√ß√£o para gerar gr√°fico de Notas Conclu√≠das por M√™s
    window.gerarGraficoNotasConcluidasPorMes = function (dados) {
      if (!dados || dados.length === 0) {
        document.getElementById('totalNotasConcluidasPorMes').textContent = '0';
        if (chartNotasConcluidasPorMesInstance) {
          chartNotasConcluidasPorMesInstance.destroy();
          chartNotasConcluidasPorMesInstance = null;
        }
        return;
      }

      // Filtrar notas: apenas CONC CTEC e CONC RTEC, desconsiderando SEM ANEXO e status ANDM/ABER/CANC
      const notasFiltradas = dados.filter(item => {
        const status = item.status_usuario || '';
        const textoMedidas = (item.texto_medidas || '').toUpperCase();

        // Verificar se o texto de medidas cont√©m "SEM ANEXO" ou varia√ß√µes
        const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') ||
          textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
          textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));

        // Apenas notas conclu√≠das
        const eNotaConcluida = status === 'CONC CTEC' || status === 'CONC RTEC';

        // Desconsiderar ANDM, ABER ou CANC (status n√£o conclu√≠dos)
        const statusValido = status !== 'ANDM' && status !== 'ABER' && status !== 'CANC';

        return eNotaConcluida && temAnexo && statusValido;
      });

      // Obter ano selecionado
      const selectAno = document.getElementById('filtroAnoNotasConcluidasPorMes');
      const anoSelecionado = selectAno ? selectAno.value : 'todos';

      const notasFiltradasPorAno = anoSelecionado === 'todos'
        ? notasFiltradas
        : notasFiltradas.filter(item => {
            const concluidaEm = item.concluida_em || '';
            if (!concluidaEm) return false;
            const partes = concluidaEm.split('.');
            if (partes.length >= 3) {
              return partes[2] === anoSelecionado;
            }
            return false;
          });

      if (notasFiltradasPorAno.length === 0) {
        document.getElementById('totalNotasConcluidasPorMes').textContent = '0';
        if (chartNotasConcluidasPorMesInstance) {
          chartNotasConcluidasPorMesInstance.destroy();
          chartNotasConcluidasPorMesInstance = null;
        }
        return;
      }

      // Atualizar total
      document.getElementById('totalNotasConcluidasPorMes').textContent = notasFiltradasPorAno.length;

      // Agrupar por m√™s (MM.AAAA) usando concluida_em
      const agrupamentoMes = {};
      notasFiltradasPorAno.forEach(item => {
        const concluidaEm = item.concluida_em || '';
        let mesAno = 'Sem data';

        if (concluidaEm) {
          const partes = concluidaEm.split('.');
          if (partes.length >= 3) {
            mesAno = partes[1] + '.' + partes[2];
          }
        }

        if (agrupamentoMes[mesAno]) {
          agrupamentoMes[mesAno]++;
        } else {
          agrupamentoMes[mesAno] = 1;
        }
      });

      // Converter para arrays e ordenar por m√™s/ano
      const labels = Object.keys(agrupamentoMes).sort((a, b) => {
        if (a === 'Sem data') return 1;
        if (b === 'Sem data') return -1;
        const [mesA, anoA] = a.split('.');
        const [mesB, anoB] = b.split('.');
        const dateA = new Date(`${anoA}-${mesA}-01`);
        const dateB = new Date(`${anoB}-${mesB}-01`);
        return dateA - dateB;
      });
      const valores = labels.map(label => agrupamentoMes[label]);

      // Destruir gr√°fico anterior se existir
      if (chartNotasConcluidasPorMesInstance) {
        chartNotasConcluidasPorMesInstance.destroy();
      }

      // Criar novo gr√°fico
      const ctx = document.getElementById('chartNotasConcluidasPorMes').getContext('2d');
      chartNotasConcluidasPorMesInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade de Notas Conclu√≠das',
            data: valores,
            backgroundColor: 'rgba(46, 125, 50, 0.7)',
            borderColor: 'rgba(46, 125, 50, 1)',
            borderWidth: 2,
            borderRadius: 8,
            hoverBackgroundColor: 'rgba(56, 142, 60, 0.9)',
            hoverBorderColor: 'rgba(56, 142, 60, 1)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(46, 125, 50, 0.9)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function (context) {
                  return context.dataset.label + ': ' + context.parsed.y;
                }
              }
            },
            datalabels: {
              color: '#ffffff',
              anchor: 'center',
              align: 'center',
              font: {
                weight: 'bold',
                size: 13
              },
              formatter: function(value) {
                return value;
              }
            }
          },
          scales: {
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: 'Roboto'
                },
                color: '#666',
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'Data de Conclus√£o',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Quantidade',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Gerar gr√°fico de notas conclu√≠das por tipo de solicita√ß√£o (Mini/Micro vs Demais)
    window.gerarGraficoConcluidasPorTipoSolicitacao = function (dados) {
      // Verificar se h√° dados dispon√≠veis
      if (!dados || dados.length === 0) {
        console.warn('Nenhum dado dispon√≠vel para gerar o gr√°fico de Conclu√≠das por Tipo de Solicita√ß√£o.');
        return;
      }

      // Obter o ano selecionado do filtro
      const anoSelecionado = parseInt(document.getElementById('filtroAnoConcluidasPorTipoSolicitacao').value);
      
      console.log('Ano selecionado:', anoSelecionado);
      console.log('Total de dados recebidos:', dados.length);

      // Filtrar dados por status CONC CTEC ou CONC RTEC
      const notasConcluidas = dados.filter(item => {
        const status = item.status_usuario || '';
        const textoMedidas = (item.texto_medidas || '').toUpperCase();
        const descricao = item.descricao ? item.descricao.toLowerCase() : '';
        const codigoMedidas = (item.codigo_medidas || '').trim();

        // Verificar c√≥digos permitidos (0040, 0041, 0042, 0045)
        const codigosPermitidos = ['0040', '0041', '0042', '0045'];
        if (!codigosPermitidos.includes(codigoMedidas)) return false;

        // Verificar se o texto de medidas cont√©m "SEM ANEXO" ou varia√ß√µes
        const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') ||
          textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
          textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));

        // Apenas notas conclu√≠das
        const eNotaConcluida = status === 'CONC CTEC' || status === 'CONC RTEC';

        // Desconsiderar ANDM, ABER ou CANC
        const statusValido = status !== 'ANDM' && status !== 'ABER' && status !== 'CANC';

        // Apenas Mini/Micro Gera√ß√£o
        const isMiniMicro = descricao.includes('mini gera√ß√£o') || descricao.includes('micro gera√ß√£o');

        if (!eNotaConcluida || !temAnexo || !statusValido || !isMiniMicro) return false;

        // Filtrar pelo ano selecionado
        const concluida_em = item.concluida_em || '';
        if (concluida_em) {
          const partes = concluida_em.split('.');
          if (partes.length === 3) {
            const ano = parseInt(partes[2]);
            if (ano !== anoSelecionado) return false;
          }
        }

        return true;
      });

      console.log('Notas conclu√≠das filtradas:', notasConcluidas.length);
      
      if (notasConcluidas.length === 0) {
        console.warn('Nenhuma nota conclu√≠da ap√≥s filtragem para o ano', anoSelecionado);
        // Destruir gr√°fico se existir
        if (chartConcluidasPorTipoSolicitacaoInstance) {
          chartConcluidasPorTipoSolicitacaoInstance.destroy();
          chartConcluidasPorTipoSolicitacaoInstance = null;
        }
        return;
      }

      // Agrupar por m√™s
      const mesesMap = {};

      notasConcluidas.forEach(item => {
        const concluida_em = item.concluida_em || '';
        if (!concluida_em) return;

        const partes = concluida_em.split('.');
        if (partes.length !== 3) return;

        const dia = partes[0];
        const mes = partes[1];
        const ano = partes[2];
        const mesAno = `${mes}.${ano}`;

        if (!mesesMap[mesAno]) {
          mesesMap[mesAno] = {
            miniCTEC: 0,
            miniRTEC: 0
          };
        }

        const status = item.status_usuario || '';
        if (status === 'CONC CTEC') {
          mesesMap[mesAno].miniCTEC++;
        } else if (status === 'CONC RTEC') {
          mesesMap[mesAno].miniRTEC++;
        }
      });

      // Converter para arrays e ordenar por data
      let meses = Object.keys(mesesMap).sort((a, b) => {
        const [mesA, anoA] = a.split('.');
        const [mesB, anoB] = b.split('.');
        const dataA = new Date(`${anoA}-${mesA}-01`);
        const dataB = new Date(`${anoB}-${mesB}-01`);
        return dataA - dataB;
      });

      const miniCTEC = meses.map(mes => mesesMap[mes].miniCTEC);
      const miniRTEC = meses.map(mes => mesesMap[mes].miniRTEC);
      const demaisCTEC = meses.map(mes => mesesMap[mes].demaisCTEC);
      const demaisRTEC = meses.map(mes => mesesMap[mes].demaisRTEC);

      console.log('Meses encontrados:', meses);
      console.log('Mini CTEC:', miniCTEC);
      console.log('Mini RTEC:', miniRTEC);
      console.log('Demais CTEC:', demaisCTEC);
      console.log('Demais RTEC:', demaisRTEC);

      // Calcular percentuais
      const percentuaisMini = meses.map(mes => {
        const totalMini = mesesMap[mes].miniCTEC + mesesMap[mes].miniRTEC;
        return totalMini > 0 ? ((mesesMap[mes].miniCTEC / totalMini) * 100).toFixed(1) : 0;
      });

      const percentuaisDemais = meses.map(mes => {
        const totalDemais = mesesMap[mes].demaisCTEC + mesesMap[mes].demaisRTEC;
        return totalDemais > 0 ? ((mesesMap[mes].demaisCTEC / totalDemais) * 100).toFixed(1) : 0;
      });

      // Converter percentuais para n√∫meros para as barras
      const miniCTECPercentual = percentuaisMini.map(p => parseFloat(p));
      const miniRTECPercentual = meses.map((mes, i) => 100 - parseFloat(percentuaisMini[i]));

      // Destruir gr√°fico existente se houver
      if (chartConcluidasPorTipoSolicitacaoInstance) {
        chartConcluidasPorTipoSolicitacaoInstance.destroy();
      }

      // Criar gr√°fico
      const ctx = document.getElementById('chartConcluidasPorTipoSolicitacao').getContext('2d');
      chartConcluidasPorTipoSolicitacaoInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: meses,
          datasets: [
            {
              label: 'Mini/Micro - CONC CTEC',
              data: miniCTECPercentual,
              backgroundColor: 'rgba(56, 142, 60, 0.8)',
              stack: 'mini',
              valoresAbsolutos: miniCTEC, // Armazenar valores absolutos
              datalabels: {
                display: false
              }
            },
            {
              label: 'Mini/Micro - CONC RTEC',
              data: miniRTECPercentual,
              backgroundColor: 'rgba(129, 199, 132, 0.8)',
              stack: 'mini',
              hidden: true,
              valoresAbsolutos: miniRTEC, // Armazenar valores absolutos
              datalabels: {
                display: true,
                formatter: (value, context) => {
                  return percentuaisMini[context.dataIndex] + '%';
                },
                anchor: 'end',
                align: 'top',
                offset: 4,
                clip: false,
                font: {
                  size: 12,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#2e7d32',
                backgroundColor: 'rgba(255,255,255,0.9)',
                borderRadius: 4,
                padding: 4
              }
            },
            {
              label: 'Taxa de Aprova√ß√£o (%)',
              data: percentuaisMini.map(p => parseFloat(p)),
              type: 'line',
              borderColor: 'rgba(27, 94, 32, 1)',
              backgroundColor: 'rgba(27, 94, 32, 0.1)',
              borderWidth: 3,
              pointRadius: 5,
              pointHoverRadius: 7,
              pointBackgroundColor: 'rgba(27, 94, 32, 1)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              fill: false,
              tension: 0.4,
              yAxisID: 'y',
              valoresAbsolutos: miniCTEC.map((ctec, i) => ctec + miniRTEC[i]), // Total absoluto
              datalabels: {
                display: true,
                formatter: (value, context) => {
                  return value.toFixed(1) + '%';
                },
                anchor: 'end',
                align: 'top',
                offset: 6,
                clip: false,
                font: {
                  size: 11,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#1b5e20',
                backgroundColor: 'rgba(255,255,255,0.9)',
                borderRadius: 4,
                padding: 3
              }
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: {
            padding: {
              top: 60
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              align: 'start',
              labels: {
                padding: 16,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#333',
                usePointStyle: true,
                pointStyle: 'rect'
              }
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const label = context.dataset.label || '';
                  const valorPercentual = context.parsed.y;
                  const valoresAbsolutos = context.dataset.valoresAbsolutos;
                  
                  if (valoresAbsolutos && valoresAbsolutos[context.dataIndex] !== undefined) {
                    const valorAbsoluto = valoresAbsolutos[context.dataIndex];
                    return `${label}: ${valorAbsoluto} notas (${valorPercentual.toFixed(1)}%)`;
                  }
                  
                  return `${label}: ${valorPercentual.toFixed(1)}%`;
                }
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              ticks: {
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                display: false
              }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              ticks: {
                stepSize: 10,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666',
                callback: function (value) {
                  return value + '%';
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Percentual de Aprova√ß√£o (%)',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });

      // Atualizar total de notas
      const totalNotas = notasConcluidas.length;
      document.getElementById('totalNotasConcluidasPorTipoMini').textContent = totalNotas;
    };

    // Gerar gr√°fico de notas conclu√≠das por tipo de solicita√ß√£o (apenas Demais Tipos)
    window.gerarGraficoConcluidasPorTipoDemais = function (dados) {
      // Verificar se h√° dados dispon√≠veis
      if (!dados || dados.length === 0) {
        console.warn('Nenhum dado dispon√≠vel para gerar o gr√°fico de Conclu√≠das por Tipo Demais.');
        return;
      }

      // Obter o ano selecionado do filtro
      const anoSelecionado = parseInt(document.getElementById('filtroAnoConcluidasPorTipoDemais').value);
      
      console.log('Ano selecionado (Demais):', anoSelecionado);
      console.log('Total de dados recebidos:', dados.length);

      // Filtrar dados por status CONC CTEC ou CONC RTEC
      const notasConcluidas = dados.filter(item => {
        const status = item.status_usuario || '';
        const textoMedidas = (item.texto_medidas || '').toUpperCase();
        const descricao = item.descricao ? item.descricao.toLowerCase() : '';
        const codigoMedidas = (item.codigo_medidas || '').trim();

        // Verificar c√≥digos permitidos (0040, 0041, 0042, 0045)
        const codigosPermitidos = ['0040', '0041', '0042', '0045'];
        if (!codigosPermitidos.includes(codigoMedidas)) return false;

        // Verificar se o texto de medidas cont√©m "SEM ANEXO" ou varia√ß√µes
        const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') ||
          textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
          textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));

        // Apenas notas conclu√≠das
        const eNotaConcluida = status === 'CONC CTEC' || status === 'CONC RTEC';

        // Desconsiderar ANDM, ABER ou CANC
        const statusValido = status !== 'ANDM' && status !== 'ABER' && status !== 'CANC';

        // Apenas Demais (N√ÉO mini ou micro)
        const isDemais = !(descricao.includes('mini gera√ß√£o') || descricao.includes('micro gera√ß√£o'));

        if (!eNotaConcluida || !temAnexo || !statusValido || !isDemais) return false;

        // Filtrar pelo ano selecionado
        const concluida_em = item.concluida_em || '';
        if (concluida_em) {
          const partes = concluida_em.split('.');
          if (partes.length === 3) {
            const ano = parseInt(partes[2]);
            if (ano !== anoSelecionado) return false;
          }
        }

        return true;
      });

      console.log('Notas Demais filtradas:', notasConcluidas.length);
      
      if (notasConcluidas.length === 0) {
        console.warn('Nenhuma nota Demais ap√≥s filtragem para o ano', anoSelecionado);
        if (chartConcluidasPorTipoDemaisInstance) {
          chartConcluidasPorTipoDemaisInstance.destroy();
          chartConcluidasPorTipoDemaisInstance = null;
        }
        return;
      }

      // Agrupar por m√™s
      const mesesMap = {};

      notasConcluidas.forEach(item => {
        const concluida_em = item.concluida_em || '';
        if (!concluida_em) return;

        const partes = concluida_em.split('.');
        if (partes.length !== 3) return;

        const dia = partes[0];
        const mes = partes[1];
        const ano = partes[2];
        const mesAno = `${mes}.${ano}`;

        if (!mesesMap[mesAno]) {
          mesesMap[mesAno] = {
            demaisCTEC: 0,
            demaisRTEC: 0
          };
        }

        const status = item.status_usuario || '';

        if (status === 'CONC CTEC') {
          mesesMap[mesAno].demaisCTEC++;
        } else if (status === 'CONC RTEC') {
          mesesMap[mesAno].demaisRTEC++;
        }
      });

      // Converter para arrays e ordenar por data
      let meses = Object.keys(mesesMap).sort((a, b) => {
        const [mesA, anoA] = a.split('.');
        const [mesB, anoB] = b.split('.');
        const dataA = new Date(`${anoA}-${mesA}-01`);
        const dataB = new Date(`${anoB}-${mesB}-01`);
        return dataA - dataB;
      });

      const demaisCTEC = meses.map(mes => mesesMap[mes].demaisCTEC);
      const demaisRTEC = meses.map(mes => mesesMap[mes].demaisRTEC);

      console.log('Meses encontrados (Demais):', meses);
      console.log('Demais CTEC:', demaisCTEC);
      console.log('Demais RTEC:', demaisRTEC);

      // Calcular percentuais
      const percentuaisDemais = meses.map(mes => {
        const totalDemais = mesesMap[mes].demaisCTEC + mesesMap[mes].demaisRTEC;
        return totalDemais > 0 ? ((mesesMap[mes].demaisCTEC / totalDemais) * 100).toFixed(1) : 0;
      });

      // Converter percentuais para n√∫meros para as barras
      const demaisCTECPercentual = percentuaisDemais.map(p => parseFloat(p));
      const demaisRTECPercentual = meses.map((mes, i) => 100 - parseFloat(percentuaisDemais[i]));

      // Destruir gr√°fico existente se houver
      if (chartConcluidasPorTipoDemaisInstance) {
        chartConcluidasPorTipoDemaisInstance.destroy();
      }

      // Criar gr√°fico
      const ctx = document.getElementById('chartConcluidasPorTipoDemais').getContext('2d');
      chartConcluidasPorTipoDemaisInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: meses,
          datasets: [
            {
              label: 'Demais - CONC CTEC',
              data: demaisCTECPercentual,
              backgroundColor: 'rgba(46, 125, 50, 0.7)',
              stack: 'demais',
              valoresAbsolutos: demaisCTEC, // Armazenar valores absolutos
              datalabels: {
                display: false
              }
            },
            {
              label: 'Demais - CONC RTEC',
              data: demaisRTECPercentual,
              backgroundColor: 'rgba(76, 175, 80, 0.7)',
              stack: 'demais',
              hidden: true,
              valoresAbsolutos: demaisRTEC, // Armazenar valores absolutos
              datalabels: {
                display: true,
                formatter: (value, context) => {
                  return percentuaisDemais[context.dataIndex] + '%';
                },
                anchor: 'end',
                align: 'top',
                offset: 4,
                clip: false,
                font: {
                  size: 12,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#2e7d32',
                backgroundColor: 'rgba(255,255,255,0.9)',
                borderRadius: 4,
                padding: 4
              }
            },
            {
              label: 'Taxa de Aprova√ß√£o (%)',
              data: percentuaisDemais.map(p => parseFloat(p)),
              type: 'line',
              borderColor: 'rgba(27, 94, 32, 1)',
              backgroundColor: 'rgba(27, 94, 32, 0.1)',
              borderWidth: 3,
              pointRadius: 5,
              pointHoverRadius: 7,
              pointBackgroundColor: 'rgba(27, 94, 32, 1)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              fill: false,
              tension: 0.4,
              yAxisID: 'y',
              valoresAbsolutos: demaisCTEC.map((ctec, i) => ctec + demaisRTEC[i]), // Total absoluto
              datalabels: {
                display: true,
                formatter: (value, context) => {
                  return value.toFixed(1) + '%';
                },
                anchor: 'end',
                align: 'top',
                offset: 6,
                clip: false,
                font: {
                  size: 11,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#1b5e20',
                backgroundColor: 'rgba(255,255,255,0.9)',
                borderRadius: 4,
                padding: 3
              }
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: {
            padding: {
              top: 60
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              align: 'start',
              labels: {
                padding: 16,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#333',
                usePointStyle: true,
                pointStyle: 'rect'
              }
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const label = context.dataset.label || '';
                  const valorPercentual = context.parsed.y;
                  const valoresAbsolutos = context.dataset.valoresAbsolutos;
                  
                  if (valoresAbsolutos && valoresAbsolutos[context.dataIndex] !== undefined) {
                    const valorAbsoluto = valoresAbsolutos[context.dataIndex];
                    return `${label}: ${valorAbsoluto} notas (${valorPercentual.toFixed(1)}%)`;
                  }
                  
                  return `${label}: ${valorPercentual.toFixed(1)}%`;
                }
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              ticks: {
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                display: false
              }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              ticks: {
                stepSize: 10,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666',
                callback: function (value) {
                  return value + '%';
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Percentual de Aprova√ß√£o (%)',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });

      // Atualizar total de notas
      const totalNotas = notasConcluidas.length;
      document.getElementById('totalNotasConcluidasPorTipoDemais').textContent = totalNotas;
    };

    // Carregar dados ao iniciar a p√°gina
    window.addEventListener('DOMContentLoaded', function() {
      carregarDados();
      // Exibir gr√°ficos de "Notas em Andamento" por padr√£o
      exibirNotasAndamento();
    });
  </script>



</body>

</html>