<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relat√≥rios T√©cnicos - N√∫cleo T√©cnico</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="fluxos.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%);
      background-attachment: fixed;
      min-height: 100vh;
      color: #333;
    }

    .container-relatorios {
      max-width: 1400px;
      margin: 30px auto;
      padding: 0 20px;
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .sidebar-recentes {
      width: 280px;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      position: sticky;
      top: 20px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
    }

    .sidebar-recentes h3 {
      color: #184d27;
      font-size: 1.2em;
      margin: 0 0 15px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid #e0e0e0;
    }

    .sidebar-item {
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      cursor: pointer;
      transition: all 0.3s;
      background: #fafafa;
    }

    .sidebar-item:hover {
      background: #e8f5e9;
      border-color: #2e7d32;
      transform: translateX(5px);
    }

    .sidebar-item-title {
      font-weight: 600;
      color: #333;
      font-size: 14px;
      margin-bottom: 5px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sidebar-item-meta {
      font-size: 11px;
      color: #999;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .sidebar-empty {
      text-align: center;
      color: #999;
      font-size: 13px;
      padding: 20px;
    }

    .main-content {
      flex: 1;
      min-width: 0;
    }

    .header-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .header-section h2 {
      color: #184d27;
      font-size: 2em;
      font-weight: 700;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2e7d32, #1b5e20);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(46, 125, 50, 0.4);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      margin-left: 10px;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-edit {
      background: #1976d2;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 8px;
    }

    .btn-delete {
      background: #f44336;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .search-section {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }

    .search-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
    }

    .input-group label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #555;
      font-size: 14px;
    }

    .input-group input, .input-group textarea, .input-group select {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.3s;
      font-family: 'Roboto', sans-serif;
    }

    .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
      outline: none;
      border-color: #2e7d32;
    }

    .input-group textarea {
      min-height: 120px;
      resize: vertical;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }

    .modal-content {
      background: white;
      max-width: 900px;
      margin: 40px auto;
      border-radius: 16px;
      padding: 35px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }

    .modal-header h3 {
      color: #184d27;
      font-size: 24px;
      font-weight: 700;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 32px;
      color: #999;
      cursor: pointer;
      transition: color 0.3s;
      line-height: 1;
    }

    .close-modal:hover {
      color: #333;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }

    .upload-area {
      border: 2px dashed #2e7d32;
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #f8fdf9;
    }

    .upload-area:hover {
      background: #e8f5e9;
      border-color: #1b5e20;
    }

    .upload-area input[type="file"] {
      display: none;
    }

    .preview-images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .preview-item {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .preview-item img {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }

    .file-preview-item {
      position: relative;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      background: #f9f9f9;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .file-icon {
      font-size: 32px;
      min-width: 40px;
      text-align: center;
    }

    .file-info {
      flex: 1;
      min-width: 0;
    }

    .file-name {
      font-weight: 500;
      color: #333;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-size {
      font-size: 12px;
      color: #999;
      margin-top: 3px;
    }

    .file-status {
      font-size: 11px;
      color: #2e7d32;
      margin-top: 3px;
    }

    .relatorio-files {
      margin-top: 15px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
    }

    .relatorio-files h4 {
      margin: 0 0 10px 0;
      color: #2e7d32;
      font-size: 14px;
      font-weight: 600;
    }

    .file-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .file-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: white;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      cursor: pointer;
      transition: all 0.3s;
    }

    .file-item:hover {
      border-color: #2e7d32;
      box-shadow: 0 2px 8px rgba(46, 125, 50, 0.2);
    }

    .file-item-icon {
      font-size: 24px;
      min-width: 30px;
      text-align: center;
    }

    .file-item-name {
      flex: 1;
      font-size: 14px;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-item-download {
      color: #2e7d32;
      font-size: 20px;
    }

    .remove-preview {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(244, 67, 54, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .relatorios-list {
      display: grid;
      gap: 20px;
    }

    .relatorio-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.3s;
    }

    .relatorio-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }

    .relatorio-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .relatorio-title {
      font-size: 20px;
      font-weight: 700;
      color: #184d27;
      margin-bottom: 8px;
    }

    .relatorio-meta {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 15px;
      font-size: 14px;
      color: #666;
    }

    .relatorio-meta span {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .relatorio-description {
      color: #555;
      line-height: 1.8;
      margin-bottom: 15px;
    }

    .relatorio-description h1 {
      font-size: 1.4em;
      color: #2e7d32;
      margin: 15px 0 10px 0;
      font-weight: 700;
    }

    .relatorio-description h2 {
      font-size: 1.2em;
      color: #2e7d32;
      margin: 12px 0 8px 0;
      font-weight: 600;
    }

    .relatorio-description h3 {
      font-size: 1.1em;
      color: #2e7d32;
      margin: 10px 0 6px 0;
      font-weight: 600;
    }

    .relatorio-description ul {
      margin: 10px 0;
      padding-left: 25px;
    }

    .relatorio-description ul li {
      margin: 5px 0;
      line-height: 1.6;
    }

    .relatorio-description strong {
      color: #2e7d32;
      font-weight: 600;
    }

    .relatorio-description em {
      font-style: italic;
      color: #666;
    }

    .relatorio-description p {
      margin: 8px 0;
    }

    .markdown-help {
      font-size: 12px;
      color: #999;
      margin-top: 8px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 6px;
      border-left: 3px solid #2e7d32;
    }

    .markdown-help strong {
      color: #2e7d32;
    }

    .format-toolbar {
      display: flex;
      gap: 5px;
      padding: 10px;
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 8px 8px 0 0;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .format-btn {
      padding: 6px 12px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
      color: #333;
      font-weight: 500;
    }

    .format-btn:hover {
      background: #2e7d32;
      color: white;
      border-color: #2e7d32;
      transform: translateY(-1px);
    }

    .format-btn:active {
      transform: translateY(0);
    }

    .format-toolbar-textarea {
      border-radius: 0 0 8px 8px !important;
      border-top: none !important;
    }

    .relatorio-images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .relatorio-image-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .relatorio-image-item img {
      width: 100%;
      height: auto;
      min-height: 200px;
      max-height: 400px;
      object-fit: contain;
      border-radius: 8px;
      cursor: pointer;
      transition: box-shadow 0.3s;
      background: #f5f5f5;
      border: 2px solid #e0e0e0;
    }

    .relatorio-image-item img:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .image-caption {
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      color: #2e7d32;
      padding: 5px 10px;
      background: #e8f5e9;
      border-radius: 4px;
      pointer-events: none;
    }

    .relatorio-videos {
      margin-top: 15px;
    }

    .video-link {
      display: inline-block;
      color: #2e7d32;
      text-decoration: none;
      margin-right: 15px;
      font-weight: 500;
    }

    .video-link:hover {
      text-decoration: underline;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state svg {
      width: 120px;
      height: 120px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    @media (max-width: 768px) {
      .search-grid {
        grid-template-columns: 1fr;
      }

      .header-section {
        flex-direction: column;
        align-items: stretch;
      }

      .btn-primary {
        width: 100%;
      }
    }

    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.98);
      z-index: 2000;
      overflow: hidden;
    }

    .image-modal-container {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: auto;
      cursor: grab;
    }

    .image-modal-container:active {
      cursor: grabbing;
    }

    .image-modal img {
      max-width: none;
      max-height: none;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
      border: 3px solid #2e7d32;
      transition: transform 0.3s ease;
      transform-origin: center center;
    }

    .image-modal-close {
      position: absolute;
      top: 20px;
      right: 40px;
      color: #333;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
      z-index: 2001;
      background: rgba(255, 255, 255, 0.9);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      border: 2px solid #2e7d32;
    }

    .image-modal-close:hover {
      background: #f44336;
      color: white;
      border-color: #f44336;
    }

    .image-modal-caption {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      color: #333;
      font-size: 18px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px 24px;
      border-radius: 8px;
      border: 2px solid #2e7d32;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 2002;
    }

    .zoom-controls {
      position: absolute;
      top: 80px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 2002;
    }

    .zoom-btn {
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid #2e7d32;
      border-radius: 50%;
      font-size: 24px;
      font-weight: bold;
      color: #2e7d32;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .zoom-btn:hover {
      background: #2e7d32;
      color: white;
      transform: scale(1.1);
    }

    .zoom-level {
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid #2e7d32;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      color: #2e7d32;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .video-input-container {
      margin-top: 15px;
    }

    .video-input-item {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .video-input-item input {
      flex: 1;
    }

    .btn-add-video {
      background: #4caf50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-remove-video {
      background: #f44336;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
  </style>
</head>

<body>

  <div style="display: flex; align-items: center; justify-content: center; gap: 24px;">
    <h1 id="titulo"
      style="font-family:'Roboto Slab', 'Georgia', serif; font-size:2.8em; color:#184d27; letter-spacing:2px; font-weight:900; padding:10px 12px; margin:0;">
      PORTAL N√öCLEO T√âCNICO
    </h1>
  </div>
  <br>

  <div class="menu-container">
    <button id="btn-relatorios" class="menu-btn" onclick="location.href='relatorios-tecnicos.html'">Relat√≥rios<br>T√©cnicos</button>
    <button id="btn-checklist" class="menu-btn" onclick="location.href='checklist.html'">Checklist</button>
    <button id="btn-indices" class="menu-btn" onclick="location.href='indices.html'">√çndices</button>
    <button id="btn-fluxos" class="menu-btn" onclick="location.href='fluxos.html'">Fluxos</button>
    <button id="btn-calendario" class="menu-btn" onclick="location.href='calendario.html'">Calend√°rio</button>
    <button id="btn-links" class="menu-btn" onclick="location.href='links.html'">Links</button>
    <button id="btn-modulos" class="menu-btn" onclick="location.href='modulos.html'">M√≥dulos<br>Homologados</button>
    <button id="btn-ferramentas" class="menu-btn" onclick="location.href='ferramentas.html'">Ferramentas</button>
    <button id="btn-controlens" class="menu-btn" onclick="location.href='controlens.html'">Controle<br>An√°lises</button>
    <button id="btn-engenharia" class="menu-btn" onclick="location.href='engenharia.html'">Engenharia</button>
    <button id="btn-configuracoes" class="menu-btn" onclick="location.href='configuracoes.html'">Configura√ß√µes</button>
    <button class="menu-btn" onclick="logout()" style="background: linear-gradient(145deg, #d32f2f, #f44336);">Sair</button>
  </div>

  <div class="container-relatorios">
    <!-- Sidebar com √∫ltimos cadastros -->
    <aside class="sidebar-recentes">
      <h3>üìÑ √öltimos Relat√≥rios</h3>
      <div id="sidebarList">
        <div class="sidebar-empty">Carregando...</div>
      </div>
    </aside>

    <!-- Conte√∫do principal -->
    <div class="main-content">
      <div class="header-section">
        <h2>üìã Relat√≥rios T√©cnicos</h2>
        <button class="btn-primary" onclick="abrirModalRelatorio()">+ Novo Relat√≥rio</button>
      </div>

      <!-- Se√ß√£o de Busca -->
      <div class="search-section">
        <h3 style="margin-bottom: 20px; color: #184d27;">üîç Buscar Relat√≥rios</h3>
        <div class="search-grid">
          <div class="input-group">
            <label>N√∫mero NS</label>
            <input type="text" id="searchNS" placeholder="Digite o NS...">
          </div>
          <div class="input-group">
            <label>N√∫mero de Instala√ß√£o</label>
            <input type="text" id="searchInstalacao" placeholder="Digite a instala√ß√£o...">
          </div>
          <div class="input-group">
            <label>Nome do Cliente</label>
            <input type="text" id="searchCliente" placeholder="Digite o nome...">
          </div>
        </div>
        <button class="btn-primary" onclick="buscarRelatorios()">Buscar</button>
        <button class="btn-secondary" onclick="limparBusca()">Limpar Filtros</button>
      </div>

      <!-- Lista de Relat√≥rios -->
      <div id="relatoriosList" class="relatorios-list">
        <div class="loading">Carregando relat√≥rios...</div>
      </div>
    </div>
  </div>

  <!-- Modal de Cadastro/Edi√ß√£o -->
  <div id="modalRelatorio" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Novo Relat√≥rio T√©cnico</h3>
        <button class="close-modal" onclick="fecharModal()">&times;</button>
      </div>

      <form id="formRelatorio" class="form-grid">
        <input type="hidden" id="relatorioId">

        <div class="input-group">
          <label>N√∫mero NS</label>
          <input type="text" id="numeroNS" placeholder="Ex: NS123456">
        </div>

        <div class="input-group">
          <label>N√∫mero de Instala√ß√£o</label>
          <input type="text" id="numeroInstalacao" placeholder="Ex: 12345678">
        </div>

        <div class="input-group">
          <label>Nome do Cliente</label>
          <input type="text" id="nomeCliente" placeholder="Ex: Jo√£o da Silva">
        </div>

        <div class="input-group">
          <label>T√≠tulo do Relat√≥rio *</label>
          <input type="text" id="tituloRelatorio" required placeholder="Ex: Instala√ß√£o de Medidor">
        </div>

        <div class="input-group">
          <label>Descri√ß√£o do Evento *</label>
          <div class="format-toolbar">
            <button type="button" class="format-btn" onclick="insertFormat('# ', '')" title="T√≠tulo">
              <strong>H1</strong>
            </button>
            <button type="button" class="format-btn" onclick="insertFormat('## ', '')" title="Subt√≠tulo">
              <strong>H2</strong>
            </button>
            <button type="button" class="format-btn" onclick="insertFormat('### ', '')" title="Se√ß√£o">
              <strong>H3</strong>
            </button>
            <button type="button" class="format-btn" onclick="insertFormat('**', '**')" title="Negrito">
              <strong>B</strong>
            </button>
            <button type="button" class="format-btn" onclick="insertFormat('*', '*')" title="It√°lico">
              <em>I</em>
            </button>
            <button type="button" class="format-btn" onclick="insertFormat('- ', '')" title="Lista">
              ‚Ä¢ Lista
            </button>
            <button type="button" class="format-btn" onclick="insertFormat('  - ', '')" subt√≥pico">
              ‚ó¶ Subt√≥pico
            </button>
          </div>
          <textarea id="descricaoEvento" class="format-toolbar-textarea" maxlength="10000" required placeholder="Descreva detalhadamente o evento ocorrido..." rows="8" oninput="atualizarContador()"></textarea>
          <div style="font-size: 12px; color: #999; margin-top: 5px; text-align: right;">
            <span id="charCounter">0</span> / 10.000 caracteres
          </div>
          <div class="markdown-help">
            <strong>‚ÑπÔ∏è Dica:</strong> Use os bot√µes acima ou digite:
            <br><strong>#</strong> T√≠tulo | <strong>##</strong> Subt√≠tulo | <strong>-</strong> T√≥pico | <strong>**negrito**</strong> | <strong>*it√°lico*</strong>
          </div>
        </div>

        <div class="input-group">
          <label>üì∑ Fotos do Evento</label>
          <div class="upload-area" onclick="document.getElementById('fotosInput').click()">
            <p style="color: #2e7d32; font-size: 16px; font-weight: 500;">üìÅ Clique para selecionar fotos</p>
            <p style="color: #999; font-size: 14px; margin-top: 8px;">Formatos aceitos: JPG, PNG, JPEG</p>
            <input type="file" id="fotosInput" accept="image/*" multiple onchange="previewImages()">
          </div>
          <div id="previewContainer" class="preview-images"></div>
        </div>

        <div class="input-group">
          <label>üìÑ Arquivos Anexos (PDF, DOC, XLS, etc.)</label>
          <div class="upload-area" onclick="document.getElementById('arquivosInput').click()">
            <p style="color: #2e7d32; font-size: 16px; font-weight: 500;">üìÅ Clique para selecionar arquivos</p>
            <p style="color: #999; font-size: 14px; margin-top: 8px;">PDF, DOC, DOCX, XLS, XLSX, TXT, ZIP</p>
            <input type="file" id="arquivosInput" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar" multiple onchange="previewFiles()">
          </div>
          <div id="filesPreviewContainer" class="preview-images"></div>
        </div>

        <div class="input-group">
          <label>üîó Material Complementar (Links)</label>
          <div id="videoInputsContainer">
            <div class="video-input-item">
              <input type="url" placeholder="Ex: https://drive.google.com/..." class="video-link-input">
              <button type="button" class="btn-add-video" onclick="adicionarCampoVideo()">+ Adicionar</button>
            </div>
          </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="submit" class="btn-primary" style="flex: 1;">üíæ Salvar Relat√≥rio</button>
          <button type="button" class="btn-secondary" onclick="fecharModal()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para visualizar imagem -->
  <div id="imageModal" class="image-modal">
    <span class="image-modal-close" onclick="fecharImagemModal()">&times;</span>
    <div class="zoom-controls">
      <button class="zoom-btn" onclick="zoomIn()" title="Aumentar zoom">+</button>
      <div class="zoom-level" id="zoomLevel">100%</div>
      <button class="zoom-btn" onclick="zoomOut()" title="Diminuir zoom">‚àí</button>
      <button class="zoom-btn" onclick="resetZoom()" title="Resetar zoom">‚ü≤</button>
    </div>
    <div class="image-modal-container" id="imageModalContainer">
      <img id="imageModalContent" src="">
    </div>
    <div id="imageModalCaption" class="image-modal-caption"></div>
  </div>

  <script>
    // Configura√ß√£o Supabase (usar nome √∫nico para evitar conflito)
    const SUPABASE_URL = 'https://nelzhukmxrgdoarsxcek.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lbHpodWtteHJnZG9hcnN4Y2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMDIxNzUsImV4cCI6MjA3MTU3ODE3NX0.KHvfJHVimKwiraEzbyZWyLnTO5P5VEvM86GlyE7y09k';
    const supabaseRelatorios = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Fun√ß√£o para verificar/criar sess√£o an√¥nima
    async function garantirAutenticacao() {
      const { data: { session } } = await supabaseRelatorios.auth.getSession();
      
      if (!session) {
        // Se n√£o houver sess√£o, fazer login an√¥nimo
        const { error } = await supabaseRelatorios.auth.signInAnonymously();
        if (error) {
          console.error('Erro ao autenticar:', error);
          throw error;
        }
      }
    }

    // Chamar ao carregar a p√°gina
    garantirAutenticacao().catch(console.error);

    let imageFilesArray = []; // Novas fotos (arquivos)
    let existingImageUrls = []; // Fotos j√° cadastradas (URLs)
    let documentFilesArray = []; // Novos arquivos (documentos)
    let existingDocumentUrls = []; // Arquivos j√° cadastrados (URLs)
    let editandoRelatorio = false;

    // Fun√ß√£o para converter Markdown b√°sico para HTML
    function markdownToHtml(text) {
      if (!text) return '';
      
      let html = text;
      
      // T√≠tulos
      html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
      html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
      html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
      
      // Negrito
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      
      // It√°lico
      html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
      
      // Listas
      const lines = html.split('\n');
      let inList = false;
      let result = [];
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const trimmed = line.trim();
        
        if (trimmed.startsWith('- ') || trimmed.startsWith('* ')) {
          if (!inList) {
            result.push('<ul>');
            inList = true;
          }
          const indent = line.search(/\S/);
          const content = trimmed.substring(2);
          const style = indent > 0 ? ` style="margin-left: ${indent * 10}px;"` : '';
          result.push(`<li${style}>${content}</li>`);
        } else {
          if (inList) {
            result.push('</ul>');
            inList = false;
          }
          if (trimmed === '') {
            result.push('<br>');
          } else if (!trimmed.startsWith('<h')) {
            result.push(`<p>${line}</p>`);
          } else {
            result.push(line);
          }
        }
      }
      
      if (inList) {
        result.push('</ul>');
      }
      
      return result.join('\n');
    }

    // Atualizar contador de caracteres
    function atualizarContador() {
      const textarea = document.getElementById('descricaoEvento');
      const counter = document.getElementById('charCounter');
      counter.textContent = textarea.value.length;
    }

    // Fun√ß√£o para inserir formata√ß√£o no textarea
    function insertFormat(before, after) {
      const textarea = document.getElementById('descricaoEvento');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const selectedText = textarea.value.substring(start, end);
      const beforeText = textarea.value.substring(0, start);
      const afterText = textarea.value.substring(end);
      
      // Se for t√≠tulo ou lista, inserir no in√≠cio da linha
      if (before.includes('#') || before.includes('-')) {
        // Encontrar in√≠cio da linha
        const lastNewLine = beforeText.lastIndexOf('\n');
        const lineStart = lastNewLine === -1 ? 0 : lastNewLine + 1;
        const lineText = textarea.value.substring(lineStart, end);
        
        textarea.value = beforeText.substring(0, lineStart) + before + lineText + afterText;
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = lineStart + before.length + lineText.length;
      } else {
        // Formata√ß√£o inline (negrito, it√°lico)
        if (selectedText) {
          textarea.value = beforeText + before + selectedText + after + afterText;
          textarea.focus();
          textarea.selectionStart = start + before.length;
          textarea.selectionEnd = end + before.length;
        } else {
          textarea.value = beforeText + before + 'texto' + after + afterText;
          textarea.focus();
          textarea.selectionStart = start + before.length;
          textarea.selectionEnd = start + before.length + 5; // Selecionar 'texto'
        }
      }
    }

    // Carregar sidebar ao iniciar (relat√≥rios n√£o carregam automaticamente)
    document.addEventListener('DOMContentLoaded', () => {
      carregarSidebar();
    });

    // Obter nome do usu√°rio baseado no email
    async function obterNomeUsuario(emailOuNome) {
      // Se j√° for um nome (n√£o cont√©m @), retornar como est√°
      if (!emailOuNome.includes('@')) {
        return emailOuNome;
      }

      try {
        const { data, error } = await supabaseRelatorios
          .from('usuarios')
          .select('nome_usuario')
          .eq('email', emailOuNome)
          .single();

        if (error || !data) {
          return emailOuNome;
        }

        return data.nome_usuario;
      } catch (error) {
        console.error('Erro ao obter nome do usu√°rio:', error);
        return emailOuNome;
      }
    }

    // Carregar sidebar com √∫ltimos cadastros
    async function carregarSidebar() {
      try {
        const { data, error } = await supabaseRelatorios
          .from('relatorios_tecnicos')
          .select('id, titulo, numero_ns, nome_cliente, data_criacao')
          .order('data_criacao', { ascending: false })
          .limit(10);

        if (error) throw error;

        const sidebarList = document.getElementById('sidebarList');
        
        if (!data || data.length === 0) {
          sidebarList.innerHTML = '<div class="sidebar-empty">Nenhum relat√≥rio cadastrado</div>';
          return;
        }

        sidebarList.innerHTML = '';
        data.forEach(relatorio => {
          const div = document.createElement('div');
          div.className = 'sidebar-item';
          div.onclick = () => scrollToRelatorio(relatorio.id);
          
          const dataFormatada = new Date(relatorio.data_criacao).toLocaleDateString('pt-BR');
          
          div.innerHTML = `
            <div class="sidebar-item-title">${relatorio.titulo}</div>
            <div class="sidebar-item-meta">
              ${relatorio.numero_ns ? `<span>üìã ${relatorio.numero_ns}</span>` : ''}
              ${relatorio.nome_cliente ? `<span>üë§ ${relatorio.nome_cliente}</span>` : ''}
              <span>üìÖ ${dataFormatada}</span>
            </div>
          `;
          
          sidebarList.appendChild(div);
        });
      } catch (error) {
        console.error('Erro ao carregar sidebar:', error);
        document.getElementById('sidebarList').innerHTML = '<div class="sidebar-empty">Erro ao carregar</div>';
      }
    }

    // Navegar para relat√≥rio espec√≠fico
    async function scrollToRelatorio(id) {
      try {
        const { data, error } = await supabaseRelatorios
          .from('relatorios_tecnicos')
          .select('*')
          .eq('id', id)
          .single();

        if (error) throw error;

        // Exibir o relat√≥rio no container principal
        const container = document.getElementById('relatoriosList');
        container.innerHTML = '';
        const card = await criarCardRelatorio(data);
        container.appendChild(card);
        
        // Scroll suave para o topo
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (error) {
        console.error('Erro ao carregar relat√≥rio:', error);
        alert('Erro ao carregar o relat√≥rio');
      }
    }

    // Abrir modal
    function abrirModalRelatorio(relatorio = null) {
      editandoRelatorio = relatorio !== null;
      document.getElementById('modalRelatorio').style.display = 'block';
      document.getElementById('modalTitle').textContent = editandoRelatorio ? 'Editar Relat√≥rio' : 'Novo Relat√≥rio T√©cnico';

      if (editandoRelatorio) {
        preencherFormulario(relatorio);
      } else {
        document.getElementById('formRelatorio').reset();
        document.getElementById('relatorioId').value = '';
        imageFilesArray = [];
        existingImageUrls = [];
        documentFilesArray = [];
        existingDocumentUrls = [];
        document.getElementById('previewContainer').innerHTML = '';
        document.getElementById('filesPreviewContainer').innerHTML = '';
        document.getElementById('videoInputsContainer').innerHTML = `
          <div class="video-input-item">
            <input type="url" placeholder="Ex: https://drive.google.com/..." class="video-link-input">
            <button type="button" class="btn-add-video" onclick="adicionarCampoVideo()">+ Adicionar</button>
          </div>
        `;
      }
    }

    // Fechar modal
    function fecharModal() {
      document.getElementById('modalRelatorio').style.display = 'none';
    }

    // Fun√ß√£o para mostrar preview completo (existentes + novas)
    function mostrarPreviewCompleto() {
      const previewContainer = document.getElementById('previewContainer');
      previewContainer.innerHTML = '';

      // Mostrar fotos existentes (URLs)
      existingImageUrls.forEach((url, index) => {
        const div = document.createElement('div');
        div.className = 'preview-item';
        div.innerHTML = `
          <img src="${url}" alt="Foto existente ${index + 1}">
          <button class="remove-preview" onclick="removerFotoExistente(${index})">&times;</button>
          <small style="display:block; text-align:center; color:#2e7d32; font-size:11px; margin-top:3px;">‚úì Cadastrada</small>
        `;
        previewContainer.appendChild(div);
      });

      // Mostrar novas fotos (arquivos)
      imageFilesArray.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const div = document.createElement('div');
          div.className = 'preview-item';
          div.innerHTML = `
            <img src="${e.target.result}" alt="Nova foto ${index + 1}">
            <button class="remove-preview" onclick="removerNovaFoto(${index})">&times;</button>
            <small style="display:block; text-align:center; color:#ff9800; font-size:11px; margin-top:3px;">‚äï Nova</small>
          `;
          previewContainer.appendChild(div);
        };
        reader.readAsDataURL(file);
      });
    }

    // Preview de imagens
    function previewImages() {
      const files = document.getElementById('fotosInput').files;
      // Adicionar novas fotos ao array existente ao inv√©s de substituir
      const newFiles = Array.from(files);
      imageFilesArray = [...imageFilesArray, ...newFiles];
      
      mostrarPreviewCompleto();
      
      // Limpar o input para permitir selecionar as mesmas fotos novamente
      document.getElementById('fotosInput').value = '';
    }

    // Remover foto existente (URL)
    function removerFotoExistente(index) {
      if (confirm('Remover esta foto? Ela ser√° exclu√≠da permanentemente ao salvar.')) {
        existingImageUrls.splice(index, 1);
        mostrarPreviewCompleto();
      }
    }

    // Remover nova foto (arquivo)
    function removerNovaFoto(index) {
      imageFilesArray.splice(index, 1);
      mostrarPreviewCompleto();
    }

    // Obter √≠cone baseado na extens√£o do arquivo
    function getFileIcon(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const icons = {
        'pdf': 'üìÑ',
        'doc': 'üìù',
        'docx': 'üìù',
        'xls': 'üìä',
        'xlsx': 'üìä',
        'txt': 'üìÉ',
        'zip': 'üì¶',
        'rar': 'üì¶'
      };
      return icons[ext] || 'üìé';
    }

    // Formatar tamanho do arquivo
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    // Preview de arquivos (documentos)
    function previewFiles() {
      const files = document.getElementById('arquivosInput').files;
      const newFiles = Array.from(files);
      documentFilesArray = [...documentFilesArray, ...newFiles];
      
      mostrarPreviewArquivos();
      
      document.getElementById('arquivosInput').value = '';
    }

    // Mostrar preview completo de arquivos
    function mostrarPreviewArquivos() {
      const container = document.getElementById('filesPreviewContainer');
      container.innerHTML = '';

      // Arquivos existentes
      existingDocumentUrls.forEach((fileData, index) => {
        const div = document.createElement('div');
        div.className = 'file-preview-item';
        div.innerHTML = `
          <div class="file-icon">${getFileIcon(fileData.nome)}</div>
          <div class="file-info">
            <div class="file-name">${fileData.nome}</div>
            <div class="file-status">‚úì Cadastrado</div>
          </div>
          <button class="remove-preview" onclick="removerArquivoExistente(${index})">&times;</button>
        `;
        container.appendChild(div);
      });

      // Novos arquivos
      documentFilesArray.forEach((file, index) => {
        const div = document.createElement('div');
        div.className = 'file-preview-item';
        div.innerHTML = `
          <div class="file-icon">${getFileIcon(file.name)}</div>
          <div class="file-info">
            <div class="file-name">${file.name}</div>
            <div class="file-size">${formatFileSize(file.size)}</div>
            <div class="file-status" style="color: #ff9800;">‚äï Novo</div>
          </div>
          <button class="remove-preview" onclick="removerNovoArquivo(${index})">&times;</button>
        `;
        container.appendChild(div);
      });
    }

    // Remover arquivo existente
    function removerArquivoExistente(index) {
      if (confirm('Remover este arquivo? Ele ser√° exclu√≠do permanentemente ao salvar.')) {
        existingDocumentUrls.splice(index, 1);
        mostrarPreviewArquivos();
      }
    }

    // Remover novo arquivo
    function removerNovoArquivo(index) {
      documentFilesArray.splice(index, 1);
      mostrarPreviewArquivos();
    }

    // Adicionar campo de material complementar
    function adicionarCampoVideo() {
      const container = document.getElementById('videoInputsContainer');
      const div = document.createElement('div');
      div.className = 'video-input-item';
      div.innerHTML = `
        <input type="url" placeholder="Ex: https://drive.google.com/..." class="video-link-input">
        <button type="button" class="btn-remove-video" onclick="this.parentElement.remove()">Remover</button>
      `;
      container.appendChild(div);
    }

    // Salvar relat√≥rio
    document.getElementById('formRelatorio').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validar se pelo menos um dos 3 campos est√° preenchido
      const ns = document.getElementById('numeroNS').value.trim();
      const instalacao = document.getElementById('numeroInstalacao').value.trim();
      const cliente = document.getElementById('nomeCliente').value.trim();

      if (!ns && !instalacao && !cliente) {
        alert('‚ö†Ô∏è Preencha pelo menos um dos campos: NS, Instala√ß√£o ou Cliente');
        return;
      }

      const btnSubmit = e.target.querySelector('button[type="submit"]');
      const textoOriginal = btnSubmit.textContent;
      btnSubmit.disabled = true;
      btnSubmit.textContent = '‚è≥ Salvando...';

      try {
        // Garantir que h√° uma sess√£o ativa antes de salvar
        await garantirAutenticacao();
        const videoInputs = document.querySelectorAll('.video-link-input');
        const videoLinks = Array.from(videoInputs)
          .map(input => input.value.trim())
          .filter(link => link !== '');

        // Upload de imagens
        const imagemUrls = [...existingImageUrls]; // Manter fotos existentes
        for (const file of imageFilesArray) {
          const fileName = `${Date.now()}_${file.name}`;
          const { data, error } = await supabaseRelatorios.storage
            .from('relatorios-tecnicos')
            .upload(fileName, file);

          if (error) throw error;

          const { data: urlData } = supabaseRelatorios.storage
            .from('relatorios-tecnicos')
            .getPublicUrl(fileName);

          imagemUrls.push(urlData.publicUrl);
        }

        // Upload de arquivos (documentos)
        const arquivoUrls = [...existingDocumentUrls]; // Manter arquivos existentes
        for (const file of documentFilesArray) {
          const fileName = `docs_${Date.now()}_${file.name}`;
          const { data, error } = await supabaseRelatorios.storage
            .from('relatorios-tecnicos')
            .upload(fileName, file);

          if (error) throw error;

          const { data: urlData } = supabaseRelatorios.storage
            .from('relatorios-tecnicos')
            .getPublicUrl(fileName);

          arquivoUrls.push({
            nome: file.name,
            url: urlData.publicUrl
          });
        }

        const relatorioData = {
          numero_ns: document.getElementById('numeroNS').value.trim() || '',
          numero_instalacao: document.getElementById('numeroInstalacao').value.trim() || '',
          nome_cliente: document.getElementById('nomeCliente').value.trim() || '',
          titulo: document.getElementById('tituloRelatorio').value,
          descricao: document.getElementById('descricaoEvento').value,
          fotos: imagemUrls,
          arquivos: arquivoUrls,
          videos: videoLinks,
          usuario: sessionStorage.getItem('userName') || localStorage.getItem('userName') || 'Usu√°rio',
          data_criacao: new Date().toISOString()
        };

        const relatorioId = document.getElementById('relatorioId').value;

        if (editandoRelatorio && relatorioId) {
          const { error } = await supabaseRelatorios
            .from('relatorios_tecnicos')
            .update(relatorioData)
            .eq('id', relatorioId);

          if (error) throw error;
          alert('‚úÖ Relat√≥rio atualizado com sucesso!');
        } else {
          const { error } = await supabaseRelatorios
            .from('relatorios_tecnicos')
            .insert([relatorioData]);

          if (error) throw error;
          alert('‚úÖ Relat√≥rio cadastrado com sucesso!');
        }

        fecharModal();
        carregarRelatorios();
        carregarSidebar();

      } catch (error) {
        console.error('Erro ao salvar relat√≥rio:', error);
        
        // Mensagem de erro espec√≠fica para RLS
        if (error.message && error.message.includes('row-level security')) {
          alert('‚ùå ERRO DE PERMISS√ÉO:\n\n' +
                'O banco de dados est√° bloqueando a inser√ß√£o por pol√≠tica de seguran√ßa.\n\n' +
                'SOLU√á√ÉO: No Supabase Dashboard, v√° em SQL Editor e execute:\n\n' +
                'ALTER TABLE relatorios_tecnicos DISABLE ROW LEVEL SECURITY;\n\n' +
                'Ou configure as pol√≠ticas RLS corretamente.');
        } else {
          alert('‚ùå Erro ao salvar relat√≥rio: ' + error.message);
        }
      } finally {
        btnSubmit.disabled = false;
        btnSubmit.textContent = textoOriginal;
      }
    });

    // Carregar relat√≥rios
    async function carregarRelatorios(filtros = {}) {
      const container = document.getElementById('relatoriosList');
      container.innerHTML = '<div class="loading">Carregando relat√≥rios...</div>';

      try {
        let query = supabaseRelatorios
          .from('relatorios_tecnicos')
          .select('*')
          .order('data_criacao', { ascending: false });

        if (filtros.ns) query = query.ilike('numero_ns', `%${filtros.ns}%`);
        if (filtros.instalacao) query = query.ilike('numero_instalacao', `%${filtros.instalacao}%`);
        
        // Buscar por cliente OU t√≠tulo quando o campo cliente for preenchido
        if (filtros.cliente) {
          query = query.or(`nome_cliente.ilike.%${filtros.cliente}%,titulo.ilike.%${filtros.cliente}%`);
        }

        const { data, error } = await query;

        if (error) throw error;

        if (!data || data.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <svg fill="#ccc" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zm-5-7v2h-3v3H9v-3H6v-2h3V9h2v3h3z"/></svg>
              <h3>Nenhum relat√≥rio encontrado</h3>
              <p>Clique em "Novo Relat√≥rio" para adicionar o primeiro registro.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = '';
        for (const relatorio of data) {
          const card = await criarCardRelatorio(relatorio);
          container.appendChild(card);
        }

      } catch (error) {
        console.error('Erro ao carregar relat√≥rios:', error);
        container.innerHTML = '<div class="empty-state"><p>Erro ao carregar relat√≥rios.</p></div>';
      }
    }

    // Criar card de relat√≥rio
    async function criarCardRelatorio(relatorio) {
      const card = document.createElement('div');
      card.className = 'relatorio-card';
      card.setAttribute('data-relatorio-id', relatorio.id);

      const dataFormatada = new Date(relatorio.data_criacao).toLocaleString('pt-BR');
      const nomeUsuario = await obterNomeUsuario(relatorio.usuario);

      // Construir metadata apenas com campos preenchidos
      let metaItems = [];
      if (relatorio.numero_ns) metaItems.push(`<span>üìã NS: <strong>${relatorio.numero_ns}</strong></span>`);
      if (relatorio.numero_instalacao) metaItems.push(`<span>üè† Instala√ß√£o: <strong>${relatorio.numero_instalacao}</strong></span>`);
      if (relatorio.nome_cliente) metaItems.push(`<span>üë§ Cliente: <strong>${relatorio.nome_cliente}</strong></span>`);
      const metaHtml = metaItems.length > 0 ? `<div class="relatorio-meta">${metaItems.join('')}</div>` : '';

      let fotosHtml = '';
      if (relatorio.fotos && relatorio.fotos.length > 0) {
        fotosHtml = '<div class="relatorio-images">';
        relatorio.fotos.forEach((foto, index) => {
          fotosHtml += `
            <div class="relatorio-image-item">
              <img src="${foto}" alt="Imagem ${index + 1}" onclick="abrirImagemModal('${foto}', 'Imagem ${index + 1}')">
              <div class="image-caption">üì∑ Imagem ${index + 1}</div>
            </div>
          `;
        });
        fotosHtml += '</div>';
      }

      let videosHtml = '';
      if (relatorio.videos && relatorio.videos.length > 0) {
        videosHtml = '<div class="relatorio-videos"><strong>üîó Material Complementar:</strong><br>';
        relatorio.videos.forEach((video, index) => {
          videosHtml += `<a href="${video}" target="_blank" class="video-link">Link ${index + 1} (${video})</a><br>`;
        });
        videosHtml += '</div>';
      }

      let arquivosHtml = '';
      if (relatorio.arquivos && relatorio.arquivos.length > 0) {
        arquivosHtml = '<div class="relatorio-files"><h4>üìé Arquivos Anexos</h4><div class="file-list">';
        relatorio.arquivos.forEach(arquivo => {
          arquivosHtml += `
            <div class="file-item" onclick="window.open('${arquivo.url}', '_blank')">
              <div class="file-item-icon">${getFileIcon(arquivo.nome)}</div>
              <div class="file-item-name">${arquivo.nome}</div>
              <div class="file-item-download">‚¨á</div>
            </div>
          `;
        });
        arquivosHtml += '</div></div>';
      }

      card.innerHTML = `
        <div class="relatorio-header">
          <div>
            <div class="relatorio-title">${relatorio.titulo}</div>
            ${metaHtml}
            <div style="font-size: 13px; color: #999; margin-top: 5px;">
              üìÖ ${dataFormatada} ‚Ä¢ Por: ${nomeUsuario}
            </div>
          </div>
          <div>
            <button class="btn-edit" onclick='editarRelatorio(${JSON.stringify(relatorio)})'>‚úèÔ∏è Editar</button>
            <button class="btn-delete" onclick="excluirRelatorio('${relatorio.id}')">üóëÔ∏è Excluir</button>
          </div>
        </div>
        <div class="relatorio-description">${markdownToHtml(relatorio.descricao)}</div>
        ${fotosHtml}
        ${arquivosHtml}
        ${videosHtml}
      `;

      return card;
    }

    // Preencher formul√°rio para edi√ß√£o
    function preencherFormulario(relatorio) {
      document.getElementById('relatorioId').value = relatorio.id;
      document.getElementById('numeroNS').value = relatorio.numero_ns;
      document.getElementById('numeroInstalacao').value = relatorio.numero_instalacao;
      document.getElementById('nomeCliente').value = relatorio.nome_cliente;
      document.getElementById('tituloRelatorio').value = relatorio.titulo;
      document.getElementById('descricaoEvento').value = relatorio.descricao;

      // Carregar fotos existentes
      imageFilesArray = [];
      existingImageUrls = relatorio.fotos ? [...relatorio.fotos] : [];
      mostrarPreviewCompleto();

      // Carregar arquivos existentes
      documentFilesArray = [];
      existingDocumentUrls = relatorio.arquivos ? [...relatorio.arquivos] : [];
      mostrarPreviewArquivos();

      // Preencher v√≠deos
      const videoContainer = document.getElementById('videoInputsContainer');
      videoContainer.innerHTML = '';
      if (relatorio.videos && relatorio.videos.length > 0) {
        relatorio.videos.forEach((video, index) => {
          const div = document.createElement('div');
          div.className = 'video-input-item';
          div.innerHTML = `
            <input type="url" value="${video}" class="video-link-input">
            <button type="button" class="btn-remove-video" onclick="this.parentElement.remove()">Remover</button>
          `;
          videoContainer.appendChild(div);
        });
      }
      const addDiv = document.createElement('div');
      addDiv.className = 'video-input-item';
      addDiv.innerHTML = `
        <input type="url" placeholder="Ex: https://drive.google.com/..." class="video-link-input">
        <button type="button" class="btn-add-video" onclick="adicionarCampoVideo()">+ Adicionar</button>
      `;
      videoContainer.appendChild(addDiv);
    }

    // Editar relat√≥rio
    function editarRelatorio(relatorio) {
      abrirModalRelatorio(relatorio);
    }

    // Excluir relat√≥rio
    async function excluirRelatorio(id) {
      if (!confirm('‚ö†Ô∏è Tem certeza que deseja excluir este relat√≥rio?')) return;

      try {
        const { error } = await supabaseRelatorios
          .from('relatorios_tecnicos')
          .delete()
          .eq('id', id);

        if (error) throw error;

        alert('‚úÖ Relat√≥rio exclu√≠do com sucesso!');
        carregarRelatorios();
        carregarSidebar();

      } catch (error) {
        console.error('Erro ao excluir:', error);
        alert('‚ùå Erro ao excluir relat√≥rio: ' + error.message);
      }
    }

    // Buscar relat√≥rios
    function buscarRelatorios() {
      const filtros = {
        ns: document.getElementById('searchNS').value.trim(),
        instalacao: document.getElementById('searchInstalacao').value.trim(),
        cliente: document.getElementById('searchCliente').value.trim()
      };

      carregarRelatorios(filtros);
    }

    // Limpar busca
    function limparBusca() {
      document.getElementById('searchNS').value = '';
      document.getElementById('searchInstalacao').value = '';
      document.getElementById('searchCliente').value = '';
      carregarRelatorios();
    }

    // Vari√°veis para controle de zoom
    let currentZoom = 1;
    let isDragging = false;
    let startX, startY, scrollLeft, scrollTop;

    // Abrir modal de imagem
    function abrirImagemModal(url, caption = '') {
      const modal = document.getElementById('imageModal');
      const img = document.getElementById('imageModalContent');
      const container = document.getElementById('imageModalContainer');
      
      img.src = url;
      document.getElementById('imageModalCaption').textContent = caption;
      modal.style.display = 'block';
      
      // Resetar zoom ao abrir
      currentZoom = 1;
      updateZoom();
      
      // Adicionar event listeners para arrastar
      container.addEventListener('mousedown', startDragging);
      container.addEventListener('mousemove', drag);
      container.addEventListener('mouseup', stopDragging);
      container.addEventListener('mouseleave', stopDragging);
      
      // Adicionar zoom com scroll do mouse
      container.addEventListener('wheel', handleWheel, { passive: false });
    }

    // Fechar modal de imagem
    function fecharImagemModal() {
      const modal = document.getElementById('imageModal');
      const container = document.getElementById('imageModalContainer');
      
      modal.style.display = 'none';
      document.getElementById('imageModalContent').src = '';
      currentZoom = 1;
      
      // Remover event listeners
      container.removeEventListener('mousedown', startDragging);
      container.removeEventListener('mousemove', drag);
      container.removeEventListener('mouseup', stopDragging);
      container.removeEventListener('mouseleave', stopDragging);
      container.removeEventListener('wheel', handleWheel);
    }

    // Fun√ß√µes de zoom
    function zoomIn() {
      currentZoom = Math.min(currentZoom + 0.25, 5);
      updateZoom();
    }

    function zoomOut() {
      currentZoom = Math.max(currentZoom - 0.25, 0.5);
      updateZoom();
    }

    function resetZoom() {
      currentZoom = 1;
      updateZoom();
      document.getElementById('imageModalContainer').scrollTop = 0;
      document.getElementById('imageModalContainer').scrollLeft = 0;
    }

    function updateZoom() {
      const img = document.getElementById('imageModalContent');
      img.style.transform = `scale(${currentZoom})`;
      document.getElementById('zoomLevel').textContent = `${Math.round(currentZoom * 100)}%`;
    }

    // Zoom com scroll do mouse
    function handleWheel(e) {
      e.preventDefault();
      if (e.deltaY < 0) {
        zoomIn();
      } else {
        zoomOut();
      }
    }

    // Fun√ß√µes para arrastar a imagem
    function startDragging(e) {
      if (currentZoom > 1) {
        isDragging = true;
        const container = document.getElementById('imageModalContainer');
        startX = e.pageX - container.offsetLeft;
        startY = e.pageY - container.offsetTop;
        scrollLeft = container.scrollLeft;
        scrollTop = container.scrollTop;
      }
    }

    function drag(e) {
      if (!isDragging) return;
      e.preventDefault();
      const container = document.getElementById('imageModalContainer');
      const x = e.pageX - container.offsetLeft;
      const y = e.pageY - container.offsetTop;
      const walkX = (x - startX) * 2;
      const walkY = (y - startY) * 2;
      container.scrollLeft = scrollLeft - walkX;
      container.scrollTop = scrollTop - walkY;
    }

    function stopDragging() {
      isDragging = false;
    }

    // Buscar ao pressionar Enter
    document.getElementById('searchNS').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') buscarRelatorios();
    });
    document.getElementById('searchInstalacao').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') buscarRelatorios();
    });
    document.getElementById('searchCliente').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') buscarRelatorios();
    });
  </script>

  <script src="auth.js"></script>
  <script src="menu.js"></script>

</body>

</html>
