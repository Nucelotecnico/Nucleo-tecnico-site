<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>N√∫cleo-T√©cnico - √çndices</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="indices.css">

</head>

<body>

  <div style="display: flex; align-items: center; justify-content: center; gap: 24px;">
    <h1 id="titulo"
      style="font-family:'Roboto Slab', 'Georgia', serif; font-size:2.8em; color:#184d27; letter-spacing:2px; font-weight:900; padding:10px 12px; margin:0;">
      PORTAL N√öCLEO T√âCNICO
    </h1>
  </div>
  <br>

  <div class="menu-container">
    <button id="btn-home" class="menu-btn" onclick="location.href='index.html'">Home</button>
    <button id="btn-checklist" class="menu-btn" onclick="location.href='checklist.html'">Checklist</button>
    <button id="btn-indices" class="menu-btn" onclick="location.href='indices.html'">√çndices</button>
    <button id="btn-fluxos" class="menu-btn" onclick="location.href='fluxos.html'">Fluxos</button>
    <button id="btn-calendario" class="menu-btn" onclick="location.href='calendario.html'">Calend√°rio</button>
    <button id="btn-links" class="menu-btn" onclick="location.href='links.html'">Links</button>
    <button id="btn-modulos" class="menu-btn" onclick="location.href='modulos.html'">M√≥dulos
      <br>Homologados</button>
    <button id="btn-ferramentas" class="menu-btn"
      onclick="location.href='ferramentas.html'">Ferramentas</button>
    <button id="btn-controlens" class="menu-btn" onclick="location.href='controlens.html'">Controle<br>An√°lises</button>
    <button id="btn-engenharia" class="menu-btn" onclick="location.href='engenharia.html'">Engenharia</button>
    <button id="btn-configuracoes" class="menu-btn" onclick="location.href='configuracoes.html'">Configura√ß√µes</button>
    <button class="menu-btn" onclick="logout()" style="background: linear-gradient(145deg, #d32f2f, #f44336);">Sair</button>

  </div>

  <script src="auth.js"></script>

  <h1 style="text-align: center; color: #184d27; margin: 20px 0;">GERENCIADOR DE √çNDICES</h1>

  <div style="max-width: 1400px; margin: 0 auto; padding: 20px;">
    
    <!-- Se√ß√£o de Upload -->
    <div id="secaoUpload" style="display: none; background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <h2 style="color: #2e7d32; margin-bottom: 16px;">üì§ Upload de Arquivo Excel</h2>
      <div style="display: flex; gap: 12px; align-items: center;">
        <input type="file" id="fileInput" accept=".xlsx, .xls" 
          style="padding: 10px; border: 2px solid #e8f5e9; border-radius: 8px; flex: 1;">
        <button onclick="processarExcel()" 
          style="background: linear-gradient(145deg, #2e7d32, #43a047); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
          Importar Dados
        </button>
        <button onclick="limparTabela()" 
          style="background: linear-gradient(145deg, #d32f2f, #f44336); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
          Limpar Tabela
        </button>
      </div>
      <p style="color: #666; font-size: 0.9em; margin-top: 8px;">
        ‚ÑπÔ∏è O arquivo Excel deve conter as colunas: Nota, √Årea operacional, Cidade, C√≥digo medidas, Descri√ß√£o, Texto medidas, Status usu√°rio, In√≠cio planejado, Fim planejado, Conclu√≠do por, Conclu√≠da em, Modificado por
      </p>
    </div>

    <!-- Gr√°fico de An√°lise Geral -->
    <div style="background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #2e7d32; margin: 0;">üìä Quantidade de Notas ABER E ANDM</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: flex-end;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <label for="filtroMesFimPlanejado" style="font-size: 14px; color: #666; font-weight: 500;">Filtrar por m√™s:</label>
            <select id="filtroMesFimPlanejado" onchange="filtrarGraficoFimPlanejadoPorMes()" 
                    style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; background: #fff; cursor: pointer;">
              <option value="todos">Todos os meses</option>
            </select>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleDescricoes" onclick="toggleDropdownDescricoes()" 
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por descri√ß√£o</span>
            </button>
            <div id="containerCheckboxesDescricoes" style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleCodigoMedidas" onclick="toggleDropdownCodigoMedidas()" 
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por C√≥digo Medidas</span>
            </button>
            <div id="containerCheckboxesCodigoMedidas" style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleStatusFimPlanejado" onclick="toggleDropdownStatusFimPlanejado()" 
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por Status</span>
            </button>
            <div id="containerCheckboxesStatusFimPlanejado" style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
        </div>
      </div>
      <div style="max-width: 1000px; margin: 0 auto;">
        <canvas id="chartFimPlanejado"></canvas>
      </div>
      <div id="infoGeralNotas" style="margin-top: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px; color: #333;">
        <strong>Total de notas:</strong> <span id="totalGeralNotas">0</span> | 
        <strong style="color: #2e7d32;">ANDM:</strong> <span id="totalANDM" style="color: #2e7d32;">0</span> | 
        <strong style="color: #66bb6a;">ABER:</strong> <span id="totalABER" style="color: #66bb6a;">0</span>
      </div>
    </div>

    <!-- Modal para exibir notas detalhadas -->
    <div id="modalNotas" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow: auto;">
      <div style="background: white; margin: 50px auto; max-width: 90%; max-height: 85vh; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="background: #2e7d32; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0;" id="modalTitulo">Notas Detalhadas</h3>
          <button onclick="fecharModalNotas()" style="background: transparent; border: none; color: white; font-size: 28px; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
        </div>
        <div style="padding: 20px 20px 40px 20px; max-height: calc(85vh - 80px); overflow-y: auto;">
          <div id="modalConteudo"></div>
        </div>
      </div>
    </div>

    <!-- Gr√°fico de Notas Conclu√≠das (CONC CTEC e CONC RTEC) -->
    <div style="background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #2e7d32; margin: 0;">‚úÖ Notas Conclu√≠das por Data de Conclus√£o</h2>
        <div style="display: flex; flex-wrap: wrap; align-items: flex-start; gap: 12px; justify-content: flex-end;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <label for="filtroMesConcluidas" style="font-size: 14px; color: #666; font-weight: 500;">Filtrar por m√™s:</label>
            <select id="filtroMesConcluidas" onchange="filtrarGraficoConcluidasPorMes()" 
                    style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; background: #fff; cursor: pointer;">
              <option value="todos">Todos os meses</option>
            </select>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleCodigoMedidasConcluidas" onclick="toggleDropdownCodigoMedidasConcluidas()" 
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por C√≥digo Medidas</span>
            </button>
            <div id="containerCheckboxesCodigoMedidasConcluidas" style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
        </div>
      </div>
      <div style="max-width: 1000px; margin: 0 auto;">
        <canvas id="chartConcluidas"></canvas>
      </div>
      <div id="infoConcluidas" style="margin-top: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px; color: #333;">
        <strong>Total de notas conclu√≠das:</strong> <span id="totalConcluidas">0</span> | 
        <strong style="color: #388e3c;">CONC CTEC:</strong> <span id="totalCONC_CTEC" style="color: #388e3c;">0</span> | 
        <strong style="color: #81c784;">CONC RTEC:</strong> <span id="totalCONC_RTEC" style="color: #81c784;">0</span> | 
        <strong style="color: #388e3c;">% Aprova√ß√£o CONC CTEC:</strong> <span id="percentualAprovacao" style="color: #388e3c; font-weight: bold;">0%</span>
      </div>
    </div>

    <!-- Gr√°fico de Prazo M√©dio Mensal -->
    <div style="background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #2e7d32; margin: 0;">üìÖ Prazo M√©dio Mensal Geral(GD e Carga)</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: flex-end;">
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleDescricoesPrazo" onclick="toggleDropdownDescricoesPrazo()" 
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por descri√ß√£o</span>
            </button>
            <div id="containerCheckboxesDescricoesPrazo" style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleCodigoMedidasPrazo" onclick="toggleDropdownCodigoMedidasPrazo()" 
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por C√≥digo Medidas</span>
            </button>
            <div id="containerCheckboxesCodigoMedidasPrazo" style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
        </div>
      </div>
      <div style="max-width: 1000px; margin: 0 auto;">
        <canvas id="chartPrazoMedio"></canvas>
      </div>
      <div id="infoPrazoMedio" style="margin-top: 16px; padding: 12px; background: #fff3e0; border-radius: 8px; color: #e65100;">
        <strong>Total de notas analisadas:</strong> <span id="totalNotasAnalisadas">0</span> | 
        <strong>Prazo m√©dio geral:</strong> <span id="prazoMedioGeral">0</span> dias
      </div>
    </div>

    <!-- Gr√°fico de Prazo M√©dio Mensal - Todos exceto Mini/Micro Gera√ß√£o -->
    <div style="background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #2e7d32; margin: 0;">üìÖ Prazo M√©dio Mensal - Carga</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: flex-end;">
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleDescricoesPrazoExceto" onclick="toggleDropdownDescricoesPrazoExceto()" 
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por descri√ß√£o</span>
            </button>
            <div id="containerCheckboxesDescricoesPrazoExceto" style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleCodigoMedidasPrazoExceto" onclick="toggleDropdownCodigoMedidasPrazoExceto()" 
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por C√≥digo Medidas</span>
            </button>
            <div id="containerCheckboxesCodigoMedidasPrazoExceto" style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
        </div>
      </div>
      <div style="max-width: 1000px; margin: 0 auto;">
        <canvas id="chartPrazoMedioExceto"></canvas>
      </div>
      <div id="infoPrazoMedioExceto" style="margin-top: 16px; padding: 12px; background: #fff3e0; border-radius: 8px; color: #e65100;">
        <strong>Total de notas analisadas:</strong> <span id="totalNotasAnalisadasExceto">0</span> | 
        <strong>Prazo m√©dio geral:</strong> <span id="prazoMedioGeralExceto">0</span> dias
      </div>
    </div>

    <!-- Gr√°fico de Prazo M√©dio Mensal - Somente Mini/Micro Gera√ß√£o -->
    <div style="background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #2e7d32; margin: 0;">üìÖ Prazo M√©dio Mensal - GD</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: flex-end;">
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleDescricoesPrazoMiniMicro" onclick="toggleDropdownDescricoesPrazoMiniMicro()" 
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por descri√ß√£o</span>
            </button>
            <div id="containerCheckboxesDescricoesPrazoMiniMicro" style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleCodigoMedidasPrazoMiniMicro" onclick="toggleDropdownCodigoMedidasPrazoMiniMicro()" 
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por C√≥digo Medidas</span>
            </button>
            <div id="containerCheckboxesCodigoMedidasPrazoMiniMicro" style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
        </div>
      </div>
      <div style="max-width: 1000px; margin: 0 auto;">
        <canvas id="chartPrazoMedioMiniMicro"></canvas>
      </div>
      <div id="infoPrazoMedioMiniMicro" style="margin-top: 16px; padding: 12px; background: #fff3e0; border-radius: 8px; color: #e65100;">
        <strong>Total de notas analisadas:</strong> <span id="totalNotasAnalisadasMiniMicro">0</span> | 
        <strong>Prazo m√©dio geral:</strong> <span id="prazoMedioGeralMiniMicro">0</span> dias
      </div>
    </div>

    <!-- Gr√°fico Filtrado - Mini Gera√ß√£o -->
    <div style="background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #2e7d32; margin: 0;">‚ö° Quantidade de notas ABER e ANDM - GD</h2>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <button id="botaoToggleCodigoMedidasMiniGeracao" onclick="toggleDropdownCodigoMedidasMiniGeracao()" 
            style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
            <span>‚ñº</span>
            <span>Filtrar por C√≥digo Medidas</span>
          </button>
          <div id="containerCheckboxesCodigoMedidasMiniGeracao" style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
            <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
          </div>
        </div>
      </div>
      <div style="max-width: 1000px; margin: 0 auto;">
        <canvas id="chartMiniGeracao"></canvas>
      </div>
      <div id="infoMiniGeracao" style="margin-top: 16px; padding: 12px; background: #f1f8f4; border-radius: 8px; color: #2e7d32;">
        <strong>Total de notas:</strong> <span id="totalMiniGeracao">0</span>
      </div>
    </div>

    <!-- Gr√°fico de Todos os Tipos de Descri√ß√£o -->
    <div style="background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <h2 style="color: #2e7d32; margin-bottom: 16px;">üìã Quantidade tipos de notas ABER e ANDM</h2>
      <div style="max-width: 1000px; margin: 0 auto;">
        <canvas id="chartOutrosTipos"></canvas>
      </div>
      <div id="infoOutrosTipos" style="margin-top: 16px; padding: 12px; background: #e3f2fd; border-radius: 8px; color: #1976d2;">
        <strong>Total de notas:</strong> <span id="totalOutrosTipos">0</span> | 
        <strong>Tipos √∫nicos:</strong> <span id="tiposUnicos">0</span>
      </div>
    </div>

    <!-- Gr√°fico Sem Mini e Micro Gera√ß√£o - Por Fim Planejado -->
    <div style="background: #fff; border-radius: 10px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #2e7d32; margin: 0;">üîç Quantidade de notas ABER e ANDM - Carga</h2>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <button id="botaoToggleCodigoMedidasSemGeracoes" onclick="toggleDropdownCodigoMedidasSemGeracoes()" 
            style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
            <span>‚ñº</span>
            <span>Filtrar por C√≥digo Medidas</span>
          </button>
          <div id="containerCheckboxesCodigoMedidasSemGeracoes" style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
            <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
          </div>
        </div>
      </div>
      <div style="max-width: 1000px; margin: 0 auto;">
        <canvas id="chartSemGeracoes"></canvas>
      </div>
      <div id="infoSemGeracoes" style="margin-top: 16px; padding: 12px; background: #f3e5f5; border-radius: 8px; color: #7b1fa2;">
        <strong>Total de notas:</strong> <span id="totalSemGeracoes">0</span>
      </div>
    </div>

    <!-- Gr√°fico: Notas Conclu√≠das por Usu√°rio -->
    <div style="background: #fff; border-radius: 10px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 24px;">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
        <h2 style="color: #d32f2f; margin: 0;">üë• Notas Conclu√≠das por Usu√°rio</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: flex-end;">
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <label for="filtroMesNotasPorUsuario" style="font-size: 14px; color: #666; font-weight: 500;">Filtrar por m√™s (Conclu√≠da em):</label>
            <select id="filtroMesNotasPorUsuario" onchange="aplicarFiltroMesNotasPorUsuario()" 
              style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; min-width: 180px;">
              <option value="todos">Todos os meses</option>
            </select>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleDescricoesNotasPorUsuario" onclick="toggleDropdownDescricoesNotasPorUsuario()" 
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por descri√ß√£o</span>
            </button>
            <div id="containerCheckboxesDescricoesNotasPorUsuario" style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button id="botaoToggleCodigoMedidasNotasPorUsuario" onclick="toggleDropdownCodigoMedidasNotasPorUsuario()" 
              style="padding: 10px 16px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;">
              <span>‚ñº</span>
              <span>Filtrar por C√≥digo Medidas</span>
            </button>
            <div id="containerCheckboxesCodigoMedidasNotasPorUsuario" style="display: none; flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px; background: #f9f9f9; border-radius: 6px; border: 1px solid #e0e0e0; min-height: 40px; margin-top: 8px;">
              <!-- Os checkboxes ser√£o inseridos aqui dinamicamente -->
            </div>
          </div>
        </div>
      </div>
      <div style="max-width: 1000px; margin: 0 auto;">
        <canvas id="chartNotasPorUsuario"></canvas>
      </div>
      <div id="infoNotasPorUsuario" style="margin-top: 16px; padding: 12px; background: #ffebee; border-radius: 8px; color: #c62828;">
        <strong>Total de notas conclu√≠das:</strong> <span id="totalNotasPorUsuario">0</span>
      </div>
    </div>

    <!-- Tabela de Dados -->
    <div id="secaoDadosCadastrados" style="display: none; background: #fff; border-radius: 10px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow-x: auto;">
      <h2 style="color: #2e7d32; margin-bottom: 16px;">üìä Dados Cadastrados</h2>
      <div id="tabelaContainer" style="overflow-x: auto;">
        <table id="tabelaIndices" style="width: 100%; border-collapse: collapse; min-width: 1200px;">
          <thead>
            <tr style="background: #f5f5f5;">
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">Nota</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">√Årea Operacional</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">Cidade</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">C√≥digo Medidas</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">Descri√ß√£o</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">Texto Medidas</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">Status Usu√°rio</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">In√≠cio Planejado</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">Fim Planejado</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">Conclu√≠do Por</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">Conclu√≠da Em</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; white-space: nowrap;">Modificado Por</th>
              <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd; white-space: nowrap;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tabelaBody">
            <tr>
              <td colspan="13" style="text-align: center; padding: 20px; color: #999;">
                Nenhum dado cadastrado. Fa√ßa upload de um arquivo Excel para come√ßar.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="auth.js"></script>
  <script>
    // Configura√ß√£o do Supabase
    const SUPABASE_URL = 'https://nelzhukmxrgdoarsxcek.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lbHpodWtteHJnZG9hcnN4Y2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMDIxNzUsImV4cCI6MjA3MTU3ODE3NX0.KHvfJHVimKwiraEzbyZWyLnTO5P5VEvM86GlyE7y09k';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Controlar acesso √† se√ß√£o de upload para usu√°rio comum
    document.addEventListener('DOMContentLoaded', function() {
      const categoria = sessionStorage.getItem('userCategoria');
      const secaoUpload = document.getElementById('secaoUpload');
      const secaoDadosCadastrados = document.getElementById('secaoDadosCadastrados');
      
      if (categoria === 'usuario') {
        if (secaoUpload) {
          secaoUpload.style.display = 'none';
        }
        if (secaoDadosCadastrados) {
          secaoDadosCadastrados.style.display = 'none';
        }
      } else {
        if (secaoUpload) {
          secaoUpload.style.display = 'block';
        }
        if (secaoDadosCadastrados) {
          secaoDadosCadastrados.style.display = 'block';
        }
      }
    });

    window.processarExcel = async function() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('Por favor, selecione um arquivo Excel.');
        return;
      }

      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          
          // Ler como array de arrays (ignora cabe√ßalhos problem√°ticos)
          const arrayData = XLSX.utils.sheet_to_json(firstSheet, { 
            header: 1, // Retorna array de arrays
            defval: '' // Define valor padr√£o para c√©lulas vazias
          });

          console.log('Total de linhas no Excel:', arrayData.length);
          console.log('Primeira linha (cabe√ßalho):', arrayData[0]);
          console.log('Segunda linha (dados):', arrayData[1]);
          console.log('Terceira linha (dados):', arrayData[2]);

          // Remover linha de cabe√ßalho
          const dadosLinhas = arrayData.slice(1).filter(row => 
            row && row.length > 0 && row.some(cell => cell !== '' && cell !== null && cell !== undefined)
          );

          console.log('Total de linhas com dados:', dadosLinhas.length);

          if (dadosLinhas.length === 0) {
            alert('O arquivo Excel est√° vazio ou n√£o possui dados v√°lidos.');
            return;
          }

          // Mapear os dados usando √≠ndices de array
          const dadosFormatados = dadosLinhas.map((row, index) => {
            console.log(`Linha ${index + 1}:`, row);
            return {
              nota: String(row[0] || ''),
              area_operacional: String(row[1] || ''),
              cidade: String(row[2] || ''),
              codigo_medidas: String(row[3] || ''),
              descricao: String(row[4] || ''),
              texto_medidas: String(row[5] || ''),
              status_usuario: String(row[6] || ''),
              inicio_planejado: String(row[7] || ''),
              fim_planejado: String(row[8] || ''),
              concluido_por: String(row[9] || ''),
              concluida_em: String(row[10] || ''),
              modificado_por: String(row[11] || '')
            };
          });

          console.log('Dados formatados:', dadosFormatados);
          console.log('Total de registros formatados:', dadosFormatados.length);

          // Inserir no banco de dados
          const { data: insertData, error } = await supabaseClient
            .from('indices')
            .insert(dadosFormatados);

          if (error) {
            console.error('Erro ao inserir dados:', error);
            alert('Erro ao importar dados: ' + error.message);
          } else {
            alert(`${dadosFormatados.length} registros importados com sucesso!`);
            fileInput.value = '';
            carregarDados();
          }
        } catch (error) {
          console.error('Erro ao processar arquivo:', error);
          alert('Erro ao processar arquivo: ' + error.message);
        }
      };

      reader.readAsArrayBuffer(file);
    };

    // Fun√ß√µes para o modal de notas
    window.abrirModalNotas = function(notas, data, status) {
      const modal = document.getElementById('modalNotas');
      const titulo = document.getElementById('modalTitulo');
      const conteudo = document.getElementById('modalConteudo');
      
      titulo.textContent = `${status} - ${data} (${notas.length} notas)`;
      
      if (notas.length === 0) {
        conteudo.innerHTML = '<p style="text-align: center; color: #666;">Nenhuma nota encontrada.</p>';
      } else {
        let html = '<table style="width: 100%; border-collapse: collapse;">';
        html += '<thead><tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Nota</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Regional</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Cidade</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">C√≥digo Medidas</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Texto Medidas</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Descri√ß√£o</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Status Usu√°rio</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Conclu√≠do Por</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">Respons√°vel</th>';
        html += '<th style="padding: 12px; text-align: left; font-weight: 600;">A√ß√µes</th>';
        html += '</tr></thead><tbody>';
        
        notas.forEach((nota, index) => {
          const bgColor = index % 2 === 0 ? '#fff' : '#f9f9f9';
          html += `<tr style="background: ${bgColor}; border-bottom: 1px solid #eee;">`;
          html += `<td style="padding: 10px;">${nota.nota || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.regional || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.cidade || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.codigo_medidas || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.texto_medidas || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.descricao || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.status_usuario || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.concluido_por || ''}</td>`;
          html += `<td style="padding: 10px;">${nota.responsavel || ''}</td>`;
          html += `<td style="padding: 10px;">`;
          html += `<select id="status_${index}" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">`;
          html += `<option value="${nota.status_usuario || ''}" selected>${nota.status_usuario || 'Selecione'}</option>`;
          html += `<option value="ANDM">ANDM</option>`;
          html += `<option value="ABER">ABER</option>`;
          html += `<option value="CONC CTEC">CONC CTEC</option>`;
          html += `<option value="CONC RTEC">CONC RTEC</option>`;
          html += `<option value="CANC">CANC</option>`;
          html += `</select>`;
          html += `<button onclick="atualizarStatusNota('${nota.id}', ${index})" style="padding: 6px 12px; margin-top: 4px; background: #2e7d32; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%;">Salvar</button>`;
          html += `</td>`;
          html += '</tr>';
        });
        
        html += '</tbody></table>';
        conteudo.innerHTML = html;
      }
      
      modal.style.display = 'block';
    };

    window.atualizarStatusNota = async function(notaId, rowIndex) {
      const selectElement = document.getElementById(`status_${rowIndex}`);
      const novoStatus = selectElement.value;
      
      if (!novoStatus || novoStatus === 'Selecione') {
        alert('Por favor, selecione um status v√°lido');
        return;
      }
      
      try {
        const { error } = await supabaseClient
          .from('indices')
          .update({ status_usuario: novoStatus })
          .eq('id', notaId);
        
        if (error) {
          console.error('Erro ao atualizar status:', error);
          alert('Erro ao atualizar status: ' + error.message);
        } else {
          alert('Status atualizado com sucesso!');
          // Recarregar os dados para atualizar os gr√°ficos
          carregarDados();
        }
      } catch (error) {
        console.error('Erro ao atualizar status:', error);
        alert('Erro ao atualizar status: ' + error.message);
      }
    };

    window.fecharModalNotas = function() {
      document.getElementById('modalNotas').style.display = 'none';
    };

    // Fechar modal ao clicar fora dele
    window.onclick = function(event) {
      const modal = document.getElementById('modalNotas');
      if (event.target === modal) {
        fecharModalNotas();
      }
    };

    window.carregarDados = async function() {
      try {
        // Buscar todos os registros usando pagina√ß√£o (Supabase tem limite de 1000 por padr√£o)
        let todosOsDados = [];
        let inicio = 0;
        const tamanhoPagina = 1000;
        let temMaisDados = true;

        console.log('Iniciando carregamento de dados com pagina√ß√£o...');

        while (temMaisDados) {
          const { data, error } = await supabaseClient
            .from('indices')
            .select('*')
            .order('fim_planejado', { ascending: true })
            .range(inicio, inicio + tamanhoPagina - 1);

          if (error) {
            console.error('Erro ao carregar dados:', error);
            return;
          }

          if (data && data.length > 0) {
            todosOsDados = todosOsDados.concat(data);
            console.log(`P√°gina carregada: ${inicio} a ${inicio + data.length}, Total acumulado: ${todosOsDados.length}`);
            inicio += tamanhoPagina;
            temMaisDados = data.length === tamanhoPagina;
          } else {
            temMaisDados = false;
          }
        }

        console.log('Total de registros carregados:', todosOsDados.length);

        // Armazenar dados globalmente
        dadosGlobais = todosOsDados;
        dadosGlobaisCompletos = todosOsDados;

        exibirDados(todosOsDados);
        
        // Popular filtro de descri√ß√µes e de meses ANTES de gerar o gr√°fico
        popularFiltroDescricoes(dadosGlobaisCompletos);
        popularFiltroMesesFimPlanejado(todosOsDados);
        popularFiltroMeses(todosOsDados);
        popularFiltroCodigoMedidas(dadosGlobaisCompletos);
        popularFiltroStatusFimPlanejado(dadosGlobaisCompletos);
        
        // Gerar gr√°fico DEPOIS de popular os filtros
        gerarGrafico(dadosGlobaisCompletos);
        
        gerarGraficoPrazoMedio(todosOsDados);
        popularFiltroDescricoesPrazo(todosOsDados);
        popularFiltroCodigoMedidasPrazo(todosOsDados);

        gerarGraficoPrazoMedioExceto(todosOsDados);
        popularFiltroDescricoesPrazoExceto(todosOsDados);
        popularFiltroCodigoMedidasPrazoExceto(todosOsDados);

        gerarGraficoPrazoMedioMiniMicro(todosOsDados);
        popularFiltroDescricoesPrazoMiniMicro(todosOsDados);
        popularFiltroCodigoMedidasPrazoMiniMicro(todosOsDados);

        gerarGraficoMiniGeracao(todosOsDados);
        popularFiltroCodigoMedidasMiniGeracao(todosOsDados);

        gerarGraficoOutrosTipos(todosOsDados);
        popularFiltroCodigoMedidasSemGeracoes(todosOsDados);

        gerarGraficoSemGeracoes(todosOsDados);
        
        popularFiltroDescricoesNotasPorUsuario(todosOsDados);
        popularFiltroMesesNotasPorUsuario(todosOsDados);
        popularFiltroCodigoMedidasNotasPorUsuario(todosOsDados);
        gerarGraficoNotasPorUsuario(todosOsDados);
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
      }
    };

    window.exibirDados = function(dados) {
      const tbody = document.getElementById('tabelaBody');
      
      if (!dados || dados.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="13" style="text-align: center; padding: 20px; color: #999;">
              Nenhum dado cadastrado. Fa√ßa upload de um arquivo Excel para come√ßar.
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = dados.map(item => `
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 12px;">${item.nota || ''}</td>
          <td style="padding: 12px;">${item.area_operacional || ''}</td>
          <td style="padding: 12px;">${item.cidade || ''}</td>
          <td style="padding: 12px;">${item.codigo_medidas || ''}</td>
          <td style="padding: 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${item.descricao || ''}">${item.descricao || ''}</td>
          <td style="padding: 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${item.texto_medidas || ''}">${item.texto_medidas || ''}</td>
          <td style="padding: 12px;">${item.status_usuario || ''}</td>
          <td style="padding: 12px;">${item.inicio_planejado || ''}</td>
          <td style="padding: 12px;">${item.fim_planejado || ''}</td>
          <td style="padding: 12px;">${item.concluido_por || ''}</td>
          <td style="padding: 12px;">${item.concluida_em || ''}</td>
          <td style="padding: 12px;">${item.modificado_por || ''}</td>
          <td style="padding: 12px; text-align: center;">
            <button onclick="excluirRegistro(${item.id})" 
              style="background: #dc3545; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
              üóëÔ∏è Excluir
            </button>
          </td>
        </tr>
      `).join('');
    };

    window.excluirRegistro = async function(id) {
      if (!confirm('Tem certeza que deseja excluir este registro?')) return;

      const { error } = await supabaseClient
        .from('indices')
        .delete()
        .eq('id', id);

      if (error) {
        alert('Erro ao excluir: ' + error.message);
      } else {
        alert('Registro exclu√≠do com sucesso!');
        carregarDados();
      }
    };

    window.limparTabela = async function() {
      if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° excluir TODOS os dados da tabela. Deseja continuar?')) return;
      
      if (!confirm('Tem certeza ABSOLUTA? Esta a√ß√£o n√£o pode ser desfeita!')) return;

      const { error } = await supabaseClient
        .from('indices')
        .delete()
        .neq('id', 0);

      if (error) {
        alert('Erro ao limpar tabela: ' + error.message);
      } else {
        alert('Tabela limpa com sucesso!');
        carregarDados();
      }
    };

    window.aplicarFiltros = async function() {
      const filtroNota = document.getElementById('filtroNota').value.toLowerCase();
      const filtroCidade = document.getElementById('filtroCidade').value.toLowerCase();
      const filtroStatus = document.getElementById('filtroStatus').value.toLowerCase();

      const buildQuery = () => {
        let query = supabaseClient.from('indices').select('*');

        if (filtroNota) {
          query = query.ilike('nota', `%${filtroNota}%`);
        }
        if (filtroCidade) {
          query = query.ilike('cidade', `%${filtroCidade}%`);
        }
        if (filtroStatus) {
          query = query.ilike('status_usuario', `%${filtroStatus}%`);
        }

        return query;
      };

      // Buscar todos os dados filtrados com pagina√ß√£o
      let dadosFiltrados = [];
      let inicio = 0;
      const tamanhoPagina = 1000;
      let temMaisDados = true;
      let ultimoErro = null;

      while (temMaisDados) {
        const { data: pagina, error } = await buildQuery()
          .order('fim_planejado', { ascending: true })
          .range(inicio, inicio + tamanhoPagina - 1);

        if (error) {
          ultimoErro = error;
          break;
        }

        if (pagina && pagina.length > 0) {
          dadosFiltrados = dadosFiltrados.concat(pagina);
          inicio += tamanhoPagina;
          temMaisDados = pagina.length === tamanhoPagina;
        } else {
          temMaisDados = false;
        }
      }

      if (ultimoErro) {
        alert('Erro ao aplicar filtros: ' + ultimoErro.message);
      } else {
        // Armazenar dados globalmente
        dadosGlobais = dadosFiltrados;
        
        console.log('Dados carregados, total:', dadosFiltrados.length);
        console.log('Primeira descri√ß√£o:', dadosFiltrados[0]?.descricao);
        
        exibirDados(dadosFiltrados);
        
        // Buscar dados completos com pagina√ß√£o
        let todosOsDadosCompletos = [];
        let inicio = 0;
        const tamanhoPagina = 1000;
        let temMaisDados = true;

        while (temMaisDados) {
          const { data: dataCompleta, error: errorCompleta } = await supabaseClient
            .from('indices')
            .select('*')
            .order('fim_planejado', { ascending: true })
            .range(inicio, inicio + tamanhoPagina - 1);

          if (errorCompleta) {
            console.error('Erro ao carregar dados completos:', errorCompleta);
            break;
          }

          if (dataCompleta && dataCompleta.length > 0) {
            todosOsDadosCompletos = todosOsDadosCompletos.concat(dataCompleta);
            inicio += tamanhoPagina;
            temMaisDados = dataCompleta.length === tamanhoPagina;
          } else {
            temMaisDados = false;
          }
        }

        dadosGlobaisCompletos = todosOsDadosCompletos.length > 0 ? todosOsDadosCompletos : dadosFiltrados;

        gerarGrafico(dadosGlobaisCompletos);
        
        // Popular filtro de descri√ß√µes e de meses
        console.log('Chamando popularFiltroDescricoes...');
        popularFiltroDescricoes(dadosGlobaisCompletos);
        console.log('Chamando popularFiltroMeses...');
        popularFiltroMesesFimPlanejado(dadosFiltrados);
        popularFiltroMeses(dadosFiltrados);
        popularFiltroCodigoMedidas(dadosGlobaisCompletos);
        popularFiltroStatusFimPlanejado(dadosGlobaisCompletos);
        
        gerarGraficoPrazoMedio(dadosFiltrados);
        popularFiltroDescricoesPrazo(dadosFiltrados);
        popularFiltroCodigoMedidasPrazo(dadosFiltrados);

        gerarGraficoPrazoMedioExceto(dadosFiltrados);
        popularFiltroDescricoesPrazoExceto(dadosFiltrados);
        popularFiltroCodigoMedidasPrazoExceto(dadosFiltrados);

        gerarGraficoPrazoMedioMiniMicro(dadosFiltrados);
        popularFiltroDescricoesPrazoMiniMicro(dadosFiltrados);
        popularFiltroCodigoMedidasPrazoMiniMicro(dadosFiltrados);

        gerarGraficoMiniGeracao(dadosFiltrados);
        popularFiltroCodigoMedidasMiniGeracao(dadosFiltrados);

        gerarGraficoOutrosTipos(dadosFiltrados);
        popularFiltroCodigoMedidasSemGeracoes(dadosFiltrados);

        gerarGraficoSemGeracoes(dadosFiltrados);
        
        popularFiltroDescricoesNotasPorUsuario(dadosFiltrados);
        popularFiltroMesesNotasPorUsuario(dadosFiltrados);
        popularFiltroCodigoMedidasNotasPorUsuario(dadosFiltrados);
        gerarGraficoNotasPorUsuario(dadosFiltrados);
      }
    };

    window.limparFiltros = function() {
      document.getElementById('filtroNota').value = '';
      document.getElementById('filtroCidade').value = '';
      document.getElementById('filtroStatus').value = '';
      carregarDados();
    };

    // Fun√ß√£o para toggle dropdown de descri√ß√µes
    window.toggleDropdownDescricoes = function() {
      const container = document.getElementById('containerCheckboxesDescricoes');
      const botao = document.getElementById('botaoToggleDescricoes');
      
      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de descri√ß√µes do Prazo M√©dio
    window.toggleDropdownDescricoesPrazo = function() {
      const container = document.getElementById('containerCheckboxesDescricoesPrazo');
      const botao = document.getElementById('botaoToggleDescricoesPrazo');
      
      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de descri√ß√µes do Prazo M√©dio - Exceto Mini/Micro
    window.toggleDropdownDescricoesPrazoExceto = function() {
      const container = document.getElementById('containerCheckboxesDescricoesPrazoExceto');
      const botao = document.getElementById('botaoToggleDescricoesPrazoExceto');
      
      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de descri√ß√µes do Prazo M√©dio - Mini/Micro
    window.toggleDropdownDescricoesPrazoMiniMicro = function() {
      const container = document.getElementById('containerCheckboxesDescricoesPrazoMiniMicro');
      const botao = document.getElementById('botaoToggleDescricoesPrazoMiniMicro');
      
      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de descri√ß√µes do gr√°fico de Notas por Usu√°rio
    window.toggleDropdownDescricoesNotasPorUsuario = function() {
      const container = document.getElementById('containerCheckboxesDescricoesNotasPorUsuario');
      const botao = document.getElementById('botaoToggleDescricoesNotasPorUsuario');
      
      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de C√≥digo Medidas do gr√°fico de Notas por Usu√°rio
    window.toggleDropdownCodigoMedidasNotasPorUsuario = function() {
      const container = document.getElementById('containerCheckboxesCodigoMedidasNotasPorUsuario');
      const botao = document.getElementById('botaoToggleCodigoMedidasNotasPorUsuario');
      
      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de C√≥digo Medidas do gr√°fico de Fim Planejado
    window.toggleDropdownCodigoMedidas = function() {
      const container = document.getElementById('containerCheckboxesCodigoMedidas');
      const botao = document.getElementById('botaoToggleCodigoMedidas');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de Status do gr√°fico de Fim Planejado
    window.toggleDropdownStatusFimPlanejado = function() {
      const container = document.getElementById('containerCheckboxesStatusFimPlanejado');
      const botao = document.getElementById('botaoToggleStatusFimPlanejado');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de C√≥digo Medidas do gr√°fico de Conclu√≠das
    window.toggleDropdownCodigoMedidasConcluidas = function() {
      const container = document.getElementById('containerCheckboxesCodigoMedidasConcluidas');
      const botao = document.getElementById('botaoToggleCodigoMedidasConcluidas');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de C√≥digo Medidas do Prazo M√©dio (CONC)
    window.toggleDropdownCodigoMedidasPrazo = function() {
      const container = document.getElementById('containerCheckboxesCodigoMedidasPrazo');
      const botao = document.getElementById('botaoToggleCodigoMedidasPrazo');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de C√≥digo Medidas do Prazo M√©dio - Exceto Mini/Micro
    window.toggleDropdownCodigoMedidasPrazoExceto = function() {
      const container = document.getElementById('containerCheckboxesCodigoMedidasPrazoExceto');
      const botao = document.getElementById('botaoToggleCodigoMedidasPrazoExceto');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de C√≥digo Medidas do Prazo M√©dio - Mini/Micro
    window.toggleDropdownCodigoMedidasPrazoMiniMicro = function() {
      const container = document.getElementById('containerCheckboxesCodigoMedidasPrazoMiniMicro');
      const botao = document.getElementById('botaoToggleCodigoMedidasPrazoMiniMicro');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de C√≥digo Medidas do gr√°fico Mini Gera√ß√£o
    window.toggleDropdownCodigoMedidasMiniGeracao = function() {
      const container = document.getElementById('containerCheckboxesCodigoMedidasMiniGeracao');
      const botao = document.getElementById('botaoToggleCodigoMedidasMiniGeracao');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para toggle dropdown de C√≥digo Medidas do gr√°fico Sem Mini/Micro Gera√ß√£o
    window.toggleDropdownCodigoMedidasSemGeracoes = function() {
      const container = document.getElementById('containerCheckboxesCodigoMedidasSemGeracoes');
      const botao = document.getElementById('botaoToggleCodigoMedidasSemGeracoes');

      if (container.style.display === 'none') {
        container.style.display = 'flex';
        botao.style.background = '#1b5e20';
        botao.querySelector('span:first-child').textContent = '‚ñ≤';
      } else {
        container.style.display = 'none';
        botao.style.background = '#2e7d32';
        botao.querySelector('span:first-child').textContent = '‚ñº';
      }
    };

    // Fun√ß√£o para popular o filtro de descri√ß√µes do gr√°fico de Fim Planejado com checkboxes
    window.popularFiltroDescricoes = function(dados) {
      console.log('=== INICIANDO popularFiltroDescricoes ===');
      console.log('Total de dados recebidos:', dados?.length || 0);
      
      if (!dados || dados.length === 0) {
        console.warn('Sem dados para popular filtro de descri√ß√µes');
        return;
      }

      const descricoes = new Set();
      
      dados.forEach((item, idx) => {
        const descricao = item.descricao || item.Descri√ß√£o || '';
        if (descricao) {
          descricoes.add(descricao);
        }
      });
      
      console.log('Descri√ß√µes encontradas:', Array.from(descricoes));
      console.log('Total de descri√ß√µes √∫nicas:', descricoes.size);
      
      const container = document.getElementById('containerCheckboxesDescricoes');
      console.log('Container encontrado?', !!container);
      
      if (!container) {
        console.error('‚ùå Container "containerCheckboxesDescricoes" n√£o encontrado!');
        return;
      }
      
      container.innerHTML = ''; // Limpar conte√∫do anterior
      
      // Adicionar checkboxes para cada descri√ß√£o
      const descricoesArray = Array.from(descricoes).sort();
      
      descricoesArray.forEach((desc, index) => {
        const checkboxId = 'checkbox_desc_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = desc;
        checkbox.checked = true; // Come√ßar marcado por padr√£o
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function() {
          console.log('Checkbox alterado:', desc, 'Marcado:', this.checked);
          aplicarFiltroDescricaoFimPlanejado();
        };
        
        const span = document.createElement('span');
        span.textContent = desc;
        span.style.userSelect = 'none';
        
        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
      
      console.log('‚úÖ Checkboxes criados com sucesso! Total:', descricoesArray.length);
    };

    // Fun√ß√£o para aplicar filtro de descri√ß√£o com checkboxes
    window.aplicarFiltroDescricaoFimPlanejado = function() {
      gerarGrafico(dadosGlobais);
    };

    // Fun√ß√£o para popular filtro de C√≥digo Medidas - Fim Planejado
    window.popularFiltroCodigoMedidas = function(dados) {
      // Buscar todos os c√≥digos de medidas existentes no banco
      const codigos = new Set();
      
      dados.forEach(item => {
        const codigo = (item.codigo_medidas || '').trim();
        if (codigo) {
          codigos.add(codigo);
        }
      });
      
      const container = document.getElementById('containerCheckboxesCodigoMedidas');
      if (!container) {
        console.error('‚ùå Container "containerCheckboxesCodigoMedidas" n√£o encontrado!');
        return;
      }

      container.innerHTML = '';
      const codigosArray = Array.from(codigos).sort();

      codigosArray.forEach((codigo, index) => {
        const checkboxId = 'checkbox_codigo_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = codigo;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function() {
          aplicarFiltroCodigoMedidasFimPlanejado();
        };

        const span = document.createElement('span');
        span.textContent = codigo;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    // Fun√ß√£o para popular filtro de Status - Fim Planejado
    window.popularFiltroStatusFimPlanejado = function(dados) {
      const statusSet = new Set();
      dados.forEach(item => {
        const status = (item.status_usuario || item.status || item.Status || item.status_atual || '').trim().toUpperCase();
        let statusBase = status;
        if (statusBase.includes('ABER')) {
          statusBase = 'ABER';
        } else if (statusBase.includes('ANDM')) {
          statusBase = 'ANDM';
        }
        if (statusBase) {
          statusSet.add(statusBase);
        }
      });

      const container = document.getElementById('containerCheckboxesStatusFimPlanejado');
      if (!container) {
        console.error('‚ùå Container "containerCheckboxesStatusFimPlanejado" n√£o encontrado!');
        return;
      }

      container.innerHTML = '';
      const statusArray = Array.from(statusSet).sort();

      statusArray.forEach((status, index) => {
        const checkboxId = 'checkbox_status_fim_planejado_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = status;
        checkbox.checked = status === 'ABER' || status === 'ANDM';
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function() {
          aplicarFiltroStatusFimPlanejado();
        };

        const span = document.createElement('span');
        span.textContent = status;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroStatusFimPlanejado = function() {
      const dadosBase = (dadosGlobaisCompletos && dadosGlobaisCompletos.length > 0) ? dadosGlobaisCompletos : dadosGlobais;
      gerarGrafico(dadosBase);
    };

    window.aplicarFiltroCodigoMedidasFimPlanejado = function() {
      gerarGrafico(dadosGlobais);
    };

    // Fun√ß√£o para popular o filtro de descri√ß√µes do Prazo M√©dio com checkboxes
    window.popularFiltroDescricoesPrazo = function(dados) {
      console.log('=== INICIANDO popularFiltroDescricoesPrazo ===');
      
      const descricoes = new Set();
      
      dados.forEach(item => {
        const descricao = item.descricao || '';
        if (descricao) {
          descricoes.add(descricao);
        }
      });
      
      const container = document.getElementById('containerCheckboxesDescricoesPrazo');
      if (!container) {
        console.error('‚ùå Container "containerCheckboxesDescricoesPrazo" n√£o encontrado!');
        return;
      }
      
      container.innerHTML = ''; // Limpar conte√∫do anterior
      
      const descricoesArray = Array.from(descricoes).sort();
      
      descricoesArray.forEach((desc, index) => {
        const checkboxId = 'checkbox_prazo_desc_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = desc;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function() {
          aplicarFiltroDescricaoPrazo();
        };
        
        const span = document.createElement('span');
        span.textContent = desc;
        span.style.userSelect = 'none';
        
        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
      
      console.log('‚úÖ Checkboxes do Prazo M√©dio criados com sucesso!');
    };

    // Fun√ß√£o para aplicar filtro de descri√ß√£o ao Prazo M√©dio
    window.aplicarFiltroDescricaoPrazo = function() {
      gerarGraficoPrazoMedio(dadosGlobais);
    };

    // Fun√ß√£o para popular filtro de C√≥digo Medidas - Prazo M√©dio (CONC)
    window.popularFiltroCodigoMedidasPrazo = function(dados) {
      const codigos = new Set();
      dados.forEach(item => {
        const status = item.status_usuario || '';
        const codigo = item.codigo_medidas || '';
        if ((status === 'CONC CTEC' || status === 'CONC RTEC') && codigo && item.inicio_planejado && item.concluida_em) {
          codigos.add(codigo);
        }
      });

      const container = document.getElementById('containerCheckboxesCodigoMedidasPrazo');
      if (!container) return;

      container.innerHTML = '';
      const codigosArray = Array.from(codigos).sort();

      codigosArray.forEach((codigo, index) => {
        const checkboxId = 'checkbox_codigo_prazo_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = codigo;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function() {
          aplicarFiltroCodigoMedidasPrazo();
        };

        const span = document.createElement('span');
        span.textContent = codigo;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroCodigoMedidasPrazo = function() {
      gerarGraficoPrazoMedio(dadosGlobais);
    };

    // Fun√ß√£o para popular filtro de C√≥digo Medidas - Conclu√≠das
    window.popularFiltroCodigoMedidasConcluidas = function(dados) {
      const codigos = new Set();
      dados.forEach(item => {
        const status = item.status_usuario || '';
        const codigo = item.codigo_medidas || '';
        if ((status === 'CONC CTEC' || status === 'CONC RTEC') && codigo) {
          codigos.add(codigo);
        }
      });

      const container = document.getElementById('containerCheckboxesCodigoMedidasConcluidas');
      if (!container) {
        console.error('‚ùå Container "containerCheckboxesCodigoMedidasConcluidas" n√£o encontrado!');
        return;
      }

      container.innerHTML = '';
      const codigosArray = Array.from(codigos).sort();

      codigosArray.forEach((codigo, index) => {
        const checkboxId = 'checkbox_codigo_concluidas_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = codigo;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function() {
          aplicarFiltroCodigoMedidasConcluidas();
        };

        const span = document.createElement('span');
        span.textContent = codigo;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroCodigoMedidasConcluidas = function() {
      const mesSelecionado = document.getElementById('filtroMesConcluidas')?.value || 'todos';
      gerarGraficoConcluidas(dadosGlobais, mesSelecionado);
    };

    // Fun√ß√£o para popular filtro de descri√ß√µes - Prazo M√©dio Exceto Mini/Micro
    window.popularFiltroDescricoesPrazoExceto = function(dados) {
      const descricoes = new Set();
      dados.forEach(item => {
        const descricao = item.descricao || '';
        if (descricao && !descricao.toLowerCase().includes('mini gera√ß√£o') && !descricao.toLowerCase().includes('micro gera√ß√£o')) {
          descricoes.add(descricao);
        }
      });
      
      const container = document.getElementById('containerCheckboxesDescricoesPrazoExceto');
      container.innerHTML = '';
      const descricoesArray = Array.from(descricoes).sort();
      
      descricoesArray.forEach((desc, index) => {
        const checkboxId = 'checkbox_prazo_exceto_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = desc;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = aplicarFiltroDescricaoPrazoExceto;
        
        const span = document.createElement('span');
        span.textContent = desc;
        span.style.userSelect = 'none';
        
        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroDescricaoPrazoExceto = function() {
      gerarGraficoPrazoMedioExceto(dadosGlobais);
    };

    // Fun√ß√£o para popular filtro de descri√ß√µes - Prazo M√©dio Mini/Micro Gera√ß√£o
    window.popularFiltroDescricoesPrazoMiniMicro = function(dados) {
      const descricoes = new Set();
      dados.forEach(item => {
        const descricao = item.descricao || '';
        if (descricao && (descricao.toLowerCase().includes('mini gera√ß√£o') || descricao.toLowerCase().includes('micro gera√ß√£o'))) {
          descricoes.add(descricao);
        }
      });
      
      const container = document.getElementById('containerCheckboxesDescricoesPrazoMiniMicro');
      container.innerHTML = '';
      const descricoesArray = Array.from(descricoes).sort();
      
      descricoesArray.forEach((desc, index) => {
        const checkboxId = 'checkbox_prazo_minimicro_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = desc;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = aplicarFiltroDescricaoPrazoMiniMicro;
        
        const span = document.createElement('span');
        span.textContent = desc;
        span.style.userSelect = 'none';
        
        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroDescricaoPrazoMiniMicro = function() {
      gerarGraficoPrazoMedioMiniMicro(dadosGlobais);
    };

    // Fun√ß√£o para popular o filtro de descri√ß√µes do gr√°fico de Notas por Usu√°rio
    window.popularFiltroDescricoesNotasPorUsuario = function(dados) {
      const descricoes = new Set();
      dados.forEach(item => {
        const descricao = item.descricao || '';
        if (descricao) {
          descricoes.add(descricao);
        }
      });

      const container = document.getElementById('containerCheckboxesDescricoesNotasPorUsuario');
      if (!container) {
        console.error('‚ùå Container "containerCheckboxesDescricoesNotasPorUsuario" n√£o encontrado!');
        return;
      }

      container.innerHTML = '';
      const descricoesArray = Array.from(descricoes).sort();

      descricoesArray.forEach((desc, index) => {
        const checkboxId = 'checkbox_notas_usuario_desc_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = desc;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function() {
          aplicarFiltroDescricaoNotasPorUsuario();
        };

        const span = document.createElement('span');
        span.textContent = desc;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroDescricaoNotasPorUsuario = function() {
      gerarGraficoNotasPorUsuario(dadosGlobais);
    };

    // Fun√ß√£o para popular o filtro de meses do gr√°fico de Notas por Usu√°rio (Conclu√≠da em)
    window.popularFiltroMesesNotasPorUsuario = function(dados) {
      const mesesSet = new Set();

      dados.forEach(item => {
        const concluidaEm = item.concluida_em || '';
        const status = item.status_usuario || '';
        if ((status === 'CONC CTEC' || status === 'CONC RTEC') && concluidaEm) {
          const partes = concluidaEm.split('.');
          if (partes.length >= 3) {
            const mesAno = partes[1] + '.' + partes[2];
            mesesSet.add(mesAno);
          }
        }
      });

      const mesesArray = Array.from(mesesSet).sort((a, b) => {
        const [mesA, anoA] = a.split('.');
        const [mesB, anoB] = b.split('.');
        const dataA = new Date(parseInt(anoA), parseInt(mesA) - 1);
        const dataB = new Date(parseInt(anoB), parseInt(mesB) - 1);
        return dataA - dataB;
      });

      const selectMes = document.getElementById('filtroMesNotasPorUsuario');
      if (!selectMes) return;
      selectMes.innerHTML = '<option value="todos">Todos os meses</option>';

      mesesArray.forEach(mesAno => {
        const [mes, ano] = mesAno.split('.');
        const nomeMes = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                         'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][parseInt(mes) - 1];
        const option = document.createElement('option');
        option.value = mesAno;
        option.textContent = `${nomeMes}/${ano}`;
        selectMes.appendChild(option);
      });

      const dataAtual = new Date();
      const mesAtual = String(dataAtual.getMonth() + 1).padStart(2, '0');
      const anoAtual = dataAtual.getFullYear();
      const mesAnoAtual = `${mesAtual}.${anoAtual}`;

      if (mesesArray.includes(mesAnoAtual)) {
        selectMes.value = mesAnoAtual;
      }
    };

    window.aplicarFiltroMesNotasPorUsuario = function() {
      gerarGraficoNotasPorUsuario(dadosGlobais);
    };

    // Fun√ß√£o para popular o filtro de C√≥digo Medidas do gr√°fico de Notas por Usu√°rio
    window.popularFiltroCodigoMedidasNotasPorUsuario = function(dados) {
      const codigos = new Set();
      dados.forEach(item => {
        const codigo = item.codigo_medidas || '';
        if (codigo) {
          codigos.add(codigo);
        }
      });

      const container = document.getElementById('containerCheckboxesCodigoMedidasNotasPorUsuario');
      if (!container) {
        console.error('‚ùå Container "containerCheckboxesCodigoMedidasNotasPorUsuario" n√£o encontrado!');
        return;
      }

      container.innerHTML = '';
      const codigosArray = Array.from(codigos).sort();

      codigosArray.forEach((codigo, index) => {
        const checkboxId = 'checkbox_notas_usuario_codigo_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = codigo;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function() {
          aplicarFiltroCodigoMedidasNotasPorUsuario();
        };

        const span = document.createElement('span');
        span.textContent = codigo;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroCodigoMedidasNotasPorUsuario = function() {
      gerarGraficoNotasPorUsuario(dadosGlobais);
    };

    // Fun√ß√£o para popular filtro de C√≥digo Medidas - Prazo M√©dio Exceto Mini/Micro
    window.popularFiltroCodigoMedidasPrazoExceto = function(dados) {
      const codigos = new Set();
      dados.forEach(item => {
        const status = item.status_usuario || '';
        const codigo = item.codigo_medidas || '';
        const descricao = (item.descricao || '').toLowerCase();
        if ((status === 'CONC CTEC' || status === 'CONC RTEC') && codigo && item.inicio_planejado && item.concluida_em &&
            !descricao.includes('mini gera√ß√£o') && !descricao.includes('micro gera√ß√£o')) {
          codigos.add(codigo);
        }
      });

      const container = document.getElementById('containerCheckboxesCodigoMedidasPrazoExceto');
      if (!container) return;

      container.innerHTML = '';
      const codigosArray = Array.from(codigos).sort();

      codigosArray.forEach((codigo, index) => {
        const checkboxId = 'checkbox_codigo_prazo_exceto_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = codigo;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function() {
          aplicarFiltroCodigoMedidasPrazoExceto();
        };

        const span = document.createElement('span');
        span.textContent = codigo;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroCodigoMedidasPrazoExceto = function() {
      gerarGraficoPrazoMedioExceto(dadosGlobais);
    };

    // Fun√ß√£o para popular filtro de C√≥digo Medidas - Prazo M√©dio Mini/Micro
    window.popularFiltroCodigoMedidasPrazoMiniMicro = function(dados) {
      const codigos = new Set();
      dados.forEach(item => {
        const status = item.status_usuario || '';
        const codigo = item.codigo_medidas || '';
        const descricao = (item.descricao || '').toLowerCase();
        if ((status === 'CONC CTEC' || status === 'CONC RTEC') && codigo && item.inicio_planejado && item.concluida_em &&
            (descricao.includes('mini gera√ß√£o') || descricao.includes('micro gera√ß√£o'))) {
          codigos.add(codigo);
        }
      });

      const container = document.getElementById('containerCheckboxesCodigoMedidasPrazoMiniMicro');
      if (!container) return;

      container.innerHTML = '';
      const codigosArray = Array.from(codigos).sort();

      codigosArray.forEach((codigo, index) => {
        const checkboxId = 'checkbox_codigo_prazo_minimicro_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = codigo;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function() {
          aplicarFiltroCodigoMedidasPrazoMiniMicro();
        };

        const span = document.createElement('span');
        span.textContent = codigo;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroCodigoMedidasPrazoMiniMicro = function() {
      gerarGraficoPrazoMedioMiniMicro(dadosGlobais);
    };

    // Fun√ß√£o para popular filtro de C√≥digo Medidas - Mini Gera√ß√£o
    window.popularFiltroCodigoMedidasMiniGeracao = function(dados) {
      const codigos = new Set();
      dados.forEach(item => {
        const codigo = item.codigo_medidas || '';
        const descricao = (item.descricao || '').toLowerCase();
        if (codigo && descricao.includes('analisar carga acessante mini gera√ß√£o')) {
          codigos.add(codigo);
        }
      });

      const container = document.getElementById('containerCheckboxesCodigoMedidasMiniGeracao');
      if (!container) return;

      container.innerHTML = '';
      const codigosArray = Array.from(codigos).sort();

      codigosArray.forEach((codigo, index) => {
        const checkboxId = 'checkbox_codigo_minigeracao_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = codigo;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function() {
          aplicarFiltroCodigoMedidasMiniGeracao();
        };

        const span = document.createElement('span');
        span.textContent = codigo;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroCodigoMedidasMiniGeracao = function() {
      gerarGraficoMiniGeracao(dadosGlobais);
    };

    // Fun√ß√£o para popular filtro de C√≥digo Medidas - Sem Gera√ß√µes
    window.popularFiltroCodigoMedidasSemGeracoes = function(dados) {
      const codigos = new Set();
      dados.forEach(item => {
        const codigo = item.codigo_medidas || '';
        const descricao = (item.descricao || '').toLowerCase();
        if (codigo && !descricao.includes('mini gera√ß√£o') && !descricao.includes('micro gera√ß√£o')) {
          codigos.add(codigo);
        }
      });

      const container = document.getElementById('containerCheckboxesCodigoMedidasSemGeracoes');
      if (!container) return;

      container.innerHTML = '';
      const codigosArray = Array.from(codigos).sort();

      codigosArray.forEach((codigo, index) => {
        const checkboxId = 'checkbox_codigo_semgeracoes_' + index;
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.cursor = 'pointer';
        label.style.fontSize = '14px';
        label.style.color = '#333';
        label.style.padding = '6px 0';
        label.style.width = '100%';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = checkboxId;
        checkbox.value = codigo;
        checkbox.checked = true;
        checkbox.style.cursor = 'pointer';
        checkbox.style.accentColor = '#2e7d32';
        checkbox.style.width = '16px';
        checkbox.style.height = '16px';
        checkbox.onchange = function() {
          aplicarFiltroCodigoMedidasSemGeracoes();
        };

        const span = document.createElement('span');
        span.textContent = codigo;
        span.style.userSelect = 'none';

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    };

    window.aplicarFiltroCodigoMedidasSemGeracoes = function() {
      gerarGraficoOutrosTipos(dadosGlobais);
    };

    // Vari√°vel global para armazenar dados
    let dadosGlobais = [];
    let dadosGlobaisCompletos = [];

    // Fun√ß√£o para popular o filtro de meses
    window.popularFiltroMeses = function(dados) {
      const mesesSet = new Set();
      
      dados.forEach(item => {
        const concluidaEm = item.concluida_em || '';
        const status = item.status_usuario || '';
        
        if ((status === 'CONC CTEC' || status === 'CONC RTEC') && concluidaEm) {
          const partes = concluidaEm.split('.');
          if (partes.length >= 3) {
            const mesAno = partes[1] + '.' + partes[2]; // MM.YYYY
            mesesSet.add(mesAno);
          }
        }
      });
      
      const mesesArray = Array.from(mesesSet).sort((a, b) => {
        const [mesA, anoA] = a.split('.');
        const [mesB, anoB] = b.split('.');
        const dataA = new Date(parseInt(anoA), parseInt(mesA) - 1);
        const dataB = new Date(parseInt(anoB), parseInt(mesB) - 1);
        return dataA - dataB;
      });
      
      const selectMes = document.getElementById('filtroMesConcluidas');
      // Manter a op√ß√£o "Todos os meses"
      selectMes.innerHTML = '<option value="todos">Todos os meses</option>';
      
      // Adicionar op√ß√µes de meses
      mesesArray.forEach(mesAno => {
        const [mes, ano] = mesAno.split('.');
        const nomeMes = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                         'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][parseInt(mes) - 1];
        const option = document.createElement('option');
        option.value = mesAno;
        option.textContent = `${nomeMes}/${ano}`;
        selectMes.appendChild(option);
      });

      // Selecionar m√™s atual por padr√£o, se existir
      const dataAtual = new Date();
      const mesAtual = String(dataAtual.getMonth() + 1).padStart(2, '0');
      const anoAtual = dataAtual.getFullYear();
      const mesAnoAtual = `${mesAtual}.${anoAtual}`;

      if (mesesArray.includes(mesAnoAtual) && selectMes.value === 'todos') {
        selectMes.value = mesAnoAtual;
        gerarGraficoConcluidas(dados, mesAnoAtual);
      }
    };

    // Fun√ß√£o para popular o filtro de meses do gr√°fico ABER/ANDM (fim_planejado)
    window.popularFiltroMesesFimPlanejado = function(dados) {
      const mesesSet = new Set();

      dados.forEach(item => {
        const fimPlanejado = item.fim_planejado || '';
        if (fimPlanejado) {
          const partes = fimPlanejado.split('.');
          if (partes.length >= 3) {
            const mesAno = partes[1] + '.' + partes[2]; // MM.YYYY
            mesesSet.add(mesAno);
          }
        }
      });

      const mesesArray = Array.from(mesesSet).sort((a, b) => {
        const [mesA, anoA] = a.split('.');
        const [mesB, anoB] = b.split('.');
        const dataA = new Date(parseInt(anoA), parseInt(mesA) - 1);
        const dataB = new Date(parseInt(anoB), parseInt(mesB) - 1);
        return dataA - dataB;
      });

      const selectMes = document.getElementById('filtroMesFimPlanejado');
      if (!selectMes) {
        return;
      }

      const valorAtual = selectMes.value || 'todos';
      selectMes.innerHTML = '<option value="todos">Todos os meses</option>';

      mesesArray.forEach(mesAno => {
        const [mes, ano] = mesAno.split('.');
        const nomeMes = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                         'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][parseInt(mes) - 1];
        const option = document.createElement('option');
        option.value = mesAno;
        option.textContent = `${nomeMes}/${ano}`;
        selectMes.appendChild(option);
      });

      if (mesesArray.includes(valorAtual)) {
        selectMes.value = valorAtual;
      }
    };

    window.filtrarGraficoFimPlanejadoPorMes = function() {
      const mesSelecionado = document.getElementById('filtroMesFimPlanejado')?.value || 'todos';
      const dadosBase = (dadosGlobaisCompletos && dadosGlobaisCompletos.length > 0) ? dadosGlobaisCompletos : dadosGlobais;
      gerarGrafico(dadosBase, mesSelecionado);
    };

    // Fun√ß√£o para filtrar gr√°fico de conclu√≠das por m√™s
    window.filtrarGraficoConcluidasPorMes = function() {
      const mesSelecionado = document.getElementById('filtroMesConcluidas').value;
      gerarGraficoConcluidas(dadosGlobais, mesSelecionado);
    };

    // Vari√°vel global para os gr√°ficos
    let chartInstance = null;
    let chartConcluidasInstance = null;
    let chartPrazoMedioInstance = null;
    let chartPrazoMedioExcetoInstance = null;
    let chartPrazoMedioMiniMicroInstance = null;
    let chartMiniGeracaoInstance = null;
    let chartOutrosTiposInstance = null;
    let chartSemGeracoesInstance = null;
    let chartNotasPorUsuarioInstance = null;

    // Fun√ß√£o para gerar gr√°fico de barras
    window.gerarGrafico = function(dados, mesFiltro = null) {
      if (!dados || dados.length === 0) {
        return;
      }

      const mesSelecionado = mesFiltro ?? (document.getElementById('filtroMesFimPlanejado')?.value || 'todos');

      const normalizarStatusBase = function(status) {
        const statusNormalizado = (status || '').trim().toUpperCase();
        if (statusNormalizado.includes('ABER')) return 'ABER';
        if (statusNormalizado.includes('ANDM')) return 'ANDM';
        return statusNormalizado;
      };

      // Obter descri√ß√µes selecionadas nos checkboxes
      const checkboxes = document.querySelectorAll('#containerCheckboxesDescricoes input[type="checkbox"]');
      const descricoesChecadas = new Set();
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          descricoesChecadas.add((checkbox.value || '').trim());
        }
      });
      const todasDescricoesMarcadas = checkboxes.length > 0 && Array.from(checkboxes).every(checkbox => checkbox.checked);

      // Obter c√≥digos medidas selecionados nos checkboxes
      const checkboxesCodigo = document.querySelectorAll('#containerCheckboxesCodigoMedidas input[type="checkbox"]');
      const codigosChecados = new Set();
      checkboxesCodigo.forEach(checkbox => {
        if (checkbox.checked) {
          codigosChecados.add((checkbox.value || '').trim());
        }
      });
      const todosCodigosMarcados = checkboxesCodigo.length > 0 && Array.from(checkboxesCodigo).every(checkbox => checkbox.checked);

      // Obter status selecionados nos checkboxes
      const checkboxesStatus = document.querySelectorAll('#containerCheckboxesStatusFimPlanejado input[type="checkbox"]');
      const statusChecados = new Set();
      checkboxesStatus.forEach(checkbox => {
        if (checkbox.checked) {
          statusChecados.add((checkbox.value || '').trim().toUpperCase());
        }
      });
      const todosStatusMarcados = checkboxesStatus.length > 0 && Array.from(checkboxesStatus).every(checkbox => checkbox.checked);
      const nenhumStatusMarcado = checkboxesStatus.length > 0 && Array.from(checkboxesStatus).every(checkbox => !checkbox.checked);

      // Debug: verificar quantos registros de cada status existem
      const contagemStatus = {};
      dados.forEach(item => {
        const status = (item.status_usuario || item.status || item.Status || item.status_atual || '').trim().toUpperCase();
        const statusBase = normalizarStatusBase(status);
        contagemStatus[statusBase] = (contagemStatus[statusBase] || 0) + 1;
      });
      console.log('Contagem por status no total de dados:', contagemStatus);
      console.log('Status ABER marcado?', statusChecados.has('ABER'));
      console.log('Status ANDM marcado?', statusChecados.has('ANDM'));
      console.log('Nenhum status marcado?', nenhumStatusMarcado);
      console.log('Todos status marcados?', todosStatusMarcados);

      // Filtrar por status selecionado e aplicar filtros de descri√ß√£o/c√≥digo
      let rejeitadosPorStatus = 0;
      let rejeitadosPorDescricao = 0;
      let rejeitadosPorCodigo = 0;
      
      const dadosFiltrados = dados.filter(item => {
        const status = (item.status_usuario || item.status || item.Status || item.status_atual || '').trim().toUpperCase();
        const statusBase = normalizarStatusBase(status);
        const descricao = (item.descricao || '').trim();
        const codigoMedidas = (item.codigo_medidas || '').trim();
        const fimPlanejado = (item.fim_planejado || '').trim();

        let mesOk = true;
        if (mesSelecionado && mesSelecionado !== 'todos') {
          const partes = fimPlanejado.split('.');
          if (partes.length >= 3) {
            const mesAno = partes[1] + '.' + partes[2];
            mesOk = mesAno === mesSelecionado;
          } else {
            mesOk = false;
          }
        }
        
        const statusOk = nenhumStatusMarcado
          ? (statusBase === 'ABER' || statusBase === 'ANDM')
          : (todosStatusMarcados || statusChecados.size === 0)
            ? !!statusBase
            : statusChecados.has(statusBase);
        const descricaoOk = todasDescricoesMarcadas || descricoesChecadas.size === 0 || descricoesChecadas.has(descricao);
        const codigoOk = todosCodigosMarcados || codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);
        
        if (!statusOk) rejeitadosPorStatus++;
        if (!descricaoOk) rejeitadosPorDescricao++;
        if (!codigoOk) rejeitadosPorCodigo++;
        
        return statusOk && descricaoOk && codigoOk && mesOk;
      });
      
      console.log('===== AN√ÅLISE DE FILTROS =====');
      console.log('Total de dados recebidos:', dados.length);
      console.log('Total de dados filtrados:', dadosFiltrados.length);
      console.log('Rejeitados por Status:', rejeitadosPorStatus);
      console.log('Rejeitados por Descri√ß√£o:', rejeitadosPorDescricao);
      console.log('Rejeitados por C√≥digo Medidas:', rejeitadosPorCodigo);
      console.log('Descri√ß√µes marcadas:', descricoesChecadas.size, 'Todas marcadas?', todasDescricoesMarcadas);
      console.log('C√≥digos marcados:', codigosChecados.size, 'Todos marcados?', todosCodigosMarcados);
      console.log('Primeiras 5 datas fim_planejado:', dadosFiltrados.slice(0, 5).map(d => d.fim_planejado));
      console.log('√öltimas 5 datas fim_planejado:', dadosFiltrados.slice(-5).map(d => d.fim_planejado));

      // Agrupar dados por fim_planejado e status
      const agrupamentoPorData = {};
      const totaisPorStatus = {};
      const statusPresentes = new Set();
      
      dadosFiltrados.forEach(item => {
        const fimPlanejado = item.fim_planejado || 'Sem data';
        const status = (item.status_usuario || item.status || item.Status || item.status_atual || '').trim().toUpperCase();
        const statusBase = normalizarStatusBase(status);
        if (!statusBase) {
          return;
        }
        statusPresentes.add(statusBase);
        
        if (!agrupamentoPorData[fimPlanejado]) {
          agrupamentoPorData[fimPlanejado] = {};
        }

        if (!agrupamentoPorData[fimPlanejado][statusBase]) {
          agrupamentoPorData[fimPlanejado][statusBase] = 0;
        }
        agrupamentoPorData[fimPlanejado][statusBase]++;

        if (!totaisPorStatus[statusBase]) {
          totaisPorStatus[statusBase] = 0;
        }
        totaisPorStatus[statusBase]++;
      });

      // Atualizar contadores na interface
      document.getElementById('totalGeralNotas').textContent = dadosFiltrados.length;
      document.getElementById('totalANDM').textContent = totaisPorStatus.ANDM || 0;
      document.getElementById('totalABER').textContent = totaisPorStatus.ABER || 0;

      // Converter para arrays e ordenar por data
      const labels = Object.keys(agrupamentoPorData).sort((a, b) => {
        if (a === 'Sem data') return 1;
        if (b === 'Sem data') return -1;
        return new Date(a.split('.').reverse().join('-')) - new Date(b.split('.').reverse().join('-'));
      });
      
      console.log('Total de labels (datas √∫nicas):', labels.length);
      console.log('Todas as labels:', labels);

      // Preparar dados para cada status selecionado
      const statusOrdenados = Array.from(statusPresentes).sort();
      const palette = [
        { bg: 'rgba(46, 125, 50, 0.7)', border: 'rgba(46, 125, 50, 1)' },
        { bg: 'rgba(102, 187, 106, 0.7)', border: 'rgba(102, 187, 106, 1)' },
        { bg: 'rgba(25, 118, 210, 0.7)', border: 'rgba(25, 118, 210, 1)' },
        { bg: 'rgba(255, 167, 38, 0.7)', border: 'rgba(255, 167, 38, 1)' },
        { bg: 'rgba(171, 71, 188, 0.7)', border: 'rgba(171, 71, 188, 1)' },
        { bg: 'rgba(239, 83, 80, 0.7)', border: 'rgba(239, 83, 80, 1)' }
      ];

      const datasets = statusOrdenados.map((status, index) => {
        const colors = palette[index % palette.length];
        return {
          label: status,
          data: labels.map(label => (agrupamentoPorData[label] && agrupamentoPorData[label][status]) ? agrupamentoPorData[label][status] : 0),
          backgroundColor: colors.bg,
          borderColor: colors.border,
          borderWidth: 2,
          borderRadius: 8,
          hoverBackgroundColor: colors.bg,
          hoverBorderColor: colors.border,
          datalabels: {
            color: '#fff',
            font: {
              weight: 'bold',
              size: 12
            },
            formatter: function(value) {
              return value > 0 ? value : '';
            }
          }
        };
      });

      // Destruir gr√°fico anterior se existir
      if (chartInstance) {
        chartInstance.destroy();
      }

      // Criar novo gr√°fico com m√∫ltiplos datasets
      const ctx = document.getElementById('chartFimPlanejado').getContext('2d');
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          onClick: (event, activeElements) => {
            if (activeElements.length > 0) {
              const datasetIndex = activeElements[0].datasetIndex;
              const index = activeElements[0].index;
              const dataLabel = labels[index];
              const statusLabel = statusOrdenados[datasetIndex];
              
              // Filtrar notas correspondentes √† barra clicada
              const notasFiltradas = dadosFiltrados.filter(item => {
                const fimPlanejado = item.fim_planejado || 'Sem data';
                const status = (item.status_usuario || item.status || item.Status || item.status_atual || '').trim().toUpperCase();
                const statusBase = normalizarStatusBase(status);
                return fimPlanejado === dataLabel && statusBase === statusLabel;
              });
              
              abrirModalNotas(notasFiltradas, dataLabel, statusLabel);
            }
          },
          plugins: {
            datalabels: {
              display: true,
              align: 'center',
              anchor: 'center'
            },
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(46, 125, 50, 0.9)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.parsed.y;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: 'Roboto'
                },
                color: '#666',
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'Fim Planejado',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Quantidade',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Fun√ß√£o para gerar gr√°fico de Notas Conclu√≠das (CONC CTEC e CONC RTEC)
    window.gerarGraficoConcluidas = function(dados, mesFiltro = null) {
      if (!dados || dados.length === 0) {
        return;
      }

      // Obter c√≥digos medidas selecionados nos checkboxes
      const checkboxesCodigo = document.querySelectorAll('#containerCheckboxesCodigoMedidasConcluidas input[type="checkbox"]');
      const codigosChecados = new Set();
      checkboxesCodigo.forEach(checkbox => {
        if (checkbox.checked) {
          codigosChecados.add(checkbox.value);
        }
      });

      // Filtrar dados por m√™s se especificado
      let dadosFiltrados = dados;
      if (mesFiltro && mesFiltro !== 'todos') {
        dadosFiltrados = dados.filter(item => {
          const concluidaEm = item.concluida_em || '';
          if (!concluidaEm) return false;
          // Extrair m√™s/ano no formato MM.YYYY
          const partes = concluidaEm.split('.');
          if (partes.length >= 2) {
            const mesAno = partes[1] + '.' + partes[2]; // MM.YYYY
            return mesAno === mesFiltro;
          }
          return false;
        });
      }

      // Agrupar dados por concluida_em e status_usuario
      const agrupamentoPorData = {};
      let totalCONC_CTEC = 0;
      let totalCONC_RTEC = 0;
      
      dadosFiltrados.forEach(item => {
        const concluidaEm = item.concluida_em || 'Sem data';
        const status = item.status_usuario || '';
        const codigoMedidas = item.codigo_medidas || '';
        const codigoOk = codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);
        
        if ((status === 'CONC CTEC' || status === 'CONC RTEC') && codigoOk) {
          if (!agrupamentoPorData[concluidaEm]) {
            agrupamentoPorData[concluidaEm] = { CONC_CTEC: 0, CONC_RTEC: 0 };
          }
          
          if (status === 'CONC CTEC') {
            agrupamentoPorData[concluidaEm].CONC_CTEC++;
            totalCONC_CTEC++;
          } else if (status === 'CONC RTEC') {
            agrupamentoPorData[concluidaEm].CONC_RTEC++;
            totalCONC_RTEC++;
          }
        }
      });

      // Atualizar contadores na interface
      const totalConcluidas = totalCONC_CTEC + totalCONC_RTEC;
      const percentualAprovacao = totalConcluidas > 0 ? ((totalCONC_CTEC / totalConcluidas) * 100).toFixed(1) : 0;
      
      document.getElementById('totalConcluidas').textContent = totalConcluidas;
      document.getElementById('totalCONC_CTEC').textContent = totalCONC_CTEC;
      document.getElementById('totalCONC_RTEC').textContent = totalCONC_RTEC;
      document.getElementById('percentualAprovacao').textContent = percentualAprovacao + '%';

      if (totalConcluidas === 0) {
        // Limpar gr√°fico se n√£o houver dados
        if (chartConcluidasInstance) {
          chartConcluidasInstance.destroy();
          chartConcluidasInstance = null;
        }
        return;
      }

      // Converter para arrays e ordenar por data
      const labels = Object.keys(agrupamentoPorData).sort((a, b) => {
        if (a === 'Sem data') return 1;
        if (b === 'Sem data') return -1;
        return new Date(a.split('.').reverse().join('-')) - new Date(b.split('.').reverse().join('-'));
      });

      // Preparar dados para cada status
      const valoresCONC_CTEC = labels.map(label => agrupamentoPorData[label].CONC_CTEC);
      const valoresCONC_RTEC = labels.map(label => agrupamentoPorData[label].CONC_RTEC);

      // Destruir gr√°fico anterior se existir
      if (chartConcluidasInstance) {
        chartConcluidasInstance.destroy();
      }

      // Criar novo gr√°fico com m√∫ltiplos datasets
      const ctx = document.getElementById('chartConcluidas').getContext('2d');
      chartConcluidasInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'CONC CTEC',
              data: valoresCONC_CTEC,
              backgroundColor: 'rgba(56, 142, 60, 0.7)',
              borderColor: 'rgba(56, 142, 60, 1)',
              borderWidth: 2,
              borderRadius: 8,
              hoverBackgroundColor: 'rgba(67, 160, 71, 0.8)',
              hoverBorderColor: 'rgba(67, 160, 71, 1)',
              datalabels: {
                color: '#fff',
                font: {
                  weight: 'bold',
                  size: 12
                },
                formatter: function(value) {
                  return value > 0 ? value : '';
                }
              }
            },
            {
              label: 'CONC RTEC',
              data: valoresCONC_RTEC,
              backgroundColor: 'rgba(129, 199, 132, 0.7)',
              borderColor: 'rgba(129, 199, 132, 1)',
              borderWidth: 2,
              borderRadius: 8,
              hoverBackgroundColor: 'rgba(165, 214, 167, 0.8)',
              hoverBorderColor: 'rgba(165, 214, 167, 1)',
              datalabels: {
                color: '#fff',
                font: {
                  weight: 'bold',
                  size: 12
                },
                formatter: function(value) {
                  return value > 0 ? value : '';
                }
              }
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          onClick: (event, activeElements) => {
            if (activeElements.length > 0) {
              const datasetIndex = activeElements[0].datasetIndex;
              const index = activeElements[0].index;
              const dataLabel = labels[index];
              const statusLabel = datasetIndex === 0 ? 'CONC CTEC' : 'CONC RTEC';
              
              // Filtrar notas correspondentes √† barra clicada
              const notasFiltradas = dadosFiltrados.filter(item => {
                const concluidaEm = item.concluida_em || 'Sem data';
                const status = item.status_usuario || '';
                const codigoMedidas = item.codigo_medidas || '';
                const codigoOk = codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);
                return concluidaEm === dataLabel && status === statusLabel && codigoOk;
              });
              
              abrirModalNotas(notasFiltradas, dataLabel, statusLabel);
            }
          },
          plugins: {
            datalabels: {
              display: true,
              align: 'center',
              anchor: 'center'
            },
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(46, 125, 50, 0.9)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.parsed.y;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: 'Roboto'
                },
                color: '#666',
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'Data de Conclus√£o',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Quantidade',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Fun√ß√£o para gerar gr√°fico de Prazo M√©dio Mensal
    window.gerarGraficoPrazoMedio = function(dados) {
      if (!dados || dados.length === 0) {
        return;
      }

      // Obter descri√ß√µes selecionadas nos checkboxes
      const checkboxes = document.querySelectorAll('#containerCheckboxesDescricoesPrazo input[type="checkbox"]');
      const descricoesChecadas = new Set();
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          descricoesChecadas.add(checkbox.value);
        }
      });

      // Obter c√≥digos medidas selecionados nos checkboxes
      const checkboxesCodigo = document.querySelectorAll('#containerCheckboxesCodigoMedidasPrazo input[type="checkbox"]');
      const codigosChecados = new Set();
      checkboxesCodigo.forEach(checkbox => {
        if (checkbox.checked) {
          codigosChecados.add(checkbox.value);
        }
      });

      // Filtrar apenas notas conclu√≠das (CONC CTEC ou CONC RTEC) com datas v√°lidas e descri√ß√£o selecionada
      const notasConcluidas = dados.filter(item => {
        const status = item.status_usuario || '';
        const descricao = item.descricao || '';
        const codigoMedidas = item.codigo_medidas || '';
        const textoMedidas = (item.texto_medidas || '').toUpperCase();
        
        // Verificar se o texto de medidas cont√©m "SEM ANEXO" ou varia√ß√µes
        const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') || 
                          textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
                          textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));
        
        const statusOk = (status === 'CONC CTEC' || status === 'CONC RTEC') && 
               item.inicio_planejado &&
               item.concluida_em;
        const descricaoOk = descricoesChecadas.size === 0 || descricoesChecadas.has(descricao);
        const codigoOk = codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);
        return statusOk && descricaoOk && codigoOk && temAnexo;
      });

      if (notasConcluidas.length === 0) {
        document.getElementById('totalNotasAnalisadas').textContent = '0';
        document.getElementById('prazoMedioGeral').textContent = '0';
        if (chartPrazoMedioInstance) {
          chartPrazoMedioInstance.destroy();
          chartPrazoMedioInstance = null;
        }
        return;
      }

      // Fun√ß√£o para converter data DD.MM.YYYY para objeto Date
      function parseData(dataStr) {
        if (!dataStr) return null;
        const partes = dataStr.split('.');
        if (partes.length !== 3) return null;
        // Date(ano, m√™s-1, dia)
        return new Date(partes[2], partes[1] - 1, partes[0]);
      }

      // Calcular diferen√ßas e agrupar por m√™s/ano
      const prazosPorMes = {};
      let somaTotalDias = 0;
      let totalNotasValidas = 0;

      notasConcluidas.forEach(item => {
        const inicioPlanejado = parseData(item.inicio_planejado);
        const concluida = parseData(item.concluida_em);
        
        if (inicioPlanejado && concluida) {
          // Calcular diferen√ßa em dias (data de conclus√£o - in√≠cio planejado)
          const diferencaDias = Math.round((concluida - inicioPlanejado) / (1000 * 60 * 60 * 24));
          
          // Agrupar por m√™s/ano (baseado na data de conclus√£o)
          const mesAno = `${String(concluida.getMonth() + 1).padStart(2, '0')}.${concluida.getFullYear()}`;
          
          if (!prazosPorMes[mesAno]) {
            prazosPorMes[mesAno] = { soma: 0, count: 0 };
          }
          
          prazosPorMes[mesAno].soma += diferencaDias;
          prazosPorMes[mesAno].count++;
          
          somaTotalDias += diferencaDias;
          totalNotasValidas++;
        }
      });

      // Calcular m√©dias mensais
      const mesesOrdenados = Object.keys(prazosPorMes).sort((a, b) => {
        const [mesA, anoA] = a.split('.').map(Number);
        const [mesB, anoB] = b.split('.').map(Number);
        return (anoA * 12 + mesA) - (anoB * 12 + mesB);
      });

      const labels = mesesOrdenados;
      const medias = mesesOrdenados.map(mes => {
        const media = prazosPorMes[mes].soma / prazosPorMes[mes].count;
        return Math.round(media * 10) / 10; // Arredondar para 1 casa decimal
      });

      // Atualizar contadores
      const prazoMedioGeral = totalNotasValidas > 0 ? Math.round((somaTotalDias / totalNotasValidas) * 10) / 10 : 0;
      document.getElementById('totalNotasAnalisadas').textContent = totalNotasValidas;
      document.getElementById('prazoMedioGeral').textContent = prazoMedioGeral;

      // Destruir gr√°fico anterior se existir
      if (chartPrazoMedioInstance) {
        chartPrazoMedioInstance.destroy();
      }

      // Criar novo gr√°fico
      const ctx = document.getElementById('chartPrazoMedio').getContext('2d');
      chartPrazoMedioInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Prazo M√©dio (dias)',
            data: medias,
            backgroundColor: 'rgba(255, 152, 0, 0.2)',
            borderColor: 'rgba(255, 152, 0, 1)',
            borderWidth: 3,
            pointBackgroundColor: 'rgba(255, 152, 0, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8,
            tension: 0.3,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            datalabels: {
              display: false
            },
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(255, 152, 0, 0.9)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function(context) {
                  return 'Prazo m√©dio: ' + context.parsed.y + ' dias';
                },
                afterLabel: function(context) {
                  const mes = labels[context.dataIndex];
                  const info = prazosPorMes[mes];
                  return 'Notas: ' + info.count;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'M√™s/Ano',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666',
                callback: function(value) {
                  return value + ' dias';
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Prazo M√©dio (dias)',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Gr√°fico Prazo M√©dio (Exceto Mini/Micro Gera√ß√£o)
    window.gerarGraficoPrazoMedioExceto = function(dados) {
      if (!dados || dados.length === 0) {
        return;
      }

      // Obter descri√ß√µes selecionadas nos checkboxes
      const checkboxes = document.querySelectorAll('#containerCheckboxesDescricoesPrazoExceto input[type="checkbox"]');
      const descricoesChecadas = new Set();
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          descricoesChecadas.add(checkbox.value);
        }
      });

      // Obter c√≥digos medidas selecionados nos checkboxes
      const checkboxesCodigo = document.querySelectorAll('#containerCheckboxesCodigoMedidasPrazoExceto input[type="checkbox"]');
      const codigosChecados = new Set();
      checkboxesCodigo.forEach(checkbox => {
        if (checkbox.checked) {
          codigosChecados.add(checkbox.value);
        }
      });

      // Filtrar apenas notas conclu√≠das (CONC CTEC ou CONC RTEC) que N√ÉO sejam mini/micro gera√ß√£o
      const notasConcluidas = dados.filter(item => {
        const status = item.status_usuario || '';
        const descricao = item.descricao || '';
        const codigoMedidas = item.codigo_medidas || '';
        const textoMedidas = (item.texto_medidas || '').toUpperCase();
        
        // Verificar se o texto de medidas cont√©m "SEM ANEXO" ou varia√ß√µes
        const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') || 
                          textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
                          textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));
        
        const statusOk = (status === 'CONC CTEC' || status === 'CONC RTEC') && 
               item.inicio_planejado &&
               item.concluida_em;
        // Excluir mini e micro gera√ß√£o
        const naoEMiniMicro = !descricao.toLowerCase().includes('mini gera√ß√£o') && 
                              !descricao.toLowerCase().includes('micro gera√ß√£o');
        const descricaoOk = descricoesChecadas.size === 0 || descricoesChecadas.has(descricao);
        const codigoOk = codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);
        return statusOk && naoEMiniMicro && descricaoOk && codigoOk && temAnexo;
      });

      if (notasConcluidas.length === 0) {
        document.getElementById('totalNotasAnalisadasExceto').textContent = '0';
        document.getElementById('prazoMedioGeralExceto').textContent = '0';
        if (chartPrazoMedioExcetoInstance) {
          chartPrazoMedioExcetoInstance.destroy();
          chartPrazoMedioExcetoInstance = null;
        }
        return;
      }

      // Fun√ß√£o para converter data DD.MM.YYYY para objeto Date
      function parseData(dataStr) {
        if (!dataStr) return null;
        const partes = dataStr.split('.');
        if (partes.length !== 3) return null;
        return new Date(partes[2], partes[1] - 1, partes[0]);
      }

      // Calcular diferen√ßas e agrupar por m√™s/ano
      const prazosPorMes = {};
      let somaTotalDias = 0;
      let totalNotasValidas = 0;

      notasConcluidas.forEach(item => {
        const inicioPlanejado = parseData(item.inicio_planejado);
        const concluida = parseData(item.concluida_em);
        
        if (inicioPlanejado && concluida) {
          const diferencaDias = Math.round((concluida - inicioPlanejado) / (1000 * 60 * 60 * 24));
          const mesAno = `${String(concluida.getMonth() + 1).padStart(2, '0')}.${concluida.getFullYear()}`;
          
          if (!prazosPorMes[mesAno]) {
            prazosPorMes[mesAno] = { soma: 0, count: 0 };
          }
          
          prazosPorMes[mesAno].soma += diferencaDias;
          prazosPorMes[mesAno].count++;
          
          somaTotalDias += diferencaDias;
          totalNotasValidas++;
        }
      });

      const mesesOrdenados = Object.keys(prazosPorMes).sort((a, b) => {
        const [mesA, anoA] = a.split('.').map(Number);
        const [mesB, anoB] = b.split('.').map(Number);
        return (anoA * 12 + mesA) - (anoB * 12 + mesB);
      });

      const labels = mesesOrdenados;
      const medias = mesesOrdenados.map(mes => {
        const media = prazosPorMes[mes].soma / prazosPorMes[mes].count;
        return Math.round(media * 10) / 10;
      });

      const prazoMedioGeral = totalNotasValidas > 0 ? Math.round((somaTotalDias / totalNotasValidas) * 10) / 10 : 0;
      document.getElementById('totalNotasAnalisadasExceto').textContent = totalNotasValidas;
      document.getElementById('prazoMedioGeralExceto').textContent = prazoMedioGeral;

      if (chartPrazoMedioExcetoInstance) {
        chartPrazoMedioExcetoInstance.destroy();
      }

      const ctx = document.getElementById('chartPrazoMedioExceto').getContext('2d');
      chartPrazoMedioExcetoInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Prazo M√©dio (dias)',
            data: medias,
            backgroundColor: 'rgba(76, 175, 80, 0.2)',
            borderColor: 'rgba(76, 175, 80, 1)',
            borderWidth: 3,
            pointBackgroundColor: 'rgba(76, 175, 80, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8,
            tension: 0.3,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            datalabels: {
              display: false
            },
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(76, 175, 80, 0.9)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function(context) {
                  return 'Prazo m√©dio: ' + context.parsed.y + ' dias';
                },
                afterLabel: function(context) {
                  const mes = labels[context.dataIndex];
                  const info = prazosPorMes[mes];
                  return 'Notas: ' + info.count;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'M√™s/Ano',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666',
                callback: function(value) {
                  return value + ' dias';
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Prazo M√©dio (dias)',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Gr√°fico Prazo M√©dio (Somente Mini/Micro Gera√ß√£o)
    window.gerarGraficoPrazoMedioMiniMicro = function(dados) {
      if (!dados || dados.length === 0) {
        return;
      }

      // Obter descri√ß√µes selecionadas nos checkboxes
      const checkboxes = document.querySelectorAll('#containerCheckboxesDescricoesPrazoMiniMicro input[type="checkbox"]');
      const descricoesChecadas = new Set();
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          descricoesChecadas.add(checkbox.value);
        }
      });

      // Obter c√≥digos medidas selecionados nos checkboxes
      const checkboxesCodigo = document.querySelectorAll('#containerCheckboxesCodigoMedidasPrazoMiniMicro input[type="checkbox"]');
      const codigosChecados = new Set();
      checkboxesCodigo.forEach(checkbox => {
        if (checkbox.checked) {
          codigosChecados.add(checkbox.value);
        }
      });

      // Filtrar apenas notas conclu√≠das (CONC CTEC ou CONC RTEC) que SEJAM mini/micro gera√ß√£o
      const notasConcluidas = dados.filter(item => {
        const status = item.status_usuario || '';
        const descricao = item.descricao || '';
        const codigoMedidas = item.codigo_medidas || '';
        const textoMedidas = (item.texto_medidas || '').toUpperCase();
        
        // Verificar se o texto de medidas cont√©m "SEM ANEXO" ou varia√ß√µes
        const temAnexo = !(textoMedidas.includes('SEM ANEXO') || textoMedidas.includes('SEM AP√äNDICE') || 
                          textoMedidas.includes('FALTA ANEXO') || textoMedidas.includes('FALTA AP√äNDICE') ||
                          textoMedidas.includes('AUS√äNCIA') || textoMedidas.includes('INEXISTENTE'));
        
        const statusOk = (status === 'CONC CTEC' || status === 'CONC RTEC') && 
               item.inicio_planejado &&
               item.concluida_em;
        // Incluir apenas mini e micro gera√ß√£o
        const ehMiniMicro = descricao.toLowerCase().includes('mini gera√ß√£o') || 
                            descricao.toLowerCase().includes('micro gera√ß√£o');
        const descricaoOk = descricoesChecadas.size === 0 || descricoesChecadas.has(descricao);
        const codigoOk = codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);
        return statusOk && ehMiniMicro && descricaoOk && codigoOk && temAnexo;
      });

      if (notasConcluidas.length === 0) {
        document.getElementById('totalNotasAnalisadasMiniMicro').textContent = '0';
        document.getElementById('prazoMedioGeralMiniMicro').textContent = '0';
        if (chartPrazoMedioMiniMicroInstance) {
          chartPrazoMedioMiniMicroInstance.destroy();
          chartPrazoMedioMiniMicroInstance = null;
        }
        return;
      }

      // Fun√ß√£o para converter data DD.MM.YYYY para objeto Date
      function parseData(dataStr) {
        if (!dataStr) return null;
        const partes = dataStr.split('.');
        if (partes.length !== 3) return null;
        return new Date(partes[2], partes[1] - 1, partes[0]);
      }

      // Calcular diferen√ßas e agrupar por m√™s/ano
      const prazosPorMes = {};
      let somaTotalDias = 0;
      let totalNotasValidas = 0;

      notasConcluidas.forEach(item => {
        const inicioPlanejado = parseData(item.inicio_planejado);
        const concluida = parseData(item.concluida_em);
        
        if (inicioPlanejado && concluida) {
          const diferencaDias = Math.round((concluida - inicioPlanejado) / (1000 * 60 * 60 * 24));
          const mesAno = `${String(concluida.getMonth() + 1).padStart(2, '0')}.${concluida.getFullYear()}`;
          
          if (!prazosPorMes[mesAno]) {
            prazosPorMes[mesAno] = { soma: 0, count: 0 };
          }
          
          prazosPorMes[mesAno].soma += diferencaDias;
          prazosPorMes[mesAno].count++;
          
          somaTotalDias += diferencaDias;
          totalNotasValidas++;
        }
      });

      const mesesOrdenados = Object.keys(prazosPorMes).sort((a, b) => {
        const [mesA, anoA] = a.split('.').map(Number);
        const [mesB, anoB] = b.split('.').map(Number);
        return (anoA * 12 + mesA) - (anoB * 12 + mesB);
      });

      const labels = mesesOrdenados;
      const medias = mesesOrdenados.map(mes => {
        const media = prazosPorMes[mes].soma / prazosPorMes[mes].count;
        return Math.round(media * 10) / 10;
      });

      const prazoMedioGeral = totalNotasValidas > 0 ? Math.round((somaTotalDias / totalNotasValidas) * 10) / 10 : 0;
      document.getElementById('totalNotasAnalisadasMiniMicro').textContent = totalNotasValidas;
      document.getElementById('prazoMedioGeralMiniMicro').textContent = prazoMedioGeral;

      if (chartPrazoMedioMiniMicroInstance) {
        chartPrazoMedioMiniMicroInstance.destroy();
      }

      const ctx = document.getElementById('chartPrazoMedioMiniMicro').getContext('2d');
      chartPrazoMedioMiniMicroInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Prazo M√©dio (dias)',
            data: medias,
            backgroundColor: 'rgba(33, 150, 243, 0.2)',
            borderColor: 'rgba(33, 150, 243, 1)',
            borderWidth: 3,
            pointBackgroundColor: 'rgba(33, 150, 243, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8,
            tension: 0.3,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            datalabels: {
              display: false
            },
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(33, 150, 243, 0.9)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function(context) {
                  return 'Prazo m√©dio: ' + context.parsed.y + ' dias';
                },
                afterLabel: function(context) {
                  const mes = labels[context.dataIndex];
                  const info = prazosPorMes[mes];
                  return 'Notas: ' + info.count;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'M√™s/Ano',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666',
                callback: function(value) {
                  return value + ' dias';
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Prazo M√©dio (dias)',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Fun√ß√£o para gerar gr√°fico filtrado de Mini Gera√ß√£o
    window.gerarGraficoMiniGeracao = function(dados) {
      if (!dados || dados.length === 0) {
        document.getElementById('totalMiniGeracao').textContent = '0';
        return;
      }

      // Obter c√≥digos medidas selecionados nos checkboxes
      const checkboxesCodigo = document.querySelectorAll('#containerCheckboxesCodigoMedidasMiniGeracao input[type="checkbox"]');
      const codigosChecados = new Set();
      checkboxesCodigo.forEach(checkbox => {
        if (checkbox.checked) {
          codigosChecados.add(checkbox.value);
        }
      });

      // Filtrar apenas registros com "Analisar Carga Acessante Mini Gera√ß√£o" na descri√ß√£o e status ABER ou ANDM
      const dadosFiltrados = dados.filter(item => {
        const temDescricao = item.descricao && item.descricao.toLowerCase().includes('analisar carga acessante mini gera√ß√£o');
        const temStatus = item.status_usuario && (item.status_usuario.toUpperCase() === 'ABER' || item.status_usuario.toUpperCase() === 'ANDM');
        const codigoMedidas = item.codigo_medidas || '';
        const codigoOk = codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);
        return temDescricao && temStatus && codigoOk;
      });

      console.log('Total de registros Mini Gera√ß√£o:', dadosFiltrados.length);
      document.getElementById('totalMiniGeracao').textContent = dadosFiltrados.length;

      if (dadosFiltrados.length === 0) {
        // Limpar gr√°fico se n√£o houver dados
        if (chartMiniGeracaoInstance) {
          chartMiniGeracaoInstance.destroy();
          chartMiniGeracaoInstance = null;
        }
        return;
      }

      // Agrupar dados por fim_planejado e contar
      const agrupamento = {};
      dadosFiltrados.forEach(item => {
        const fimPlanejado = item.fim_planejado || 'Sem data';
        if (agrupamento[fimPlanejado]) {
          agrupamento[fimPlanejado]++;
        } else {
          agrupamento[fimPlanejado] = 1;
        }
      });

      // Converter para arrays e ordenar por data
      const labels = Object.keys(agrupamento).sort((a, b) => {
        if (a === 'Sem data') return 1;
        if (b === 'Sem data') return -1;
        return new Date(a.split('.').reverse().join('-')) - new Date(b.split('.').reverse().join('-'));
      });
      const valores = labels.map(label => agrupamento[label]);

      // Destruir gr√°fico anterior se existir
      if (chartMiniGeracaoInstance) {
        chartMiniGeracaoInstance.destroy();
      }

      // Criar novo gr√°fico
      const ctx = document.getElementById('chartMiniGeracao').getContext('2d');
      chartMiniGeracaoInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade de Notas - Mini Gera√ß√£o',
            data: valores,
            backgroundColor: 'rgba(255, 152, 0, 0.7)',
            borderColor: 'rgba(255, 152, 0, 1)',
            borderWidth: 2,
            borderRadius: 8,
            hoverBackgroundColor: 'rgba(255, 167, 38, 0.8)',
            hoverBorderColor: 'rgba(255, 167, 38, 1)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(255, 152, 0, 0.9)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function(context) {
                  return 'Notas: ' + context.parsed.y;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Quantidade',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: 'Roboto'
                },
                color: '#666',
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'Fim Planejado',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Fun√ß√£o para gerar gr√°fico com todos os tipos de descri√ß√£o (incluindo Mini Gera√ß√£o)
    window.gerarGraficoOutrosTipos = function(dados) {
      // Obter c√≥digos medidas selecionados nos checkboxes
      const checkboxesCodigo = document.querySelectorAll('#containerCheckboxesCodigoMedidasSemGeracoes input[type="checkbox"]');
      const codigosChecados = new Set();
      checkboxesCodigo.forEach(checkbox => {
        if (checkbox.checked) {
          codigosChecados.add(checkbox.value);
        }
      });

      // Filtrar apenas status ANDM e ABER
      const dadosFiltrados = dados.filter(item => {
        const status = item.status_usuario || '';
        const codigoMedidas = item.codigo_medidas || '';
        const codigoOk = codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);
        return (status === 'ANDM' || status === 'ABER') && codigoOk;
      });

      // Atualizar contador total
      document.getElementById('totalOutrosTipos').textContent = dadosFiltrados.length;

      if (dadosFiltrados.length === 0) {
        // Limpar gr√°fico se n√£o houver dados
        if (chartOutrosTiposInstance) {
          chartOutrosTiposInstance.destroy();
          chartOutrosTiposInstance = null;
        }
        document.getElementById('tiposUnicos').textContent = '0';
        return;
      }

      // Agrupar dados por descri√ß√£o e contar
      const agrupamento = {};
      dadosFiltrados.forEach(item => {
        const descricao = item.descricao || 'Sem descri√ß√£o';
        if (agrupamento[descricao]) {
          agrupamento[descricao]++;
        } else {
          agrupamento[descricao] = 1;
        }
      });

      // Atualizar contador de tipos √∫nicos
      document.getElementById('tiposUnicos').textContent = Object.keys(agrupamento).length;

      // Converter para arrays e ordenar por quantidade (decrescente)
      const ordenado = Object.entries(agrupamento).sort((a, b) => b[1] - a[1]);
      const labels = ordenado.map(item => item[0]);
      const valores = ordenado.map(item => item[1]);

      // Destruir gr√°fico anterior se existir
      if (chartOutrosTiposInstance) {
        chartOutrosTiposInstance.destroy();
      }

      // Criar novo gr√°fico
      const ctx = document.getElementById('chartOutrosTipos').getContext('2d');
      chartOutrosTiposInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade de Notas - Todos os Tipos',
            data: valores,
            backgroundColor: 'rgba(25, 118, 210, 0.7)',
            borderColor: 'rgba(25, 118, 210, 1)',
            borderWidth: 2,
            borderRadius: 8,
            hoverBackgroundColor: 'rgba(66, 165, 245, 0.8)',
            hoverBorderColor: 'rgba(66, 165, 245, 1)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(25, 118, 210, 0.9)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function(context) {
                  return 'Notas: ' + context.parsed.y;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Quantidade',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: 'Roboto'
                },
                color: '#666',
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'Tipo de Descri√ß√£o',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Fun√ß√£o para gerar gr√°fico sem Mini e Micro Gera√ß√£o - Por Fim Planejado
    window.gerarGraficoSemGeracoes = function(dados) {
      // Filtrar dados excluindo mini e micro gera√ß√£o E considerando apenas ANDM e ABER
      const dadosFiltrados = dados.filter(item => {
        const descricao = (item.descricao || '').toLowerCase();
        const status = item.status_usuario || '';
        return !descricao.includes('mini gera√ß√£o') && 
               !descricao.includes('micro gera√ß√£o') &&
               (status === 'ANDM' || status === 'ABER');
      });

      // Atualizar contador total
      document.getElementById('totalSemGeracoes').textContent = dadosFiltrados.length;

      if (dadosFiltrados.length === 0) {
        // Limpar gr√°fico se n√£o houver dados
        if (chartSemGeracoesInstance) {
          chartSemGeracoesInstance.destroy();
          chartSemGeracoesInstance = null;
        }
        return;
      }

      // Agrupar dados por fim_planejado e contar
      const agrupamento = {};
      dadosFiltrados.forEach(item => {
        const fimPlanejado = item.fim_planejado || 'Sem data';
        if (agrupamento[fimPlanejado]) {
          agrupamento[fimPlanejado]++;
        } else {
          agrupamento[fimPlanejado] = 1;
        }
      });

      // Converter para arrays e ordenar por data
      const labels = Object.keys(agrupamento).sort((a, b) => {
        if (a === 'Sem data') return 1;
        if (b === 'Sem data') return -1;
        return new Date(a.split('.').reverse().join('-')) - new Date(b.split('.').reverse().join('-'));
      });
      const valores = labels.map(label => agrupamento[label]);

      // Destruir gr√°fico anterior se existir
      if (chartSemGeracoesInstance) {
        chartSemGeracoesInstance.destroy();
      }

      // Criar novo gr√°fico
      const ctx = document.getElementById('chartSemGeracoes').getContext('2d');
      chartSemGeracoesInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade de Notas - Sem Mini/Micro Gera√ß√£o',
            data: valores,
            backgroundColor: 'rgba(123, 31, 162, 0.7)',
            borderColor: 'rgba(123, 31, 162, 1)',
            borderWidth: 2,
            borderRadius: 8,
            hoverBackgroundColor: 'rgba(156, 39, 176, 0.8)',
            hoverBorderColor: 'rgba(156, 39, 176, 1)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(123, 31, 162, 0.9)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function(context) {
                  return 'Notas: ' + context.parsed.y;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Quantidade',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            x: {
              ticks: {
                font: {
                  size: 11,
                  family: 'Roboto'
                },
                color: '#666',
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'Fim Planejado',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Gr√°fico de Notas Conclu√≠das por Usu√°rio
    window.gerarGraficoNotasPorUsuario = function(dados) {
      if (!dados || dados.length === 0) {
        document.getElementById('totalNotasPorUsuario').textContent = '0';
        if (chartNotasPorUsuarioInstance) {
          chartNotasPorUsuarioInstance.destroy();
          chartNotasPorUsuarioInstance = null;
        }
        return;
      }

      // Obter descri√ß√µes selecionadas nos checkboxes
      const checkboxes = document.querySelectorAll('#containerCheckboxesDescricoesNotasPorUsuario input[type="checkbox"]');
      const descricoesChecadas = new Set();
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          descricoesChecadas.add(checkbox.value);
        }
      });

      // Obter m√™s selecionado (Conclu√≠da em)
      const selectMes = document.getElementById('filtroMesNotasPorUsuario');
      const mesSelecionado = selectMes ? selectMes.value : 'todos';

      // Obter c√≥digos de medidas selecionados
      const checkboxesCodigo = document.querySelectorAll('#containerCheckboxesCodigoMedidasNotasPorUsuario input[type="checkbox"]');
      const codigosChecados = new Set();
      checkboxesCodigo.forEach(checkbox => {
        if (checkbox.checked) {
          codigosChecados.add(checkbox.value);
        }
      });

      // Filtrar apenas notas conclu√≠das (status CONC CTEC ou CONC RTEC) com usu√°rio preenchido
      const notasConcluidas = dados.filter(item => {
        const status = item.status_usuario || '';
        const usuario = (item.concluido_por || '').trim();
        const descricao = item.descricao || '';
        const codigoMedidas = item.codigo_medidas || '';
        const concluidaEm = item.concluida_em || '';

        const descricaoOk = descricoesChecadas.size === 0 || descricoesChecadas.has(descricao);
        const codigoOk = codigosChecados.size === 0 || codigosChecados.has(codigoMedidas);

        let mesOk = true;
        if (mesSelecionado !== 'todos') {
          const partes = concluidaEm.split('.');
          if (partes.length >= 3) {
            const mesAno = partes[1] + '.' + partes[2];
            mesOk = mesAno === mesSelecionado;
          } else {
            mesOk = false;
          }
        }

        return (status === 'CONC CTEC' || status === 'CONC RTEC') && usuario !== '' && descricaoOk && codigoOk && mesOk;
      });

      if (notasConcluidas.length === 0) {
        document.getElementById('totalNotasPorUsuario').textContent = '0';
        if (chartNotasPorUsuarioInstance) {
          chartNotasPorUsuarioInstance.destroy();
          chartNotasPorUsuarioInstance = null;
        }
        return;
      }

      // Atualizar total
      document.getElementById('totalNotasPorUsuario').textContent = notasConcluidas.length;

      // Agrupar por usu√°rio (concluido_por)
      const agrupamentoUsuario = {};
      notasConcluidas.forEach(item => {
        const usuario = (item.concluido_por || 'Desconhecido').trim();
        if (agrupamentoUsuario[usuario]) {
          agrupamentoUsuario[usuario]++;
        } else {
          agrupamentoUsuario[usuario] = 1;
        }
      });

      // Converter para arrays e ordenar por quantidade (decrescente)
      const labels = Object.keys(agrupamentoUsuario).sort((a, b) => {
        return agrupamentoUsuario[b] - agrupamentoUsuario[a];
      });
      const valores = labels.map(label => agrupamentoUsuario[label]);

      // Cores alternadas para melhor visualiza√ß√£o
      const cores = [
        'rgba(255, 87, 34, 0.7)',   // Deep Orange
        'rgba(244, 67, 54, 0.7)',   // Red
        'rgba(233, 30, 99, 0.7)',   // Pink
        'rgba(156, 39, 176, 0.7)',  // Purple
        'rgba(103, 58, 183, 0.7)',  // Deep Purple
        'rgba(63, 81, 181, 0.7)',   // Indigo
        'rgba(33, 150, 243, 0.7)',  // Blue
        'rgba(0, 172, 193, 0.7)',   // Cyan
        'rgba(0, 150, 136, 0.7)',   // Teal
        'rgba(76, 175, 80, 0.7)'    // Green
      ];

      const backgroundColors = labels.map((_, index) => cores[index % cores.length]);
      const borderColors = backgroundColors.map(color => color.replace('0.7', '1'));

      // Destruir gr√°fico anterior se existir
      if (chartNotasPorUsuarioInstance) {
        chartNotasPorUsuarioInstance.destroy();
      }

      // Criar novo gr√°fico
      const ctx = document.getElementById('chartNotasPorUsuario').getContext('2d');
      chartNotasPorUsuarioInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade de Notas Conclu√≠das',
            data: valores,
            backgroundColor: backgroundColors,
            borderColor: borderColors,
            borderWidth: 2,
            borderRadius: 8,
            hoverBackgroundColor: borderColors,
            barPercentage: 0.8,
            categoryPercentage: 0.9
          }]
        },
        options: {
          indexAxis: 'y', // Gr√°fico horizontal
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.0,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                font: {
                  size: 14,
                  family: 'Roboto'
                },
                color: '#333'
              }
            },
            title: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.7)',
              titleFont: {
                size: 14,
                family: 'Roboto'
              },
              bodyFont: {
                size: 13,
                family: 'Roboto'
              },
              padding: 12,
              callbacks: {
                label: function(context) {
                  return 'Notas: ' + context.parsed.x;
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Quantidade de Notas',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            },
            y: {
              ticks: {
                font: {
                  size: 12,
                  family: 'Roboto'
                },
                color: '#666'
              },
              grid: {
                display: false
              },
              title: {
                display: true,
                text: 'Usu√°rio',
                font: {
                  size: 13,
                  family: 'Roboto',
                  weight: 'bold'
                },
                color: '#333'
              }
            }
          }
        }
      });
    };

    // Carregar dados ao iniciar a p√°gina
    window.addEventListener('DOMContentLoaded', carregarDados);
  </script>

  

</body>

</html>