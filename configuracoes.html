<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Configura√ß√µes - Cadastro de Usu√°rios</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="configuracoes.css">
</head>

<body>
    <div style="display: flex; align-items: center; justify-content: center; gap: 24px;">
        <h1 id="titulo"
            style="font-family:'Roboto Slab', 'Georgia', serif; font-size:2.8em; color:#184d27; letter-spacing:2px; font-weight:900; padding:10px 12px; margin:0;">
            PORTAL N√öCLEO T√âCNICO
        </h1>
    </div>
    <br>

    <div class="menu-container">
        <button id="btn-relatorios" class="menu-btn" onclick="location.href='relatorios-tecnicos.html'">Relat√≥rios<br>T√©cnicos</button>
        <button id="btn-checklist" class="menu-btn" onclick="location.href='checklist.html'">Checklist</button>
        <button id="btn-indices" class="menu-btn" onclick="location.href='indices.html'">√çndices</button>
        <button id="btn-fluxos" class="menu-btn" onclick="location.href='fluxos.html'">Fluxos</button>
        <button id="btn-calendario" class="menu-btn" onclick="location.href='calendario.html'">Calend√°rio</button>
        <button id="btn-links" class="menu-btn" onclick="location.href='links.html'">Links</button>
        <button id="btn-modulos" class="menu-btn" onclick="location.href='modulos.html'">M√≥dulos<br>Homologados</button>
        <button id="btn-ferramentas" class="menu-btn" onclick="location.href='ferramentas.html'">Ferramentas</button>
        <button id="btn-controlens" class="menu-btn" onclick="location.href='controlens.html'">Controle<br>An√°lises</button>
        <button id="btn-engenharia" class="menu-btn" onclick="location.href='engenharia.html'">Engenharia</button>
        <button id="btn-configuracoes" class="menu-btn" onclick="location.href='configuracoes.html'">Configura√ß√µes</button>
        <button class="menu-btn" onclick="logout()" style="background: linear-gradient(145deg, #d32f2f, #f44336);">Sair</button>
    </div>

    <script src="auth.js"></script>
    <script src="menu.js"></script>

    <h1 style="display:inline-block; vertical-align:middle; padding: 0px 0px;">CADASTRO DE USU√ÅRIOS</h1>

    <div id="container" style="display: flex; flex-direction: column; align-items: center; gap: 30px; margin-bottom: 30px;">
        <!-- Testador de Login -->
        <div style="max-width: 400px; width: 100%; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 24px; border-left: 4px solid #ff9800;">
            <h2 style="text-align: center; color: #ff9800; margin-top: 0;">üîê Testador de Login</h2>
            <form id="formTestadorLogin" style="display: flex; flex-direction: column; gap: 10px;">
                <div style="display: flex; align-items: center;">
                    <label for="emailTeste" style="width: 120px; text-align: left; font-weight: 600;">Email</label>
                    <input type="email" id="emailTeste" placeholder="email@exemplo.com" required style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="display: flex; align-items: center;">
                    <label for="senhaTeste" style="width: 120px; text-align: left; font-weight: 600;">Senha</label>
                    <input type="password" id="senhaTeste" placeholder="Insira a senha" required style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <button type="submit" style="background: linear-gradient(145deg, #ff9f68, #ffb088); color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 8px;">
                    Testar Login
                </button>
            </form>
            <div id="resultadoTeste" style="margin-top: 16px; padding: 12px; border-radius: 4px; display: none; font-size: 14px;"></div>
        </div>

        <div style="max-width: 400px; width: 100%; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 24px; border-left: 4px solid #2e7d32;">
            <h2 style="text-align: center; color: #2e7d32; margin-top: 0;">üë§ Novo Usu√°rio</h2>
            <form id="form" style="display: flex; flex-direction: column; gap: 10px;">
                <input type="hidden" id="usuarioId">
                <div style="display: flex; align-items: center;">
                    <label for="nomeUsuario" style="width: 120px; text-align: left; font-weight: 600;">Nome Usu√°rio</label>
                    <input type="text" id="nomeUsuario" placeholder="Nome completo" required style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="display: flex; align-items: center;">
                    <label for="matricula" style="width: 120px; text-align: left; font-weight: 600;">Matr√≠cula</label>
                    <input type="text" id="matricula" placeholder="Matr√≠cula" required style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="display: flex; align-items: center;">
                    <label for="email" style="width: 120px; text-align: left; font-weight: 600;">Email</label>
                    <input type="email" id="email" placeholder="email@exemplo.com" required style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="display: flex; align-items: center;">
                    <label for="telefone" style="width: 120px; text-align: left; font-weight: 600;">Telefone</label>
                    <input type="text" id="telefone" placeholder="(00) 00000-0000" required style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="display: flex; align-items: center;">
                    <label for="dataNasc" style="width: 120px; text-align: left; font-weight: 600;">Data Nasc.</label>
                    <input type="date" id="dataNasc" required style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="display: flex; align-items: center;">
                    <label for="senha" style="width: 120px; text-align: left; font-weight: 600;">Senha</label>
                    <input type="password" id="senha" placeholder="M√≠nimo 6 caracteres" minlength="6" required style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="display: flex; align-items: center;">
                    <label for="categoria" style="width: 120px; text-align: left; font-weight: 600;">Categoria</label>
                    <select id="categoria" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="usuario">Usu√°rio</option>
                        <option value="tecnico">T√©cnico</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button type="submit" id="btnSalvar" style="background: linear-gradient(145deg, #2e7d32, #43a047); color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 8px;">
                    Cadastrar
                </button>
                <button type="button" id="btnCancelarEdicao" style="display: none; background: #9e9e9e; color: white; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    Cancelar edi√ß√£o
                </button>
            </form>
        </div>

        <div style="max-width: 1200px; width: 100%; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 24px;">
            <h2 style="text-align: center;">Usu√°rios Cadastrados</h2>
            <div id="usuarios-lista">
                <table style="width: 100%; border-collapse: collapse; table-layout: auto;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; min-width: 220px;">Nome Usu√°rio</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Matr√≠cula</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; min-width: 220px;">Email</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Telefone</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Data Nasc.</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Categoria</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Data Cria√ß√£o</th>
                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="usuarios-tbody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 20px;">Carregando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Bot√£o para mostrar/ocultar logs -->
        <div style="max-width: 1200px; width: 100%; margin: 30px auto 0; text-align: center; clear: both;">
            <button id="toggleLogsBtn" onclick="toggleLogs()"
                style="background-color: #1976d2; color: white; padding: 15px 35px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s; white-space: nowrap; display: inline-block; min-width: 280px; height: auto;">
                üìä Exibir Logs de Acesso
            </button>
        </div>

        <!-- Se√ß√£o de Logs (inicialmente oculta) -->
        <div id="logsSection" style="display: none; max-width: 1200px; width: 100%; margin: 0 auto 20px; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 24px; clear: both;">
            <h2 style="color: #184d27; border-bottom: 2px solid #184d27; padding-bottom: 10px; margin-top: 0;">
                üìã Hist√≥rico de Acessos
            </h2>
            <div id="logCount" style="margin: 10px 0; font-weight: bold; color: #184d27;"></div>
            <div style="overflow-x: auto;">
                <table id="logTable"
                    style="width: 100%; border-collapse: collapse; table-layout: auto;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; min-width: 200px;">Nome Usu√°rio</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; min-width: 220px;">Email</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Categoria</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Data e Hora do Acesso</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Bot√£o para mostrar/ocultar logs de atualiza√ß√£o de relat√≥rios -->
        <div style="max-width: 1200px; width: 100%; margin: 30px auto; text-align: center; clear: both;">
            <button id="toggleUpdateReportsLogsBtn" onclick="toggleUpdateReportsLogs()"
                style="background-color: #ff9800; color: white; padding: 15px 35px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s; white-space: nowrap; display: inline-block; min-width: 320px; height: auto;">
                üìä Exibir Logs de Atualiza√ß√£o de Relat√≥rios
            </button>
        </div>

        <!-- Se√ß√£o de Logs de Atualiza√ß√£o (inicialmente oculta) -->
        <div id="updateReportsLogsSection" style="display: none; max-width: 1200px; width: 100%; margin: 0 auto 20px; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 24px; clear: both;">
            <h2 style="color: #184d27; border-bottom: 2px solid #184d27; padding-bottom: 10px; margin-top: 0;">
                üìù Hist√≥rico de Atualiza√ß√µes de Relat√≥rios
            </h2>
            <div id="updateReportsLogCount" style="margin: 10px 0; font-weight: bold; color: #184d27;"></div>
            <div style="overflow-x: auto;">
                <table id="updateReportsLogTable"
                    style="width: 100%; border-collapse: collapse; table-layout: auto;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; min-width: 200px;">Nome Usu√°rio</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; min-width: 220px;">Email</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Categoria</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Tipo de Relat√≥rio</th>
                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Qtd. Registros</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Data e Hora da Atualiza√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://nelzhukmxrgdoarsxcek.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lbHpodWtteHJnZG9hcnN4Y2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMDIxNzUsImV4cCI6MjA3MTU3ODE3NX0.KHvfJHVimKwiraEzbyZWyLnTO5P5VEvM86GlyE7y09k';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Fun√ß√£o para formatar data e hora
        function formatarData(dataISO) {
            if (!dataISO) return 'N/A';
            
            const match = dataISO.match(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/);
            if (!match) return dataISO;
            
            let [_, ano, mes, dia, hora, minuto, segundo] = match;
            hora = parseInt(hora);
            
            // Subtrai 3 horas para converter UTC para Bras√≠lia (UTC-3)
            hora -= 3;
            
            if (hora < 0) {
                hora += 24;
                dia = parseInt(dia) - 1;
                if (dia < 1) {
                    dia = 1;
                }
                dia = dia.toString().padStart(2, '0');
            }
            
            hora = hora.toString().padStart(2, '0');
            
            return `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo}`;
        }

        // Fun√ß√£o para toggle de logs
        window.toggleLogs = async function() {
            const logsSection = document.getElementById('logsSection');
            const toggleBtn = document.getElementById('toggleLogsBtn');
            
            if (logsSection.style.display === 'none') {
                logsSection.style.display = 'block';
                toggleBtn.textContent = 'üìä Ocultar Logs de Acesso';
                toggleBtn.style.backgroundColor = '#ff9800';
                await loadLoginLogs();
            } else {
                logsSection.style.display = 'none';
                toggleBtn.textContent = 'üìä Exibir Logs de Acesso';
                toggleBtn.style.backgroundColor = '#1976d2';
            }
        };

        // Fun√ß√£o para carregar logs de login
        async function loadLoginLogs() {
            console.log('Carregando logs de acesso...');
            const logTableBody = document.querySelector("#logTable tbody");
            const logCount = document.getElementById("logCount");
            
            try {
                const { data, error } = await supabaseClient.from("login_logs_nt")
                    .select("nome_usuario, email, categoria, login_timestamp")
                    .order('login_timestamp', { ascending: false })
                    .limit(100);

                console.log('Logs retornados:', data);
                console.log('Erro (se houver):', error);

                if (error) {
                    console.error('Erro detalhado:', error);
                    throw error;
                }

                logTableBody.innerHTML = "";

                if (!data || data.length === 0) {
                    logTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px; color: #666;">Nenhum log de acesso registrado</td></tr>';
                    logCount.textContent = 'Total: 0 acessos registrados';
                    return;
                }

                logCount.textContent = `Total: ${data.length} acesso(s) registrado(s) (√∫ltimos 100)`;

                data.forEach((log, index) => {
                    const row = document.createElement("tr");
                    row.style.backgroundColor = index % 2 === 0 ? '#f9f9f9' : '#fff';
                    row.style.borderBottom = '1px solid #eee';
                    row.innerHTML = `
                        <td style="padding: 12px; min-width: 180px;">${log.nome_usuario || 'N/A'}</td>
                        <td style="padding: 12px; min-width: 220px; word-break: break-word;">${log.email}</td>
                        <td style="padding: 12px;">
                            <span style="background-color: ${log.categoria === 'admin' ? '#ff9800' : log.categoria === 'tecnico' ? '#2196F3' : '#4CAF50'}; 
                                         color: white; padding: 4px 8px; border-radius: 3px; font-size: 12px; font-weight: bold;">
                                ${log.categoria.toUpperCase()}
                            </span>
                        </td>
                        <td style="padding: 12px;">${formatarData(log.login_timestamp)}</td>
                    `;
                    logTableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Erro ao carregar logs:', error);
                let errorMsg = error.message;
                if (error.message.includes('relation') || error.message.includes('does not exist')) {
                    errorMsg = 'Tabela "login_logs_nt" n√£o encontrada. Execute o SQL no Supabase primeiro!';
                }
                logTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 20px; color: #d32f2f;">
                    ‚ùå Erro ao carregar logs: ${errorMsg}<br><br>
                    <small>Verifique o console (F12) para mais detalhes</small>
                </td></tr>`;
                logCount.textContent = 'Erro ao carregar logs';
            }
        }

        // Fun√ß√£o para toggle de logs de atualiza√ß√£o de relat√≥rios
        window.toggleUpdateReportsLogs = async function() {
            const updateReportsLogsSection = document.getElementById('updateReportsLogsSection');
            const toggleBtn = document.getElementById('toggleUpdateReportsLogsBtn');
            
            if (updateReportsLogsSection.style.display === 'none') {
                updateReportsLogsSection.style.display = 'block';
                toggleBtn.textContent = 'üìä Ocultar Logs de Atualiza√ß√£o de Relat√≥rios';
                toggleBtn.style.backgroundColor = '#2e7d32';
                await loadUpdateReportsLogs();
            } else {
                updateReportsLogsSection.style.display = 'none';
                toggleBtn.textContent = 'üìä Exibir Logs de Atualiza√ß√£o de Relat√≥rios';
                toggleBtn.style.backgroundColor = '#ff9800';
            }
        };

        // Fun√ß√£o para carregar logs de atualiza√ß√£o de relat√≥rios
        async function loadUpdateReportsLogs() {
            console.log('Carregando logs de atualiza√ß√£o de relat√≥rios...');
            const logTableBody = document.querySelector("#updateReportsLogTable tbody");
            const logCount = document.getElementById("updateReportsLogCount");
            
            try {
                const { data, error } = await supabaseClient.from("update_reports_logs_nt")
                    .select("nome_usuario, email, categoria, tipo_relatorio, quantidade_registros, update_timestamp")
                    .order('update_timestamp', { ascending: false })
                    .limit(100);

                console.log('Logs de atualiza√ß√£o retornados:', data);
                console.log('Erro (se houver):', error);

                if (error) {
                    console.error('Erro detalhado:', error);
                    throw error;
                }

                logTableBody.innerHTML = "";

                if (!data || data.length === 0) {
                    logTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px; color: #666;">Nenhum log de atualiza√ß√£o registrado</td></tr>';
                    logCount.textContent = 'Total: 0 atualiza√ß√µes registradas';
                    return;
                }

                logCount.textContent = `Total: ${data.length} atualiza√ß√£o(√µes) registrada(s) (√∫ltimas 100)`;

                data.forEach((log, index) => {
                    const row = document.createElement("tr");
                    row.style.backgroundColor = index % 2 === 0 ? '#f9f9f9' : '#fff';
                    row.style.borderBottom = '1px solid #eee';
                    row.innerHTML = `
                        <td style="padding: 12px; min-width: 180px;">${log.nome_usuario || 'N/A'}</td>
                        <td style="padding: 12px; min-width: 220px; word-break: break-word;">${log.email}</td>
                        <td style="padding: 12px;">
                            <span style="background-color: ${log.categoria === 'admin' ? '#ff9800' : log.categoria === 'tecnico' ? '#2196F3' : '#4CAF50'}; 
                                         color: white; padding: 4px 8px; border-radius: 3px; font-size: 12px; font-weight: bold;">
                                ${log.categoria.toUpperCase()}
                            </span>
                        </td>
                        <td style="padding: 12px;">
                            <span style="background-color: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 3px; font-size: 12px; font-weight: bold;">
                                ${log.tipo_relatorio.toUpperCase()}
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: center; font-weight: 600;">${log.quantidade_registros}</td>
                        <td style="padding: 12px;">${formatarData(log.update_timestamp)}</td>
                    `;
                    logTableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Erro ao carregar logs de atualiza√ß√£o:', error);
                let errorMsg = error.message;
                if (error.message.includes('relation') || error.message.includes('does not exist')) {
                    errorMsg = 'Tabela "update_reports_logs_nt" n√£o encontrada. Execute o SQL no Supabase primeiro!';
                }
                logTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 20px; color: #d32f2f;">
                    ‚ùå Erro ao carregar logs: ${errorMsg}<br><br>
                    <small>Verifique o console (F12) para mais detalhes</small>
                </td></tr>`;
                logCount.textContent = 'Erro ao carregar logs';
            }
        }

        // Fun√ß√£o para testar o login
        document.getElementById('formTestadorLogin').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('emailTeste').value.trim().toLowerCase();
            const senha = document.getElementById('senhaTeste').value;
            const resultadoDiv = document.getElementById('resultadoTeste');

            try {
                resultadoDiv.style.display = 'block';
                resultadoDiv.style.background = '#fff3cd';
                resultadoDiv.style.color = '#856404';
                resultadoDiv.style.border = '1px solid #ffc107';
                resultadoDiv.innerHTML = '‚è≥ Verificando credenciais...';

                const { data, error } = await supabaseClient
                    .from('user_login_nt')
                    .select('id, nome_usuario, email, categoria, matricula')
                    .eq('email', email)
                    .eq('senha', senha)
                    .single();

                if (error) {
                    if (error.code === 'PGRST116') {
                        resultadoDiv.style.background = '#f8d7da';
                        resultadoDiv.style.color = '#721c24';
                        resultadoDiv.style.border = '1px solid #f5c6cb';
                        resultadoDiv.innerHTML = '‚ùå <strong>Login falhou!</strong><br>Email ou senha incorretos.';
                    } else {
                        resultadoDiv.style.background = '#f8d7da';
                        resultadoDiv.style.color = '#721c24';
                        resultadoDiv.style.border = '1px solid #f5c6cb';
                        resultadoDiv.innerHTML = '‚ùå <strong>Erro:</strong> ' + error.message;
                    }
                } else if (data) {
                    // Registra o log de acesso
                    console.log('Tentando inserir log de acesso...');
                    try {
                        const { error: logError } = await supabaseClient.from("login_logs_nt").insert([{
                            nome_usuario: data.nome_usuario,
                            email: data.email,
                            categoria: data.categoria,
                            login_timestamp: new Date().toISOString()
                        }]);
                        
                        if (logError) {
                            console.error('Erro ao inserir log:', logError);
                        } else {
                            console.log('Log inserido com sucesso!');
                        }
                    } catch (logException) {
                        console.error('Exce√ß√£o ao registrar log:', logException);
                    }
                    
                    resultadoDiv.style.background = '#d4edda';
                    resultadoDiv.style.color = '#155724';
                    resultadoDiv.style.border = '1px solid #c3e6cb';
                    resultadoDiv.innerHTML = `
                        ‚úÖ <strong>Login bem-sucedido!</strong><br>
                        <strong>Nome:</strong> ${data.nome_usuario}<br>
                        <strong>Email:</strong> ${data.email}<br>
                        <strong>Matr√≠cula:</strong> ${data.matricula}<br>
                        <strong>Categoria:</strong> <span style="background: ${data.categoria === 'admin' ? '#ff9800' : data.categoria === 'tecnico' ? '#2196F3' : '#4CAF50'}; color: white; padding: 2px 6px; border-radius: 3px;">${data.categoria.toUpperCase()}</span>
                    `;
                }
            } catch (error) {
                console.error('Erro ao testar login:', error);
                resultadoDiv.style.background = '#f8d7da';
                resultadoDiv.style.color = '#721c24';
                resultadoDiv.style.border = '1px solid #f5c6cb';
                resultadoDiv.innerHTML = '‚ùå <strong>Erro ao testar login:</strong> ' + error.message;
            }
        });

        // Fun√ß√£o para carregar usu√°rios
        async function carregarUsuarios() {
            try {
                const { data, error } = await supabaseClient
                    .from('user_login_nt')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tbody = document.getElementById('usuarios-tbody');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">Nenhum usu√°rio cadastrado</td></tr>';
                    return;
                }

                data.forEach(usuario => {
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid #eee';
                    tr.innerHTML = `
                        <td style="padding: 12px; min-width: 180px;">${usuario.nome_usuario || ''}</td>
                        <td style="padding: 12px;">${usuario.matricula || ''}</td>
                        <td style="padding: 12px; min-width: 220px; word-break: break-word;">${usuario.email}</td>
                        <td style="padding: 12px;">${usuario.telefone || ''}</td>
                        <td style="padding: 12px;">${usuario.data_nasc ? new Date(usuario.data_nasc).toLocaleDateString('pt-BR') : ''}</td>
                        <td style="padding: 12px;">
                            <span style="background-color: ${usuario.categoria === 'admin' ? '#ff9800' : usuario.categoria === 'tecnico' ? '#2196F3' : '#4CAF50'}; 
                                         color: white; padding: 4px 8px; border-radius: 3px; font-size: 12px; font-weight: bold;">
                                ${usuario.categoria.toUpperCase()}
                            </span>
                        </td>
                        <td style="padding: 12px;">${new Date(usuario.created_at).toLocaleString('pt-BR')}</td>
                        <td style="padding: 12px; text-align: center; display: flex; gap: 8px; justify-content: center;">
                            <button class="btn-editar" data-id="${usuario.id}" data-nome="${usuario.nome_usuario || ''}" data-matricula="${usuario.matricula || ''}" data-email="${usuario.email}" data-telefone="${usuario.telefone || ''}" data-data-nasc="${usuario.data_nasc || ''}" data-categoria="${usuario.categoria}" style="background: #1976d2; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; transition: all 0.3s ease;">
                                Editar
                            </button>
                            <button class="btn-excluir" data-id="${usuario.id}" style="background: #d32f2f; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; transition: all 0.3s ease;">
                                Excluir
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                document.getElementById('usuarios-tbody').innerHTML = `
                    <tr><td colspan="8" style="text-align: center; padding: 20px; color: red;">
                        Erro ao carregar usu√°rios: ${error.message}
                    </td></tr>
                `;
            }
        }

        // Fun√ß√£o para excluir usu√°rio usando delega√ß√£o de eventos
        document.addEventListener('click', async function(e) {
            if (e.target && e.target.classList.contains('btn-editar')) {
                const id = e.target.getAttribute('data-id');
                document.getElementById('usuarioId').value = id;
                document.getElementById('nomeUsuario').value = e.target.getAttribute('data-nome') || '';
                document.getElementById('matricula').value = e.target.getAttribute('data-matricula') || '';
                document.getElementById('email').value = e.target.getAttribute('data-email') || '';
                document.getElementById('telefone').value = e.target.getAttribute('data-telefone') || '';
                document.getElementById('dataNasc').value = (e.target.getAttribute('data-data-nasc') || '').split('T')[0];
                document.getElementById('categoria').value = e.target.getAttribute('data-categoria') || 'usuario';

                document.getElementById('btnSalvar').textContent = 'Salvar altera√ß√µes';
                document.getElementById('btnCancelarEdicao').style.display = 'block';
                return;
            }

            if (e.target && e.target.classList.contains('btn-excluir')) {
                const id = e.target.getAttribute('data-id');
                
                if (!confirm('Tem certeza que deseja excluir este usu√°rio?')) return;

                try {
                    const { error } = await supabaseClient
                        .from('user_login_nt')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;

                    alert('Usu√°rio exclu√≠do com sucesso!');
                    carregarUsuarios();

                } catch (error) {
                    console.error('Erro ao excluir usu√°rio:', error);
                    alert('Erro ao excluir usu√°rio: ' + error.message);
                }
            }
        });

        document.getElementById('btnCancelarEdicao').addEventListener('click', function() {
            document.getElementById('form').reset();
            document.getElementById('usuarioId').value = '';
            document.getElementById('btnSalvar').textContent = 'Cadastrar';
            this.style.display = 'none';
        });

        // Fun√ß√£o para cadastrar usu√°rio
        document.getElementById('form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const usuarioId = document.getElementById('usuarioId').value;
            const nomeUsuario = document.getElementById('nomeUsuario').value.trim();
            const matricula = document.getElementById('matricula').value.trim();
            const email = document.getElementById('email').value.trim().toLowerCase();
            const telefone = document.getElementById('telefone').value.trim();
            const dataNasc = document.getElementById('dataNasc').value;
            const senha = document.getElementById('senha').value;
            const categoria = document.getElementById('categoria').value;

            try {
                if (usuarioId) {
                    const { error } = await supabaseClient
                        .from('user_login_nt')
                        .update({
                            nome_usuario: nomeUsuario,
                            matricula: matricula,
                            email: email,
                            telefone: telefone,
                            data_nasc: dataNasc,
                            senha: senha,
                            categoria: categoria
                        })
                        .eq('id', usuarioId);

                    if (error) throw error;

                    alert('Usu√°rio atualizado com sucesso!');
                } else {
                    const { data, error } = await supabaseClient
                        .from('user_login_nt')
                        .insert([
                            {
                                nome_usuario: nomeUsuario,
                                matricula: matricula,
                                email: email,
                                telefone: telefone,
                                data_nasc: dataNasc,
                                senha: senha,
                                categoria: categoria
                            }
                        ])
                        .select();

                    if (error) throw error;
                    alert('Usu√°rio cadastrado com sucesso!');
                }

                document.getElementById('form').reset();
                document.getElementById('usuarioId').value = '';
                document.getElementById('btnSalvar').textContent = 'Cadastrar';
                document.getElementById('btnCancelarEdicao').style.display = 'none';
                carregarUsuarios();

            } catch (error) {
                console.error('Erro ao cadastrar usu√°rio:', error);
                alert('Erro ao cadastrar usu√°rio: ' + error.message);
            }
        });

        // Carregar usu√°rios ao carregar a p√°gina
        window.addEventListener('load', carregarUsuarios);
    </script>
</body>

</html>
